<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.18.9/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        textarea { font-family: Consolas, monospace; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal-content { background: white; margin: 15% auto; padding: 20px; width: 320px; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div id="root"></div>
    <script type="text/babel">
        function App() {
            const [state, setState] = React.useState({
                salary: 0,
                living_expense: 5000,
                start_month: 1,
                repay_list: [],
                course_list: [],
                result: '',
                modal: null
            });

            const showModal = (type) => {
                setState({ ...state, modal: type });
            };

            const closeModal = () => {
                setState({ ...state, modal: null });
            };

            const addPerson = async () => {
                const name = document.getElementById('person-name').value;
                const debt = document.getElementById('person-debt').value;
                const response = await fetch('/api/add_person', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, debt })
                });
                const data = await response.json();
                if (data.status === 'error') {
                    alert(data.message);
                } else {
                    setState({ ...state, repay_list: data.repay_list, modal: null });
                }
            };

            const addCourse = async () => {
                const fee = document.getElementById('course-fee').value;
                const months = document.getElementById('course-months').value;
                const response = await fetch('/api/add_course', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ fee, months })
                });
                const data = await response.json();
                if (data.status === 'error') {
                    alert(data.message);
                } else {
                    setState({ ...state, course_list: data.course_list, modal: null });
                }
            };

            const setSalary = async () => {
                const salary = document.getElementById('salary-input').value;
                const response = await fetch('/api/set_salary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ salary })
                });
                const data = await response.json();
                if (data.status === 'error') {
                    alert(data.message);
                } else {
                    setState({ ...state, salary: data.salary, modal: null });
                }
            };

            const setLivingExpense = async () => {
                const expense = document.getElementById('expense-input').value;
                const response = await fetch('/api/set_living_expense', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ expense })
                });
                const data = await response.json();
                if (data.status === 'error') {
                    alert(data.message);
                } else {
                    setState({ ...state, living_expense: data.living_expense, modal: null });
                }
            };

            const setStartMonth = async () => {
                const start_month = document.getElementById('start-month-input').value;
                const response = await fetch('/api/set_start_month', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_month })
                });
                const data = await response.json();
                if (data.status === 'error') {
                    alert(data.message);
                } else {
                    setState({ ...state, start_month: data.start_month, modal: null });
                }
            };

            const calculate = async () => {
                const response = await fetch('/api/calculate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                if (data.status === 'error') {
                    alert(data.message);
                } else {
                    setState({ ...state, result: data.result });
                }
            };

            const exportCsv = () => {
                window.location.href = '/api/export_csv';
            };

            const copyResult = () => {
                if (!state.result) {
                    alert('ç„¡è©¦ç®—çµæœå¯è¤‡è£½ï¼Œè«‹å…ˆåŸ·è¡Œè©¦ç®—');
                    return;
                }
                navigator.clipboard.writeText(state.result).then(() => {
                    alert('å·²è¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿');
                });
            };

            const clearAll = async () => {
                const response = await fetch('/api/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                setState({
                    salary: 0,
                    living_expense: 5000,
                    start_month: 1,
                    repay_list: [],
                    course_list: [],
                    result: '',
                    modal: null
                });
                alert(data.message);
            };

            const exitApp = () => {
                if (window.confirm('ç¢ºå®šè¦é›¢é–‹æ‡‰ç”¨ç¨‹å¼ï¼Ÿ')) {
                    window.close();
                }
            };

            return (
                <div className="max-w-4xl mx-auto bg-white p-4 rounded-lg shadow-md">
                    <h1 className="text-2xl font-bold text-center mb-4">ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</h1>
                    <div className="flex flex-wrap gap-2 mb-4">
                        <button className="px-4 py-2 bg-[#FFD700] rounded-lg font-bold text-sm" onClick={exportCsv} disabled={!state.result}>ğŸ’¾ åŒ¯å‡º CSV</button>
                        <button className="px-4 py-2 bg-[#87CEFA] rounded-lg font-bold text-sm" onClick={copyResult} disabled={!state.result}>ğŸ“‹ è¤‡è£½çµæœ</button>
                        <button className="px-4 py-2 bg-[#FFB6C1] rounded-lg font-bold text-sm" onClick={() => showModal('addPerson')}>â• æ–°å¢é‚„æ¬¾äºº</button>
                        <button className="px-4 py-2 bg-[#ADD8E6] rounded-lg font-bold text-sm" onClick={() => showModal('addCourse')}>â• æ–°å¢èª²ç¨‹</button>
                        <button className="px-4 py-2 bg-[#87CEFA] rounded-lg font-bold text-sm" onClick={() => showModal('setSalary')}>ğŸ’¼ è¨­å®šè–ªæ°´</button>
                        <button className="px-4 py-2 bg-[#FFD700] rounded-lg font-bold text-sm" onClick={() => showModal('setLivingExpense')}>ğŸ™ è¨­å®šç”Ÿæ´»è²»</button>
                        <button className="px-4 py-2 bg-[#FFDEAD] rounded-lg font-bold text-sm" onClick={() => showModal('setStartMonth')}>ğŸ“† è¨­å®šèµ·å§‹æœˆ</button>
                        <button className="px-4 py-2 bg-[#D8BFD8] rounded-lg font-bold text-sm" onClick={clearAll}>ğŸ§¹ æ¸…ç©ºé‡ä¾†</button>
                        <button className="px-4 py-2 bg-[#CD5C5C] text-white rounded-lg font-bold text-sm" onClick={exitApp}>âŒ é›¢é–‹</button>
                    </div>
                    <div className="mb-4">
                        <p className="text-sm">æ¯æœˆè–ªæ°´: {state.salary.toFixed(2)} å…ƒ</p>
                        <p className="text-sm">æ¯æœˆç”Ÿæ´»è²»: {state.living_expense.toFixed(2)} å…ƒ</p>
                        <p className="text-sm">é‚„æ¬¾èµ·å§‹æœˆ: ç¬¬ {state.start_month} å€‹æœˆ</p>
                    </div>
                    <div className="mb-4">
                        <h2 className="font-bold text-sm">é‚„æ¬¾äººæ¸…å–®ï¼š</h2>
                        <textarea className="w-full h-24 p-2 border rounded text-sm" readOnly value={state.repay_list.map(p => `${p.name} æ¬  ${p.debt.toFixed(2)} å…ƒ`).join('\n')}></textarea>
                    </div>
                    <div className="mb-4">
                        <h2 className="font-bold text-sm">èª²ç¨‹æ¸…å–®ï¼š</h2>
                        <textarea className="w-full h-24 p-2 border rounded text-sm" readOnly value={state.course_list.length === 0 ? 'å°šç„¡èª²ç¨‹' : state.course_list.map((c, i) => `èª²ç¨‹${i+1}: ç¸½è²»ç”¨ ${c.fee.toFixed(2)} å…ƒï¼ŒæœŸæ•¸ ${c.months} æœˆï¼Œæ¯æœˆè²»ç”¨ ${(c.fee/c.months).toFixed(2)} å…ƒ`).join('\n')}></textarea>
                    </div>
                    <button className="w-full py-3 bg-[#90EE90] rounded-lg font-bold text-sm mb-4" onClick={calculate}>ğŸ“Š é–‹å§‹è©¦ç®—</button>
                    <div>
                        <h2 className="font-bold text-sm">è©¦ç®—çµæœï¼š</h2>
                        <textarea className="w-full h-96 p-2 border rounded font-mono text-sm" readOnly value={state.result}></textarea>
                    </div>

                    {state.modal === 'addPerson' && (
                        <div className="modal" style={{ display: 'block' }}>
                            <div className="modal-content">
                                <h2 className="text-lg font-bold">â• æ–°å¢é‚„æ¬¾äºº</h2>
                                <label className="block text-sm">è«‹è¼¸å…¥é‚„æ¬¾äººå§“åï¼š</label>
                                <input id="person-name" type="text" className="w-full p-2 mb-2 border rounded text-sm" autoFocus />
                                <label className="block text-sm">æ¬ æ¬¾é‡‘é¡ (å…ƒ)ï¼š</label>
                                <input id="person-debt" type="number" step="0.01" className="w-full p-2 mb-2 border rounded text-sm" />
                                <div className="flex gap-2">
                                    <button className="px-4 py-2 bg-[#FFB6C1] rounded-lg font-bold text-sm" onClick={addPerson}>åŠ å…¥</button>
                                    <button className="px-4 py-2 bg-gray-300 rounded-lg font-bold text-sm" onClick={closeModal}>å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {state.modal === 'addCourse' && (
                        <div className="modal" style={{ display: 'block' }}>
                            <div className="modal-content">
                                <h2 className="text-lg font-bold">â• æ–°å¢èª²ç¨‹</h2>
                                <label className="block text-sm">èª²ç¨‹ç¸½è²»ç”¨ (å…ƒ)ï¼š</label>
                                <input id="course-fee" type="number" step="0.01" className="w-full p-2 mb-2 border rounded text-sm" autoFocus />
                                <label className="block text-sm">èª²ç¨‹æœŸæ•¸ (æœˆ)ï¼š</label>
                                <input id="course-months" type="number" step="1" className="w-full p-2 mb-2 border rounded text-sm" />
                                <div className="flex gap-2">
                                    <button className="px-4 py-2 bg-[#ADD8E6] rounded-lg font-bold text-sm" onClick={addCourse}>æ–°å¢èª²ç¨‹</button>
                                    <button className="px-4 py-2 bg-gray-300 rounded-lg font-bold text-sm" onClick={closeModal}>å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {state.modal === 'setSalary' && (
                        <div className="modal" style={{ display: 'block' }}>
                            <div className="modal-content">
                                <h2 className="text-lg font-bold">ğŸ’¼ è¨­å®šè–ªæ°´</h2>
                                <label className="block text-sm">è«‹è¼¸å…¥æ¯æœˆè–ªæ°´ (å…ƒ)ï¼š</label>
                                <input id="salary-input" type="number" step="0.01" className="w-full p-2 mb-2 border rounded text-sm" defaultValue={state.salary} autoFocus />
                                <div className="flex gap-2">
                                    <button className="px-4 py-2 bg-[#87CEFA] rounded-lg font-bold text-sm" onClick={setSalary}>è¨­å®šå®Œæˆ</button>
                                    <button className="px-4 py-2 bg-gray-300 rounded-lg font-bold text-sm" onClick={closeModal}>å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {state.modal === 'setLivingExpense' && (
                        <div className="modal" style={{ display: 'block' }}>
                            <div className="modal-content">
                                <h2 className="text-lg font-bold">ğŸ™ è¨­å®šç”Ÿæ´»è²»</h2>
                                <label className="block text-sm">è«‹è¼¸å…¥æ¯æœˆç”Ÿæ´»è²» (å…ƒ)ï¼š</label>
                                <input id="expense-input" type="number" step="0.01" className="w-full p-2 mb-2 border rounded text-sm" defaultValue={state.living_expense} autoFocus />
                                <div className="flex gap-2">
                                    <button className="px-4 py-2 bg-[#FFD700] rounded-lg font-bold text-sm" onClick={setLivingExpense}>è¨­å®šå®Œæˆ</button>
                                    <button className="px-4 py-2 bg-gray-300 rounded-lg font-bold text-sm" onClick={closeModal}>å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {state.modal === 'setStartMonth' && (
                        <div className="modal" style={{ display: 'block' }}>
                            <div className="modal-content">
                                <h2 className="text-lg font-bold">ğŸ“† è¨­å®šèµ·å§‹æœˆ</h2>
                                <label className="block text-sm">è«‹è¼¸å…¥å¾ç¬¬å¹¾å€‹æœˆé–‹å§‹é‚„æ¬¾ï¼ˆ1èµ·ç®—ï¼‰ï¼š</label>
                                <input id="start-month-input" type="number" step="1" className="w-full p-2 mb-2 border rounded text-sm" defaultValue={state.start_month} autoFocus />
                                <div className="flex gap-2">
                                    <button className="px-4 py-2 bg-[#FFDEAD] rounded-lg font-bold text-sm" onClick={setStartMonth}>è¨­å®šå®Œæˆ</button>
                                    <button className="px-4 py-2 bg-gray-300 rounded-lg font-bold text-sm" onClick={closeModal}>å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
