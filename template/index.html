<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>還款計算器</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 10px; }
        nav a { margin: 0 10px; cursor: pointer; color: blue; text-decoration: underline; }
        section { display: none; }
        section.active { display: block; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        input[type="number"] { width: 100px; }
        .btn { padding: 5px 10px; cursor: pointer; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>還款計算器</h1>

    <nav>
        <a data-page="main">首頁</a>
        <a data-page="about">關於</a>
        <a data-page="contact">聯絡</a>
        <a data-page="terms">服務條款</a>
        <a data-page="privacy">隱私權政策</a>
    </nav>

    <!-- 主頁 -->
    <section id="main" class="active">
        <h2>基本設定</h2>
        <div>
            <label>每月薪水: <input type="number" id="salary" min="0" step="0.01" /></label>
            <button id="btnSetSalary">設定薪水</button>
        </div>
        <div>
            <label>每月生活費: <input type="number" id="livingExpense" min="0" step="0.01" /></label>
            <button id="btnSetExpense">設定生活費</button>
        </div>
        <div>
            <label>還款起始月份(1~12): <input type="number" id="startMonth" min="1" max="12" /></label>
            <button id="btnSetStartMonth">設定起始月份</button>
        </div>

        <h2>還款人管理</h2>
        <div>
            <input type="text" id="personName" placeholder="姓名" />
            <input type="number" id="personDebt" placeholder="欠款金額" min="0" step="0.01" />
            <button id="btnAddPerson">新增還款人</button>
        </div>
        <ul id="personList"></ul>

        <h2>課程管理</h2>
        <div>
            <input type="number" id="courseFee" placeholder="課程費用" min="0" step="0.01" />
            <input type="number" id="courseMonths" placeholder="期數" min="1" />
            <button id="btnAddCourse">新增課程</button>
        </div>
        <ul id="courseList"></ul>

        <h2>計算與結果</h2>
        <button id="btnCalculate">開始計算</button>
        <button id="btnExportCsv">匯出 CSV</button>

        <pre id="resultArea" style="background:#eee; padding:10px; height:300px; overflow:auto;"></pre>
    </section>

    <!-- 關於頁 -->
    <section id="about">
        <h2>關於我們</h2>
        <p>這是一個還款計算器的示範專案。</p>
    </section>

    <!-- 聯絡頁 -->
    <section id="contact">
        <h2>聯絡我們</h2>
        <p>請透過 email@example.com 聯絡我們。</p>
    </section>

    <!-- 服務條款 -->
    <section id="terms">
        <h2>服務條款</h2>
        <p>本服務條款規範本網站的使用規範與權利義務。</p>
    </section>

    <!-- 隱私權政策 -->
    <section id="privacy">
        <h2>隱私權政策</h2>
        <p>本網站重視您的隱私權，請詳閱本政策內容。</p>
    </section>

    <script>
    // 頁面切換
    document.querySelectorAll('nav a').forEach(a => {
        a.addEventListener('click', () => {
            let page = a.getAttribute('data-page');
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(page).classList.add('active');
        });
    });

    const apiBase = '/api';

    // 取得目前狀態並初始化
    async function loadState() {
        const res = await fetch(apiBase + '/get_current_state');
        const data = await res.json();
        if(data.status === 'success') {
            document.getElementById('salary').value = data.salary;
            document.getElementById('livingExpense').value = data.living_expense;
            document.getElementById('startMonth').value = data.start_month;
            refreshPersonList(data.repay_list);
            refreshCourseList(data.course_list);
        }
    }

    // 更新還款人列表
    function refreshPersonList(list) {
        const ul = document.getElementById('personList');
        ul.innerHTML = '';
        list.forEach((p,i) => {
            let li = document.createElement('li');
            li.textContent = `${p.name} 欠款: ${p.debt.toFixed(2)} 元 `;
            let btn = document.createElement('button');
            btn.textContent = '刪除';
            btn.onclick = () => removePerson(p.name);
            li.appendChild(btn);
            ul.appendChild(li);
        });
    }

    // 更新課程列表
    function refreshCourseList(list) {
        const ul = document.getElementById('courseList');
        ul.innerHTML = '';
        list.forEach((c,i) => {
            let li = document.createElement('li');
            li.textContent = `費用: ${c.fee.toFixed(2)} 元，期數: ${c.months} `;
            let btn = document.createElement('button');
            btn.textContent = '刪除';
            btn.onclick = () => removeCourse(i);
            li.appendChild(btn);
            ul.appendChild(li);
        });
    }

    // 新增還款人
    async function addPerson() {
        let name = document.getElementById('personName').value.trim();
        let debt = document.getElementById('personDebt').value.trim();
        if(!name || !debt) {
            alert('請輸入姓名和欠款金額');
            return;
        }
        let res = await fetch(apiBase + '/add_person', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({name, debt})
        });
        let data = await res.json();
        if(data.status === 'success') {
            refreshPersonList(data.repay_list);
            document.getElementById('personName').value = '';
            document.getElementById('personDebt').value = '';
        } else alert(data.message);
    }

    // 移除還款人
    async function removePerson(name) {
        let res = await fetch(apiBase + '/remove_person', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({name})
        });
        let data = await res.json();
        if(data.status === 'success') {
            refreshPersonList(data.repay_list);
        } else alert(data.message);
    }

    // 新增課程
    async function addCourse() {
        let fee = document.getElementById('courseFee').value.trim();
        let months = document.getElementById('courseMonths').value.trim();
        if(!fee || !months) {
            alert('請輸入課程費用與期數');
            return;
        }
        let res = await fetch(apiBase + '/add_course', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({fee, months})
        });
        let data = await res.json();
        if(data.status === 'success') {
            refreshCourseList(data.course_list);
            document.getElementById('courseFee').value = '';
            document.getElementById('courseMonths').value = '';
        } else alert(data.message);
    }

    // 移除課程
    async function removeCourse(idx) {
        let res = await fetch(apiBase + '/remove_course', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({index: idx})
        });
        let data = await res.json();
        if(data.status === 'success') {
            refreshCourseList(data.course_list);
        } else alert(data.message);
    }

    // 設定薪水
    async function setSalary() {
        let salary = document.getElementById('salary').value.trim();
        let res = await fetch(apiBase + '/set_salary', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({salary})
        });
        let data = await res.json();
        if(data.status === 'success') alert('薪水設定成功');
        else alert(data.message);
    }

    // 設定生活費
    async function setExpense() {
        let expense = document.getElementById('livingExpense').value.trim();
        let res = await fetch(apiBase + '/set_living_expense', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({expense})
        });
        let data = await res.json();
        if(data.status === 'success') alert('生活費設定成功');
        else alert(data.message);
    }

    // 設定起始月份
    async function setStartMonth() {
        let start_month = document.getElementById('startMonth').value.trim();
        let res = await fetch(apiBase + '/set_start_month', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({start_month})
        });
        let data = await res.json();
        if(data.status === 'success') alert('起始月份設定成功');
        else alert(data.message);
    }

    // 計算
    async function calculate() {
        const res = await fetch(apiBase + '/calculate', {method: 'POST'});
        const data = await res.json();
        if(data.status === 'success') {
            document.getElementById('resultArea').textContent = JSON.stringify(data, null, 2);
        } else {
            alert(data.message);
        }
    }

    // 匯出 CSV
    async function exportCsv() {
        const res = await fetch(apiBase + '/export_csv');
        if(res.ok) {
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'repayment_plan.csv';
            a.click();
            URL.revokeObjectURL(url);
        } else {
            const err = await res.json();
            alert(err.message || '匯出失敗');
        }
    }

    // 綁定事件
    document.getElementById('btnAddPerson').addEventListener('click', addPerson);
    document.getElementById('btnAddCourse').addEventListener('click', addCourse);
    document.getElementById('btnSetSalary').addEventListener('click', setSalary);
    document.getElementById('btnSetExpense').addEventListener('click', setExpense);
    document.getElementById('btnSetStartMonth').addEventListener('click', setStartMonth);
    document.getElementById('btnCalculate').addEventListener('click', calculate);
    document.getElementById('btnExportCsv').addEventListener('click', exportCsv);

    // 頁面載入時初始化
    window.onload = loadState;
    </script>
</body>
</html>
