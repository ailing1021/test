<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💰 超級還款試算表 - 專業版</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    html, body, #root {
      height: 100%;
      margin: 0; padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background-color: #f4f7fa;
      display: flex;
      flex-direction: column;
    }
    #root {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .main-content {
      flex-grow: 1;
      padding: 1rem;
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }
    .container {
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 1rem 1.5rem;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 14px;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 0.5rem 0.75rem;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background-color: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    button {
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
      border-radius: 0.375rem;
      font-weight: 600;
    }
    button:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    footer {
      background: #fff;
      border-top: 1px solid #e5e7eb;
      padding: 1rem 0;
      text-align: center;
      font-size: 14px;
      color: #555;
      flex-shrink: 0;
    }
    #cookie-banner {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #f8f8f8;
      padding: 1rem;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
      font-family: sans-serif;
      font-size: 14px;
      color: #333;
      z-index: 1000;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <div id="cookie-banner" style="display:none;">
    <span style="flex: 1; min-width: 200px; text-align: center;">
      我們使用 Cookie 改善網站功能與分析流量。請選擇是否接受。
    </span>
    <div>
      <button id="btnAccept" style="background: #007bff; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer;">
        接受全部
      </button>
      <button id="btnDecline" style="background: #ccc; color: #000; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; margin-left: 8px;">
        僅使用必要
      </button>
    </div>
  </div>

  <footer>
    <a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">隱私權政策</a> |
    <a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">服務條款</a> |
    <a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">免責聲明</a> |
    <a href="#" target="_blank" rel="noopener noreferrer" class="text-blue-600 underline">聯絡我們</a>
  </footer>

  <script>
    // Cookie banner handling
    const cookieBanner = document.getElementById('cookie-banner');
    const btnAccept = document.getElementById('btnAccept');
    const btnDecline = document.getElementById('btnDecline');

    function acceptCookies() {
      localStorage.setItem('cookieConsent', 'accepted');
      cookieBanner.style.display = 'none';
    }
    function declineCookies() {
      localStorage.setItem('cookieConsent', 'declined');
      cookieBanner.style.display = 'none';
    }

    btnAccept.addEventListener('click', acceptCookies);
    btnDecline.addEventListener('click', declineCookies);

    document.addEventListener('DOMContentLoaded', () => {
      if (!localStorage.getItem('cookieConsent')) {
        cookieBanner.style.display = 'flex';
      }
    });
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Error Boundary
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      componentDidCatch(error, errorInfo) {
        console.error(error, errorInfo);
      }
      render() {
        if (this.state.hasError) {
          return (
            <div className="text-center p-8 text-red-600">
              <h1 className="text-3xl mb-4">應用程式發生錯誤</h1>
              <pre>{this.state.error && this.state.error.toString()}</pre>
              <button
                className="mt-4 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
                onClick={() => window.location.reload()}
              >
                重新整理
              </button>
            </div>
          );
        }
        return this.props.children;
      }
    }

    // 主App元件
    function App() {
      // 各種狀態
      const [salary, setSalary] = useState(30000);
      const [livingExpense, setLivingExpense] = useState(8000);
      const [startMonth, setStartMonth] = useState(1);
      const [repayList, setRepayList] = useState([
        { name: "張三", debt: 10000 },
        { name: "李四", debt: 15000 },
      ]);
      const [courseList, setCourseList] = useState([
        { fee: 30000, months: 6 }
      ]);
      const [resultText, setResultText] = useState('');
      const [errorMsg, setErrorMsg] = useState('');

      // 表格滾動用ref
      const resultRef = useRef(null);

      // 新增還款人表單狀態
      const [newPersonName, setNewPersonName] = useState('');
      const [newPersonDebt, setNewPersonDebt] = useState('');

      // 新增課程表單狀態
      const [newCourseFee, setNewCourseFee] = useState('');
      const [newCourseMonths, setNewCourseMonths] = useState('');

      // 新增還款人
      function addPerson() {
        if (!newPersonName.trim()) {
          alert("姓名不能空白");
          return;
        }
        const debtNum = parseFloat(newPersonDebt);
        if (isNaN(debtNum) || debtNum <= 0) {
          alert("欠款必須大於0");
          return;
        }
        setRepayList(prev => [...prev, { name: newPersonName.trim(), debt: debtNum }]);
        setNewPersonName('');
        setNewPersonDebt('');
      }

      // 新增課程
      function addCourse() {
        const feeNum = parseFloat(newCourseFee);
        const monthsNum = parseInt(newCourseMonths);
        if (isNaN(feeNum) || feeNum <= 0) {
          alert("課程費用必須大於0");
          return;
        }
        if (isNaN(monthsNum) || monthsNum <= 0) {
          alert("課程期數必須是正整數");
          return;
        }
        setCourseList(prev => [...prev, { fee: feeNum, months: monthsNum }]);
        setNewCourseFee('');
        setNewCourseMonths('');
      }

      // 移除還款人
      function removePerson(idx) {
        if (!window.confirm(`確定刪除還款人「${repayList[idx].name}」嗎？`)) return;
        setRepayList(prev => prev.filter((_, i) => i !== idx));
      }

      // 移除課程
      function removeCourse(idx) {
        if (!window.confirm(`確定刪除課程 #${idx + 1} 嗎？`)) return;
        setCourseList(prev => prev.filter((_, i) => i !== idx));
      }

      // 計算邏輯：每月還款明細
      function runCalculation() {
        setErrorMsg('');
        setResultText('');

        if (salary <= 0) {
          setErrorMsg("薪資需大於0");
          return;
        }
        if (livingExpense < 0) {
          setErrorMsg("生活費不可為負");
          return;
        }
        if (startMonth < 1 || startMonth > 12) {
          setErrorMsg("起始月份需介於1~12");
          return;
        }
        if (repayList.length === 0) {
          setErrorMsg("請至少新增一個還款人");
          return;
        }
        if (courseList.length === 0) {
          setErrorMsg("請至少新增一個課程");
          return;
        }

        const availablePerMonth = salary - livingExpense;
        if (availablePerMonth <= 0) {
          setErrorMsg("薪資扣除生活費後須大於0");
          return;
        }

        const totalDebt = repayList.reduce((a, c) => a + c.debt, 0);
        const totalCourseFee = courseList.reduce((a, c) => a + c.fee, 0);

        // 還款比例
        const repayRatios = repayList.map(p => p.debt / totalDebt);

        // 欠款餘額
        let debtsLeft = repayList.map(p => p.debt);

        let monthIdx = startMonth;
        let year = new Date().getFullYear();

        let maxIter = 240; // 最多20年

        let output = "月份\t還款人\t本月還款金額\n";

        for (let i = 0; i < maxIter; i++) {
          if (debtsLeft.every(d => d <= 0)) break;

          // 當月課程分期支出
          let coursePayThisMonth = 0;
          for (const c of courseList) {
            if (i < c.months) coursePayThisMonth += c.fee / c.months;
          }

          // 可支配金額
          let disposable = availablePerMonth - coursePayThisMonth;
          if (disposable < 0) disposable = 0;

          // 本月還款分配
          let repayThisMonth = debtsLeft.map((d, idx) => {
            if (d <= 0) return 0;
            return Math.min(d, disposable * repayRatios[idx]);
          });

          debtsLeft = debtsLeft.map((d, idx) => Math.max(0, d - repayThisMonth[idx]));

          let displayMonth = `${year}年${monthIdx}月`;

          for (let j = 0; j < repayList.length; j++) {
            output += `${displayMonth}\t${repayList[j].name}\t${repayThisMonth[j].toFixed(2)}\n`;
          }

          monthIdx++;
          if (monthIdx > 12) {
            monthIdx = 1;
            year++;
          }
        }

        setResultText(output);

        // 捲動結果表格到頂端
        if (resultRef.current) resultRef.current.scrollTop = 0;
      }

      // 轉換結果成表格陣列
      function parseResultTable(text) {
        if (!text) return { headers: [], rows: [] };
        const lines = text.trim().split('\n');
        if (lines.length < 2) return { headers: [], rows: [] };
        const headers = lines[0].split('\t');
        const rows = lines.slice(1).map(line => line.split('\t'));
        return { headers, rows };
      }

      // 複製結果
      function copyResult() {
        if (!resultText) {
          alert("沒有計算結果可複製");
          return;
        }
        navigator.clipboard.writeText(resultText).then(() => {
          alert("已複製試算結果");
        }).catch(() => {
          alert("複製失敗，請手動複製");
        });
      }

      // 匯出 CSV
      function exportCsv() {
        if (!resultText) {
          alert("沒有計算結果可匯出");
          return;
        }
        const csvContent = resultText.replace(/\t/g, ',');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'repay_result.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      // 清空所有資料
      function clearAll() {
        if (!window.confirm("確定要清空所有資料嗎？此操作無法復原。")) return;
        setSalary(0);
        setLivingExpense(0);
        setStartMonth(1);
        setRepayList([]);
        setCourseList([]);
        setResultText('');
        setErrorMsg('');
      }

      // 離開頁面（跳空白）
      function exitApp() {
        if (window.confirm("確定要離開？")) {
          window.location.href = 'about:blank';
        }
      }

      // 圖表容器 ref
      const chartRef = useRef(null);
      const chartInstance = useRef(null);

      // 畫還款人欠款圓餅圖
      useEffect(() => {
        if (!chartRef.current) return;
        if (chartInstance.current) {
          chartInstance.current.destroy();
        }
        if (repayList.length === 0) return;

        const labels = repayList.map(p => p.name);
        const dataValues = repayList.map(p => p.debt);
        if (dataValues.every(v => v <= 0)) return;

        const ctx = chartRef.current.getContext('2d');
        chartInstance.current = new Chart(ctx, {
          type: 'pie',
          data: {
            labels,
            datasets: [{
              data: dataValues,
              backgroundColor: [
                '#3b82f6','#10b981','#ef4444','#f59e0b','#8b5cf6',
                '#06b6d4','#db2777','#6d28d9','#ca8a04','#4ade80'
              ],
              hoverOffset: 20,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'right', labels: { font: { size: 14 } } },
              title: {
                display: true,
                text: '總欠款分佈',
                font: { size: 20, weight: 'bold' },
                padding: { bottom: 20 }
              },
              tooltip: {
                callbacks: {
                  label(ctx) {
                    const label = ctx.label || '';
                    const value = ctx.parsed || 0;
                    return `${label}: ${value.toLocaleString()} 元`;
                  }
                }
              }
            }
          }
        });
      }, [repayList]);

      const { headers, rows } = parseResultTable(resultText);

      return (
        <>
          <main className="main-content">
            <h1 className="text-3xl font-bold text-center mb-6">💰 超級還款試算表 - 專業版</h1>

            {/* 薪資與生活費輸入 */}
            <section className="container">
              <h2 className="text-xl font-semibold mb-2">基本設定</h2>
              <div className="flex flex-wrap gap-4">
                <label className="flex-1 min-w-[120px]">
                  薪資（月薪）：
                  <input
                    type="number"
                    className="w-full border rounded px-2 py-1"
                    value={salary}
                    onChange={e => setSalary(parseInt(e.target.value) || 0)}
                    min={0}
                  />
                </label>
                <label className="flex-1 min-w-[120px]">
                  生活費（月支出）：
                  <input
                    type="number"
                    className="w-full border rounded px-2 py-1"
                    value={livingExpense}
                    onChange={e => setLivingExpense(parseInt(e.target.value) || 0)}
                    min={0}
                  />
                </label>
                <label className="flex-1 min-w-[120px]">
                  起始月份：
                  <input
                    type="number"
                    className="w-full border rounded px-2 py-1"
                    value={startMonth}
                    onChange={e => {
                      const val = parseInt(e.target.value);
                      if (val >= 1 && val <= 12) setStartMonth(val);
                    }}
                    min={1}
                    max={12}
                  />
                </label>
              </div>
            </section>

            {/* 還款人管理 */}
            <section className="container">
              <h2 className="text-xl font-semibold mb-2">還款人列表</h2>
              <table>
                <thead>
                  <tr>
                    <th>姓名</th>
                    <th>欠款金額（元）</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  {repayList.length === 0 ? (
                    <tr>
                      <td colSpan={3}>尚無還款人，請新增</td>
                    </tr>
                  ) : (
                    repayList.map((p, idx) => (
                      <tr key={idx}>
                        <td>{p.name}</td>
                        <td>{p.debt.toLocaleString()}</td>
                        <td>
                          <button
                            className="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded"
                            onClick={() => removePerson(idx)}
                            title="刪除"
                          >
                            刪除
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>

              <div className="flex flex-wrap gap-4 mt-4">
                <input
                  type="text"
                  placeholder="姓名"
                  value={newPersonName}
                  onChange={e => setNewPersonName(e.target.value)}
                  className="border rounded px-3 py-1 flex-grow min-w-[120px]"
                />
                <input
                  type="number"
                  placeholder="欠款金額（元）"
                  value={newPersonDebt}
                  onChange={e => setNewPersonDebt(e.target.value)}
                  className="border rounded px-3 py-1 w-36"
                  min={0}
                />
                <button
                  className="bg-green-600 hover:bg-green-800 text-white px-4 py-1 rounded"
                  onClick={addPerson}
                >
                  新增還款人
                </button>
              </div>
            </section>

            {/* 課程管理 */}
            <section className="container">
              <h2 className="text-xl font-semibold mb-2">課程列表</h2>
              <table>
                <thead>
                  <tr>
                    <th>課程費用（元）</th>
                    <th>分期月數</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  {courseList.length === 0 ? (
                    <tr>
                      <td colSpan={3}>尚無課程，請新增</td>
                    </tr>
                  ) : (
                    courseList.map((c, idx) => (
                      <tr key={idx}>
                        <td>{c.fee.toLocaleString()}</td>
                        <td>{c.months}</td>
                        <td>
                          <button
                            className="bg-red-500 hover:bg-red-700 text-white px-3 py-1 rounded"
                            onClick={() => removeCourse(idx)}
                            title="刪除"
                          >
                            刪除
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>

              <div className="flex flex-wrap gap-4 mt-4">
                <input
                  type="number"
                  placeholder="課程費用（元）"
                  value={newCourseFee}
                  onChange={e => setNewCourseFee(e.target.value)}
                  className="border rounded px-3 py-1 w-48"
                  min={0}
                />
                <input
                  type="number"
                  placeholder="分期月數"
                  value={newCourseMonths}
                  onChange={e => setNewCourseMonths(e.target.value)}
                  className="border rounded px-3 py-1 w-36"
                  min={1}
                />
                <button
                  className="bg-green-600 hover:bg-green-800 text-white px-4 py-1 rounded"
                  onClick={addCourse}
                >
                  新增課程
                </button>
              </div>
            </section>

            {/* 計算按鈕與錯誤提示 */}
            <section className="container flex flex-col items-center">
              {errorMsg && (
                <div className="mb-4 p-2 rounded bg-red-100 text-red-700 w-full text-center font-semibold">
                  ⚠️ {errorMsg}
                </div>
              )}
              <button
                className="bg-blue-600 hover:bg-blue-800 text-white px-6 py-3 rounded text-lg font-bold"
                onClick={runCalculation}
              >
                執行試算
              </button>
            </section>

            {/* 結果展示區 */}
            <section className="container flex flex-col gap-4">
              <h2 className="text-xl font-semibold">試算結果明細</h2>
              <div
                ref={resultRef}
                style={{ maxHeight: '240px', overflowY: 'auto', fontFamily: 'monospace', whiteSpace: 'pre' }}
                className="border rounded p-3 bg-gray-50"
                tabIndex={0}
                aria-label="試算結果"
              >
                {resultText || "尚無試算結果"}
              </div>

              <div className="flex gap-4 justify-center mt-2">
                <button
                  className="bg-gray-700 hover:bg-gray-900 text-white px-4 py-1 rounded"
                  onClick={copyResult}
                  disabled={!resultText}
                  title="複製結果"
                >
                  複製結果
                </button>
                <button
                  className="bg-gray-700 hover:bg-gray-900 text-white px-4 py-1 rounded"
                  onClick={exportCsv}
                  disabled={!resultText}
                  title="匯出CSV"
                >
                  匯出CSV
                </button>
                <button
                  className="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-1 rounded"
                  onClick={clearAll}
                  title="清空所有資料"
                >
                  清空資料
                </button>
                <button
                  className="bg-red-600 hover:bg-red-800 text-white px-4 py-1 rounded"
                  onClick={exitApp}
                  title="離開頁面"
                >
                  離開
                </button>
              </div>
            </section>

            {/* 圖表區 */}
            <section className="container">
              <h2 className="text-xl font-semibold mb-2">欠款分佈圖表</h2>
              <canvas ref={chartRef} style={{ maxHeight: '360px' }} aria-label="欠款分佈圖表" role="img"></canvas>
            </section>
          </main>
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>
