<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3023489511713645"
    crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💰 超級還款試算表 - 完整版</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body, #root {
      height: 100%;
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f3f4f6; /* Tailwind gray-100 */
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 380px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    textarea {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
    }
  </style>

  <meta name="google-site-verification" content="BCvXzgcedvqCehBvT5sfZjBzHe56ld3ft6gNTqERsyE" />
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WGEGPPKK5D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('consent', 'default', {
      ad_storage: 'denied',
      analytics_storage: 'denied'
    });
    gtag('config', 'G-WGEGPPKK5D');
  </script>
</head>
<body>
  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">
    function App() {
      const getInitialState = () => {
        return {
          salary: 0,
          livingExpense: 0,
          startMonth: 1,
          repayList: [],
          courseList: [],
          calculationResult: '',
          modalType: null,
        };
      };

      const [state, setState] = React.useState(getInitialState);

      React.useEffect(() => {
        fetchCurrentState();
      }, []);

      const fetchCurrentState = async () => {
        try {
          const response = await fetch('/api/get_current_state');
          if (response.ok) {
            const data = await response.json();
            setState(prev => ({
              ...prev,
              salary: data.salary || 0,
              livingExpense: data.living_expense || 0,
              startMonth: data.start_month || 1,
              repayList: data.repay_list || [],
              courseList: data.course_list || [],
            }));
          } else {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            console.error('Failed to fetch current state:', response.status, errorData.message);
            alert(`無法獲取最新狀態，請檢查伺服器或網路連線。錯誤：${errorData.message}`);
          }
        } catch (error) {
          console.error('Error fetching current state:', error);
          alert('獲取最新狀態時發生網路錯誤或伺服器問題。');
        }
      };

      const openModal = (type) => {
        setState(prev => ({ ...prev, modalType: type }));
      };

      const closeModal = () => {
        setState(prev => ({ ...prev, modalType: null }));
      };

      const addPerson = async (name, debt) => {
        if (!name.trim()) {
          alert("姓名不能為空");
          return false;
        }
        if (isNaN(parseFloat(debt)) || parseFloat(debt) <= 0) {
          alert("欠款金額必須大於0");
          return false;
        }
        try {
          const response = await fetch('/api/add_person', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name.trim(), debt: parseFloat(debt) }),
          });
          const data = await response.json();
          if (response.ok && data.status === 'success') {
            await fetchCurrentState();
            return true;
          } else {
            alert("新增還款人失敗: " + (data.message || response.statusText));
            return false;
          }
        } catch (error) {
          console.error('Error adding person:', error);
          alert('新增還款人時發生網路錯誤或伺服器問題。');
          return false;
        }
      };

      const addCourse = async (fee, months) => {
        if (isNaN(parseFloat(fee)) || parseFloat(fee) <= 0) {
          alert("課程總費用必須大於0");
          return false;
        }
        if (!Number.isInteger(parseInt(months)) || parseInt(months) <= 0) {
          alert("課程期數必須是大於0的整數");
          return false;
        }
        try {
          const response = await fetch('/api/add_course', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ fee: parseFloat(fee), months: parseInt(months) }),
          });
          const data = await response.json();
          if (response.ok && data.status === 'success') {
            await fetchCurrentState();
            return true;
          } else {
            alert("新增課程失敗: " + (data.message || response.statusText));
            return false;
          }
        } catch (error) {
          console.error('Error adding course:', error);
          alert('新增課程時發生網路錯誤或伺服器問題。');
          return false;
        }
      };

      const setSalary = async (salary) => {
        if (isNaN(parseFloat(salary)) || parseFloat(salary) < 0) {
          alert("薪水必須是非負數");
          return false;
        }
        try {
          const response = await fetch('/api/set_salary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ salary: parseFloat(salary) }),
          });
          const data = await response.json();
          if (response.ok && data.status === 'success') {
            await fetchCurrentState();
            return true;
          } else {
            alert("設定薪水失敗: " + (data.message || response.statusText));
            return false;
          }
        } catch (error) {
          console.error('Error setting salary:', error);
          alert('設定薪水時發生網路錯誤或伺服器問題。');
          return false;
        }
      };

      const setLivingExpense = async (expense) => {
        if (isNaN(parseFloat(expense)) || parseFloat(expense) < 0) {
          alert("生活費必須是非負數");
          return false;
        }
        try {
          const response = await fetch('/api/set_living_expense', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ expense: parseFloat(expense) }),
          });
          const data = await response.json();
          if (response.ok && data.status === 'success') {
            await fetchCurrentState();
            return true;
          } else {
            alert("設定生活費失敗: " + (data.message || response.statusText));
            return false;
          }
        } catch (error) {
          console.error('Error setting living expense:', error);
          alert('設定生活費時發生網路錯誤或伺服器問題。');
          return false;
        }
      };

      const setStartMonth = async (month) => {
        const monthInt = parseInt(month);
        if (!Number.isInteger(monthInt) || monthInt < 1 || monthInt > 12) {
          alert("起始月份必須介於1到12");
          return false;
        }
        try {
          const response = await fetch('/api/set_start_month', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ start_month: monthInt }),
          });
          const data = await response.json();
          if (response.ok && data.status === 'success') {
            await fetchCurrentState();
            return true;
          } else {
            alert("設定起始月份失敗: " + (data.message || response.statusText));
            return false;
          }
        } catch (error) {
          console.error('Error setting start month:', error);
          alert('設定起始月份時發生網路錯誤或伺服器問題。');
          return false;
        }
      };

      const removePerson = (index) => {
        if (!confirm(`確定要從前端列表中移除還款人「${state.repayList[index].name}」嗎？\n(注意：此操作不會同步清除後端數據，如需徹底清除請使用「清空資料」)`)) return;
        const newList = [...state.repayList];
        newList.splice(index, 1);
        setState(prev => ({ ...prev, repayList: newList }));
      };

      const removeCourse = (index) => {
        if (!confirm(`確定要從前端列表中移除課程 #${index + 1} 嗎？\n(注意：此操作不會同步清除後端數據，如需徹底清除請使用「清空資料」)`)) return;
        const newList = [...state.courseList];
        newList.splice(index, 1);
        setState(prev => ({ ...prev, courseList: newList }));
      };

      const calculate = async () => {
        try {
          const response = await fetch('/api/calculate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const data = await response.json();
          console.log('API response:', data); // Debug API response
          if (response.ok && data.status === 'success') {
            console.log('calculationResult:', data.result); // Debug result
            setState(prev => ({ ...prev, calculationResult: data.result }));
          } else {
            alert("計算失敗: " + (data.message || response.statusText));
            setState(prev => ({ ...prev, calculationResult: `錯誤: ${data.message || response.statusText}` }));
          }
        } catch (error) {
          console.error('Error during calculation:', error);
          alert('計算時發生網路錯誤或伺服器問題。');
          setState(prev => ({ ...prev, calculationResult: `發生錯誤，請檢查網路連線或伺服器。` }));
        }
      };

      const copyResult = async () => {
        try {
          if (state.calculationResult) {
            await navigator.clipboard.writeText(state.calculationResult);
            alert('試算結果已複製到剪貼簿！');
          } else {
            alert('沒有試算結果可供複製。');
          }
        } catch (err) {
          console.error('複製失敗:', err);
          alert('無法複製到剪貼簿，請手動選取文字複製。');
        }
      };

      const exportCsv = async () => {
        try {
          const response = await fetch('/api/export_csv', {
            method: 'GET',
          });
          if (response.ok) {
            const contentDisposition = response.headers.get('Content-Disposition');
            let filename = 'repay_result.csv';
            if (contentDisposition && contentDisposition.includes('filename=')) {
              filename = contentDisposition.split('filename=')[1].trim().replace(/"/g, '');
            }
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
            alert("CSV 檔案已成功下載。");
          } else {
            const errorData = await response.json().catch(() => ({ message: response.statusText }));
            alert("匯出CSV失敗: " + (errorData.message || response.statusText));
          }
        } catch (error) {
          console.error('Error exporting CSV:', error);
          alert('匯出CSV時發生網路錯誤或伺服器問題。');
        }
      };

      const clearAll = async () => {
        if (!confirm('確定要清空所有設定和結果嗎？這將重置所有後端數據。')) return;
        try {
          const response = await fetch('/api/reset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
          });
          const data = await response.json();
          if (response.ok && data.status === 'success') {
            await fetchCurrentState();
            setState(prev => ({ ...prev, calculationResult: '' }));
            alert(data.message);
          } else {
            alert("清空資料失敗: " + (data.message || response.statusText));
          }
        } catch (error) {
          console.error('Error clearing data:', error);
          alert('清空資料時發生網路錯誤或伺服器問題。');
        }
      };

      const exitApp = () => {
        if (confirm('確定離開？')) {
          window.location.href = 'about:blank';
        }
      };

      const parseResultToTable = (result) => {
        if (!result || result.trim() === '') {
          console.log('calculationResult is empty or invalid');
          return { headers: [], rows: [] };
        }
        try {
          // Try parsing as JSON first
          const data = JSON.parse(result);
          console.log('Parsed as JSON:', data);
          return {
            headers: data.headers || [],
            rows: data.rows || []
          };
        } catch (jsonError) {
          console.log('Not JSON, trying tab-separated:', jsonError);
          // Fall back to tab-separated
          const lines = result.trim().split('\n');
          const headers = lines[0].split('\t').map(h => h.trim());
          const rows = lines.slice(1).map(line => line.split('\t').map(cell => cell.trim()));
          console.log('Parsed headers:', headers);
          console.log('Parsed rows:', rows);
          return { headers, rows };
        }
      };

      const ModalContent = () => {
        if (!state.modalType) return null;

        let input1Ref = React.useRef(null);
        let input2Ref = React.useRef(null);

        const handleSubmit = async () => {
          let success = false;
          switch (state.modalType) {
            case 'addPerson':
              success = await addPerson(input1Ref.current.value, input2Ref.current.value);
              break;
            case 'addCourse':
              success = await addCourse(input1Ref.current.value, input2Ref.current.value);
              break;
            case 'setSalary':
              success = await setSalary(input1Ref.current.value);
              break;
            case 'setLivingExpense':
              success = await setLivingExpense(input1Ref.current.value);
              break;
            case 'setStartMonth':
              success = await setStartMonth(input1Ref.current.value);
              break;
            default:
              closeModal();
              return;
          }
          if (success) {
            closeModal();
          }
        };

        let title = '';
        let label1 = '';
        let label2 = '';
        let placeholder1 = '';
        let placeholder2 = '';
        let showInput2 = true;
        let input1Type = 'text';
        let input2Type = 'number';

        switch (state.modalType) {
          case 'addPerson':
            title = '🎀 新增還款人 🎀';
            label1 = '姓名';
            label2 = '欠款金額 (元)';
            placeholder1 = '例如：小明';
            placeholder2 = '例如：10000';
            input1Type = 'text';
            input2Type = 'number';
            break;
          case 'addCourse':
            title = '🎀 新增課程費用 🎀';
            label1 = '課程總費用 (元)';
            label2 = '期數（月）';
            placeholder1 = '例如：30000';
            placeholder2 = '例如：6';
            input1Type = 'number';
            input2Type = 'number';
            break;
          case 'setSalary':
            title = '💰 設定薪水 💰';
            label1 = '薪水 (元)';
            placeholder1 = '例如：34000';
            showInput2 = false;
            input1Type = 'number';
            break;
          case 'setLivingExpense':
            title = '🍀 設定生活費 🍀';
            label1 = '生活費 (元)';
            placeholder1 = '例如：5000';
            showInput2 = false;
            input1Type = 'number';
            break;
          case 'setStartMonth':
            title = '📅 設定起始月份 📅';
            label1 = '起始月份 (1~12)';
            placeholder1 = '例如：1';
            showInput2 = false;
            input1Type = 'number';
            break;
          default:
            return null;
        }

        return (
          <div className="modal" onClick={closeModal}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
              <h2 className="text-xl font-bold mb-4">{title}</h2>
              <div className="mb-3">
                <label className="block mb-1">{label1}:</label>
                <input
                  type={input1Type}
                  ref={input1Ref}
                  placeholder={placeholder1}
                  className="w-full border rounded px-2 py-1"
                  autoFocus
                  defaultValue={
                    state.modalType === 'setSalary' ? state.salary :
                    state.modalType === 'setLivingExpense' ? state.livingExpense :
                    state.modalType === 'setStartMonth' ? state.startMonth : ''
                  }
                />
              </div>
              {showInput2 && (
                <div className="mb-3">
                  <label className="block mb-1">{label2}:</label>
                  <input
                    type={input2Type}
                    ref={input2Ref}
                    placeholder={placeholder2}
                    className="w-full border rounded px-2 py-1"
                  />
                </div>
              )}
              <div className="flex justify-end space-x-2">
                <button
                  className="bg-gray-300 hover:bg-gray-400 px-3 py-1 rounded"
                  onClick={closeModal}
                >
                  取消
                </button>
                <button
                  className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                  onClick={handleSubmit}
                >
                  確定
                </button>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="flex flex-col h-full p-4 max-w-3xl mx-auto">
          <h1 className="text-3xl font-bold mb-4 text-center">💰 超級還款試算表</h1>

          <div className="flex flex-wrap gap-3 mb-6 justify-center">
            <button
              className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 whitespace-nowrap"
              onClick={() => openModal('setSalary')}
              title="設定薪水"
            >
              薪水：{state.salary.toFixed(0)}
            </button>
            <button
              className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 whitespace-nowrap"
              onClick={() => openModal('setLivingExpense')}
              title="設定生活費"
            >
              生活費：{state.livingExpense.toFixed(0)}
            </button>
            <button
              className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 whitespace-nowrap"
              onClick={() => openModal('setStartMonth')}
              title="設定起始月份"
            >
              起始月：{state.startMonth}
            </button>
            <button
              className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700 whitespace-nowrap"
              onClick={() => openModal('addPerson')}
              title="新增還款人"
            >
              新增還款人
            </button>
            <button
              className="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700 whitespace-nowrap"
              onClick={() => openModal('addCourse')}
              title="新增課程費用"
            >
              新增課程費用
            </button>
            <button
              className="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 whitespace-nowrap"
              onClick={calculate}
              title="開始計算"
            >
              計算試算
            </button>
            <button
              className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600 whitespace-nowrap"
              onClick={copyResult}
              title="複製試算結果"
            >
              複製結果
            </button>
            <button
              className="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 whitespace-nowrap"
              onClick={exportCsv}
              title="匯出試算結果CSV"
            >
              匯出CSV
            </button>
            <button
              className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 whitespace-nowrap"
              onClick={clearAll}
              title="清空所有資料"
            >
              清空資料
            </button>
            <button
              className="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-800 whitespace-nowrap"
              onClick={exitApp}
              title="離開網頁"
            >
              離開
            </button>
          </div>

          <div className="mb-6 bg-white rounded shadow p-4 overflow-auto max-h-48">
            <h2 className="text-xl font-semibold mb-3">還款人列表</h2>
            {state.repayList.length === 0 ? (
              <p className="text-gray-500">尚無還款人，請新增。</p>
            ) : (
              <table className="w-full text-sm text-left">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="p-2">姓名</th>
                    <th className="p-2">欠款金額 (元)</th>
                    <th className="p-2">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {state.repayList.map((p, i) => (
                    <tr key={i} className="border-b">
                      <td className="p-2">{p.name}</td>
                      <td className="p-2">{p.debt.toFixed(2)}</td>
                      <td className="p-2">
                        <button
                          className="text-red-600 hover:text-red-800"
                          onClick={() => removePerson(i)}
                        >
                          刪除
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>

          <div className="mb-6 bg-white rounded shadow p-4 overflow-auto max-h-48">
            <h2 className="text-xl font-semibold mb-3">課程費用列表</h2>
            {state.courseList.length === 0 ? (
              <p className="text-gray-500">尚無課程費用，請新增。</p>
            ) : (
              <table className="w-full text-sm text-left">
                <thead className="bg-gray-100">
                  <tr>
                    <th className="p-2">總費用 (元)</th>
                    <th className="p-2">期數 (月)</th>
                    <th className="p-2">操作</th>
                  </tr>
                </thead>
                <tbody>
                  {state.courseList.map((c, i) => (
                    <tr key={i} className="border-b">
                      <td className="p-2">{c.fee.toFixed(2)}</td>
                      <td className="p-2">{c.months}</td>
                      <td className="p-2">
                        <button
                          className="text-red-600 hover:text-red-800"
                          onClick={() => removeCourse(i)}
                        >
                          刪除
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            )}
          </div>

          <div className="flex-grow bg-white rounded shadow p-4 overflow-x-auto">
            <h2 className="text-xl font-semibold mb-3">試算結果</h2>
            {state.calculationResult ? (
              <div>
                {(() => {
                  const { headers, rows } = parseResultToTable(state.calculationResult);
                  if (headers.length === 0 && rows.length === 0) {
                    return <p className="text-gray-500">無有效試算結果，請檢查輸入數據或重新計算。</p>;
                  }
                  return (
                    <table className="w-full text-sm text-left border-collapse" aria-label="試算結果表格">
                      <thead className="bg-gray-100 sticky top-0">
                        <tr>
                          {headers.map((header, index) => (
                            <th key={index} className="p-3 font-semibold border-b border-gray-200 whitespace-nowrap min-w-[100px]">
                              {header}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {rows.map((row, rowIndex) => (
                          <tr
                            key={rowIndex}
                            className={rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}
                          >
                            {row.map((cell, cellIndex) => (
                              <td
                                key={cellIndex}
                                className="p-3 border-b border-gray-200 whitespace-nowrap min-w-[100px]"
                              >
                                {cell}
                              </td>
                            ))}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  );
                })()}
              </div>
            ) : (
              <p className="text-gray-500">無試算結果，請先執行計算。</p>
            )}
          </div>

          <ModalContent />
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>

  <div id="cookie-banner" style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #f8f8f8;
    padding: 16px;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
    font-family: sans-serif;
    font-size: 14px;
    color: #333;
    z-index: 9999;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 10px;
  ">
    <span style="flex: 1; min-width: 200px; text-align: center;">
      我們使用 Cookie 改善網站功能與分析流量。請選擇是否接受。
    </span>
    <div>
      <button onclick="acceptCookies()" style="background: #007bff; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer;">
        接受全部
      </button>
      <button onclick="declineCookies()" style="background: #ccc; color: #000; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; margin-left: 8px;">
        僅使用必要
      </button>
    </div>
  </div>

  <script>
    function acceptCookies() {
      localStorage.setItem('cookieConsent', 'accepted');
      if (typeof gtag === 'function') {
        gtag('consent', 'update', {
          ad_storage: 'granted',
          analytics_storage: 'granted'
        });
      }
      document.getElementById('cookie-banner').style.display = 'none';
    }

    function declineCookies() {
      localStorage.setItem('cookieConsent', 'declined');
      if (typeof gtag === 'function') {
        gtag('consent', 'update', {
          ad_storage: 'denied',
          analytics_storage: 'denied'
        });
      }
      document.getElementById('cookie-banner').style.display = 'none';
    }

    if (localStorage.getItem('cookieConsent')) {
      document.getElementById('cookie-banner').style.display = 'none';
    }
  </script>

  <footer class="text-center text-sm text-gray-500 mt-10 py-4 border-t border-gray-300">
    <p>
      <a href="/about" class="underline hover:text-blue-600">關於我們</a> |
      <a href="/privacy" class="underline hover:text-blue-600">隱私權政策</a> |
      <a href="/terms" class="underline hover:text-blue-600">服務條款</a> |
      <a href="/contact" class="underline hover:text-blue-600">聯絡我們</a>
    </p>
  </footer>
</body>
</html>
