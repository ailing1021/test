<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ - å°ˆæ¥­ç‰ˆ</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background-color: #f4f7fa;
    }
    #root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      background: white;
      margin: 16px auto;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 1200px;
      width: 95%;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 16px;
      text-align: center;
      font-weight: bold;
      color: #111827;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }
    input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
      outline-offset: 2px;
      outline-color: #3b82f6;
    }
    button {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    button:hover {
      background-color: #2563eb;
    }
    .flex-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .flex-row > div {
      flex: 1;
      min-width: 220px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      text-align: center;
    }
    th {
      background-color: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .table-wrapper {
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    .chart-container {
      position: relative;
      width: 100%;
      max-width: 700px;
      margin: 0 auto 32px;
      height: 350px;
    }
    footer {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      padding: 16px 0;
      text-align: center;
      margin-top: auto;
      font-size: 14px;
      color: #6b7280;
      user-select: none;
    }
    footer a {
      color: #3b82f6;
      text-decoration: none;
      margin: 0 12px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .error-msg {
      color: #ef4444;
      font-weight: 600;
      margin-bottom: 12px;
    }
    @media (max-width: 640px) {
      .flex-row {
        flex-direction: column;
      }
      .chart-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <footer>
    <a href="/privacy" target="_blank" rel="noopener noreferrer">éš±ç§æ¬Šæ”¿ç­–</a>|
    <a href="/terms" target="_blank" rel="noopener noreferrer">ä½¿ç”¨æ¢æ¬¾</a>|
    <a href="/cookie" target="_blank" rel="noopener noreferrer">Cookie è¨­å®š</a>|
    <a href="/contact" target="_blank" rel="noopener noreferrer">è¯çµ¡æˆ‘å€‘</a>
  </footer>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    function App() {

      // åŸºæœ¬ç‹€æ…‹
      const [salary, setSalary] = useState('');
      const [livingExpense, setLivingExpense] = useState('');
      const [startMonth, setStartMonth] = useState(1);
      const [repayList, setRepayList] = useState([]);
      const [courseList, setCourseList] = useState([]);
      const [errorMsg, setErrorMsg] = useState('');
      const [calcResult, setCalcResult] = useState(null);
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);

      // è¡¨å–®è¼¸å…¥æ§åˆ¶
      const [newPersonName, setNewPersonName] = useState('');
      const [newPersonDebt, setNewPersonDebt] = useState('');
      const [newCourseFee, setNewCourseFee] = useState('');
      const [newCourseMonths, setNewCourseMonths] = useState('');

      // APIæ¨¡æ“¬ or å¾…é€£æ¥
      // é€™è£¡ç”¨å‰ç«¯æ¨¡æ“¬è¨ˆç®—ï¼Œå¯¦éš›å¯æ›æˆfetchå‘¼å«å¾Œç«¯API

      // æ–°å¢é‚„æ¬¾äºº
      function addRepayPerson() {
        if (!newPersonName.trim()) {
          setErrorMsg('é‚„æ¬¾äººå§“åä¸èƒ½ç‚ºç©º');
          return;
        }
        if (!newPersonDebt || isNaN(newPersonDebt) || Number(newPersonDebt) <= 0) {
          setErrorMsg('æ¬ æ¬¾é‡‘é¡å¿…é ˆæ˜¯å¤§æ–¼0çš„æ•¸å­—');
          return;
        }
        setRepayList([...repayList, { name: newPersonName.trim(), debt: Number(newPersonDebt) }]);
        setNewPersonName('');
        setNewPersonDebt('');
        setErrorMsg('');
      }

      // æ–°å¢èª²ç¨‹
      function addCourse() {
        if (!newCourseFee || isNaN(newCourseFee) || Number(newCourseFee) <= 0) {
          setErrorMsg('èª²ç¨‹è²»ç”¨å¿…é ˆæ˜¯å¤§æ–¼0çš„æ•¸å­—');
          return;
        }
        if (!newCourseMonths || isNaN(newCourseMonths) || !Number.isInteger(Number(newCourseMonths)) || Number(newCourseMonths) <= 0) {
          setErrorMsg('èª²ç¨‹æœŸæ•¸å¿…é ˆæ˜¯å¤§æ–¼0çš„æ•´æ•¸');
          return;
        }
        setCourseList([...courseList, { fee: Number(newCourseFee), months: Number(newCourseMonths) }]);
        setNewCourseFee('');
        setNewCourseMonths('');
        setErrorMsg('');
      }

      // ç§»é™¤é‚„æ¬¾äºº
      function removeRepayPerson(index) {
        if (!window.confirm(`ç¢ºå®šç§»é™¤é‚„æ¬¾äººã€Œ${repayList[index].name}ã€å—ï¼Ÿ`)) return;
        const copy = [...repayList];
        copy.splice(index, 1);
        setRepayList(copy);
      }

      // ç§»é™¤èª²ç¨‹
      function removeCourse(index) {
        if (!window.confirm(`ç¢ºå®šç§»é™¤èª²ç¨‹ #${index+1} å—ï¼Ÿ`)) return;
        const copy = [...courseList];
        copy.splice(index, 1);
        setCourseList(copy);
      }

      // è¨ˆç®—ä¸»å‡½æ•¸ - é‚„æ¬¾è¨ˆç•«
      function calculateRepaymentPlan() {
        setErrorMsg('');
        setCalcResult(null);

        const sal = Number(salary);
        const expense = Number(livingExpense);
        if (isNaN(sal) || sal <= 0) {
          setErrorMsg('è«‹è¼¸å…¥æ­£ç¢ºä¸”å¤§æ–¼0çš„è–ªæ°´');
          return;
        }
        if (isNaN(expense) || expense < 0) {
          setErrorMsg('è«‹è¼¸å…¥æ­£ç¢ºçš„ç”Ÿæ´»è²»(å¯ç‚º0)');
          return;
        }
        if (!Number.isInteger(startMonth) || startMonth < 1 || startMonth > 12) {
          setErrorMsg('èµ·å§‹æœˆä»½å¿…é ˆæ˜¯1~12çš„æ•´æ•¸');
          return;
        }
        if (repayList.length === 0) {
          setErrorMsg('è«‹è‡³å°‘æ–°å¢ä¸€ä½é‚„æ¬¾äºº');
          return;
        }
        if (courseList.length === 0) {
          setErrorMsg('è«‹è‡³å°‘æ–°å¢ä¸€é–€èª²ç¨‹');
          return;
        }

        // è¨ˆç®—æ¯æœˆå¯é‚„æ¬¾é¡åº¦ = è–ªæ°´ - ç”Ÿæ´»è²» - èª²ç¨‹æœˆè²»
        const totalMonthlyCourseFee = courseList.reduce((sum, c) => sum + (c.fee / c.months), 0);

        if (totalMonthlyCourseFee > sal - expense) {
          setErrorMsg('èª²ç¨‹æœˆè²»å·²è¶…éå¯ç”¨é‚„æ¬¾é‡‘é¡ï¼Œç„¡æ³•è¨ˆç®—');
          return;
        }

        const monthlyRepayBudget = sal - expense - totalMonthlyCourseFee;

        // è¨ˆç®—é‚„æ¬¾äººæ¯”ä¾‹(ä»¥æ¬ æ¬¾é‡‘é¡å ç¸½æ¬ æ¬¾æ¯”ä¾‹)
        const totalDebt = repayList.reduce((sum, p) => sum + p.debt, 0);

        if (totalDebt <= 0) {
          setErrorMsg('æ¬ æ¬¾ç¸½é¡å¿…é ˆå¤§æ–¼0');
          return;
        }

        // è¨ˆç®—æ¯å€‹æœˆé‚„çµ¦æ¯å€‹äººçš„éŒ¢ï¼Œç›´åˆ°æ‰€æœ‰äººéƒ½é‚„å®Œ
        // å›å‚³ä¸€å€‹é™£åˆ—ï¼Œæ¯å€‹æœˆç‰©ä»¶åŒ…å«æœˆä»½èˆ‡æ¯äººé‚„æ¬¾é‡‘é¡
        let remainingDebts = repayList.map(p => ({ ...p }));
        let monthIndex = 0;
        let plan = [];
        // æœ€å¤šè¨ˆç®—100æœŸé˜²æ­¢ç„¡é™è¿´åœˆ
        while (remainingDebts.some(p => p.debt > 0) && monthIndex < 100) {
          monthIndex++;
          const monthPay = {};
          const monthName = ((startMonth + monthIndex - 2) % 12) + 1; // 1~12å¾ªç’°
          let budget = monthlyRepayBudget;

          // ä¾ç…§æ¬ æ¬¾æ¯”ä¾‹åˆ†é…é‚„æ¬¾
          let debtSumThisMonth = remainingDebts.reduce((sum, p) => sum + p.debt, 0);
          remainingDebts.forEach(p => {
            if (p.debt <= 0) {
              monthPay[p.name] = 0;
              return;
            }
            // æ¬ æ¬¾æ¯”ç‡
            let ratio = p.debt / debtSumThisMonth;
            let pay = Math.min(Math.round(monthlyRepayBudget * ratio * 100) / 100, p.debt, budget);
            budget -= pay;
            p.debt -= pay;
            p.debt = Math.round(p.debt * 100) / 100;
            monthPay[p.name] = pay;
          });

          // è‹¥æœ‰å‰©é¤˜é ç®—ï¼Œå¹³å‡åˆ†é…çµ¦é‚„æœ‰æ¬ æ¬¾çš„äºº(é˜²æ­¢å› å››æ¨äº”å…¥å°è‡´å‰©é¤˜)
          if (budget > 0) {
            const needPayers = remainingDebts.filter(p => p.debt > 0);
            if (needPayers.length > 0) {
              const extraPerPerson = Math.round((budget / needPayers.length) * 100) / 100;
              needPayers.forEach(p => {
                let extra = Math.min(extraPerPerson, p.debt);
                p.debt -= extra;
                p.debt = Math.round(p.debt * 100) / 100;
                monthPay[p.name] += extra;
              });
            }
          }

          plan.push({ month: monthName, pays: { ...monthPay } });
        }

        // æ•´ç†æˆè¡¨æ ¼å½¢å¼èˆ‡ç¸½é‚„æ¬¾æœŸæ•¸
        setCalcResult({
          plan,
          monthlyRepayBudget,
          totalDebt,
          totalMonths: monthIndex,
          totalCourseFee: totalMonthlyCourseFee,
        });
      }

      // è¤‡è£½çµæœ
      function copyResult() {
        if (!calcResult) return alert('è«‹å…ˆåŸ·è¡Œè¨ˆç®—');
        let text = `æ¯æœˆé‚„æ¬¾ç¸½é¡ï¼š${calcResult.monthlyRepayBudget.toFixed(2)} å…ƒ\né‚„æ¬¾ç¸½æœŸæ•¸ï¼šç´„ ${calcResult.totalMonths} å€‹æœˆ\n\nè©³ç´°æ¯æœˆé‚„æ¬¾è¨ˆç•«ï¼š\n`;
        calcResult.plan.forEach((m, idx) => {
          text += `ç¬¬${idx+1}å€‹æœˆ(æœˆä»½:${m.month}æœˆ)ï¼š\n`;
          Object.entries(m.pays).forEach(([name, pay]) => {
            text += `  ${name}ï¼š${pay.toFixed(2)} å…ƒ\n`;
          });
        });
        navigator.clipboard.writeText(text).then(() => alert('å·²è¤‡è£½è©¦ç®—çµæœåˆ°å‰ªè²¼ç°¿'));
      }

      // åŒ¯å‡º CSV
      function exportCsv() {
        if (!calcResult) return alert('è«‹å…ˆåŸ·è¡Œè¨ˆç®—');
        let csv = 'æœˆä»½,é‚„æ¬¾äºº,é‚„æ¬¾é‡‘é¡\n';
        calcResult.plan.forEach(m => {
          Object.entries(m.pays).forEach(([name, pay]) => {
            csv += `${m.month},${name},${pay.toFixed(2)}\n`;
          });
        });
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'repayment_plan.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      // Chart.js é¡¯ç¤ºç¸½æ¬ æ¬¾åˆ†ä½ˆ
      useEffect(() => {
        if (chartInstanceRef.current) {
          chartInstanceRef.current.destroy();
        }
        if (repayList.length === 0) return;

        const ctx = chartRef.current.getContext('2d');
        chartInstanceRef.current = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: repayList.map(p => p.name),
            datasets: [{
              data: repayList.map(p => p.debt),
              backgroundColor: [
                '#3b82f6','#10b981','#ef4444','#f59e0b','#8b5cf6',
                '#06b6d4','#db2777','#6d28d9','#ca8a04','#4ade80'
              ],
            }],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'right' },
              title: { display: true, text: 'ç¸½æ¬ æ¬¾åˆ†ä½ˆ' }
            }
          }
        });
      }, [repayList]);

      return (
        <div className="container" role="main" aria-label="è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨">
          <h1>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ - å°ˆæ¥­ç‰ˆ</h1>
          <div className="flex-row" style={{marginBottom:'24px'}}>
            <div>
              <label htmlFor="salary">æ¯æœˆè–ªæ°´ (å…ƒ)</label>
              <input type="number" id="salary" min="0" step="100" value={salary} onChange={e => setSalary(e.target.value)} placeholder="è¼¸å…¥æ¯æœˆè–ªæ°´" aria-required="true"/>
            </div>
            <div>
              <label htmlFor="livingExpense">æ¯æœˆç”Ÿæ´»è²» (å…ƒ)</label>
              <input type="number" id="livingExpense" min="0" step="100" value={livingExpense} onChange={e => setLivingExpense(e.target.value)} placeholder="è¼¸å…¥æ¯æœˆç”Ÿæ´»è²»" aria-required="true"/>
            </div>
            <div>
              <label htmlFor="startMonth">èµ·å§‹æœˆä»½ (1-12)</label>
              <input type="number" id="startMonth" min="1" max="12" value={startMonth} onChange={e => setStartMonth(Number(e.target.value))} aria-required="true"/>
            </div>
          </div>

          <div className="container" style={{padding:'12px', marginBottom:'24px'}}>
            <h2>æ–°å¢é‚„æ¬¾äºº</h2>
            <div className="flex-row">
              <div>
                <label htmlFor="newPersonName">å§“å</label>
                <input type="text" id="newPersonName" value={newPersonName} onChange={e => setNewPersonName(e.target.value)} placeholder="è¼¸å…¥é‚„æ¬¾äººå§“å" aria-required="true"/>
              </div>
              <div>
                <label htmlFor="newPersonDebt">æ¬ æ¬¾é‡‘é¡ (å…ƒ)</label>
                <input type="number" id="newPersonDebt" min="0" step="100" value={newPersonDebt} onChange={e => setNewPersonDebt(e.target.value)} placeholder="è¼¸å…¥æ¬ æ¬¾é‡‘é¡" aria-required="true"/>
              </div>
              <div style={{alignSelf:'flex-end'}}>
                <button onClick={addRepayPerson} aria-label="æ–°å¢é‚„æ¬¾äºº">æ–°å¢é‚„æ¬¾äºº</button>
              </div>
            </div>
          </div>

          <div className="container" style={{padding:'12px', marginBottom:'24px'}}>
            <h2>é‚„æ¬¾äººåˆ—è¡¨</h2>
            {repayList.length === 0 ? (
              <p>å°šç„¡é‚„æ¬¾äººè³‡æ–™</p>
            ) : (
              <div className="table-wrapper" role="table" aria-label="é‚„æ¬¾äººåˆ—è¡¨">
                <table>
                  <thead>
                    <tr>
                      <th>å§“å</th>
                      <th>æ¬ æ¬¾é‡‘é¡ (å…ƒ)</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {repayList.map((p, i) => (
                      <tr key={i}>
                        <td>{p.name}</td>
                        <td>{p.debt.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>
                          <button onClick={() => removeRepayPerson(i)} aria-label={`ç§»é™¤é‚„æ¬¾äºº ${p.name}`}>åˆªé™¤</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          <div className="container" style={{padding:'12px', marginBottom:'24px'}}>
            <h2>æ–°å¢èª²ç¨‹</h2>
            <div className="flex-row">
              <div>
                <label htmlFor="newCourseFee">èª²ç¨‹ç¸½è²»ç”¨ (å…ƒ)</label>
                <input type="number" id="newCourseFee" min="0" step="100" value={newCourseFee} onChange={e => setNewCourseFee(e.target.value)} placeholder="è¼¸å…¥èª²ç¨‹è²»ç”¨" aria-required="true"/>
              </div>
              <div>
                <label htmlFor="newCourseMonths">èª²ç¨‹æœŸæ•¸ (æœˆ)</label>
                <input type="number" id="newCourseMonths" min="1" max="100" step="1" value={newCourseMonths} onChange={e => setNewCourseMonths(e.target.value)} placeholder="è¼¸å…¥èª²ç¨‹æœŸæ•¸" aria-required="true"/>
              </div>
              <div style={{alignSelf:'flex-end'}}>
                <button onClick={addCourse} aria-label="æ–°å¢èª²ç¨‹">æ–°å¢èª²ç¨‹</button>
              </div>
            </div>
          </div>

          <div className="container" style={{padding:'12px', marginBottom:'24px'}}>
            <h2>èª²ç¨‹åˆ—è¡¨</h2>
            {courseList.length === 0 ? (
              <p>å°šç„¡èª²ç¨‹è³‡æ–™</p>
            ) : (
              <div className="table-wrapper" role="table" aria-label="èª²ç¨‹åˆ—è¡¨">
                <table>
                  <thead>
                    <tr>
                      <th>èª²ç¨‹ç·¨è™Ÿ</th>
                      <th>èª²ç¨‹ç¸½è²»ç”¨ (å…ƒ)</th>
                      <th>èª²ç¨‹æœŸæ•¸ (æœˆ)</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {courseList.map((c, i) => (
                      <tr key={i}>
                        <td>{i+1}</td>
                        <td>{c.fee.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>{c.months}</td>
                        <td>
                          <button onClick={() => removeCourse(i)} aria-label={`ç§»é™¤èª²ç¨‹ç·¨è™Ÿ ${i+1}`}>åˆªé™¤</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {errorMsg && <p className="error-msg" role="alert">{errorMsg}</p>}

          <div style={{textAlign:'center', marginBottom:'32px'}}>
            <button onClick={calculateRepaymentPlan} aria-label="é–‹å§‹è¨ˆç®—é‚„æ¬¾è¨ˆç•«" style={{minWidth:'220px', fontWeight:'700', fontSize:'1.25rem'}}>
              è¨ˆç®—é‚„æ¬¾è¨ˆç•«
            </button>
          </div>

          {calcResult && (
            <>
              <div style={{marginBottom:'24px'}}>
                <h2>è©¦ç®—çµæœ</h2>
                <p>æ¯æœˆå¯ç”¨é‚„æ¬¾é¡åº¦ï¼š<strong>{calcResult.monthlyRepayBudget.toFixed(2)}</strong> å…ƒ</p>
                <p>ç¸½æ¬ æ¬¾é‡‘é¡ï¼š<strong>{calcResult.totalDebt.toFixed(2)}</strong> å…ƒ</p>
                <p>èª²ç¨‹æ¯æœˆè²»ç”¨åˆè¨ˆï¼š<strong>{calcResult.totalCourseFee.toFixed(2)}</strong> å…ƒ</p>
                <p>ä¼°è¨ˆé‚„æ¬¾æœŸæ•¸ï¼šç´„ <strong>{calcResult.totalMonths}</strong> å€‹æœˆ</p>

                <div className="chart-container" role="img" aria-label="æ¬ æ¬¾æ¯”ä¾‹åœ“é¤…åœ–">
                  <canvas ref={chartRef}></canvas>
                </div>

                <div className="table-wrapper" style={{maxHeight:'420px'}}>
                  <table aria-label="æ¯æœˆé‚„æ¬¾è¨ˆç•«æ˜ç´°">
                    <thead>
                      <tr>
                        <th>æœˆä»½</th>
                        {repayList.map(p => <th key={p.name}>{p.name}</th>)}
                      </tr>
                    </thead>
                    <tbody>
                      {calcResult.plan.map((m, idx) => (
                        <tr key={idx}>
                          <td>{m.month} æœˆ</td>
                          {repayList.map(p => (
                            <td key={p.name}>{(m.pays[p.name] || 0).toFixed(2)}</td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div style={{marginTop:'24px', textAlign:'center'}}>
                  <button onClick={copyResult} aria-label="è¤‡è£½é‚„æ¬¾çµæœ">è¤‡è£½çµæœ</button>
                  <button onClick={exportCsv} aria-label="åŒ¯å‡ºé‚„æ¬¾è¨ˆç•« CSV" style={{marginLeft:'16px'}}>åŒ¯å‡º CSV</button>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
