<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3023489511713645"
    crossorigin="anonymous"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💰 超級還款試算表 - 專業版</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* Ensure html and body take full height */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    /* Set min-height for the root React element to be full screen, and use flexbox */
    #root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background-color: #f4f7fa;
    }
    /* Main content grows to push footer down */
    .main-content {
      flex-grow: 1;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 24px;
      margin: 16px auto;
    }
    .btn {
      transition: all 0.2s ease-in-out;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
    }
    th, td {
      border: 1px solid #e5e7eb;
    }
    /* Sticky header for tables */
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: #f9fafb;
      z-index: 10;
    }
    /* Footer styles */
    footer {
      margin-top: auto;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 16px 0;
      text-align: center;
      padding-bottom: 80px; /* Space for cookie banner */
    }
    /* Cookie banner adjustments */
    #cookie-banner {
      z-index: 100; /* Below modal but above content */
    }
    /* Responsive adjustments */
    @media (max-width: 640px) {
      footer {
        padding-bottom: 100px; /* Extra space for cookie banner on mobile */
      }
      #cookie-banner {
        flex-direction: column;
        gap: 8px;
      }
    }
  </style>

  <meta name="google-site-verification" content="BCvXzgcedvqCehBvT5sfZjBzHe56ld3ft6gNTqERsyE" />
  <script async src="https://www.googletagmanager.com/js?id=G-WGEGPPKK5D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('consent', 'default', {
      ad_storage: 'denied',
      analytics_storage: 'denied'
    });
    gtag('config', 'G-WGEGPPKK5D');
  </script>
</head>
<body>
  <div id="root"></div>
  <div id="cookie-banner" style="
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #f8f8f8;
    padding: 16px;
    box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
    font-family: sans-serif;
    font-size: 14px;
    color: #333;
    z-index: 100;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    gap: 10px;
  ">
    <span style="flex: 1; min-width: 200px; text-align: center;">
      我們使用 Cookie 改善網站功能與分析流量。請選擇是否接受。
    </span>
    <div>
      <button onclick="acceptCookies()" style="background: #007bff; color: white; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer;">
        接受全部
      </button>
      <button onclick="declineCookies()" style="background: #ccc; color: #000; border: none; padding: 8px 14px; border-radius: 4px; cursor: pointer; margin-left: 8px;">
        僅使用必要
      </button>
    </div>
  </div>

  <script>
    function acceptCookies() {
      localStorage.setItem('cookieConsent', 'accepted');
      if (typeof gtag === 'function') {
        gtag('consent', 'update', {
          ad_storage: 'granted',
          analytics_storage: 'granted'
        });
      }
      document.getElementById('cookie-banner').style.display = 'none';
    }

    function declineCookies() {
      localStorage.setItem('cookieConsent', 'declined');
      if (typeof gtag === 'function') {
        gtag('consent', 'update', {
          ad_storage: 'denied',
          analytics_storage: 'denied'
        });
      }
      document.getElementById('cookie-banner').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('cookieConsent')) {
        document.getElementById('cookie-banner').style.display = 'none';
      } else {
        document.getElementById('cookie-banner').style.display = 'flex';
      }
    });
  </script>

  <script type="text/babel">
    // Error Boundary to catch rendering issues
    class ErrorBoundary extends React.Component {
      state = { hasError: false };
      static getDerivedStateFromError(error) {
        return { hasError: true };
      }
      render() {
        if (this.state.hasError) {
          return <h1 class="text-center text-red-600">發生錯誤，請重新整理頁面。</h1>;
        }
        return this.props.children;
      }
 Sex {
        const getInitialState = () => ({
          salary: 0,
          livingExpense: 0,
          startMonth: 1,
          repayList: [],
          courseList: [],
          calculationResult: '',
          modalType: null
        });

        const [state, setState] = React.useState(getInitialState);

        React.useEffect(() => {
          fetchCurrentState();
        }, []);

        const fetchCurrentState = async () => {
          try {
            const response = await fetch('/api/get_current_state');
            if (response.ok) {
              const data = await response.json();
              setState(prev => ({
                ...prev,
                salary: data.salary || 0,
                livingExpense: data.living_expense || 0,
                startMonth: data.start_month || 1,
                repayList: data.repay_list || [],
                courseList: data.course_list || []
              }));
            } else {
              const errorData = await response.json().catch(() => ({ message: response.statusText }));
              console.error('Failed to fetch current state:', response.status, errorData.message);
              alert(`無法獲取最新狀態，請檢查伺服器或網路連線。錯誤：${errorData.message}`);
            }
          } catch (error) {
            console.error('Error fetching current state:', error);
            alert('獲取最新狀態時發生網路錯誤或伺服器問題。');
          }
        };

        const openModal = (type) => {
          setState(prev => ({ ...prev, modalType: type }));
        };

        const closeModal = () => {
          setState(prev => ({ ...prev, modalType: null }));
        };

        const addPerson = async (name, debt) => {
          if (!name.trim()) {
            alert("姓名不能為空");
            return false;
          }
          if (isNaN(parseFloat(debt)) || parseFloat(debt) <= 0) {
            alert("欠款金額必須大於0");
            return false;
          }
          try {
            const response = await fetch('/api/add_person', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ name: name.trim(), debt: parseFloat(debt) })
            });
            const data = await response.json();
            if (response.ok && data.status === 'success') {
              await fetchCurrentState();
              return true;
            } else {
              alert("新增還款人失敗: " + (data.message || response.statusText));
              return false;
            }
          } catch (error) {
            console.error('Error adding person:', error);
            alert('新增還款人時發生網路錯誤或伺服器問題。');
            return false;
          }
        };

        const addCourse = async (fee, months) => {
          if (isNaN(parseFloat(fee)) || parseFloat(fee) <= 0) {
            alert("課程總費用必須大於0");
            return false;
          }
          if (!Number.isInteger(parseInt(months)) || parseInt(months) <= 0) {
            alert("課程期數必須是大於0的整數");
            return false;
          }
          try {
            const response = await fetch('/api/add_course', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ fee: parseFloat(fee), months: parseInt(months) })
            });
            const data = await response.json();
            if (response.ok && data.status === 'success') {
              await fetchCurrentState();
              return true;
            } else {
              alert("新增課程失敗: " + (data.message || response.statusText));
              return false;
            }
          } catch (error) {
            console.error('Error adding course:', error);
            alert('新增課程時發生網路錯誤或伺服器問題。');
            return false;
          }
        };

        const setSalary = async (salary) => {
          if (isNaN(parseFloat(salary)) || parseFloat(salary) < 0) {
            alert("薪水必須是非負數");
            return false;
          }
          try {
            const response = await fetch('/api/set_salary', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ salary: parseFloat(salary) })
            });
            const data = await response.json();
            if (response.ok && data.status === 'success') {
              await fetchCurrentState();
              return true;
            } else {
              alert("設定薪水失敗: " + (data.message || response.statusText));
              return false;
            }
          } catch (error) {
            console.error('Error setting salary:', error);
            alert('設定薪水時發生網路錯誤或伺服器問題。');
            return false;
          }
        };

        const setLivingExpense = async (expense) => {
          if (isNaN(parseFloat(expense)) || parseFloat(expense) < 0) {
            alert("生活費必須是非負數");
            return false;
          }
          try {
            const response = await fetch('/api/set_living_expense', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ expense: parseFloat(expense) })
            });
            const data = await response.json();
            if (response.ok && data.status === 'success') {
              await fetchCurrentState();
              return true;
            } else {
              alert("設定生活費失敗: " + (data.message || response.statusText));
              return false;
            }
          } catch (error) {
            console.error('Error setting living expense:', error);
            alert('設定生活費時發生網路錯誤或伺服器問題。');
            return false;
          }
        };

        const setStartMonth = async (month) => {
          const monthInt = parseInt(month);
          if (!Number.isInteger(monthInt) || monthInt < 1 || monthInt > 12) {
            alert("起始月份必須介於1到12");
            return false;
          }
          try {
            const response = await fetch('/api/set_start_month', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ start_month: monthInt })
            });
            const data = await response.json();
            if (response.ok && data.status === 'success') {
              await fetchCurrentState();
              return true;
            } else {
              alert("設定起始月份失敗: " + (data.message || response.statusText));
              return false;
            }
          } catch (error) {
            console.error('Error setting start month:', error);
            alert('設定起始月份時發生網路錯誤或伺服器問題。');
            return false;
          }
        };

        const removePerson = (index) => {
          if (!confirm(`確定要從前端列表中移除還款人「${state.repayList[index].name}」嗎？\n(注意：此操作不會同步清除後端數據，如需徹底清除請使用「清空資料」)`)) return;
          const newList = [...state.repayList];
          newList.splice(index, 1);
          setState(prev => ({ ...prev, repayList: newList }));
        };

        const removeCourse = (index) => {
          if (!confirm(`確定要從前端列表中移除課程 #${index + 1} 嗎？\n(注意：此操作不會同步清除後端數據，如需徹底清除請使用「清空資料」)`)) return;
          const newList = [...state.courseList];
          newList.splice(index, 1);
          setState(prev => ({ ...prev, courseList: newList }));
        };

        const calculate = async () => {
          try {
            const response = await fetch('/api/calculate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });
            const data = await response.json();
            console.log('API response:', data);
            if (response.ok && data.status === 'success') {
              console.log('calculationResult:', data.result);
              setState(prev => ({ ...prev, calculationResult: data.result }));
            } else {
              alert("計算失敗: " + (data.message || response.statusText));
              setState(prev => ({ ...prev, calculationResult: `錯誤: ${data.message || response.statusText}` }));
            }
          } catch (error) {
            console.error('Error during calculation:', error);
            alert('計算時發生網路錯誤或伺服器問題。');
            setState(prev => ({ ...prev, calculationResult: `發生錯誤，請檢查網路連線或伺服器。` }));
          }
        };

        const copyResult = async () => {
          try {
            if (state.calculationResult) {
              await navigator.clipboard.writeText(state.calculationResult);
              alert('試算結果已複製到剪貼簿！');
            } else {
              alert('沒有試算結果可供複製。');
            }
          } catch (err) {
            console.error('複製失敗:', err);
            alert('無法複製到剪貼簿，請手動選取文字複製。');
          }
        };

        const exportCsv = async () => {
          try {
            const response = await fetch('/api/export_csv', {
              method: 'GET'
            });
            if (response.ok) {
              const contentDisposition = response.headers.get('Content-Disposition');
              let filename = 'repay_result.csv';
              if (contentDisposition && contentDisposition.includes('filename=')) {
                filename = contentDisposition.split('filename=')[1].trim().replace(/"/g, '');
              }
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              a.remove();
              window.URL.revokeObjectURL(url);
              alert("CSV 檔案已成功下載。");
            } else {
              const errorData = await response.json().catch(() => ({ message: response.statusText }));
              alert("匯出CSV失敗: " + (errorData.message || response.statusText));
            }
          } catch (error) {
            console.error('Error exporting CSV:', error);
            alert('匯出CSV時發生網路錯誤或伺服器問題。');
          }
        };

        const clearAll = async () => {
          if (!confirm('確定要清空所有設定和結果嗎？這將重置所有後端數據。')) return;
          try {
            const response = await fetch('/api/reset', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({})
            });
            const data = await response.json();
            if (response.ok && data.status === 'success') {
              await fetchCurrentState();
              setState(prev => ({ ...prev, calculationResult: '' }));
              alert(data.message);
            } else {
              alert("清空資料失敗: " + (data.message || response.statusText));
            }
          } catch (error) {
            console.error('Error clearing data:', error);
            alert('清空資料時發生網路錯誤或伺服器問題。');
          }
        };

        const exitApp = () => {
          if (confirm('確定離開？')) {
            window.location.href = 'about:blank';
          }
        };

        const parseResultToTable = (result) => {
          if (!result || result.trim() === '') {
            console.log('calculationResult is empty or invalid');
            return { headers: [], rows: [] };
          }
          try {
            const data = JSON.parse(result);
            console.log('Parsed as JSON:', data);
            return {
              headers: data.headers || [],
              rows: data.rows || []
            };
          } catch (jsonError) {
            console.log('Not JSON, trying tab-separated:', jsonError);
            const lines = result.trim().split('\n');
            const headers = lines[0].split('\t').map(h => h.trim());
            const rows = lines.slice(1).map(line => line.split('\t').map(cell => cell.trim()));
            console.log('Parsed headers:', headers);
            console.log('Parsed rows:', rows);
            return { headers, rows };
          }
        };

        const prepareOverallDebtChartData = (repayList) => {
          const labels = repayList.map(person => person.name);
          const values = repayList.map(person => person.debt);
          return { labels, values };
        };

        React.useEffect(() => {
          const canvas = document.getElementById('overall-debt-chart');
          if (!canvas) return;

          const existingChart = Chart.getChart(canvas);
          if (existingChart) {
            existingChart.destroy();
          }

          const { labels, values } = prepareOverallDebtChartData(state.repayList);

          if (values.length > 0 && values.some(val => val > 0)) {
            new Chart(canvas, {
              type: 'pie',
              data: {
                labels: labels,
                datasets: [{
                  data: values,
                  backgroundColor: [
                    '#3b82f6',
                    '#10b981',
                    '#ef4444',
                    '#f59e0b',
                    '#8b5cf6',
                    '#06b6d4',
                    '#db2777',
                    '#6d28d9',
                    '#ca8a04',
                    '#4ade80'
                  ],
                  hoverOffset: 8
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    position: 'right',
                    labels: {
                      font: { size: 14 },
                      boxWidth: 20
                    }
                  },
                  title: {
                    display: true,
                    text: '總欠款分佈',
                    font: { size: 20, weight: 'bold' },
                    padding: { bottom: 20 }
                  },
                  tooltip: {
                    callbacks: {
                      label: function(context) {
                        let label = context.label || '';
                        if (label) {
                          label += ': ';
                        }
                        if (context.parsed !== null) {
                          label += new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD' }).format(context.parsed);
                        }
                        return label;
                      }
                    }
                  }
                }
              }
            });
          }
        }, [state.repayList]);

        const ModalContent = () => {
          if (!state.modalType) return null;
          let input1Ref = React.useRef(null);
          let input2Ref = React.useRef(null);

          const handleSubmit = async () => {
            let success = false;
            switch (state.modalType) {
              case 'addPerson':
                success = await addPerson(input1Ref.current.value, input2Ref.current.value);
                break;
              case 'addCourse':
                success = await addCourse(input1Ref.current.value, input2Ref.current.value);
                break;
              case 'setSalary':
                success = await setSalary(input1Ref.current.value);
                break;
              case 'setLivingExpense':
                success = await setLivingExpense(input1Ref.current.value);
                break;
              case 'setStartMonth':
                success = await setStartMonth(input1Ref.current.value);
                break;
              default:
                closeModal();
                return;
            }
            if (success) closeModal();
          };

          let title = '', label1 = '', label2 = '', placeholder1 = '', placeholder2 = '', showInput2 = true, input1Type = 'text', input2Type = 'number';
          switch (state.modalType) {
            case 'addPerson':
              title = '🎀 新增還款人';
              label1 = '姓名';
              label2 = '欠款金額 (元)';
              placeholder1 = '例如：小明';
              placeholder2 = '例如：10000';
              break;
            case 'addCourse':
              title = '🎀 新增課程費用';
              label1 = '課程總費用 (元)';
              label2 = '期數（月）';
              placeholder1 = '例如：30000';
              placeholder2 = '例如：6';
              break;
            case 'setSalary':
              title = '💰 設定薪水';
              label1 = '薪水 (元)';
              placeholder1 = '例如：34000';
              showInput2 = false;
              input1Type = 'number';
              break;
            case 'setLivingExpense':
              title = '🍀 設定生活費';
              label1 = '生活費 (元)';
              placeholder1 = '例如：5000';
              showInput2 = false;
              input1Type = 'number';
              break;
            case 'setStartMonth':
              title = '📅 設定起始月份';
              label1 = '起始月份 (1~12)';
              placeholder1 = '例如：1';
              showInput2 = false;
              input1Type = 'number';
              break;
            default:
              return null;
          }

          return (
            <div class="modal" onClick={closeModal}>
              <div class="modal-content" onClick={e => e.stopPropagation()}>
                <h2 class="text-2xl font-semibold mb-6 text-gray-800">{title}</h2>
                <div class="mb-4">
                  <label class="block mb-2 text-sm font-medium text-gray-700">{label1}:</label>
                  <input
                    type={input1Type}
                    ref={input1Ref}
                    placeholder={placeholder1}
                    class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    autoFocus
                    defaultValue={
                      state.modalType === 'setSalary' ? state.salary :
                      state.modalType === 'setLivingExpense' ? state.livingExpense :
                      state.modalType === 'setStartMonth' ? state.startMonth : ''
                    }
                  />
                </div>
                {showInput2 && (
                  <div class="mb-4">
                    <label class="block mb-2 text-sm font-medium text-gray-700">{label2}:</label>
                    <input
                      type={input2Type}
                      ref={input2Ref}
                      placeholder={placeholder2}
                      class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                  </div>
                )}
                <div class="flex justify-end space-x-3">
                  <button
                    class="btn bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg"
                    onClick={closeModal}
                  >
                    取消
                  </button>
                  <button
                    class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                    onClick={handleSubmit}
                  >
                    確定
                  </button>
                </div>
              </div>
            </div>
          );
        };

        return (
          <div class="main-content">
            <div class="container max-w-4xl mx-auto">
              <h1 class="text-3xl font-bold mb-8 text-center text-gray-800">💰 超級還款試算表</h1>

              <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4 mb-8">
                <button class="btn bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700" onClick={() => openModal('setSalary')} title="設定薪水">
                  薪水：{state.salary.toFixed(0)}
                </button>
                <button class="btn bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700" onClick={() => openModal('setLivingExpense')} title="設定生活費">
                  生活費：{state.livingExpense.toFixed(0)}
                </button>
                <button class="btn bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700" onClick={() => openModal('setStartMonth')} title="設定起始月份">
                  起始月：{state.startMonth}
                </button>
                <button class="btn bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700" onClick={() => openModal('addPerson')} title="新增還款人">
                  新增還款人
                </button>
                <button class="btn bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700" onClick={() => openModal('addCourse')} title="新增課程費用">
                  新增課程費用
                </button>
                <button class="btn bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700" onClick={calculate} title="開始計算">
                  計算試算
                </button>
                <button class="btn bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600" onClick={copyResult} title="複製試算結果">
                  複製結果
                </button>
                <button class="btn bg-orange-600 text-white px-4 py-2 rounded-lg hover:bg-orange-700" onClick={exportCsv} title="匯出試算結果CSV">
                  匯出CSV
                </button>
                <button class="btn bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700" onClick={clearAll} title="清空所有資料">
                  清空資料
                </button>
                <button class="btn bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800" onClick={exitApp} title="離開網頁">
                  離開
                </button>
              </div>

              <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">還款人列表</h2>
                {state.repayList.length === 0 ? (
                  <p class="text-gray-500">尚無還款人，請新增。</p>
                ) : (
                  <>
                    <div class="overflow-x-auto mb-6">
                      <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 sticky-header">
                          <tr>
                            <th class="p-3 font-semibold text-gray-700 border">姓名</th>
                            <th class="p-3 font-semibold text-gray-700 border">欠款金額 (元)</th>
                            <th class="p-3 font-semibold text-gray-700 border">操作</th>
                          </tr>
                        </thead>
                        <tbody>
                          {state.repayList.map((p, i) => (
                            <tr key={i} class="border-b hover:bg-gray-50">
                              <td class="p-3 border">{p.name}</td>
                              <td class="p-3 border">{p.debt.toFixed(2)}</td>
                              <td class="p-3 border">
                                <button
                                  class="text-red-600 hover:text-red-800 font-medium"
                                  onClick={() => removePerson(i)}
                                >
                                  刪除
                                </button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    <div class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50 flex justify-center items-center">
                      <div style={{ height: '300px', width: '100%', maxWidth: '500px' }}>
                        <canvas id="overall-debt-chart"></canvas>
                      </div>
                    </div>
                  </>
                )}
              </div>

              <div class="mb-8 bg-white rounded-lg shadow-sm p-6">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">課程費用列表</h2>
                {state.courseList.length === 0 ? (
                  <p class="text-gray-500">尚無課程費用，請新增。</p>
                ) : (
                  <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                      <thead class="bg-gray-50 sticky-header">
                        <tr>
                          <th class="p-3 font-semibold text-gray-700 border">總費用 (元)</th>
                          <th class="p-3 font-semibold text-gray-700 border">期數 (月)</th>
                          <th class="p-3 font-semibold text-gray-700 border">操作</th>
                        </tr>
                      </thead>
                      <tbody>
                        {state.courseList.map((c, i) => (
                          <tr key={i} class="border-b hover:bg-gray-50">
                            <td class="p-3 border">{c.fee.toFixed(2)}</td>
                            <td class="p-3 border">{c.months}</td>
                            <td class="p-3 border">
                              <button
                                class="text-red-600 hover:text-red-800 font-medium"
                                onClick={() => removeCourse(i)}
                              >
                                刪除
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>

              <div class="bg-white rounded-lg shadow-sm p-6 overflow-x-auto">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">試算結果</h2>
                {state.calculationResult ? (
                  <div>
                    {(() => {
                      const { headers, rows } = parseResultToTable(state.calculationResult);
                      if (headers.length === 0 && rows.length === 0) {
                        return <p class="text-gray-500">無有效試算結果，請檢查輸入數據或重新計算。</p>;
                      }
                      return (
                        <table class="w-full text-sm text-left" aria-label="試算結果表格">
                          <thead class="bg-gray-50 sticky-header">
                            <tr>
                              {headers.map((header, index) => (
                                <th key={index} class="p-3 font-semibold text-gray-700 border min-w-[120px] whitespace-nowrap">
                                  {header}
                                </th>
                              ))}
                            </tr>
                          </thead>
                          <tbody>
                            {rows.map((row, rowIndex) => (
                              <tr
                                key={rowIndex}
                                class={rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50'}
                              >
                                {row.map((cell, cellIndex) => (
                                  <td
                                    key={cellIndex}
                                    class="p-3 border text-gray-600 whitespace-nowrap min-w-[120px]"
                                  >
                                    {cell}
                                  </td>
                                ))}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      );
                    })()}
                  </div>
                ) : (
                  <p class="text-gray-500">無試算結果，請先執行計算。</p>
                )}
              </div>

              <ModalContent />
            </div>
            <footer class="text-center text-sm text-gray-500 py-4 border-t border-gray-300 bg-white">
              <p>
                <a href="/about" class="underline hover:text-blue-600">關於我們</a> |
                <a href="/privacy" class="underline hover:text-blue-600">隱私權政策</a> |
                <a href="/terms" class="underline hover:text-blue-600">服務條款</a> |
                <a href="/contact" class="underline hover:text-blue-600">聯絡我們</a>
              </p>
            </footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(
        <ErrorBoundary>
          <App />
        </ErrorBoundary>
      );
    </script>
</body>
</html>

### Key Features Ensured
1. **Footer Always at Bottom**: The `#root` element uses `min-height: 100vh` and `display: flex; flex-direction: column`, with `.main-content` having `flex-grow: 1` to push the footer to the bottom. The `footer` has `margin-top: auto` to ensure it stays at the bottom even when content is short.
2. **Privacy Policy Link**: The `<a href="/privacy">隱私權政策</a>` link is included in the footer, ensuring it’s always visible.
3. **Cookie Banner**: The banner’s `z-index` is lowered to `100`, and the footer has `padding-bottom: 80px` (100px on mobile) to prevent overlap when the banner is visible. The banner hides after cookie consent, further reducing overlap risk.
4. **Responsive Design**: Media queries adjust the footer’s `padding-bottom` and cookie banner’s layout for mobile devices.
5. **Error Handling**: The `ErrorBoundary` component catches rendering errors, preventing the footer from being hidden due to JavaScript issues.
6. **All Functionality Preserved**: Modals, pie chart, API calls (e.g., `/api/get_current_state`, `/api/calculate`), and table rendering remain unchanged.

### Testing Instructions
1. **Verify Footer Visibility**:
   - Open the page in a browser and use developer tools (F12 > Inspect) to confirm the `<footer>` element is present and visible at the bottom.
   - Test with minimal content (e.g., empty `repayList` and `courseList`) to ensure the footer stays at the bottom of the viewport.
   - Resize the window to various sizes (mobile, tablet, desktop) to check responsiveness.

2. **Check Privacy Policy Link**:
   - Click the "隱私權政策" link to ensure it navigates to `/privacy`. If it results in a 404 error, create a `privacy.html` file or configure the `/privacy` route on your server:
     ```html
     <!DOCTYPE html>
     <html lang="zh-TW">
     <head>
       <meta charset="UTF-8">
       <title>隱私權政策</title>
     </head>
     <body>
       <h1>隱私權政策</h1>
       <p>這裡是您的隱私權政策內容...</p>
     </body>
     </html>
     ```
   - For a Flask backend, add:
     ```python
     from flask import send_file
     @app.get('/privacy')
     def privacy():
       return send_file('privacy.html')
     ```

3. **Test Cookie Banner**:
   - Load the page without `cookieConsent` in `localStorage` to ensure the banner appears.
   - Click "接受全部" or "僅使用必要" and verify the banner hides (`display: none`).
   - Check that the footer remains visible above the banner with sufficient padding.

4. **Debug JavaScript Errors**:
   - Open the browser console (F12 > Console) to check for errors that might affect rendering.
   - Ensure CDN scripts (React, ReactDOM, Babel, Chart.js) load correctly. If errors occur, consider a local development setup with Vite or Webpack.

5. **Test Functionality**:
   - Add a repayment person and course via modals, calculate results, copy results, and export CSV to ensure all features work.
   - Verify the pie chart updates when `repayList` changes.

### Deployment Notes
Based on our previous discussions (July 2, 2025), you wanted to deploy this application online. This code assumes a Flask backend with endpoints like `/api/get_current_state`, `/api/calculate`, etc. To deploy:
1. **Backend Setup**:
   - Create a Flask `app.py` with the required endpoints (e.g., `/api/get_current_state`, `/api/add_person`).
   - Store data in a backend database or file (e.g., JSON or SQLite).
   - Example `app.py` snippet:
     ```python
     from flask import Flask, jsonify, request
     import json
     app = Flask(__name__)
     state = {'salary': 0, 'living_expense': 0, 'start_month': 1, 'repay_list': [], 'course_list': []}
     @app.route('/api/get_current_state', methods=['GET'])
     def get_current_state():
       return jsonify(state)
     # Add other endpoints: /api/add_person, /api/add_course, etc.
     ```
2. **Deploy to Render**:
   - Push the project (including `index.html`, `app.py`, `requirements.txt`) to a GitHub repository.
   - Create a Render account, link the repository, and deploy as a Web Service.
   - Ensure `requirements.txt` includes `flask`, and set the start command to `gunicorn app:app`.
   - Access the app via the provided Render URL (e.g., `https://your-app.onrender.com`).

### Recommendations
- **Local Testing**: Test locally with `python app.py` and open `http://localhost:5000` to verify the footer and functionality.
- **Privacy Page**: Ensure the `/privacy` route is set up to avoid 404 errors.
- **Production Setup**: For production, use a bundler like Vite instead of CDN scripts for better reliability.
- **Backup Backend**: If API endpoints fail, mock them locally for testing:
  ```python
  @app.route('/api/calculate', methods=['POST'])
  def calculate():
    return jsonify({'status': 'success', 'result': '{"headers": ["Month", "Payment"], "rows": [["1", "1000"], ["2", "1000"]]}'})
  ```

If you encounter issues (e.g., footer not visible, API errors, or 404 on `/privacy`), please provide details (console errors, screenshots, or server setup), and I’ll assist further. This revised code should ensure the "隱私權政策" link is always visible at the bottom of the page.
