<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💰 超級還款試算表 - 專業版</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background-color: #f4f7fa;
    }
    #root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .container {
      background: white;
      margin: 16px auto;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 1200px;
      width: 95%;
    }
    h1 {
      font-size: 2rem;
      margin-bottom: 16px;
      text-align: center;
      font-weight: bold;
      color: #111827;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }
    input[type="number"], input[type="text"], select {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
      outline-offset: 2px;
      outline-color: #3b82f6;
    }
    button {
      background-color: #3b82f6;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease-in-out;
    }
    button:hover {
      background-color: #2563eb;
    }
    .flex-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .flex-row > div {
      flex: 1;
      min-width: 220px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 8px 12px;
      text-align: center;
    }
    th {
      background-color: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    .table-wrapper {
      max-height: 320px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    .chart-container {
      position: relative;
      width: 100%;
      max-width: 700px;
      margin: 0 auto 32px;
      height: 350px;
    }
    footer {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      padding: 16px 0;
      text-align: center;
      margin-top: auto;
      font-size: 14px;
      color: #6b7280;
      user-select: none;
    }
    footer a {
      color: #3b82f6;
      text-decoration: none;
      margin: 0 12px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .error-msg {
      color: #ef4444;
      font-weight: 600;
      margin-bottom: 12px;
    }
    @media (max-width: 640px) {
      .flex-row {
        flex-direction: column;
      }
      .chart-container {
        height: 250px;
      }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <footer>
    <a href="/privacy" target="_blank" rel="noopener noreferrer">隱私權政策</a>|
    <a href="/terms" target="_blank" rel="noopener noreferrer">使用條款</a>|
    <a href="/cookie" target="_blank" rel="noopener noreferrer">Cookie 設定</a>|
    <a href="/contact" target="_blank" rel="noopener noreferrer">聯絡我們</a>
  </footer>

  <script type="text/babel">

    const { useState, useEffect, useRef } = React;

    function App() {

      // 基本狀態
      const [salary, setSalary] = useState('');
      const [livingExpense, setLivingExpense] = useState('');
      const [startMonth, setStartMonth] = useState(1);
      const [repayList, setRepayList] = useState([]);
      const [courseList, setCourseList] = useState([]);
      const [errorMsg, setErrorMsg] = useState('');
      const [calcResult, setCalcResult] = useState(null);
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);

      // 表單輸入控制
      const [newPersonName, setNewPersonName] = useState('');
      const [newPersonDebt, setNewPersonDebt] = useState('');
      const [newCourseFee, setNewCourseFee] = useState('');
      const [newCourseMonths, setNewCourseMonths] = useState('');

      // API模擬 or 待連接
      // 這裡用前端模擬計算，實際可換成fetch呼叫後端API

      // 新增還款人
      function addRepayPerson() {
        if (!newPersonName.trim()) {
          setErrorMsg('還款人姓名不能為空');
          return;
        }
        if (!newPersonDebt || isNaN(newPersonDebt) || Number(newPersonDebt) <= 0) {
          setErrorMsg('欠款金額必須是大於0的數字');
          return;
        }
        setRepayList([...repayList, { name: newPersonName.trim(), debt: Number(newPersonDebt) }]);
        setNewPersonName('');
        setNewPersonDebt('');
        setErrorMsg('');
      }

      // 新增課程
      function addCourse() {
        if (!newCourseFee || isNaN(newCourseFee) || Number(newCourseFee) <= 0) {
          setErrorMsg('課程費用必須是大於0的數字');
          return;
        }
        if (!newCourseMonths || isNaN(newCourseMonths) || !Number.isInteger(Number(newCourseMonths)) || Number(newCourseMonths) <= 0) {
          setErrorMsg('課程期數必須是大於0的整數');
          return;
        }
        setCourseList([...courseList, { fee: Number(newCourseFee), months: Number(newCourseMonths) }]);
        setNewCourseFee('');
        setNewCourseMonths('');
        setErrorMsg('');
      }

      // 移除還款人
      function removeRepayPerson(index) {
        if (!window.confirm(`確定移除還款人「${repayList[index].name}」嗎？`)) return;
        const copy = [...repayList];
        copy.splice(index, 1);
        setRepayList(copy);
      }

      // 移除課程
      function removeCourse(index) {
        if (!window.confirm(`確定移除課程 #${index+1} 嗎？`)) return;
        const copy = [...courseList];
        copy.splice(index, 1);
        setCourseList(copy);
      }

      // 計算主函數 - 還款計畫
      function calculateRepaymentPlan() {
        setErrorMsg('');
        setCalcResult(null);

        const sal = Number(salary);
        const expense = Number(livingExpense);
        if (isNaN(sal) || sal <= 0) {
          setErrorMsg('請輸入正確且大於0的薪水');
          return;
        }
        if (isNaN(expense) || expense < 0) {
          setErrorMsg('請輸入正確的生活費(可為0)');
          return;
        }
        if (!Number.isInteger(startMonth) || startMonth < 1 || startMonth > 12) {
          setErrorMsg('起始月份必須是1~12的整數');
          return;
        }
        if (repayList.length === 0) {
          setErrorMsg('請至少新增一位還款人');
          return;
        }
        if (courseList.length === 0) {
          setErrorMsg('請至少新增一門課程');
          return;
        }

        // 計算每月可還款額度 = 薪水 - 生活費 - 課程月費
        const totalMonthlyCourseFee = courseList.reduce((sum, c) => sum + (c.fee / c.months), 0);

        if (totalMonthlyCourseFee > sal - expense) {
          setErrorMsg('課程月費已超過可用還款金額，無法計算');
          return;
        }

        const monthlyRepayBudget = sal - expense - totalMonthlyCourseFee;

        // 計算還款人比例(以欠款金額占總欠款比例)
        const totalDebt = repayList.reduce((sum, p) => sum + p.debt, 0);

        if (totalDebt <= 0) {
          setErrorMsg('欠款總額必須大於0');
          return;
        }

        // 計算每個月還給每個人的錢，直到所有人都還完
        // 回傳一個陣列，每個月物件包含月份與每人還款金額
        let remainingDebts = repayList.map(p => ({ ...p }));
        let monthIndex = 0;
        let plan = [];
        // 最多計算100期防止無限迴圈
        while (remainingDebts.some(p => p.debt > 0) && monthIndex < 100) {
          monthIndex++;
          const monthPay = {};
          const monthName = ((startMonth + monthIndex - 2) % 12) + 1; // 1~12循環
          let budget = monthlyRepayBudget;

          // 依照欠款比例分配還款
          let debtSumThisMonth = remainingDebts.reduce((sum, p) => sum + p.debt, 0);
          remainingDebts.forEach(p => {
            if (p.debt <= 0) {
              monthPay[p.name] = 0;
              return;
            }
            // 欠款比率
            let ratio = p.debt / debtSumThisMonth;
            let pay = Math.min(Math.round(monthlyRepayBudget * ratio * 100) / 100, p.debt, budget);
            budget -= pay;
            p.debt -= pay;
            p.debt = Math.round(p.debt * 100) / 100;
            monthPay[p.name] = pay;
          });

          // 若有剩餘預算，平均分配給還有欠款的人(防止因四捨五入導致剩餘)
          if (budget > 0) {
            const needPayers = remainingDebts.filter(p => p.debt > 0);
            if (needPayers.length > 0) {
              const extraPerPerson = Math.round((budget / needPayers.length) * 100) / 100;
              needPayers.forEach(p => {
                let extra = Math.min(extraPerPerson, p.debt);
                p.debt -= extra;
                p.debt = Math.round(p.debt * 100) / 100;
                monthPay[p.name] += extra;
              });
            }
          }

          plan.push({ month: monthName, pays: { ...monthPay } });
        }

        // 整理成表格形式與總還款期數
        setCalcResult({
          plan,
          monthlyRepayBudget,
          totalDebt,
          totalMonths: monthIndex,
          totalCourseFee: totalMonthlyCourseFee,
        });
      }

      // 複製結果
      function copyResult() {
        if (!calcResult) return alert('請先執行計算');
        let text = `每月還款總額：${calcResult.monthlyRepayBudget.toFixed(2)} 元\n還款總期數：約 ${calcResult.totalMonths} 個月\n\n詳細每月還款計畫：\n`;
        calcResult.plan.forEach((m, idx) => {
          text += `第${idx+1}個月(月份:${m.month}月)：\n`;
          Object.entries(m.pays).forEach(([name, pay]) => {
            text += `  ${name}：${pay.toFixed(2)} 元\n`;
          });
        });
        navigator.clipboard.writeText(text).then(() => alert('已複製試算結果到剪貼簿'));
      }

      // 匯出 CSV
      function exportCsv() {
        if (!calcResult) return alert('請先執行計算');
        let csv = '月份,還款人,還款金額\n';
        calcResult.plan.forEach(m => {
          Object.entries(m.pays).forEach(([name, pay]) => {
            csv += `${m.month},${name},${pay.toFixed(2)}\n`;
          });
        });
        const blob = new Blob([csv], {type: 'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'repayment_plan.csv';
        a.click();
        URL.revokeObjectURL(url);
      }

      // Chart.js 顯示總欠款分佈
      useEffect(() => {
        if (chartInstanceRef.current) {
          chartInstanceRef.current.destroy();
        }
        if (repayList.length === 0) return;

        const ctx = chartRef.current.getContext('2d');
        chartInstanceRef.current = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: repayList.map(p => p.name),
            datasets: [{
              data: repayList.map(p => p.debt),
              backgroundColor: [
                '#3b82f6','#10b981','#ef4444','#f59e0b','#8b5cf6',
                '#06b6d4','#db2777','#6d28d9','#ca8a04','#4ade80'
              ],
            }],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'right' },
              title: { display: true, text: '總欠款分佈' }
            }
          }
        });
      }, [repayList]);

      return (
        <div className="container" role="main" aria-label="超級還款試算表">
          <h1>💰 超級還款試算表 - 專業版</h1>
          <div className="flex-row" style={{marginBottom:'24px'}}>
            <div>
              <label htmlFor="salary">每月薪水 (元)</label>
              <input type="number" id="salary" min="0" step="100" value={salary} onChange={e => setSalary(e.target.value)} placeholder="輸入每月薪水" aria-required="true"/>
            </div>
            <div>
              <label htmlFor="livingExpense">每月生活費 (元)</label>
              <input type="number" id="livingExpense" min="0" step="100" value={livingExpense} onChange={e => setLivingExpense(e.target.value)} placeholder="輸入每月生活費" aria-required="true"/>
            </div>
            <div>
              <label htmlFor="startMonth">起始月份 (1-12)</label>
              <input type="number" id="startMonth" min="1" max="12" value={startMonth} onChange={e => setStartMonth(Number(e.target.value))} aria-required="true"/>
            </div>
          </div>

          <div className="container" style={{padding:'12px', marginBottom:'24px'}}>
            <h2>新增還款人</h2>
            <div className="flex-row">
              <div>
                <label htmlFor="newPersonName">姓名</label>
                <input type="text" id="newPersonName" value={newPersonName} onChange={e => setNewPersonName(e.target.value)} placeholder="輸入還款人姓名" aria-required="true"/>
              </div>
              <div>
                <label htmlFor="newPersonDebt">欠款金額 (元)</label>
                <input type="number" id="newPersonDebt" min="0" step="100" value={newPersonDebt} onChange={e => setNewPersonDebt(e.target.value)} placeholder="輸入欠款金額" aria-required="true"/>
              </div>
              <div style={{alignSelf:'flex-end'}}>
                <button onClick={addRepayPerson} aria-label="新增還款人">新增還款人</button>
              </div>
            </div>
          </div>

          <div className="container" style={{padding:'12px', marginBottom:'24px'}}>
            <h2>還款人列表</h2>
            {repayList.length === 0 ? (
              <p>尚無還款人資料</p>
            ) : (
              <div className="table-wrapper" role="table" aria-label="還款人列表">
                <table>
                  <thead>
                    <tr>
                      <th>姓名</th>
                      <th>欠款金額 (元)</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    {repayList.map((p, i) => (
                      <tr key={i}>
                        <td>{p.name}</td>
                        <td>{p.debt.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>
                          <button onClick={() => removeRepayPerson(i)} aria-label={`移除還款人 ${p.name}`}>刪除</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          <div className="container" style={{padding:'12px', marginBottom:'24px'}}>
            <h2>新增課程</h2>
            <div className="flex-row">
              <div>
                <label htmlFor="newCourseFee">課程總費用 (元)</label>
                <input type="number" id="newCourseFee" min="0" step="100" value={newCourseFee} onChange={e => setNewCourseFee(e.target.value)} placeholder="輸入課程費用" aria-required="true"/>
              </div>
              <div>
                <label htmlFor="newCourseMonths">課程期數 (月)</label>
                <input type="number" id="newCourseMonths" min="1" max="100" step="1" value={newCourseMonths} onChange={e => setNewCourseMonths(e.target.value)} placeholder="輸入課程期數" aria-required="true"/>
              </div>
              <div style={{alignSelf:'flex-end'}}>
                <button onClick={addCourse} aria-label="新增課程">新增課程</button>
              </div>
            </div>
          </div>

          <div className="container" style={{padding:'12px', marginBottom:'24px'}}>
            <h2>課程列表</h2>
            {courseList.length === 0 ? (
              <p>尚無課程資料</p>
            ) : (
              <div className="table-wrapper" role="table" aria-label="課程列表">
                <table>
                  <thead>
                    <tr>
                      <th>課程編號</th>
                      <th>課程總費用 (元)</th>
                      <th>課程期數 (月)</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>
                    {courseList.map((c, i) => (
                      <tr key={i}>
                        <td>{i+1}</td>
                        <td>{c.fee.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                        <td>{c.months}</td>
                        <td>
                          <button onClick={() => removeCourse(i)} aria-label={`移除課程編號 ${i+1}`}>刪除</button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {errorMsg && <p className="error-msg" role="alert">{errorMsg}</p>}

          <div style={{textAlign:'center', marginBottom:'32px'}}>
            <button onClick={calculateRepaymentPlan} aria-label="開始計算還款計畫" style={{minWidth:'220px', fontWeight:'700', fontSize:'1.25rem'}}>
              計算還款計畫
            </button>
          </div>

          {calcResult && (
            <>
              <div style={{marginBottom:'24px'}}>
                <h2>試算結果</h2>
                <p>每月可用還款額度：<strong>{calcResult.monthlyRepayBudget.toFixed(2)}</strong> 元</p>
                <p>總欠款金額：<strong>{calcResult.totalDebt.toFixed(2)}</strong> 元</p>
                <p>課程每月費用合計：<strong>{calcResult.totalCourseFee.toFixed(2)}</strong> 元</p>
                <p>估計還款期數：約 <strong>{calcResult.totalMonths}</strong> 個月</p>

                <div className="chart-container" role="img" aria-label="欠款比例圓餅圖">
                  <canvas ref={chartRef}></canvas>
                </div>

                <div className="table-wrapper" style={{maxHeight:'420px'}}>
                  <table aria-label="每月還款計畫明細">
                    <thead>
                      <tr>
                        <th>月份</th>
                        {repayList.map(p => <th key={p.name}>{p.name}</th>)}
                      </tr>
                    </thead>
                    <tbody>
                      {calcResult.plan.map((m, idx) => (
                        <tr key={idx}>
                          <td>{m.month} 月</td>
                          {repayList.map(p => (
                            <td key={p.name}>{(m.pays[p.name] || 0).toFixed(2)}</td>
                          ))}
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div style={{marginTop:'24px', textAlign:'center'}}>
                  <button onClick={copyResult} aria-label="複製還款結果">複製結果</button>
                  <button onClick={exportCsv} aria-label="匯出還款計畫 CSV" style={{marginLeft:'16px'}}>匯出 CSV</button>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
