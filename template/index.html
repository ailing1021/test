<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’° Qç‰ˆé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</title>
  <style>
    /* --- åŸºæœ¬CSS Reset èˆ‡å­—å‹è¨­å®š --- */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fef6f6;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      background: #c83e3e;
      color: #fff;
      padding: 18px 20px;
      font-weight: 900;
      font-size: 1.7rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(200, 62, 62, 0.5);
      user-select: none;
    }
    main {
      flex-grow: 1;
      max-width: 960px;
      margin: 20px auto 60px auto;
      background: #fff5f5;
      border-radius: 12px;
      box-shadow: 0 6px 16px #f2b7b7cc;
      padding: 20px 30px;
    }
    h2 {
      border-left: 5px solid #c83e3e;
      padding-left: 12px;
      color: #a13131;
      margin-top: 30px;
      margin-bottom: 12px;
      font-weight: 800;
    }
    label {
      display: block;
      margin: 10px 0 6px 0;
      font-weight: 600;
      color: #7a2a2a;
    }
    input[type="number"],
    input[type="text"],
    select {
      width: 100%;
      padding: 10px 14px;
      border-radius: 12px;
      border: 2px solid #f6c2c2;
      font-size: 1rem;
      transition: border-color 0.3s;
    }
    input[type="number"]:focus,
    input[type="text"]:focus,
    select:focus {
      border-color: #c83e3e;
      outline: none;
    }
    button {
      margin-top: 15px;
      padding: 12px 16px;
      border-radius: 28px;
      border: none;
      background: #c83e3e;
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    button:hover {
      background: #a83131;
    }
    .list-group {
      margin: 8px 0 16px 0;
    }
    .list-item {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
      background: #f6c2c2aa;
      border-radius: 14px;
      padding: 12px 16px;
      align-items: center;
      justify-content: space-between;
      transition: background-color 0.3s;
    }
    .list-item:hover {
      background: #f08a8a;
    }
    .list-item input[type="text"],
    .list-item input[type="number"] {
      flex: 1;
      font-size: 1rem;
      border: 1.5px solid #f9a3a3;
      border-radius: 8px;
      padding: 6px 10px;
    }
    .btn-remove {
      flex-shrink: 0;
      background: #a02a2a;
      border-radius: 50%;
      color: white;
      font-weight: 900;
      border: none;
      width: 30px;
      height: 30px;
      font-size: 1.3rem;
      line-height: 28px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 0 6px #a02a2aaa;
      transition: background-color 0.2s;
    }
    .btn-remove:hover {
      background: #d14a4a;
      box-shadow: 0 0 8px #d14a4aaa;
    }
    #resultArea {
      margin-top: 20px;
      background: #fceaea;
      border-radius: 18px;
      border: 2px dashed #c83e3e;
      padding: 18px 24px;
      font-weight: 700;
      white-space: pre-wrap;
      color: #7a2a2a;
      min-height: 120px;
      overflow-y: auto;
    }
    #chartsArea {
      margin-top: 24px;
      background: #fff0f0;
      padding: 12px 16px;
      border-radius: 18px;
      box-shadow: inset 0 0 8px #f9a3a3cc;
      display: flex;
      justify-content: center;
    }
    canvas {
      max-width: 100%;
      height: auto !important;
    }
    footer {
      background: #c83e3e;
      color: #fff;
      text-align: center;
      padding: 16px 10px;
      font-weight: 600;
      user-select: none;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      font-size: 0.95rem;
    }
    footer a {
      color: #fff0f0;
      text-decoration: none;
      margin: 0 8px;
      font-weight: 700;
      transition: color 0.3s;
    }
    footer a:hover {
      color: #ffd1d1;
      text-decoration: underline;
    }
    @media (max-width: 480px) {
      main {
        margin: 10px 10px 80px 10px;
        padding: 16px 14px;
      }
      .list-item {
        flex-direction: column;
        align-items: flex-start;
      }
      .list-item input[type="text"],
      .list-item input[type="number"] {
        width: 100%;
      }
      .btn-remove {
        align-self: flex-end;
        margin-top: 8px;
      }
    }
  </style>
</head>
<body>

<header>ğŸ’° Qç‰ˆé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</header>

<main>
  <!-- è–ªè³‡èˆ‡ç”Ÿæ´»è²»è¼¸å…¥ -->
  <section id="basicInfo">
    <h2>åŸºæœ¬è³‡æ–™</h2>
    <label for="inputSalary">æ¯æœˆè–ªè³‡ï¼ˆå…ƒï¼‰</label>
    <input type="number" id="inputSalary" min="0" placeholder="è«‹è¼¸å…¥æ¯æœˆè–ªè³‡" />
    <label for="inputExpense">æ¯æœˆç”Ÿæ´»è²»ï¼ˆå…ƒï¼‰</label>
    <input type="number" id="inputExpense" min="0" placeholder="è«‹è¼¸å…¥æ¯æœˆç”Ÿæ´»è²»" />
  </section>

  <!-- å‚µå‹™äººæ¸…å–® -->
  <section id="debtorsSection">
    <h2>å‚µå‹™äººæ¸…å–®</h2>
    <div id="debtorsList" class="list-group"></div>
    <button id="btnAddDebtor" type="button">ï¼‹ æ–°å¢å‚µå‹™äºº</button>
  </section>

  <!-- èª²ç¨‹æ¸…å–® -->
  <section id="coursesSection">
    <h2>èª²ç¨‹æ¸…å–®</h2>
    <div id="coursesList" class="list-group"></div>
    <button id="btnAddCourse" type="button">ï¼‹ æ–°å¢èª²ç¨‹</button>
  </section>

  <!-- èµ·å§‹æœˆä»½ -->
  <section id="startMonthSection">
    <h2>èµ·å§‹æœˆä»½</h2>
    <label for="selectStartMonth">é¸æ“‡èµ·å§‹æœˆä»½</label>
    <select id="selectStartMonth">
      <option value="1">1 æœˆ</option>
      <option value="2">2 æœˆ</option>
      <option value="3">3 æœˆ</option>
      <option value="4">4 æœˆ</option>
      <option value="5">5 æœˆ</option>
      <option value="6">6 æœˆ</option>
      <option value="7">7 æœˆ</option>
      <option value="8">8 æœˆ</option>
      <option value="9">9 æœˆ</option>
      <option value="10">10 æœˆ</option>
      <option value="11">11 æœˆ</option>
      <option value="12">12 æœˆ</option>
    </select>
  </section>

  <!-- æ“ä½œæŒ‰éˆ• -->
  <section id="actions">
    <button id="btnCalculate" type="button">é–‹å§‹è¨ˆç®—</button>
    <button id="btnExportCSV" type="button" disabled>åŒ¯å‡º CSV</button>
  </section>

  <!-- è¨ˆç®—çµæœå€ -->
  <section id="resultSection">
    <h2>è¨ˆç®—çµæœ</h2>
    <pre id="resultArea">è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€</pre>
  </section>

  <!-- åœ–è¡¨å€ -->
  <section id="chartsSection">
    <h2>å‚µå‹™æ¯”ä¾‹åœ“é¤…åœ–</h2>
    <div id="chartsArea">
      <canvas id="pieChart"></canvas>
    </div>
  </section>
  <section id="contactForm" style="margin-top: 50px;">
  <h2>è¯çµ¡æˆ‘å€‘</h2>
  <form action="https://formsubmit.co/a3017255@gmail.com" method="POST">
    <label for="name">æ‚¨çš„å§“åï¼š</label>
    <input type="text" id="name" name="name" required><br><br>

    <label for="email">æ‚¨çš„ Emailï¼š</label>
    <input type="email" id="email" name="email" required><br><br>

    <label for="message">è¨Šæ¯å…§å®¹ï¼š</label><br>
    <textarea id="message" name="message" rows="5" required></textarea><br><br>

    <button type="submit">é€å‡º</button>
  </form>
</section>
</main>

<footer style="text-align: center; font-size: 0.9rem; padding: 14px 10px; background: #ffbaba55; color: #7a2f2f; margin-top: auto; box-shadow: inset 0 1px 4px #ffbabacc;">
  <a href="/about" target="_blank" rel="noopener noreferrer" style="color: #d14a4a; font-weight: 700; text-decoration: none; margin: 0 8px;">é—œæ–¼æˆ‘å€‘</a> | 
  <a href="#contactForm" style="color: #d14a4a; font-weight: 700; text-decoration: none; margin: 0 8px;">è¯çµ¡æˆ‘å€‘</a> | 
  <a href="/privacy" target="_blank" rel="noopener noreferrer" style="color: #d14a4a; font-weight: 700; text-decoration: none; margin: 0 8px;">éš±ç§æ¬Šæ”¿ç­–</a> | 
  <a href="/terms" target="_blank" rel="noopener noreferrer" style="color: #d14a4a; font-weight: 700; text-decoration: none; margin: 0 8px;">æœå‹™æ¢æ¬¾</a>
</footer>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // å…¨å±€ç‹€æ…‹
  const state = {
    salary: 0,
    livingExpense: 0,
    startMonth: 1,
    debtors: [],
    courses: [],
    monthRecords: [],
  };

  // DOM Elements
  const inputSalary = document.getElementById('inputSalary');
  const inputExpense = document.getElementById('inputExpense');
  const selectStartMonth = document.getElementById('selectStartMonth');
  const debtorsList = document.getElementById('debtorsList');
  const coursesList = document.getElementById('coursesList');
  const btnAddDebtor = document.getElementById('btnAddDebtor');
  const btnAddCourse = document.getElementById('btnAddCourse');
  const btnCalculate = document.getElementById('btnCalculate');
  const btnExportCSV = document.getElementById('btnExportCSV');
  const resultArea = document.getElementById('resultArea');

  let pieChart = null;

  // å»ºç«‹å‚µå‹™äººè¼¸å…¥å€å¡Š
  function createDebtorItem(name = '', debt = '') {
    const div = document.createElement('div');
    div.className = 'list-item';

    const inputName = document.createElement('input');
    inputName.type = 'text';
    inputName.placeholder = 'å§“å';
    inputName.value = name;
    inputName.autocomplete = "off";

    const inputDebt = document.createElement('input');
    inputDebt.type = 'number';
    inputDebt.placeholder = 'æ¬ æ¬¾é‡‘é¡';
    inputDebt.min = 0;
    inputDebt.value = debt;

    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn-remove';
    btnRemove.title = "ç§»é™¤å‚µå‹™äºº";
    btnRemove.innerHTML = '&times;';
    btnRemove.onclick = () => {
      div.remove();
      updateStateFromUI();
    };

    // è¼¸å…¥æ”¹è®Šå³æ›´æ–°ç‹€æ…‹
    inputName.addEventListener('input', updateStateFromUI);
    inputDebt.addEventListener('input', updateStateFromUI);

    div.appendChild(inputName);
    div.appendChild(inputDebt);
    div.appendChild(btnRemove);

    return div;
  }

  // å»ºç«‹èª²ç¨‹è¼¸å…¥å€å¡Š
  function createCourseItem(name = '', fee = '', months = '') {
    const div = document.createElement('div');
    div.className = 'list-item';

    const inputName = document.createElement('input');
    inputName.type = 'text';
    inputName.placeholder = 'èª²ç¨‹åç¨±';
    inputName.value = name;
    inputName.autocomplete = "off";

    const inputFee = document.createElement('input');
    inputFee.type = 'number';
    inputFee.placeholder = 'èª²ç¨‹è²»ç”¨';
    inputFee.min = 0;
    inputFee.value = fee;

    const inputMonths = document.createElement('input');
    inputMonths.type = 'number';
    inputMonths.placeholder = 'æœŸæ•¸ï¼ˆæœˆï¼‰';
    inputMonths.min = 1;
    inputMonths.value = months;

    const btnRemove = document.createElement('button');
    btnRemove.className = 'btn-remove';
    btnRemove.title = "ç§»é™¤èª²ç¨‹";
    btnRemove.innerHTML = '&times;';
    btnRemove.onclick = () => {
      div.remove();
      updateStateFromUI();
    };

    // è¼¸å…¥æ”¹è®Šå³æ›´æ–°ç‹€æ…‹
    inputName.addEventListener('input', updateStateFromUI);
    inputFee.addEventListener('input', updateStateFromUI);
    inputMonths.addEventListener('input', updateStateFromUI);

    div.appendChild(inputName);
    div.appendChild(inputFee);
    div.appendChild(inputMonths);
    div.appendChild(btnRemove);

    return div;
  }

  // æ–°å¢å‚µå‹™äºº
  btnAddDebtor.addEventListener('click', () => {
    const item = createDebtorItem();
    debtorsList.appendChild(item);
  });

  // æ–°å¢èª²ç¨‹
  btnAddCourse.addEventListener('click', () => {
    const item = createCourseItem();
    coursesList.appendChild(item);
  });

  // å¾UIåŒæ­¥ç‹€æ…‹ç‰©ä»¶
  function updateStateFromUI() {
    state.salary = parseFloat(inputSalary.value) || 0;
    state.livingExpense = parseFloat(inputExpense.value) || 0;
    state.startMonth = parseInt(selectStartMonth.value, 10) || 1;

    state.debtors = [];
    [...debtorsList.children].forEach(div => {
      const inputs = div.querySelectorAll('input');
      const name = inputs[0].value.trim();
      const debt = parseFloat(inputs[1].value);
      if (name && !isNaN(debt) && debt > 0) {
        state.debtors.push({ name, debt });
      }
    });

    state.courses = [];
    [...coursesList.children].forEach(div => {
      const inputs = div.querySelectorAll('input');
      const name = inputs[0].value.trim() || "èª²ç¨‹";
      const fee = parseFloat(inputs[1].value);
      const months = parseInt(inputs[2].value, 10);
      if (!isNaN(fee) && fee > 0 && !isNaN(months) && months > 0) {
        state.courses.push({ name, fee, months });
      }
    });

    btnExportCSV.disabled = true;
  }

  // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
  function showError(msg) {
    alert(msg);
  }

  // è¨ˆç®—é‚è¼¯ï¼ˆèˆ‡ä½ åŸæœ¬Pythoné‚è¼¯ç›¸åŒï¼‰
  function calculateRepaymentPlan() {
    if (state.salary <= 0) {
      showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„è–ªè³‡');
      return;
    }
    if (state.livingExpense < 0) {
      showError('ç”Ÿæ´»è²»ä¸å¯ç‚ºè² æ•¸');
      return;
    }
    if (state.livingExpense >= state.salary) {
      showError('ç”Ÿæ´»è²»ä¸å¯å¤§æ–¼æˆ–ç­‰æ–¼è–ªè³‡');
      return;
    }
    if (state.debtors.length === 0 && state.courses.length === 0) {
      showError('è«‹è‡³å°‘æ–°å¢ä¸€ä½å‚µå‹™äººæˆ–ä¸€å€‹èª²ç¨‹');
      return;
    }

    const disposableIncome = state.salary - state.livingExpense;

    // åˆå§‹åŒ–å‚µå‹™äººèˆ‡èª²ç¨‹å‰©é¤˜é‡‘é¡
    const debtsRemaining = {};
    state.debtors.forEach(d => debtsRemaining[d.name] = d.debt);
    const coursesRemaining = state.courses.map(c => ({
      ...c,
      monthlyPayment: c.fee / c.months,
      remainingFee: c.fee
    }));

    const startYear = new Date().getFullYear();

    const monthRecords = [];
    let monthCount = 0;
    const maxMonths = 2000;

    const repayCompletionDates = {};
    const courseCompletionDates = {};

    while (true) {
      // åˆ¤æ–·æ˜¯å¦å…¨éƒ¨é‚„æ¸…
      const allDebtsCleared = Object.values(debtsRemaining).every(v => v <= 0.001);
      const allCoursesCleared = coursesRemaining.every(c => c.remainingFee <= 0.001);
      if (allDebtsCleared && allCoursesCleared) break;
      if (monthCount > maxMonths) {
        showError('è¨ˆç®—è¶…éæœ€å¤§æœˆä»½ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢º');
        break;
      }

      const currentMonthIndex = (state.startMonth - 1 + monthCount) % 12 + 1;
      const currentYear = startYear + Math.floor((state.startMonth - 1 + monthCount) / 12);

      // æœ¬æœˆå¯ç”¨æ–¼é‚„æ¬¾çš„é‡‘é¡
      let budget = disposableIncome;

      // å„ªå…ˆé‚„å‚µå‹™äººï¼Œä¾åºå¹³å‡åˆ†é…
      const activeDebtors = Object.entries(debtsRemaining).filter(([_, debt]) => debt > 0.001);
      if (activeDebtors.length > 0) {
        // å¹³å‡åˆ†é…é ç®—çµ¦æ¯å€‹æ´»å‚µå‹™äºº
        const budgetPerDebtor = budget / (activeDebtors.length + coursesRemaining.filter(c => c.remainingFee > 0.001).length);
        activeDebtors.forEach(([name, debt]) => {
          const pay = Math.min(debt, budgetPerDebtor);
          debtsRemaining[name] -= pay;
          budget -= pay;
          if (debtsRemaining[name] <= 0.001 && !(name in repayCompletionDates)) {
            repayCompletionDates[name] = { year: currentYear, month: currentMonthIndex };
          }
        });
      }

      // å‰©ä¸‹é ç®—åˆ†çµ¦èª²ç¨‹æœˆä»˜
      const activeCourses = coursesRemaining.filter(c => c.remainingFee > 0.001);
      if (activeCourses.length > 0 && budget > 0) {
        // å¹³å‡åˆ†é…é ç®—çµ¦æ´»èºèª²ç¨‹
        const budgetPerCourse = budget / activeCourses.length;
        activeCourses.forEach(course => {
          const pay = Math.min(course.remainingFee, budgetPerCourse, course.monthlyPayment);
          course.remainingFee -= pay;
          budget -= pay;
          if (course.remainingFee <= 0.001 && !(course.name in courseCompletionDates)) {
            courseCompletionDates[course.name] = { year: currentYear, month: currentMonthIndex };
          }
        });
      }

      // è¨˜éŒ„æœ¬æœˆè³‡æ–™
      monthRecords.push({
        year: currentYear,
        month: currentMonthIndex,
        debtsRemaining: JSON.parse(JSON.stringify(debtsRemaining)),
        coursesRemaining: coursesRemaining.map(c => ({ name: c.name, remainingFee: c.remainingFee })),
        budgetLeft: budget
      });

      monthCount++;
    }

    state.monthRecords = monthRecords;

    return {
      repayCompletionDates,
      courseCompletionDates,
      monthCount,
      disposableIncome
    };
  }

  // é¡¯ç¤ºçµæœåˆ°é é¢
  function displayResults(calcResult) {
    let text = `ğŸ“… è¨ˆç®—èµ·å§‹æœˆä»½ï¼š${state.startMonth} æœˆ\n`;
    text += `ğŸ’° è–ªè³‡ï¼š${state.salary.toLocaleString()} å…ƒ\n`;
    text += `ğŸ  ç”Ÿæ´»è²»ï¼š${state.livingExpense.toLocaleString()} å…ƒ\n`;
    text += `ğŸ”¢ ç¸½é‚„æ¬¾æœŸæ•¸ï¼šç´„ ${calcResult.monthCount} å€‹æœˆ\n\n`;

    text += 'ğŸ“Œ å‚µå‹™äººé‚„æ¬¾å®Œæˆæ™‚é–“ï¼š\n';
    for (const [name, date] of Object.entries(calcResult.repayCompletionDates)) {
      text += `  - ${name} ï¼š${date.year} å¹´ ${date.month} æœˆ\n`;
    }
    if (Object.keys(calcResult.repayCompletionDates).length === 0) {
      text += '  ç„¡å‚µå‹™äººæˆ–å‚µå‹™å·²æ¸…ã€‚\n';
    }

    text += '\nğŸ“Œ èª²ç¨‹ç¹³è²»å®Œæˆæ™‚é–“ï¼š\n';
    for (const [name, date] of Object.entries(calcResult.courseCompletionDates)) {
      text += `  - ${name} ï¼š${date.year} å¹´ ${date.month} æœˆ\n`;
    }
    if (Object.keys(calcResult.courseCompletionDates).length === 0) {
      text += '  ç„¡èª²ç¨‹æˆ–å·²ç¹³æ¸…ã€‚\n';
    }

    resultArea.textContent = text;
  }

  // ç¹ªè£½åœ“é¤…åœ– (å‚µå‹™æ¯”ä¾‹)
  function renderPieChart() {
    if (pieChart) {
      pieChart.destroy();
      pieChart = null;
    }

    const totalDebt = state.debtors.reduce((sum, d) => sum + d.debt, 0);
    if (totalDebt <= 0) {
      // ç„¡å‚µå‹™å°±ä¸ç•«åœ–
      document.getElementById('chartsArea').style.display = 'none';
      return;
    }
    document.getElementById('chartsArea').style.display = 'flex';

    const labels = state.debtors.map(d => d.name);
    const data = state.debtors.map(d => d.debt);

    const backgroundColors = [
      '#ff6f6f', '#ff9f6f', '#ffc56f', '#b3d955',
      '#6fcb9f', '#6fcbe6', '#6f8ffc', '#b16ffb',
      '#eb6ffb', '#ff6fb8', '#ff6f8f'
    ];

    const ctx = document.getElementById('pieChart').getContext('2d');

    pieChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [{
          label: 'å‚µå‹™æ¯”ä¾‹',
          data: data,
          backgroundColor: backgroundColors.slice(0, labels.length),
          borderWidth: 1,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'right',
            labels: {
              font: { size: 14, weight: '600' },
              color: '#a13131',
              padding: 12
            }
          },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed.toLocaleString()} å…ƒ`
            }
          }
        }
      }
    });
  }

  // ç”¢ç”Ÿ CSV å­—ä¸²
  function generateCSV() {
    if (!state.monthRecords || state.monthRecords.length === 0) return '';

    const headers = ['å¹´æœˆ', ...state.debtors.map(d => `å‚µå‹™-${d.name}`), ...state.courses.map(c => `èª²ç¨‹-${c.name}`), 'å‰©é¤˜é ç®—'];
    const rows = state.monthRecords.map(r => {
      const yearMonth = `${r.year}å¹´${r.month}æœˆ`;
      const debtValues = state.debtors.map(d => {
        const val = r.debtsRemaining[d.name];
        return val ? val.toFixed(2) : '0.00';
      });
      const courseValues = state.courses.map(c => {
        const course = r.coursesRemaining.find(crs => crs.name === c.name);
        return course ? course.remainingFee.toFixed(2) : '0.00';
      });
      return [yearMonth, ...debtValues, ...courseValues, r.budgetLeft.toFixed(2)];
    });

    // CSVåˆä½µï¼Œé€—è™Ÿåˆ†éš”ï¼Œæ–‡å­—æ¬„ä½åŒ…é›™å¼•è™Ÿ
    let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
    rows.forEach(row => {
      csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
    });

    return csvContent;
  }

  // ä¸‹è¼‰ CSV
  function downloadCSV(filename, csvContent) {
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // æŒ‰éˆ•äº‹ä»¶ï¼šé–‹å§‹è¨ˆç®—
  btnCalculate.addEventListener('click', () => {
    updateStateFromUI();

    const calcResult = calculateRepaymentPlan();
    if (!calcResult) return;

    displayResults(calcResult);
    renderPieChart();
    btnExportCSV.disabled = false;
  });

  // æŒ‰éˆ•äº‹ä»¶ï¼šåŒ¯å‡º CSV
  btnExportCSV.addEventListener('click', () => {
    const csv = generateCSV();
    if (!csv) {
      alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
      return;
    }
    const filename = `é‚„æ¬¾è©¦ç®—è¡¨_${new Date().toISOString().slice(0,10)}.csv`;
    downloadCSV(filename, csv);
  });

  // é é¢è¼‰å…¥æ™‚ï¼Œé å…ˆåŠ å…¥1ç­†å‚µå‹™äººèˆ‡èª²ç¨‹ï¼Œæ–¹ä¾¿æ“ä½œ
  window.onload = () => {
    btnAddDebtor.click();
    btnAddCourse.click();
  };
</script>

</body>
</html>
