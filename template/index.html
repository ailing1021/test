<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>💰 超級還款試算表 - 700行完整版</title>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  /* --- 基本排版與樣式 --- */
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f9fafb;
    color: #111827;
  }
  #root {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  main {
    flex-grow: 1;
    max-width: 1280px;
    margin: 20px auto 0 auto;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  }
  h1, h2, h3 {
    margin: 0 0 12px 0;
    font-weight: 700;
  }
  h1 {
    font-size: 2.5rem;
    color: #1e293b;
    text-align: center;
  }
  h2 {
    font-size: 1.7rem;
    color: #334155;
    border-bottom: 2px solid #3b82f6;
    padding-bottom: 4px;
    margin-bottom: 20px;
  }
  label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
  }
  input[type="number"], input[type="text"], select {
    width: 100%;
    padding: 8px 12px;
    font-size: 1rem;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    outline-offset: 2px;
    outline-color: #3b82f6;
    box-sizing: border-box;
  }
  button {
    background-color: #3b82f6;
    border: none;
    color: white;
    font-size: 1rem;
    font-weight: 700;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button:hover {
    background-color: #2563eb;
  }
  button:disabled {
    background-color: #93c5fd;
    cursor: not-allowed;
  }
  .section {
    margin-bottom: 32px;
  }
  .flex-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  .flex-col {
    display: flex;
    flex-direction: column;
  }
  .flex-row > div, .flex-col > div {
    flex: 1;
    min-width: 250px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #e2e8f0;
    padding: 12px 16px;
    text-align: center;
  }
  th {
    background-color: #f1f5f9;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .table-wrapper {
    max-height: 360px;
    overflow-y: auto;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
  }
  .error-msg {
    color: #dc2626;
    font-weight: 700;
    margin-bottom: 20px;
  }
  .footer {
    background-color: #f1f5f9;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: #64748b;
    user-select: none;
    margin-top: auto;
    border-top: 1px solid #cbd5e1;
  }
  .footer a {
    color: #3b82f6;
    text-decoration: none;
    margin: 0 12px;
  }
  .footer a:hover {
    text-decoration: underline;
  }
  @media (max-width: 640px) {
    .flex-row {
      flex-direction: column;
    }
    .flex-row > div {
      min-width: 100%;
    }
  }
</style>
</head>
<body>
  <div id="root"></div>
<footer class="footer">
  <a href="/privacy" target="_blank">隱私權政策</a> |
  <a href="/terms" target="_blank">使用條款</a> |
  <a href="/about" target="_blank">關於我們</a> |
  <a href="/contact" target="_blank">聯絡我們</a>
</footer>

<script type="text/babel">

  const { useState, useEffect, useRef } = React;

  /**
   * 還款人資料結構
   * @typedef {Object} RepayPerson
   * @property {string} name - 姓名
   * @property {number} debt - 欠款金額
   */

  /**
   * 課程資料結構
   * @typedef {Object} Course
   * @property {number} fee - 課程總費用
   * @property {number} months - 課程期數(月份)
   */

  /**
   * 主元件
   */
  function App() {

    // 基本輸入欄位狀態
    const [salary, setSalary] = useState('');
    const [livingExpense, setLivingExpense] = useState('');
    const [startMonth, setStartMonth] = useState(1);

    // 還款人列表 (RepayPerson[])
    const [repayList, setRepayList] = useState([]);
    // 新增還款人欄位
    const [newPersonName, setNewPersonName] = useState('');
    const [newPersonDebt, setNewPersonDebt] = useState('');

    // 課程列表 (Course[])
    const [courseList, setCourseList] = useState([]);
    // 新增課程欄位
    const [newCourseFee, setNewCourseFee] = useState('');
    const [newCourseMonths, setNewCourseMonths] = useState('');

    // 錯誤訊息
    const [errorMsg, setErrorMsg] = useState('');

    // 計算結果狀態
    const [calcResult, setCalcResult] = useState(null);

    // Chart.js 圖表實例引用
    const chartRef = useRef(null);
    const chartInstanceRef = useRef(null);

    // ====== 輸入控制與驗證 ======
    // 驗證數字格式，允許空白或合法正數
    function validatePositiveNumber(val) {
      if (val === '') return true;
      return !isNaN(val) && Number(val) >= 0;
    }

    // ====== 新增還款人功能 ======
    function addRepayPerson() {
      setErrorMsg('');
      if (!newPersonName.trim()) {
        setErrorMsg('請輸入還款人姓名');
        return;
      }
      if (!newPersonDebt.trim() || isNaN(newPersonDebt) || Number(newPersonDebt) <= 0) {
        setErrorMsg('欠款金額必須是大於0的數字');
        return;
      }
      // 檢查姓名是否重複
      if (repayList.some(p => p.name === newPersonName.trim())) {
        setErrorMsg('還款人姓名不可重複');
        return;
      }
      setRepayList([...repayList, { name: newPersonName.trim(), debt: Number(newPersonDebt) }]);
      setNewPersonName('');
      setNewPersonDebt('');
    }

    // ====== 新增課程功能 ======
    function addCourse() {
      setErrorMsg('');
      if (!newCourseFee.trim() || isNaN(newCourseFee) || Number(newCourseFee) <= 0) {
        setErrorMsg('課程費用必須是大於0的數字');
        return;
      }
      if (!newCourseMonths.trim() || isNaN(newCourseMonths) || !Number.isInteger(Number(newCourseMonths)) || Number(newCourseMonths) <= 0) {
        setErrorMsg('課程期數必須是大於0的整數');
        return;
      }
      setCourseList([...courseList, { fee: Number(newCourseFee), months: Number(newCourseMonths) }]);
      setNewCourseFee('');
      setNewCourseMonths('');
    }

    // ====== 移除還款人 ======
    function removeRepayPerson(index) {
      if (!window.confirm(`確定要移除還款人 ${repayList[index].name} 嗎？`)) return;
      const newList = [...repayList];
      newList.splice(index, 1);
      setRepayList(newList);
    }

    // ====== 移除課程 ======
    function removeCourse(index) {
      if (!window.confirm(`確定要移除課程 #${index + 1} 嗎？`)) return;
      const newList = [...courseList];
      newList.splice(index, 1);
      setCourseList(newList);
    }

    // ====== 計算還款計畫 ======
    function calculateRepaymentPlan() {
      setErrorMsg('');
      setCalcResult(null);

      const sal = Number(salary);
      const expense = Number(livingExpense);
      const startMon = Number(startMonth);

      if (isNaN(sal) || sal <= 0) {
        setErrorMsg('請輸入正確的每月薪水 (大於0)');
        return;
      }
      if (isNaN(expense) || expense < 0) {
        setErrorMsg('請輸入正確的每月生活費 (不可為負數)');
        return;
      }
      if (!Number.isInteger(startMon) || startMon < 1 || startMon > 12) {
        setErrorMsg('起始月份必須是1~12的整數');
        return;
      }
      if (repayList.length === 0) {
        setErrorMsg('請至少新增一位還款人');
        return;
      }
      if (courseList.length === 0) {
        setErrorMsg('請至少新增一門課程');
        return;
      }

      // 課程每月費用合計
      const totalCourseMonthlyFee = courseList.reduce((sum, c) => sum + c.fee / c.months, 0);

      if (totalCourseMonthlyFee > sal - expense) {
        setErrorMsg('課程月費超過薪水扣除生活費後的可用額度');
        return;
      }

      // 每月可用還款額度
      const monthlyRepayBudget = sal - expense - totalCourseMonthlyFee;

      // 欠款總額
      const totalDebt = repayList.reduce((sum, p) => sum + p.debt, 0);
      if (totalDebt <= 0) {
        setErrorMsg('欠款總額必須大於0');
        return;
      }

      // 複製剩餘欠款
      let remainingDebts = repayList.map(p => ({ ...p }));
      let monthCount = 0;
      let plan = [];

      // 最多計算200期，避免死循環
      while (remainingDebts.some(p => p.debt > 0) && monthCount < 200) {
        monthCount++;
        const monthNumber = ((startMon + monthCount - 2) % 12) + 1;
        let budget = monthlyRepayBudget;
        const monthPayment = {};

        // 欠款總和
        const currentDebtSum = remainingDebts.reduce((sum, p) => sum + p.debt, 0);

        remainingDebts.forEach(p => {
          if (p.debt <= 0) {
            monthPayment[p.name] = 0;
            return;
          }
          const ratio = p.debt / currentDebtSum;
          let payAmount = Math.min(Math.round(monthlyRepayBudget * ratio * 100) / 100, p.debt, budget);
          budget -= payAmount;
          p.debt = Math.round((p.debt - payAmount) * 100) / 100;
          monthPayment[p.name] = payAmount;
        });

        // 將剩餘預算平均分配給尚未還清的還款人
        if (budget > 0) {
          const debtors = remainingDebts.filter(p => p.debt > 0);
          if (debtors.length > 0) {
            const extraPerPerson = Math.round((budget / debtors.length) * 100) / 100;
            debtors.forEach(p => {
              const extraPay = Math.min(extraPerPerson, p.debt);
              p.debt = Math.round((p.debt - extraPay) * 100) / 100;
              monthPayment[p.name] += extraPay;
            });
          }
        }

        plan.push({ month: monthNumber, pays: { ...monthPayment } });
      }

      setCalcResult({
        totalDebt,
        monthlyRepayBudget,
        totalCourseMonthlyFee,
        totalMonths: monthCount,
        plan,
      });
    }

    // ====== 複製結果文字 ======
    function copyResultToClipboard() {
      if (!calcResult) {
        alert('請先計算還款計畫');
        return;
      }
      let text = `每月可用還款額度：${calcResult.monthlyRepayBudget.toFixed(2)} 元\n`;
      text += `總欠款金額：${calcResult.totalDebt.toFixed(2)} 元\n`;
      text += `課程每月費用：${calcResult.totalCourseMonthlyFee.toFixed(2)} 元\n`;
      text += `估計還款期數：約 ${calcResult.totalMonths} 個月\n\n`;
      text += `詳細每月還款計畫：\n`;

      calcResult.plan.forEach((m, idx) => {
        text += `第${idx + 1}個月 (月份: ${m.month}月):\n`;
        Object.entries(m.pays).forEach(([name, pay]) => {
          text += `  ${name}: ${pay.toFixed(2)} 元\n`;
        });
        text += '\n';
      });

      navigator.clipboard.writeText(text).then(() => alert('已複製結果到剪貼簿'));
    }

    // ====== 匯出 CSV ======
    function exportCsvFile() {
      if (!calcResult) {
        alert('請先計算還款計畫');
        return;
      }
      let csv = '月份,還款人,還款金額\n';
      calcResult.plan.forEach(m => {
        Object.entries(m.pays).forEach(([name, pay]) => {
          csv += `${m.month},${name},${pay.toFixed(2)}\n`;
        });
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `repayment_plan_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // ====== Chart.js 顯示欠款分布 ======
    useEffect(() => {
      if (chartInstanceRef.current) {
        chartInstanceRef.current.destroy();
      }
      if (repayList.length === 0) return;

      const ctx = chartRef.current.getContext('2d');
      chartInstanceRef.current = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: repayList.map(p => p.name),
          datasets: [{
            label: '欠款金額',
            data: repayList.map(p => p.debt),
            backgroundColor: [
              '#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6',
              '#06b6d4', '#db2777', '#6d28d9', '#ca8a04', '#4ade80'
            ],
            borderWidth: 1,
          }],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: { font: { size: 14 } }
            },
            tooltip: { enabled: true },
            title: {
              display: true,
              text: '還款人欠款比例圖',
              font: { size: 18, weight: 'bold' }
            },
          },
          cutout: '60%',
        },
      });
    }, [repayList]);

    // ====== 主畫面渲染 ======
    return (
      <main role="main" aria-label="超級還款試算表主畫面">
        <h1>💰 超級還款試算表</h1>

        {/* 薪資與生活費輸入 */}
        <section className="section" aria-labelledby="salary-expense-label">
          <h2 id="salary-expense-label">基本資料輸入</h2>
          <div className="flex-row">
            <div className="flex-col">
              <label htmlFor="salary">每月薪水 (元)</label>
              <input
                type="number"
                id="salary"
                min="0"
                step="100"
                placeholder="輸入每月薪水"
                value={salary}
                onChange={e => validatePositiveNumber(e.target.value) && setSalary(e.target.value)}
                aria-required="true"
              />
            </div>
            <div className="flex-col">
              <label htmlFor="living-expense">每月生活費 (元)</label>
              <input
                type="number"
                id="living-expense"
                min="0"
                step="100"
                placeholder="輸入每月生活費"
                value={livingExpense}
                onChange={e => validatePositiveNumber(e.target.value) && setLivingExpense(e.target.value)}
                aria-required="true"
              />
            </div>
            <div className="flex-col" style={{minWidth: '120px'}}>
              <label htmlFor="start-month">起始月份</label>
              <select
                id="start-month"
                value={startMonth}
                onChange={e => setStartMonth(Number(e.target.value))}
                aria-required="true"
              >
                {[...Array(12).keys()].map(m => (
                  <option key={m+1} value={m+1}>{m+1} 月</option>
                ))}
              </select>
            </div>
          </div>
        </section>

        {/* 還款人新增與列表 */}
        <section className="section" aria-labelledby="repay-list-label">
          <h2 id="repay-list-label">新增還款人</h2>
          <div className="flex-row" style={{alignItems: 'flex-end'}}>
            <div className="flex-col">
              <label htmlFor="new-person-name">姓名</label>
              <input
                type="text"
                id="new-person-name"
                placeholder="輸入還款人姓名"
                value={newPersonName}
                onChange={e => setNewPersonName(e.target.value)}
                aria-required="true"
                maxLength={20}
              />
            </div>
            <div className="flex-col">
              <label htmlFor="new-person-debt">欠款金額 (元)</label>
              <input
                type="number"
                id="new-person-debt"
                min="0"
                step="100"
                placeholder="輸入欠款金額"
                value={newPersonDebt}
                onChange={e => validatePositiveNumber(e.target.value) && setNewPersonDebt(e.target.value)}
                aria-required="true"
              />
            </div>
            <div>
              <button onClick={addRepayPerson} aria-label="新增還款人">新增</button>
            </div>
          </div>

          {/* 還款人列表表格 */}
          {repayList.length === 0 ? (
            <p style={{marginTop:'12px'}}>尚無還款人資料</p>
          ) : (
            <div className="table-wrapper" role="table" aria-label="還款人列表" style={{marginTop:'12px'}}>
              <table>
                <thead>
                  <tr>
                    <th>姓名</th>
                    <th>欠款金額 (元)</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  {repayList.map((p, i) => (
                    <tr key={i}>
                      <td>{p.name}</td>
                      <td>{p.debt.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                      <td>
                        <button
                          onClick={() => removeRepayPerson(i)}
                          aria-label={`移除還款人 ${p.name}`}
                          style={{backgroundColor:'#ef4444', margin: '0 auto', display:'block'}}
                        >刪除</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* 課程新增與列表 */}
        <section className="section" aria-labelledby="course-list-label">
          <h2 id="course-list-label">新增課程</h2>
          <div className="flex-row" style={{alignItems: 'flex-end'}}>
            <div className="flex-col">
              <label htmlFor="new-course-fee">課程總費用 (元)</label>
              <input
                type="number"
                id="new-course-fee"
                min="0"
                step="100"
                placeholder="輸入課程費用"
                value={newCourseFee}
                onChange={e => validatePositiveNumber(e.target.value) && setNewCourseFee(e.target.value)}
                aria-required="true"
              />
            </div>
            <div className="flex-col" style={{minWidth:'140px'}}>
              <label htmlFor="new-course-months">課程期數 (月)</label>
              <input
                type="number"
                id="new-course-months"
                min="1"
                max="100"
                step="1"
                placeholder="輸入課程期數"
                value={newCourseMonths}
                onChange={e => {
                  const val = e.target.value;
                  if (val === '' || (/^\d+$/.test(val) && Number(val) > 0 && Number(val) <= 100)) {
                    setNewCourseMonths(val);
                  }
                }}
                aria-required="true"
              />
            </div>
            <div>
              <button onClick={addCourse} aria-label="新增課程">新增</button>
            </div>
          </div>

          {/* 課程列表表格 */}
          {courseList.length === 0 ? (
            <p style={{marginTop:'12px'}}>尚無課程資料</p>
          ) : (
            <div className="table-wrapper" role="table" aria-label="課程列表" style={{marginTop:'12px'}}>
              <table>
                <thead>
                  <tr>
                    <th>課程編號</th>
                    <th>課程總費用 (元)</th>
                    <th>課程期數 (月)</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody>
                  {courseList.map((c, i) => (
                    <tr key={i}>
                      <td>{i+1}</td>
                      <td>{c.fee.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                      <td>{c.months}</td>
                      <td>
                        <button
                          onClick={() => removeCourse(i)}
                          aria-label={`移除課程編號 ${i+1}`}
                          style={{backgroundColor:'#ef4444', margin: '0 auto', display:'block'}}
                        >刪除</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* 錯誤訊息 */}
        {errorMsg && <p className="error-msg" role="alert">{errorMsg}</p>}

        {/* 計算按鈕 */}
        <div style={{textAlign: 'center', marginBottom: '32px'}}>
          <button
            onClick={calculateRepaymentPlan}
            aria-label="開始計算還款計畫"
            style={{minWidth:'260px', fontWeight:'700', fontSize:'1.3rem'}}
          >
            計算還款計畫
          </button>
        </div>

        {/* 計算結果 */}
        {calcResult && (
          <section className="section" aria-labelledby="result-label">
            <h2 id="result-label">試算結果</h2>
            <p>每月可用還款額度：<strong>{calcResult.monthlyRepayBudget.toFixed(2)}</strong> 元</p>
            <p>總欠款金額：<strong>{calcResult.totalDebt.toFixed(2)}</strong> 元</p>
            <p>課程每月費用合計：<strong>{calcResult.totalCourseMonthlyFee.toFixed(2)}</strong> 元</p>
            <p>估計還款期數：約 <strong>{calcResult.totalMonths}</strong> 個月</p>

            <div
              className="chart-container"
              role="img"
              aria-label="欠款比例圓餅圖"
              style={{maxWidth:'480px', margin:'20px auto'}}
            >
              <canvas ref={chartRef} width="480" height="360"></canvas>
            </div>

            {/* 每月還款明細表格 */}
            <div className="table-wrapper" style={{maxHeight:'480px'}}>
              <table aria-label="每月還款計畫明細" style={{tableLayout:'fixed'}}>
                <thead>
                  <tr>
                    <th style={{width:'80px'}}>月份</th>
                    {repayList.map(p => (
                      <th key={p.name} style={{wordBreak:'break-word'}}>{p.name}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {calcResult.plan.map((m, idx) => (
                    <tr key={idx}>
                      <td>{m.month} 月</td>
                      {repayList.map(p => (
                        <td key={p.name}>{(m.pays[p.name] || 0).toFixed(2)}</td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* 複製與匯出按鈕 */}
            <div style={{marginTop:'24px', textAlign:'center'}}>
              <button onClick={copyResultToClipboard} aria-label="複製還款結果">複製結果</button>
              <button onClick={exportCsvFile} aria-label="匯出還款計畫 CSV" style={{marginLeft:'16px'}}>匯出 CSV</button>
            </div>
          </section>
        )}

      </main>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>
