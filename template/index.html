<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>💰 超級還款試算表 - 專業版</title>

  <!-- React & ReactDOM -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <!-- Babel for JSX in browser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0; padding: 0;
      background-color: #f0f4f8;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
    }
    #root {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      padding-bottom: 4rem; /* 留給固定footer空間 */
    }
    /* fixed footer */
    footer {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: #1f2937; /* Tailwind gray-800 */
      color: #d1d5db; /* Tailwind gray-300 */
      padding: 0.75rem 1rem;
      box-shadow: inset 0 1px 0 rgba(255 255 255 / 0.1);
      font-size: 0.875rem; /* text-sm */
      z-index: 1000;
    }
    footer a {
      color: #9ca3af; /* Tailwind gray-400 */
      text-decoration: none;
      margin: 0 1rem;
      transition: color 0.2s ease-in-out;
    }
    footer a:hover {
      color: #f9fafb; /* Tailwind gray-50 */
      text-decoration: underline;
    }
    /* Scrollbar for table overflow */
    .table-container {
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <footer className="footer">
    <nav className="flex justify-center">
      <a href="/privacy" target="_blank" rel="noopener noreferrer">隱私權政策</a>
      <a href="/terms" target="_blank" rel="noopener noreferrer">服務條款</a>
      <a href="/disclaimer" target="_blank" rel="noopener noreferrer">免責聲明</a>
      <a href="/contact" target="_blank" rel="noopener noreferrer">聯絡我們</a>
    </nav>
  </footer>

  <script type="text/babel">

  // Utility: currency formatter
  const currencyFormatter = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD' });

  // ErrorBoundary元件，捕捉子元件錯誤
  class ErrorBoundary extends React.Component {
    constructor(props) {
      super(props);
      this.state = { hasError: false, error: null };
    }
    static getDerivedStateFromError(error) {
      return { hasError: true, error };
    }
    componentDidCatch(error, info) {
      console.error("ErrorBoundary caught:", error, info);
    }
    render() {
      if (this.state.hasError) {
        return (
          <div className="p-8 text-center">
            <h1 className="text-3xl font-bold text-red-600 mb-4">發生錯誤</h1>
            <p className="mb-6">請重新整理頁面或聯絡客服。</p>
            <button
              onClick={() => window.location.reload()}
              className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
            >
              重新整理
            </button>
          </div>
        );
      }
      return this.props.children;
    }
  }

  // 新增還款人表單
  function AddPersonForm({ onAdd }) {
    const [name, setName] = React.useState('');
    const [debt, setDebt] = React.useState('');

    function handleSubmit(e) {
      e.preventDefault();
      if (!name.trim()) { alert('姓名不能空白'); return; }
      if (isNaN(parseFloat(debt)) || parseFloat(debt) <= 0) { alert('欠款金額需大於0'); return; }
      onAdd(name.trim(), parseFloat(debt));
      setName('');
      setDebt('');
    }

    return (
      <form onSubmit={handleSubmit} className="mb-4 p-4 bg-white rounded shadow">
        <h2 className="text-xl font-semibold mb-3">新增還款人</h2>
        <div className="flex flex-col sm:flex-row gap-4 items-center">
          <input
            className="border p-2 rounded flex-grow"
            placeholder="姓名"
            value={name}
            onChange={e => setName(e.target.value)}
            required
          />
          <input
            type="number"
            className="border p-2 rounded flex-grow"
            placeholder="欠款金額 (NT$)"
            value={debt}
            onChange={e => setDebt(e.target.value)}
            required
            min="0"
            step="0.01"
          />
          <button type="submit" className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
            新增
          </button>
        </div>
      </form>
    );
  }

  // 新增課程表單
  function AddCourseForm({ onAdd }) {
    const [fee, setFee] = React.useState('');
    const [months, setMonths] = React.useState('');

    function handleSubmit(e) {
      e.preventDefault();
      if (isNaN(parseFloat(fee)) || parseFloat(fee) <= 0) { alert('課程費用需大於0'); return; }
      if (!Number.isInteger(Number(months)) || Number(months) <= 0) { alert('課程期數需為大於0整數'); return; }
      onAdd(parseFloat(fee), parseInt(months));
      setFee('');
      setMonths('');
    }

    return (
      <form onSubmit={handleSubmit} className="mb-4 p-4 bg-white rounded shadow">
        <h2 className="text-xl font-semibold mb-3">新增課程</h2>
        <div className="flex flex-col sm:flex-row gap-4 items-center">
          <input
            type="number"
            className="border p-2 rounded flex-grow"
            placeholder="課程總費用 (NT$)"
            value={fee}
            onChange={e => setFee(e.target.value)}
            min="0"
            step="0.01"
            required
          />
          <input
            type="number"
            className="border p-2 rounded flex-grow"
            placeholder="期數"
            value={months}
            onChange={e => setMonths(e.target.value)}
            min="1"
            required
          />
          <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            新增
          </button>
        </div>
      </form>
    );
  }

  // 還款人列表
  function RepayList({ list, onRemove }) {
    return (
      <div className="mb-6 p-4 bg-white rounded shadow">
        <h2 className="text-xl font-semibold mb-3">還款人列表</h2>
        <div className="table-container max-h-96 overflow-auto">
          <table className="min-w-full border border-gray-300">
            <thead className="bg-gray-100 sticky top-0">
              <tr>
                <th className="border px-4 py-2">姓名</th>
                <th className="border px-4 py-2">欠款金額 (NT$)</th>
                <th className="border px-4 py-2">操作</th>
              </tr>
            </thead>
            <tbody>
              {list.length === 0 && (
                <tr><td colSpan="3" className="text-center p-4 text-gray-500">尚無資料</td></tr>
              )}
              {list.map((p, i) => (
                <tr key={i} className="hover:bg-gray-50">
                  <td className="border px-4 py-2">{p.name}</td>
                  <td className="border px-4 py-2">{currencyFormatter.format(p.debt)}</td>
                  <td className="border px-4 py-2 text-center">
                    <button
                      onClick={() => onRemove(i)}
                      className="text-red-600 hover:text-red-800"
                      title="移除"
                    >❌</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  }

  // 課程列表
  function CourseList({ list, onRemove }) {
    return (
      <div className="mb-6 p-4 bg-white rounded shadow">
        <h2 className="text-xl font-semibold mb-3">課程列表</h2>
        <div className="table-container max-h-80 overflow-auto">
          <table className="min-w-full border border-gray-300">
            <thead className="bg-gray-100 sticky top-0">
              <tr>
                <th className="border px-4 py-2">課程費用 (NT$)</th>
                <th className="border px-4 py-2">期數</th>
                <th className="border px-4 py-2">操作</th>
              </tr>
            </thead>
            <tbody>
              {list.length === 0 && (
                <tr><td colSpan="3" className="text-center p-4 text-gray-500">尚無資料</td></tr>
              )}
              {list.map((c, i) => (
                <tr key={i} className="hover:bg-gray-50">
                  <td className="border px-4 py-2">{currencyFormatter.format(c.fee)}</td>
                  <td className="border px-4 py-2 text-center">{c.months}</td>
                  <td className="border px-4 py-2 text-center">
                    <button
                      onClick={() => onRemove(i)}
                      className="text-red-600 hover:text-red-800"
                      title="移除"
                    >❌</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    );
  }

  // 薪資與生活費設定表單
  function SalaryExpenseForm({ salary, livingExpense, startMonth, onSetSalary, onSetExpense, onSetMonth }) {
    const [salaryInput, setSalaryInput] = React.useState(salary);
    const [expenseInput, setExpenseInput] = React.useState(livingExpense);
    const [monthInput, setMonthInput] = React.useState(startMonth);

    React.useEffect(() => { setSalaryInput(salary); }, [salary]);
    React.useEffect(() => { setExpenseInput(livingExpense); }, [livingExpense]);
    React.useEffect(() => { setMonthInput(startMonth); }, [startMonth]);

    function onSalaryBlur() {
      onSetSalary(parseFloat(salaryInput));
    }
    function onExpenseBlur() {
      onSetExpense(parseFloat(expenseInput));
    }
    function onMonthBlur() {
      const m = parseInt(monthInput);
      if (m >= 1 && m <= 12) {
        onSetMonth(m);
      } else {
        alert("起始月份必須是1~12");
        setMonthInput(startMonth);
      }
    }

    return (
      <div className="mb-6 p-4 bg-white rounded shadow grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div>
          <label className="block font-semibold mb-1">薪資 (NT$)</label>
          <input
            type="number"
            min="0"
            step="0.01"
            className="border p-2 rounded w-full"
            value={salaryInput}
            onChange={e => setSalaryInput(e.target.value)}
            onBlur={onSalaryBlur}
          />
        </div>
        <div>
          <label className="block font-semibold mb-1">生活費 (NT$)</label>
          <input
            type="number"
            min="0"
            step="0.01"
            className="border p-2 rounded w-full"
            value={expenseInput}
            onChange={e => setExpenseInput(e.target.value)}
            onBlur={onExpenseBlur}
          />
        </div>
        <div>
          <label className="block font-semibold mb-1">起始月份</label>
          <input
            type="number"
            min="1"
            max="12"
            className="border p-2 rounded w-full"
            value={monthInput}
            onChange={e => setMonthInput(e.target.value)}
            onBlur={onMonthBlur}
          />
        </div>
      </div>
    );
  }

  // 試算結果顯示與複製匯出區塊
  function ResultPanel({ result, onCopy, onExportCsv }) {
    // 將試算結果（字串或JSON）解析成表格顯示
    const [tableData, setTableData] = React.useState({ headers: [], rows: [] });

    React.useEffect(() => {
      if (!result) {
        setTableData({ headers: [], rows: [] });
        return;
      }
      // 嘗試解析JSON
      try {
        const parsed = JSON.parse(result);
        if (parsed.headers && parsed.rows) {
          setTableData(parsed);
          return;
        }
      } catch {}

      // 嘗試用Tab分隔字串拆表
      const lines = result.trim().split('\n');
      if (lines.length > 1) {
        const headers = lines[0].split('\t').map(h => h.trim());
        const rows = lines.slice(1).map(l => l.split('\t').map(cell => cell.trim()));
        setTableData({ headers, rows });
      }
    }, [result]);

    return (
      <div className="mb-6 p-4 bg-white rounded shadow">
        <h2 className="text-xl font-semibold mb-3">試算結果</h2>
        {result ? (
          <>
            <div className="table-container max-h-80 overflow-auto mb-4">
              <table className="min-w-full border border-gray-300">
                <thead className="bg-gray-100 sticky top-0">
                  <tr>
                    {tableData.headers.map((h, i) => (
                      <th key={i} className="border px-4 py-2 text-left">{h}</th>
                    ))}
                  </tr>
                </thead>
                <tbody>
                  {tableData.rows.map((row, rIdx) => (
                    <tr key={rIdx} className={rIdx % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                      {row.map((cell, cIdx) => (
                        <td key={cIdx} className="border px-4 py-2">{cell}</td>
                      ))}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <div className="flex gap-4 justify-end">
              <button
                onClick={onCopy}
                className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              >
                複製結果
              </button>
              <button
                onClick={onExportCsv}
                className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
              >
                匯出 CSV
              </button>
            </div>
          </>
        ) : (
          <p className="text-gray-500">尚無試算結果</p>
        )}
      </div>
    );
  }

  // Chart元件（顯示總欠款分布圓餅圖）
  function DebtChart({ repayList }) {
    const canvasRef = React.useRef(null);
    React.useEffect(() => {
      if (!canvasRef.current) return;

      const existingChart = Chart.getChart(canvasRef.current);
      if (existingChart) existingChart.destroy();

      const labels = repayList.map(p => p.name);
      const dataValues = repayList.map(p => p.debt);

      if (dataValues.length === 0) return;

      const colors = [
        '#3b82f6','#10b981','#ef4444','#f59e0b','#8b5cf6',
        '#06b6d4','#db2777','#6d28d9','#ca8a04','#4ade80'
      ];

      new Chart(canvasRef.current, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: dataValues,
            backgroundColor: colors.slice(0, labels.length),
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { enabled: true }
          }
        }
      });

    }, [repayList]);

    return (
      <div className="mb-6 p-4 bg-white rounded shadow max-w-md mx-auto">
        <h2 className="text-xl font-semibold mb-3 text-center">欠款分布圓餅圖</h2>
        {repayList.length === 0 ? (
          <p className="text-center text-gray-500">尚無還款人資料</p>
        ) : (
          <canvas ref={canvasRef}></canvas>
        )}
      </div>
    );
  }

  // 主App元件
  function App() {
    // 狀態管理
    const [salary, setSalary] = React.useState(0);
    const [livingExpense, setLivingExpense] = React.useState(5000);
    const [startMonth, setStartMonth] = React.useState(1);

    const [repayList, setRepayList] = React.useState([]);
    const [courseList, setCourseList] = React.useState([]);

    const [resultText, setResultText] = React.useState('');

    // 新增還款人
    function addPerson(name, debt) {
      setRepayList(prev => [...prev, { name, debt }]);
    }
    // 刪除還款人
    function removePerson(idx) {
      setRepayList(prev => prev.filter((_, i) => i !== idx));
    }

    // 新增課程
    function addCourse(fee, months) {
      setCourseList(prev => [...prev, { fee, months }]);
    }
    // 刪除課程
    function removeCourse(idx) {
      setCourseList(prev => prev.filter((_, i) => i !== idx));
    }

    // 執行試算主邏輯
    function runCalculation() {
      // 檢查基本資料
      if (salary <= 0) {
        alert("薪資需大於0");
        return;
      }
      if (livingExpense < 0) {
        alert("生活費不可為負");
        return;
      }
      if (startMonth < 1 || startMonth > 12) {
        alert("起始月份需介於1~12");
        return;
      }
      if (repayList.length === 0) {
        alert("請至少新增一個還款人");
        return;
      }
      if (courseList.length === 0) {
        alert("請至少新增一個課程");
        return;
      }

      // 假設邏輯：計算還款總額與時間，簡單試算 (可自行擴充)
      // 還款月可用薪資扣除生活費，均分給欠款人和課程分期。

      const availablePerMonth = salary - livingExpense;
      if (availablePerMonth <= 0) {
        alert("薪資扣除生活費後須大於0");
        return;
      }

      // 總欠款與課程總期數計算
      const totalDebt = repayList.reduce((a, c) => a + c.debt, 0);
      const totalCourseFee = courseList.reduce((a, c) => a + c.fee, 0);
      const totalCourseMonths = courseList.reduce((a, c) => a + c.months, 0);

      // 還款人分攤金額比例
      const repayRatios = repayList.map(p => p.debt / totalDebt);

      // 開始產生試算表（CSV樣式文字）
      let output = "月份\t還款人\t欠款餘額\t課程分期支出\t可支配金額\n";

      // 簡單邏輯：每月先扣課程分期費用，剩下的可支配金額均分給還款人還款
      // 課程分期費用 = 各課程費用 / 期數，期數期間內每月繳交，超過期數後0
      // 欠款餘額每月減少還款金額

      // 初始化欠款餘額
      let debtsLeft = repayList.map(p => p.debt);

      let monthIdx = startMonth;
      let year = new Date().getFullYear();

      let maxIter = 240; // 最多試算20年防死循環

      for (let i = 0; i < maxIter; i++) {
        if (debtsLeft.every(d => d <= 0)) break; // 全部還清

        // 該月課程分期支出
        let coursePayThisMonth = 0;
        for (const c of courseList) {
          if (i < c.months) coursePayThisMonth += c.fee / c.months;
        }

        // 可支配金額：扣除課程分期後
        let disposable = availablePerMonth - coursePayThisMonth;
        if (disposable < 0) disposable = 0;

        // 還款人每人分攤
        let repayThisMonth = debtsLeft.map((d, idx) => {
          if (d <= 0) return 0;
          return Math.min(d, disposable * repayRatios[idx]);
        });

        // 扣除還款
        debtsLeft = debtsLeft.map((d, idx) => Math.max(0, d - repayThisMonth[idx]));

        // 計算月份顯示文字
        let displayMonth = `${year}年${monthIdx}月`;

        // 將每還款人結果輸出
        for (let j = 0; j < repayList.length; j++) {
          output += `${displayMonth}\t${repayList[j].name}\t${debtsLeft[j].toFixed(2)}\t${coursePayThisMonth.toFixed(2)}\t${disposable.toFixed(2)}\n`;
        }

        monthIdx++;
        if (monthIdx > 12) {
          monthIdx = 1;
          year++;
        }
      }

      setResultText(output);
    }

    // 複製結果文字到剪貼簿
    function copyResultToClipboard() {
      if (!resultText) return;
      navigator.clipboard.writeText(resultText).then(() => {
        alert("結果已複製到剪貼簿！");
      });
    }

    // 匯出 CSV 檔案
    function exportCsv() {
      if (!resultText) return;
      const blob = new Blob([resultText], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `repay_calculation_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    return (
      <div className="flex-grow max-w-6xl mx-auto p-4">
        <h1 className="text-3xl font-bold text-center mb-8">💰 超級還款試算表 - 專業版</h1>

        <SalaryExpenseForm
          salary={salary}
          livingExpense={livingExpense}
          startMonth={startMonth}
          onSetSalary={setSalary}
          onSetExpense={setLivingExpense}
          onSetMonth={setStartMonth}
        />

        <AddPersonForm onAdd={addPerson} />
        <RepayList list={repayList} onRemove={removePerson} />

        <AddCourseForm onAdd={addCourse} />
        <CourseList list={courseList} onRemove={removeCourse} />

        <div className="flex justify-center mb-6">
          <button
            onClick={runCalculation}
            className="bg-purple-700 text-white px-6 py-3 rounded hover:bg-purple-800 transition"
          >
            執行試算
          </button>
        </div>

        <ResultPanel
          result={resultText}
          onCopy={copyResultToClipboard}
          onExportCsv={exportCsv}
        />

        <DebtChart repayList={repayList} />
      </div>
    );
  }

  // Render App with ErrorBoundary
  ReactDOM.createRoot(document.getElementById('root')).render(
    <ErrorBoundary>
      <App />
    </ErrorBoundary>
  );
  </script>
</body>
</html>
