<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ğŸ’° Qç‰ˆé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</title>
    <style>
        /* --- åŸºæœ¬CSS Reset èˆ‡å­—å‹è¨­å®š --- */
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fef6f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        header {
            background: #c83e3e;
            color: #fff;
            padding: 18px 20px;
            font-weight: 900;
            font-size: 1.7rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(200, 62, 62, 0.5);
            user-select: none;
        }
        main {
            flex-grow: 1;
            max-width: 960px;
            margin: 20px auto 60px auto;
            background: #fff5f5;
            border-radius: 12px;
            box-shadow: 0 6px 16px #f2b7b7cc;
            padding: 20px 30px;
        }
        h2 {
            border-left: 5px solid #c83e3e;
            padding-left: 12px;
            color: #a13131;
            margin-top: 30px;
            margin-bottom: 12px;
            font-weight: 800;
        }
        label {
            display: block;
            margin: 10px 0 6px 0;
            font-weight: 600;
            color: #7a2a2a;
        }
        /* æ‰€æœ‰è¼¸å…¥æ¡†å’Œé¸å–®éƒ½è®Šæˆåœ“è§’ */
        input[type="number"],
        input[type="text"],
        input[type="email"], /* For contact form email input */
        textarea, /* For contact form message textarea */
        select {
            width: 100%;
            padding: 10px 14px;
            border-radius: 20px; /* Qç‰ˆåœ“è§’ */
            border: 2px solid #f6c2c2;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        input[type="number"]:focus,
        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus,
        select:focus {
            border-color: #c83e3e;
            outline: none;
        }
        button {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 28px;
            border: none;
            background: #c83e3e;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            user-select: none;
        }
        button + button { /* Added for spacing between buttons */
            margin-left: 10px;
        }
        button:hover {
            background: #a83131;
        }
        .list-group {
            margin: 8px 0 16px 0;
        }
        .list-item {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            background: #f6c2c2aa;
            border-radius: 22px; /* Qç‰ˆæ©¢åœ“å½¢åˆ—è¡¨é …ç›® */
            padding: 12px 16px;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s;
        }
        .list-item:hover {
            background: #f08a8a;
        }
        .list-item input[type="text"],
        .list-item input[type="number"] {
            flex: 1;
            font-size: 1rem;
            border: 1.5px solid #f9a3a3;
            border-radius: 16px; /* Qç‰ˆåˆ—è¡¨å…§éƒ¨è¼¸å…¥æ¡†åœ“è§’ */
            padding: 6px 10px;
        }
        .btn-remove {
            flex-shrink: 0;
            background: #a02a2a;
            border-radius: 50%;
            color: white;
            font-weight: 900;
            border: none;
            width: 30px;
            height: 30px;
            font-size: 1.3rem;
            line-height: 28px;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 0 6px #a02a2aaa;
            transition: background-color 0.2s;
        }
        .btn-remove:hover {
            background: #d14a4a;
            box-shadow: 0 0 8px #d14a4aaa;
        }
        #resultArea {
            margin-top: 20px;
            background: #fceaea;
            border-radius: 22px; /* Qç‰ˆçµæœå€å¡Šåœ“è§’ */
            border: 2px dashed #c83e3e;
            padding: 18px 24px;
            font-weight: 700;
            white-space: pre-wrap;
            color: #7a2a2a;
            min-height: 120px;
            overflow-y: auto;
        }
        #chartsArea {
            margin-top: 24px;
            background: #fff0f0;
            border-radius: 22px; /* Qç‰ˆåœ–è¡¨å€å¡Šåœ“è§’ */
            padding: 12px 16px;
            box-shadow: inset 0 0 8px #f9a3a3cc;
            display: flex;
            justify-content: center;
        }
        canvas {
            max-width: 100%;
            height: auto !important;
        }
        footer {
            background: #c83e3e; /* ä¿®æ­£å› Q ç‰ˆé¢¨æ ¼çš„æ·±ç´…è‰² */
            color: #fff; /* ä¿®æ­£å›ç™½è‰²æ–‡å­— */
            text-align: center;
            padding: 16px 10px;
            font-weight: 600;
            user-select: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            font-size: 0.95rem;
            box-shadow: 0 -2px 5px rgba(200, 62, 62, 0.4); /* åº•éƒ¨é™°å½± */
        }
        footer a {
            color: #fff0f0;
            text-decoration: none;
            margin: 0 8px;
            font-weight: 700;
            transition: color 0.3s;
        }
        footer a:hover {
            color: #ffd1d1;
            text-decoration: underline;
        }
        @media (max-width: 480px) {
            main {
                margin: 10px 10px 80px 10px;
                padding: 16px 14px;
            }
            .list-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .list-item input[type="text"],
            .list-item input[type="number"] {
                width: 100%;
                border-radius: 20px; /* åœ¨å°è¢å¹•ä¸‹ä¹Ÿä¿æŒåœ“è§’ */
            }
            .btn-remove {
                align-self: flex-end;
                margin-top: 8px;
            }
        }
    </style>
</head>
<body>

<header>ğŸ’° Qç‰ˆé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</header>

<main>
    <section id="basicInfo">
        <h2>åŸºæœ¬è³‡æ–™</h2>
        <label for="inputSalary">æ¯æœˆè–ªè³‡ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="inputSalary" min="0" placeholder="è«‹è¼¸å…¥æ¯æœˆè–ªè³‡" />
        <label for="inputExpense">æ¯æœˆç”Ÿæ´»è²»ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="inputExpense" min="0" placeholder="è«‹è¼¸å…¥æ¯æœˆç”Ÿæ´»è²»" />
    </section>

    <section id="debtorsSection">
        <h2>å‚µå‹™äººæ¸…å–®</h2>
        <div id="debtorsList" class="list-group"></div>
        <button id="btnAddDebtor" type="button">ï¼‹ æ–°å¢å‚µå‹™äºº</button>
    </section>

    <section id="coursesSection">
        <h2>èª²ç¨‹æ¸…å–®</h2>
        <div id="coursesList" class="list-group"></div>
        <button id="btnAddCourse" type="button">ï¼‹ æ–°å¢èª²ç¨‹</button>
    </section>

    <section id="startMonthSection">
        <h2>èµ·å§‹æœˆä»½</h2>
        <label for="selectStartMonth">é¸æ“‡èµ·å§‹æœˆä»½</label>
        <select id="selectStartMonth">
            <option value="1">1 æœˆ</option>
            <option value="2">2 æœˆ</option>
            <option value="3">3 æœˆ</option>
            <option value="4">4 æœˆ</option>
            <option value="5">5 æœˆ</option>
            <option value="6">6 æœˆ</option>
            <option value="7">7 æœˆ</option>
            <option value="8">8 æœˆ</option>
            <option value="9">9 æœˆ</option>
            <option value="10">10 æœˆ</option>
            <option value="11">11 æœˆ</option>
            <option value="12">12 æœˆ</option>
        </select>
    </section>

    <section id="actions">
        <button id="btnCalculate" type="button">é–‹å§‹è¨ˆç®—</button>
        <button id="btnExportCSV" type="button" disabled>åŒ¯å‡º CSV</button>
        <button id="btnClearResults" type="button" disabled>æ¸…é™¤å…¨éƒ¨</button>
        <button id="btnCopyResults" type="button" disabled>è¤‡è£½çµæœ</button>
        <button id="btnExportPDF" type="button" disabled>åŒ¯å‡º PDF</button>
    </section>

    <section id="resultSection">
        <h2>è¨ˆç®—çµæœ</h2>
        <pre id="resultArea">è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€</pre>
    </section>

    <section id="chartsSection">
        <h2>å‚µå‹™æ¯”ä¾‹åœ“é¤…åœ–</h2>
        <div id="chartsArea">
            <canvas id="pieChart"></canvas>
        </div>
    </section>
    <section id="contactForm" style="margin-top: 50px;">
        <h2>è¯çµ¡æˆ‘å€‘</h2>
        <form action="https://formsubmit.co/a3017255@gmail.com" method="POST">
            <label for="name">æ‚¨çš„å§“åï¼š</label>
            <input type="text" id="name" name="name" required><br><br>

            <label for="email">æ‚¨çš„ Emailï¼š</label>
            <input type="email" id="email" name="email" required><br><br>

            <label for="message">è¨Šæ¯å…§å®¹ï¼š</label><br>
            <textarea id="message" name="message" rows="5" required></textarea><br><br>

            <button type="submit">é€å‡º</button>
        </form>
    </section>
</main>

<footer style="text-align: center; font-size: 0.9rem; padding: 14px 10px; background: #c83e3e; color: #fff; margin-top: auto; box-shadow: inset 0 1px 4px #ffbabacc;">
    <a href="/about" target="_blank" rel="noopener noreferrer" style="color: #fff0f0; font-weight: 700; text-decoration: none; margin: 0 8px;">é—œæ–¼æˆ‘å€‘</a> |
    <a href="#contactForm" style="color: #fff0f0; font-weight: 700; text-decoration: none; margin: 0 8px;">è¯çµ¡æˆ‘å€‘</a> |
    <a href="/privacy" target="_blank" rel="noopener noreferrer" style="color: #fff0f0; font-weight: 700; text-decoration: none; margin: 0 8px;">éš±ç§æ¬Šæ”¿ç­–</a> |
    <a href="/terms" target="_blank" rel="noopener noreferrer" style="color: #fff0f0; font-weight: 700; text-decoration: none; margin: 0 8px;">æœå‹™æ¢æ¬¾</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // Global state object to hold all calculator data
    const state = {
        salary: 0,
        livingExpense: 0,
        startMonth: 1,
        debtors: [],
        courses: [],
        monthRecords: [],
    };

    // DOM Element references
    const inputSalary = document.getElementById('inputSalary');
    const inputExpense = document.getElementById('inputExpense');
    const selectStartMonth = document.getElementById('selectStartMonth');
    const debtorsList = document.getElementById('debtorsList');
    const coursesList = document.getElementById('coursesList');
    const btnAddDebtor = document.getElementById('btnAddDebtor');
    const btnAddCourse = document.getElementById('btnAddCourse');
    const btnCalculate = document.getElementById('btnCalculate');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnClearResults = document.getElementById('btnClearResults');
    const btnCopyResults = document.getElementById('btnCopyResults');
    const btnExportPDF = document.getElementById('btnExportPDF');
    const resultArea = document.getElementById('resultArea');
    const chartsArea = document.getElementById('chartsArea');

    let pieChart = null; // To store the Chart.js instance

    /**
     * Creates a new debtor input item.
     * @param {string} name - Initial debtor name.
     * @param {string} debt - Initial debt amount.
     * @returns {HTMLElement} The created list item div.
     */
    function createDebtorItem(name = '', debt = '') {
        const div = document.createElement('div');
        div.className = 'list-item';

        const inputName = document.createElement('input');
        inputName.type = 'text';
        inputName.placeholder = 'å§“å';
        inputName.value = name;
        inputName.autocomplete = "off";

        const inputDebt = document.createElement('input');
        inputDebt.type = 'number';
        inputDebt.placeholder = 'æ¬ æ¬¾é‡‘é¡';
        inputDebt.min = 0;
        inputDebt.value = debt;

        const btnRemove = document.createElement('button');
        btnRemove.className = 'btn-remove';
        btnRemove.title = "ç§»é™¤å‚µå‹™äºº";
        btnRemove.innerHTML = '&times;'; // Unicode multiplication sign for 'x'
        btnRemove.onclick = () => {
            div.remove(); // Remove the item from the DOM
            updateStateFromUI(); // Update the global state
            clearResultDisplayOnly(); // Clear results as input changed
        };

        // Add event listeners to inputs for real-time state updates
        inputName.addEventListener('input', updateStateFromUI);
        inputDebt.addEventListener('input', updateStateFromUI);

        div.appendChild(inputName);
        div.appendChild(inputDebt);
        div.appendChild(btnRemove);

        return div;
    }

    /**
     * Creates a new course input item.
     * @param {string} name - Initial course name.
     * @param {string} fee - Initial course fee.
     * @param {string} months - Initial repayment months.
     * @returns {HTMLElement} The created list item div.
     */
    function createCourseItem(name = '', fee = '', months = '') {
        const div = document.createElement('div');
        div.className = 'list-item';

        const inputName = document.createElement('input');
        inputName.type = 'text';
        inputName.placeholder = 'èª²ç¨‹åç¨±';
        inputName.value = name;
        inputName.autocomplete = "off";

        const inputFee = document.createElement('input');
        inputFee.type = 'number';
        inputFee.placeholder = 'èª²ç¨‹è²»ç”¨';
        inputFee.min = 0;
        inputFee.value = fee;

        const inputMonths = document.createElement('input');
        inputMonths.type = 'number';
        inputMonths.placeholder = 'æœŸæ•¸ï¼ˆæœˆï¼‰';
        inputMonths.min = 1;
        inputMonths.value = months;

        const btnRemove = document.createElement('button');
        btnRemove.className = 'btn-remove';
        btnRemove.title = "ç§»é™¤èª²ç¨‹";
        btnRemove.innerHTML = '&times;';
        btnRemove.onclick = () => {
            div.remove();
            updateStateFromUI();
            clearResultDisplayOnly(); // Clear results as input changed
        };

        inputName.addEventListener('input', updateStateFromUI);
        inputFee.addEventListener('input', updateStateFromUI);
        inputMonths.addEventListener('input', updateStateFromUI);

        div.appendChild(inputName);
        div.appendChild(inputFee);
        div.appendChild(inputMonths);
        div.appendChild(btnRemove);

        return div;
    }

    // Event listener for adding a new debtor
    btnAddDebtor.addEventListener('click', () => {
        const item = createDebtorItem();
        debtorsList.appendChild(item);
        clearResultDisplayOnly(); // Clear results on new item added
    });

    // Event listener for adding a new course
    btnAddCourse.addEventListener('click', () => {
        const item = createCourseItem();
        coursesList.appendChild(item);
        clearResultDisplayOnly(); // Clear results on new item added
    });

    /**
     * Updates the global state object by reading values from the UI.
     * This function should be called whenever input values might have changed.
     */
    function updateStateFromUI() {
        state.salary = parseFloat(inputSalary.value) || 0;
        state.livingExpense = parseFloat(inputExpense.value) || 0;
        state.startMonth = parseInt(selectStartMonth.value, 10) || 1;

        // Collect debtor data
        state.debtors = [];
        [...debtorsList.children].forEach(div => {
            const inputs = div.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const debt = parseFloat(inputs[1].value);
            if (name && !isNaN(debt) && debt > 0) {
                state.debtors.push({ name, debt });
            }
        });

        // Collect course data
        state.courses = [];
        [...coursesList.children].forEach(div => {
            const inputs = div.querySelectorAll('input');
            const name = inputs[0].value.trim() || "èª²ç¨‹";
            const fee = parseFloat(inputs[1].value);
            const months = parseInt(inputs[2].value, 10);
            if (!isNaN(fee) && fee > 0 && !isNaN(months) && months > 0) {
                state.courses.push({ name, fee, months });
            }
        });

        // Disable result buttons until calculation is performed again
        btnExportCSV.disabled = true;
        // btnClearResults is always available
        btnCopyResults.disabled = true;
        btnExportPDF.disabled = true;
    }

    /**
     * Displays an alert message to the user.
     * @param {string} msg - The message to display.
     */
    function showError(msg) {
        alert(msg);
    }

    /**
     * Calculates the repayment plan based on the current state.
     * @returns {object|null} An object containing calculation results or null if validation fails.
     */
    function calculateRepaymentPlan() {
        // Input validation
        if (state.salary <= 0) {
            showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„è–ªè³‡ï¼');
            clearResultDisplayOnly();
            return null;
        }
        if (state.livingExpense < 0) {
            showError('ç”Ÿæ´»è²»ä¸å¯ç‚ºè² æ•¸ï¼');
            clearResultDisplayOnly();
            return null;
        }
        if (state.livingExpense >= state.salary) {
            showError('ç”Ÿæ´»è²»ä¸å¯å¤§æ–¼æˆ–ç­‰æ–¼è–ªè³‡ï¼Œè«‹èª¿æ•´ï¼');
            clearResultDisplayOnly();
            return null;
        }
        if (state.debtors.length === 0 && state.courses.length === 0) {
            showError('è«‹è‡³å°‘æ–°å¢ä¸€ä½å‚µå‹™äººæˆ–ä¸€å€‹èª²ç¨‹ï¼');
            clearResultDisplayOnly();
            return null;
        }

        const disposableIncome = state.salary - state.livingExpense;

        // Initialize remaining debts and course fees
        const debtsRemaining = {};
        state.debtors.forEach(d => debtsRemaining[d.name] = d.debt);
        const coursesRemaining = state.courses.map(c => ({
            ...c,
            monthlyPayment: c.fee / c.months, // Calculate monthly payment for courses
            remainingFee: c.fee
        }));

        const startYear = new Date().getFullYear();

        const monthRecords = [];
        let monthCount = 0;
        const maxMonths = 2000; // Safety limit to prevent infinite loops

        const repayCompletionDates = {};
        const courseCompletionDates = {};

        // Main calculation loop
        while (true) {
            const allDebtsCleared = Object.values(debtsRemaining).every(v => v <= 0.001);
            const allCoursesCleared = coursesRemaining.every(c => c.remainingFee <= 0.001);

            if (allDebtsCleared && allCoursesCleared) break; // All cleared, exit loop

            if (monthCount > maxMonths) {
                showError('è¨ˆç®—è¶…éæœ€å¤§æœˆä»½ï¼Œå¯èƒ½å­˜åœ¨ç„¡æ³•é‚„æ¸…çš„å‚µå‹™æˆ–èª²ç¨‹ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢ºã€‚');
                clearResultDisplayOnly();
                return null;
            }

            const currentMonthIndex = (state.startMonth - 1 + monthCount) % 12 + 1;
            const currentYear = startYear + Math.floor((state.startMonth - 1 + monthCount) / 12);

            let currentBudget = disposableIncome; // Budget for the current month

            const activeDebtors = Object.entries(debtsRemaining).filter(([_, debt]) => debt > 0.001);
            const activeCourses = coursesRemaining.filter(c => c.remainingFee > 0.001);

            const totalActiveItems = activeDebtors.length + activeCourses.length;

            if (totalActiveItems > 0) {
                const budgetPerItem = currentBudget / totalActiveItems; // Distribute budget evenly among active items

                // Pay off debtors first
                activeDebtors.forEach(([name, debt]) => {
                    const payAmount = Math.min(debt, budgetPerItem);
                    debtsRemaining[name] -= payAmount;
                    currentBudget -= payAmount; // Reduce budget
                    if (debtsRemaining[name] <= 0.001 && !(name in repayCompletionDates)) {
                        repayCompletionDates[name] = { year: currentYear, month: currentMonthIndex };
                    }
                });

                // Then pay off courses using remaining budget
                activeCourses.forEach(course => {
                    const payAmount = Math.min(course.remainingFee, course.monthlyPayment, budgetPerItem);
                    course.remainingFee -= payAmount;
                    currentBudget -= payAmount; // Reduce budget
                    if (course.remainingFee <= 0.001 && !(course.name in courseCompletionDates)) {
                        courseCompletionDates[course.name] = { year: currentYear, month: currentMonthIndex };
                    }
                });
            }


            // Record monthly data (deep copy current state for records)
            monthRecords.push({
                year: currentYear,
                month: currentMonthIndex,
                debtsRemaining: JSON.parse(JSON.stringify(debtsRemaining)),
                coursesRemaining: coursesRemaining.map(c => ({ name: c.name, remainingFee: c.remainingFee })),
                budgetLeft: currentBudget
            });

            monthCount++;
        }

        state.monthRecords = monthRecords; // Store the full record in global state

        return {
            repayCompletionDates,
            courseCompletionDates,
            monthCount,
            disposableIncome
        };
    }

    /**
     * Displays the calculated results in the result area.
     * @param {object} calcResult - The result object from calculateRepaymentPlan.
     */
    function displayResults(calcResult) {
        let text = `ğŸ“… è¨ˆç®—èµ·å§‹æœˆä»½ï¼š${state.startMonth} æœˆ\n`;
        text += `ğŸ’° è–ªè³‡ï¼š${state.salary.toLocaleString()} å…ƒ\n`;
        text += `ğŸ  ç”Ÿæ´»è²»ï¼š${state.livingExpense.toLocaleString()} å…ƒ\n`;
        text += `ğŸ”¢ ç¸½é‚„æ¬¾æœŸæ•¸ï¼šç´„ **${calcResult.monthCount}** å€‹æœˆ\n\n`;

        text += '--- å‚µå‹™äººé‚„æ¸…æ™‚é–“ ---\n';
        if (Object.keys(calcResult.repayCompletionDates).length === 0) {
            text += 'Â  ç„¡å‚µå‹™äººæˆ–å‚µå‹™å·²æ¸…ã€‚\n';
        } else {
            for (const [name, date] of Object.entries(calcResult.repayCompletionDates)) {
                text += `Â  - **${name}** ğŸ—“ï¸ ${date.year}/${String(date.month).padStart(2, '0')} é‚„æ¸…\n`;
            }
        }

        text += '\n--- èª²ç¨‹è²»ç”¨ç¹³æ¸…æ™‚é–“ ---\n';
        if (Object.keys(calcResult.courseCompletionDates).length === 0) {
            text += 'Â  ç„¡èª²ç¨‹æˆ–èª²ç¨‹è²»ç”¨å·²æ¸…ã€‚\n';
        } else {
            for (const [name, date] of Object.entries(calcResult.courseCompletionDates)) {
                text += `Â  - **${name}** ğŸ—“ï¸ ${date.year}/${String(date.month).padStart(2, '0')} ç¹³æ¸…\n`;
            }
        }

        text += `\n--- æ¯æœˆé‚„æ¬¾åˆ†é…æ˜ç´° ---\n`;
        state.monthRecords.forEach((rec, index) => {
            text += `\nğŸ“† ${rec.year}/${String(rec.month).padStart(2, '0')} (ç¬¬ ${index + 1} æœˆ)\n`;

            // Debtor payments for the current month
            state.debtors.forEach(debtor => {
                const currentRemaining = rec.debtsRemaining[debtor.name] || 0;
                let prevRemaining = debtor.debt; // Default for first month
                if (index > 0 && state.monthRecords[index - 1].debtsRemaining[debtor.name] !== undefined) {
                    prevRemaining = state.monthRecords[index - 1].debtsRemaining[debtor.name];
                }
                const paidThisMonth = prevRemaining - currentRemaining;
                if (paidThisMonth > 0.001) {
                    text += `Â  ğŸ’³ **${debtor.name}** é‚„æ¬¾ ${paidThisMonth.toFixed(2).toLocaleString()} å…ƒ\n`;
                }
            });

            // Course payments for the current month
            state.courses.forEach(course => {
                const currentRemaining = rec.coursesRemaining.find(c => c.name === course.name)?.remainingFee || 0;
                let prevRemaining = course.fee; // Default for first month
                if (index > 0) {
                    const prevCourse = state.monthRecords[index - 1].coursesRemaining.find(c => c.name === course.name);
                    if (prevCourse) {
                        prevRemaining = prevCourse.remainingFee;
                    }
                }
                const paidThisMonth = prevRemaining - currentRemaining;
                if (paidThisMonth > 0.001) {
                    text += `Â  ğŸ“ **${course.name}** ç¹³è²» ${paidThisMonth.toFixed(2).toLocaleString()} å…ƒ\n`;
                }
            });

            if (rec.budgetLeft > 0.001) {
                text += `Â  å‰©é¤˜é ç®—ï¼š${rec.budgetLeft.toFixed(2).toLocaleString()} å…ƒ\n`;
            }
            text += `----------------------------------------\n`;
        });

        resultArea.innerHTML = text.replace(/\n/g, '<br>'); // Use innerHTML to render bold and line breaks
    }

    /**
     * Renders or updates the pie chart based on current debtor data.
     */
    function renderPieChart() {
        if (pieChart) {
            pieChart.destroy(); // Destroy existing chart instance
            pieChart = null;
        }

        const totalDebt = state.debtors.reduce((sum, d) => sum + d.debt, 0);
        if (totalDebt <= 0) {
            chartsArea.style.display = 'none'; // Hide chart area if no debt
            return;
        }
        chartsArea.style.display = 'flex'; // Show chart area

        const labels = state.debtors.map(d => d.name);
        const data = state.debtors.map(d => d.debt);

        // Fun and vibrant colors
        const backgroundColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40',
            '#C9CBCE', '#7B68EE', '#FFDAB9', '#ADFF2F', '#8A2BE2'
        ];

        const ctx = document.getElementById('pieChart').getContext('2d');

        pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å‚µå‹™æ¯”ä¾‹',
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: { size: 14, weight: '600' },
                            color: '#a13131',
                            padding: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => {
                                const total = ctx.dataset.data.reduce((sum, val) => sum + val, 0);
                                const percentage = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
                                return `${ctx.label}: ${ctx.parsed.toLocaleString()} å…ƒ (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    /**
     * Generates a CSV string from the monthRecords.
     * @returns {string} The CSV content.
     */
    function generateCSV() {
        if (!state.monthRecords || state.monthRecords.length === 0) return '';

        // Headers for CSV
        const headers = ['å¹´æœˆ', 'æ¯æœˆç¸½é‚„æ¬¾é‡‘é¡'];
        state.debtors.forEach(d => headers.push(`å‚µå‹™-${d.name}`));
        state.courses.forEach(c => headers.push(`èª²ç¨‹-${c.name}`));
        headers.push('å‰©é¤˜é ç®—');

        let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';

        // Data rows
        state.monthRecords.forEach(r => {
            const yearMonth = `${r.year}å¹´${String(r.month).padStart(2, '0')}æœˆ`;
            let totalMonthlyPayment = 0;

            const debtPayments = state.debtors.map(d => {
                const currentRemaining = r.debtsRemaining[d.name] || 0;
                let prevRemaining = d.debt;
                const recordIndex = state.monthRecords.indexOf(r);
                if (recordIndex > 0) {
                    const prevRecord = state.monthRecords[recordIndex - 1];
                    prevRemaining = prevRecord.debtsRemaining[d.name] || 0;
                }
                const paid = prevRemaining - currentRemaining;
                totalMonthlyPayment += paid;
                return paid.toFixed(2);
            });

            const coursePayments = state.courses.map(c => {
                const currentRemaining = r.coursesRemaining.find(crs => crs.name === c.name)?.remainingFee || 0;
                let prevRemaining = c.fee;
                const recordIndex = state.monthRecords.indexOf(r);
                if (recordIndex > 0) {
                    const prevRecord = state.monthRecords[recordIndex - 1];
                    const prevCourse = prevRecord.coursesRemaining.find(crs => crs.name === c.name);
                    if (prevCourse) prevRemaining = prevCourse.remainingFee;
                }
                const paid = prevRemaining - currentRemaining;
                totalMonthlyPayment += paid;
                return paid.toFixed(2);
            });

            const row = [
                yearMonth,
                totalMonthlyPayment.toFixed(2),
                ...debtPayments,
                ...coursePayments,
                r.budgetLeft.toFixed(2)
            ];
            csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });

        return csvContent;
    }

    /**
     * Triggers the download of a CSV file.
     * @param {string} filename - The desired filename for the CSV.
     * @param {string} csvContent - The content of the CSV file.
     */
    function downloadCSV(filename, csvContent) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.style.display = 'none'; // Hide the link
        document.body.appendChild(link);
        link.click(); // Programmatically click the link to trigger download
        document.body.removeChild(link); // Clean up
    }

    /**
     * Clears only the result display area and chart, keeping inputs.
     * Used when input fields are changed, indicating calculation is no longer current.
     */
    function clearResultDisplayOnly() {
        resultArea.innerHTML = 'è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€';
        if (pieChart) {
            pieChart.destroy();
            pieChart = null;
        }
        chartsArea.style.display = 'none';
        state.monthRecords = []; // Clear recorded data
        btnExportCSV.disabled = true;
        btnCopyResults.disabled = true;
        btnExportPDF.disabled = true;
        btnClearResults.disabled = false; // "æ¸…é™¤å…¨éƒ¨" button should always be available
    }

    /**
     * Clears all input fields, dynamic lists, results, and resets the state.
     * This is the "Clear All" functionality.
     */
    function clearAllInputsAndResults() {
        // Clear input fields
        inputSalary.value = '';
        inputExpense.value = '';
        selectStartMonth.value = '1'; // Reset to January

        // Clear dynamic lists by removing all children
        debtorsList.innerHTML = '';
        coursesList.innerHTML = '';

        // Reset global state to initial values
        state.salary = 0;
        state.livingExpense = 0;
        state.startMonth = 1;
        state.debtors = [];
        state.courses = [];
        state.monthRecords = [];

        // Clear result display and chart
        resultArea.innerHTML = 'è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€';
        if (pieChart) {
            pieChart.destroy();
            pieChart = null;
        }
        chartsArea.style.display = 'none';

        // Disable result-related buttons
        btnExportCSV.disabled = true;
        btnClearResults.disabled = false; // "Clear All" should always be active
        btnCopyResults.disabled = true;
        btnExportPDF.disabled = true;
    }

    // --- Event Listeners for Buttons ---

    btnCalculate.addEventListener('click', () => {
        updateStateFromUI(); // Ensure state is up-to-date

        const calcResult = calculateRepaymentPlan();
        if (!calcResult) {
            // If calculation failed (e.g., due to validation errors),
            // calculateRepaymentPlan would have shown an error and cleared results.
            return;
        }

        displayResults(calcResult);
        renderPieChart();
        btnExportCSV.disabled = false;
        // btnClearResults.disabled = false; // This button is generally always enabled
        btnCopyResults.disabled = false;
        btnExportPDF.disabled = false;
    });

    btnExportCSV.addEventListener('click', () => {
        const csv = generateCSV();
        if (!csv) {
            alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™ï¼');
            return;
        }
        const filename = `é‚„æ¬¾è©¦ç®—è¡¨_${new Date().toISOString().slice(0, 10)}.csv`;
        downloadCSV(filename, csv);
    });

    // The "Clear All" button
    btnClearResults.addEventListener('click', () => {
        clearAllInputsAndResults();
        // After clearing, add initial debtor and course items for user convenience
        btnAddDebtor.click();
        btnAddCourse.click();
    });

    btnCopyResults.addEventListener('click', async () => {
        try {
            const textToCopy = resultArea.innerText; // Use innerText to get plain text
            if (!textToCopy || textToCopy.includes('è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€')) {
                alert('æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½ï¼è«‹å…ˆé€²è¡Œè¨ˆç®—ã€‚');
                return;
            }
            await navigator.clipboard.writeText(textToCopy);
            alert('è¨ˆç®—çµæœå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        } catch (err) {
            console.error('è¤‡è£½åˆ°å‰ªè²¼ç°¿å¤±æ•—ï¼š', err);
            // Fallback for browsers that don't support clipboard API or when it fails
            alert(
                'è¤‡è£½å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨å®‰å…¨é™åˆ¶æˆ–å…¶ä»–å•é¡Œã€‚\n' +
                'è«‹æ‚¨æ‰‹å‹•é¸å–ã€Œè¨ˆç®—çµæœã€å€å¡Šçš„æ‰€æœ‰æ–‡å­— (Ctrl+A / Cmd+A)ï¼Œ\n' +
                'ç„¶å¾ŒæŒ‰ Ctrl+C / Cmd+C é€²è¡Œè¤‡è£½ã€‚'
            );
        }
    });

    btnExportPDF.addEventListener('click', async () => {
        const { jsPDF } = window.jspdf;
        if (!jsPDF) {
            alert('PDF åŒ¯å‡ºå‡½å¼åº«æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚');
            console.error('jsPDF library not loaded.');
            return;
        }
        if (!window.html2canvas) {
            alert('PDF åŒ¯å‡ºå‡½å¼åº«æœªè¼‰å…¥ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–ç¨å¾Œå†è©¦ã€‚');
            console.error('html2canvas library not loaded.');
            return;
        }

        try {
            // Temporarily hide the footer to prevent it from being captured in the PDF
            const footerElement = document.querySelector('footer');
            const originalFooterDisplay = footerElement.style.display;
            footerElement.style.display = 'none';

            const mainElement = document.querySelector('main');
            const originalMainOverflow = mainElement.style.overflow;
            const originalMainPaddingBottom = mainElement.style.paddingBottom;

            // Ensure content isn't cut off during capture
            mainElement.style.overflow = 'visible';
            mainElement.style.paddingBottom = '50px'; // Add some padding for visual separation in PDF

            // Use a temporary clone to avoid altering the live DOM during capture
            const clonedMain = mainElement.cloneNode(true);
            clonedMain.style.position = 'absolute';
            clonedMain.style.top = '-9999px'; // Move off-screen
            clonedMain.style.left = '-9999px';
            clonedMain.style.width = mainElement.offsetWidth + 'px'; // Maintain original width
            clonedMain.style.height = 'auto'; // Let height adjust
            clonedMain.style.overflow = 'visible';
            document.body.appendChild(clonedMain);

            // Capture the cloned main element as a canvas image
            const canvas = await html2canvas(clonedMain, {
                scale: 2, // Increase resolution for better quality
                useCORS: true, // Allow cross-origin images if any
                logging: false, // Reduce console noise
                scrollY: -window.scrollY // Correct capture position
            });

            document.body.removeChild(clonedMain); // Remove the clone

            // Restore original styles
            footerElement.style.display = originalFooterDisplay;
            mainElement.style.overflow = originalMainOverflow;
            mainElement.style.paddingBottom = originalMainPaddingBottom;

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF('p', 'mm', 'a4'); // Portrait, millimeters, A4 size (210x297 mm)
            const imgWidth = 210 - 20; // A4 width minus 10mm margin on each side (20mm total)
            const pageHeight = 297; // A4 height
            let imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;

            let position = 10; // Start at 10mm from top

            // Add image to PDF, handling multiple pages if content is long
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= (pageHeight - position);

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight + 10; // Adjust position for next page
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            const filename = `é‚„æ¬¾è©¦ç®—çµæœ_${new Date().toISOString().slice(0, 10)}.pdf`;
            pdf.save(filename);
            alert('PDF å·²æˆåŠŸåŒ¯å‡ºï¼è«‹æª¢æŸ¥æ‚¨çš„ä¸‹è¼‰è³‡æ–™å¤¾ã€‚');

        } catch (err) {
            console.error('åŒ¯å‡º PDF å¤±æ•—ï¼š', err);
            alert('åŒ¯å‡º PDF å¤±æ•—ï¼Œè«‹ç¢ºèªæ‚¨çš„ç€è¦½å™¨æ˜¯å¦æ”¯æ´ï¼Œæˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤è©³æƒ…è«‹è¦‹ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·çš„ Consoleã€‚');
        }
    });

    // --- Initialization on page load ---
    window.onload = () => {
        clearAllInputsAndResults(); // Ensure a clean start
        btnAddDebtor.click(); // Add a default debtor input field
        btnAddCourse.click(); // Add a default course input field
        chartsArea.style.display = 'none'; // Hide chart area initially
        btnClearResults.disabled = false; // Enable "Clear All" from the start
    };

    // --- Input Change Event Listeners ---
    // Clear results display when any input changes, as the calculation becomes outdated
    inputSalary.addEventListener('input', clearResultDisplayOnly);
    inputExpense.addEventListener('input', clearResultDisplayOnly);
    selectStartMonth.addEventListener('change', clearResultDisplayOnly);

</script>

</body>
</html>
