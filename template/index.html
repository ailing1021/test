<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</title>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  /* --- åŸºæœ¬æ’ç‰ˆèˆ‡æ¨£å¼ --- */
  html, body {
    margin: 0; padding: 0; height: 100%;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f9fafb;
    color: #111827;
  }
  #root {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  main {
    flex-grow: 1;
    max-width: 1280px;
    margin: 20px auto 0 auto;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 15px rgba(0,0,0,0.1);
  }
  h1, h2, h3 {
    margin: 0 0 12px 0;
    font-weight: 700;
  }
  h1 {
    font-size: 2.5rem;
    color: #1e293b;
    text-align: center;
  }
  h2 {
    font-size: 1.7rem;
    color: #334155;
    border-bottom: 2px solid #3b82f6;
    padding-bottom: 4px;
    margin-bottom: 20px;
  }
  label {
    display: block;
    font-weight: 600;
    margin-bottom: 6px;
  }
  input[type="number"], input[type="text"], select {
    width: 100%;
    padding: 8px 12px;
    font-size: 1rem;
    border: 1px solid #cbd5e1;
    border-radius: 6px;
    outline-offset: 2px;
    outline-color: #3b82f6;
    box-sizing: border-box;
  }
  button {
    background-color: #3b82f6;
    border: none;
    color: white;
    font-size: 1rem;
    font-weight: 700;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    user-select: none;
  }
  button:hover {
    background-color: #2563eb;
  }
  button:disabled {
    background-color: #93c5fd;
    cursor: not-allowed;
  }
  .section {
    margin-bottom: 32px;
  }
  .flex-row {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
  }
  .flex-col {
    display: flex;
    flex-direction: column;
  }
  .flex-row > div, .flex-col > div {
    flex: 1;
    min-width: 250px;
  }
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    border: 1px solid #e2e8f0;
    padding: 12px 16px;
    text-align: center;
  }
  th {
    background-color: #f1f5f9;
    position: sticky;
    top: 0;
    z-index: 2;
  }
  .table-wrapper {
    max-height: 360px;
    overflow-y: auto;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
  }
  .error-msg {
    color: #dc2626;
    font-weight: 700;
    margin-bottom: 20px;
  }
  .footer {
    background-color: #f1f5f9;
    text-align: center;
    padding: 12px 0;
    font-size: 14px;
    color: #64748b;
    user-select: none;
    margin-top: auto;
    border-top: 1px solid #cbd5e1;
  }
  .footer a {
    color: #3b82f6;
    text-decoration: none;
    margin: 0 12px;
  }
  .footer a:hover {
    text-decoration: underline;
  }
  @media (max-width: 640px) {
    .flex-row {
      flex-direction: column;
    }
    .flex-row > div {
      min-width: 100%;
    }
  }
</style>
</head>
<body>
  <div id="root"></div>
<footer class="footer">
  <a href="http://localhost:5000/api/pages/privacy" target="_blank">éš±ç§æ¬Šæ”¿ç­–</a> |
  <a href="http://localhost:5000/api/pages/terms" target="_blank">ä½¿ç”¨æ¢æ¬¾</a> |
  <a href="http://localhost:5000/api/pages/about" target="_blank">é—œæ–¼æˆ‘å€‘</a> |
  <a href="http://localhost:5000/api/pages/contact" target="_blank">è¯çµ¡æˆ‘å€‘</a>
</footer>

<script type="text/babel">
  const { useState, useEffect, useRef } = React;

  // å®šç¾©æ•¸æ“šçµæ§‹é¡å‹ï¼ˆåƒ…ç‚ºæ–¹ä¾¿ç†è§£ï¼ŒJavaScript ä¸å¼·åˆ¶é¡å‹ï¼‰
  /**
   * é‚„æ¬¾äººè³‡æ–™çµæ§‹
   * @typedef {Object} RepayPerson
   * @property {string} name - å§“å
   * @property {number} debt - æ¬ æ¬¾é‡‘é¡
   */

  /**
   * èª²ç¨‹è³‡æ–™çµæ§‹
   * @typedef {Object} Course
   * @property {number} fee - èª²ç¨‹ç¸½è²»ç”¨
   * @property {number} months - èª²ç¨‹æœŸæ•¸(æœˆä»½)
   */

  /**
   * ä¸»å…ƒä»¶
   */
  function App() {
    // åŸºæœ¬è¼¸å…¥æ¬„ä½ç‹€æ…‹
    const [salary, setSalary] = useState('');
    const [livingExpense, setLivingExpense] = useState('');
    const [startMonth, setStartMonth] = useState(1);

    // é‚„æ¬¾äººåˆ—è¡¨ (RepayPerson[])
    const [repayList, setRepayList] = useState([]);
    // æ–°å¢é‚„æ¬¾äººæ¬„ä½
    const [newPersonName, setNewPersonName] = useState('');
    const [newPersonDebt, setNewPersonDebt] = useState('');

    // èª²ç¨‹åˆ—è¡¨ (Course[])
    const [courseList, setCourseList] = useState([]);
    // æ–°å¢èª²ç¨‹æ¬„ä½
    const [newCourseFee, setNewCourseFee] = useState('');
    const [newCourseMonths, setNewCourseMonths] = useState('');

    // éŒ¯èª¤è¨Šæ¯
    const [errorMsg, setErrorMsg] = useState('');

    // è¨ˆç®—çµæœç‹€æ…‹
    // é€™è£¡çš„ calcResult å°‡æœƒå„²å­˜å¾Œç«¯è¿”å›çš„çµæ§‹åŒ–æ•¸æ“š
    const [calcResult, setCalcResult] = useState(null);

    // Chart.js åœ–è¡¨å¯¦ä¾‹å¼•ç”¨
    const chartRef = useRef(null);
    const chartInstanceRef = useRef(null);

    // ====== åˆæ¬¡è¼‰å…¥æ™‚å¾å¾Œç«¯ç²å–ç•¶å‰ç‹€æ…‹ ======
    useEffect(() => {
      fetch('http://localhost:5000/api/get_current_state')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'success') {
            setSalary(data.salary === 0 ? '' : data.salary.toString());
            setLivingExpense(data.living_expense === 0 ? '' : data.living_expense.toString());
            setStartMonth(data.start_month);
            setRepayList(data.repay_list);
            setCourseList(data.course_list);
          } else {
            console.error('Failed to load initial state:', data.message);
          }
        })
        .catch(error => console.error('Error fetching initial state:', error));
    }, []); // ç©ºä¾è³´é™£åˆ—è¡¨ç¤ºåªåœ¨çµ„ä»¶æ›è¼‰æ™‚åŸ·è¡Œä¸€æ¬¡

    // ====== è¼¸å…¥æ§åˆ¶èˆ‡é©—è­‰ ======
    // é©—è­‰æ•¸å­—æ ¼å¼ï¼Œå…è¨±ç©ºç™½æˆ–åˆæ³•æ­£æ•¸ (å‰ç«¯å³æ™‚é©—è­‰)
    function validatePositiveNumber(val) {
      if (val === '') return true;
      return !isNaN(val) && Number(val) >= 0;
    }

    // å°‡è–ªæ°´å’Œç”Ÿæ´»è²»è®Šå‹•åŒæ­¥åˆ°å¾Œç«¯
    const handleSalaryChange = (e) => {
        const val = e.target.value;
        if (validatePositiveNumber(val)) {
            setSalary(val);
            fetch('http://localhost:5000/api/set_salary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ salary: Number(val) })
            }).then(res => res.json()).then(data => {
                if (data.status !== 'success') setErrorMsg(data.message);
            }).catch(err => setErrorMsg('æ›´æ–°è–ªæ°´å¤±æ•—'));
        }
    };

    const handleLivingExpenseChange = (e) => {
        const val = e.target.value;
        if (validatePositiveNumber(val)) {
            setLivingExpense(val);
            fetch('http://localhost:5000/api/set_living_expense', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ expense: Number(val) })
            }).then(res => res.json()).then(data => {
                if (data.status !== 'success') setErrorMsg(data.message);
            }).catch(err => setErrorMsg('æ›´æ–°ç”Ÿæ´»è²»å¤±æ•—'));
        }
    };

    const handleStartMonthChange = (e) => {
        const val = Number(e.target.value);
        setStartMonth(val);
        fetch('http://localhost:5000/api/set_start_month', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ start_month: val })
        }).then(res => res.json()).then(data => {
            if (data.status !== 'success') setErrorMsg(data.message);
        }).catch(err => setErrorMsg('æ›´æ–°èµ·å§‹æœˆä»½å¤±æ•—'));
    };

    // ====== æ–°å¢é‚„æ¬¾äººåŠŸèƒ½ (æ•¸æ“šç™¼é€åˆ°å¾Œç«¯) ======
    function addRepayPerson() {
      setErrorMsg('');
      if (!newPersonName.trim()) {
        setErrorMsg('è«‹è¼¸å…¥é‚„æ¬¾äººå§“å');
        return;
      }
      if (!newPersonDebt.trim() || isNaN(newPersonDebt) || Number(newPersonDebt) <= 0) {
        setErrorMsg('æ¬ æ¬¾é‡‘é¡å¿…é ˆæ˜¯å¤§æ–¼0çš„æ•¸å­—');
        return;
      }

      fetch('http://localhost:5000/api/add_person', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: newPersonName.trim(),
          debt: Number(newPersonDebt)
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.message || 'ä¼ºæœå™¨éŒ¯èª¤'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          setRepayList(data.repay_list); // ä½¿ç”¨å¾Œç«¯è¿”å›çš„æœ€æ–°åˆ—è¡¨æ›´æ–°ç‹€æ…‹
          setNewPersonName('');
          setNewPersonDebt('');
          setErrorMsg('');
        } else {
          setErrorMsg(data.message);
        }
      })
      .catch(error => {
        console.error('æ–°å¢é‚„æ¬¾äººå¤±æ•—:', error);
        setErrorMsg(`æ–°å¢å¤±æ•—ï¼š${error.message || 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤'}`);
      });
    }

    // ====== ç§»é™¤é‚„æ¬¾äºº (æ•¸æ“šç™¼é€åˆ°å¾Œç«¯) ======
    function removeRepayPerson(nameToRemove) {
      if (!window.confirm(`ç¢ºå®šè¦ç§»é™¤é‚„æ¬¾äºº ${nameToRemove} å—ï¼Ÿ`)) return;

      fetch('http://localhost:5000/api/remove_person', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: nameToRemove })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.message || 'ä¼ºæœå™¨éŒ¯èª¤'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          setRepayList(data.repay_list); // ä½¿ç”¨å¾Œç«¯è¿”å›çš„æœ€æ–°åˆ—è¡¨æ›´æ–°ç‹€æ…‹
          setErrorMsg('');
        } else {
          setErrorMsg(data.message);
        }
      })
      .catch(error => {
        console.error('ç§»é™¤é‚„æ¬¾äººå¤±æ•—:', error);
        setErrorMsg(`ç§»é™¤å¤±æ•—ï¼š${error.message || 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤'}`);
      });
    }

    // ====== æ–°å¢èª²ç¨‹åŠŸèƒ½ (æ•¸æ“šç™¼é€åˆ°å¾Œç«¯) ======
    function addCourse() {
      setErrorMsg('');
      if (!newCourseFee.trim() || isNaN(newCourseFee) || Number(newCourseFee) <= 0) {
        setErrorMsg('èª²ç¨‹è²»ç”¨å¿…é ˆæ˜¯å¤§æ–¼0çš„æ•¸å­—');
        return;
      }
      if (!newCourseMonths.trim() || isNaN(newCourseMonths) || !Number.isInteger(Number(newCourseMonths)) || Number(newCourseMonths) <= 0) {
        setErrorMsg('èª²ç¨‹æœŸæ•¸å¿…é ˆæ˜¯å¤§æ–¼0çš„æ•´æ•¸');
        return;
      }
      
      fetch('http://localhost:5000/api/add_course', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          fee: Number(newCourseFee),
          months: Number(newCourseMonths)
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.message || 'ä¼ºæœå™¨éŒ¯èª¤'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          setCourseList(data.course_list); // ä½¿ç”¨å¾Œç«¯è¿”å›çš„æœ€æ–°åˆ—è¡¨æ›´æ–°ç‹€æ…‹
          setNewCourseFee('');
          setNewCourseMonths('');
          setErrorMsg('');
        } else {
          setErrorMsg(data.message);
        }
      })
      .catch(error => {
        console.error('æ–°å¢èª²ç¨‹å¤±æ•—:', error);
        setErrorMsg(`æ–°å¢å¤±æ•—ï¼š${error.message || 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤'}`);
      });
    }

    // ====== ç§»é™¤èª²ç¨‹ (æ•¸æ“šç™¼é€åˆ°å¾Œç«¯) ======
    function removeCourse(indexToRemove) {
      if (!window.confirm(`ç¢ºå®šè¦ç§»é™¤èª²ç¨‹ #${indexToRemove + 1} å—ï¼Ÿ`)) return;

      fetch('http://localhost:5000/api/remove_course', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ index: indexToRemove })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => { throw new Error(err.message || 'ä¼ºæœå™¨éŒ¯èª¤'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          setCourseList(data.course_list); // ä½¿ç”¨å¾Œç«¯è¿”å›çš„æœ€æ–°åˆ—è¡¨æ›´æ–°ç‹€æ…‹
          setErrorMsg('');
        } else {
          setErrorMsg(data.message);
        }
      })
      .catch(error => {
        console.error('ç§»é™¤èª²ç¨‹å¤±æ•—:', error);
        setErrorMsg(`ç§»é™¤å¤±æ•—ï¼š${error.message || 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤'}`);
      });
    }

    // ====== å¾å¾Œç«¯è¨ˆç®—é‚„æ¬¾è¨ˆç•« ======
    function calculateRepaymentPlan() {
      setErrorMsg('');
      setCalcResult(null); // æ¸…é™¤ä¸Šæ¬¡çµæœ

      fetch('http://localhost:5000/api/calculate', { // <--- å‘å¾Œç«¯ API ç™¼é€è«‹æ±‚
        method: 'POST', // ä½¿ç”¨ POST æ–¹æ³•
        headers: {
          'Content-Type': 'application/json',
        },
        // body ä¸éœ€è¦åŒ…å«æ•¸æ“šï¼Œå› ç‚ºå¾Œç«¯æœƒå¾å…¶ç‹€æ…‹ä¸­ç²å–æ‰€æœ‰å¿…è¦æ•¸æ“š
        body: JSON.stringify({}) // ç™¼é€ä¸€å€‹ç©ºçš„ JSON ç‰©ä»¶
      })
      .then(response => {
        if (!response.ok) { // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
          return response.json().then(err => { throw new Error(err.message || 'ä¼ºæœå™¨éŒ¯èª¤'); });
        }
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          // å¾Œç«¯ç¾åœ¨è¿”å›äº†çµæ§‹åŒ–çš„æ•¸æ“šï¼Œå¯ä»¥ç›´æ¥æ›´æ–°ç‹€æ…‹
          setCalcResult({
            totalDebt: data.total_debt,
            monthlyRepayBudget: data.monthly_repay_budget,
            totalCourseMonthlyFee: data.total_course_monthly_fee,
            totalMonths: data.total_months,
            plan: data.repayment_plan, // è©³ç´°çš„æ¯æœˆè¨ˆç•«
            repayCompletionDates: data.repay_completion_dates,
            courseCompletionDates: data.course_completion_dates,
            summaryText: data.summary_text // å®Œæ•´çš„æ–‡å­—æ‘˜è¦
          });
          setErrorMsg('');
        } else {
          setErrorMsg(data.message);
        }
      })
      .catch(error => {
        console.error('è¨ˆç®—é‚„æ¬¾è¨ˆç•«å¤±æ•—:', error);
        setErrorMsg(`è¨ˆç®—å¤±æ•—ï¼š${error.message || 'ç¶²è·¯æˆ–ä¼ºæœå™¨éŒ¯èª¤'}`);
      });
    }

    // ====== è¤‡è£½çµæœæ–‡å­— (ä½¿ç”¨å¾Œç«¯æä¾›çš„æ‘˜è¦) ======
    function copyResultToClipboard() {
      if (!calcResult || !calcResult.summaryText) {
        alert('è«‹å…ˆè¨ˆç®—é‚„æ¬¾è¨ˆç•«');
        return;
      }
      navigator.clipboard.writeText(calcResult.summaryText).then(() => alert('å·²è¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿'));
    }

    // ====== åŒ¯å‡º CSV (è«‹æ±‚å¾Œç«¯ç”Ÿæˆä¸¦ä¸‹è¼‰) ======
    function exportCsvFile() {
      if (!calcResult) {
        alert('è«‹å…ˆè¨ˆç®—é‚„æ¬¾è¨ˆç•«æ‰èƒ½åŒ¯å‡ºCSV');
        return;
      }
      // ç›´æ¥è®“ç€è¦½å™¨å°å‘åˆ°å¾Œç«¯åŒ¯å‡º CSV çš„ API
      window.location.href = 'http://localhost:5000/api/export_csv';
    }

    // ====== Chart.js é¡¯ç¤ºæ¬ æ¬¾åˆ†å¸ƒ (åŸºæ–¼å‰ç«¯çš„ repayList ç‹€æ…‹) ======
    useEffect(() => {
      if (chartInstanceRef.current) {
        chartInstanceRef.current.destroy(); // éŠ·æ¯€èˆŠçš„ Chart å¯¦ä¾‹
      }
      if (repayList.length === 0 || !chartRef.current) { // å¦‚æœæ²’æœ‰é‚„æ¬¾äººæˆ– canvas ä¸å­˜åœ¨ï¼Œå‰‡ä¸ç¹ªåœ–
        return;
      }

      const ctx = chartRef.current.getContext('2d');
      chartInstanceRef.current = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: repayList.map(p => p.name),
          datasets: [{
            label: 'æ¬ æ¬¾é‡‘é¡',
            data: repayList.map(p => p.debt),
            backgroundColor: [
              '#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6',
              '#06b6d4', '#db2777', '#6d28d9', '#ca8a04', '#4ade80'
            ],
            borderWidth: 1,
          }],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: { font: { size: 14 } }
            },
            tooltip: { enabled: true },
            title: {
              display: true,
              text: 'é‚„æ¬¾äººæ¬ æ¬¾æ¯”ä¾‹åœ–',
              font: { size: 18, weight: 'bold' }
            },
          },
          cutout: '60%',
        },
      });
    }, [repayList]); // ç•¶ repayList æ”¹è®Šæ™‚é‡æ–°ç¹ªè£½åœ–è¡¨

    // ====== ä¸»ç•«é¢æ¸²æŸ“ ======
    return (
      <main role="main" aria-label="è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ä¸»ç•«é¢">
        <h1>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</h1>

        {/* è–ªè³‡èˆ‡ç”Ÿæ´»è²»è¼¸å…¥ */}
        <section className="section" aria-labelledby="salary-expense-label">
          <h2 id="salary-expense-label">åŸºæœ¬è³‡æ–™è¼¸å…¥</h2>
          <div className="flex-row">
            <div className="flex-col">
              <label htmlFor="salary">æ¯æœˆè–ªæ°´ (å…ƒ)</label>
              <input
                type="number"
                id="salary"
                min="0"
                step="100"
                placeholder="è¼¸å…¥æ¯æœˆè–ªæ°´"
                value={salary}
                onChange={handleSalaryChange} // ä½¿ç”¨ä¿®æ­£å¾Œçš„è™•ç†å‡½æ•¸
                aria-required="true"
              />
            </div>
            <div className="flex-col">
              <label htmlFor="living-expense">æ¯æœˆç”Ÿæ´»è²» (å…ƒ)</label>
              <input
                type="number"
                id="living-expense"
                min="0"
                step="100"
                placeholder="è¼¸å…¥æ¯æœˆç”Ÿæ´»è²»"
                value={livingExpense}
                onChange={handleLivingExpenseChange} // ä½¿ç”¨ä¿®æ­£å¾Œçš„è™•ç†å‡½æ•¸
                aria-required="true"
              />
            </div>
            <div className="flex-col" style={{minWidth: '120px'}}>
              <label htmlFor="start-month">èµ·å§‹æœˆä»½</label>
              <select
                id="start-month"
                value={startMonth}
                onChange={handleStartMonthChange} // ä½¿ç”¨ä¿®æ­£å¾Œçš„è™•ç†å‡½æ•¸
                aria-required="true"
              >
                {[...Array(12).keys()].map(m => (
                  <option key={m+1} value={m+1}>{m+1} æœˆ</option>
                ))}
              </select>
            </div>
          </div>
        </section>

        {/* é‚„æ¬¾äººæ–°å¢èˆ‡åˆ—è¡¨ */}
        <section className="section" aria-labelledby="repay-list-label">
          <h2 id="repay-list-label">æ–°å¢é‚„æ¬¾äºº</h2>
          <div className="flex-row" style={{alignItems: 'flex-end'}}>
            <div className="flex-col">
              <label htmlFor="new-person-name">å§“å</label>
              <input
                type="text"
                id="new-person-name"
                placeholder="è¼¸å…¥é‚„æ¬¾äººå§“å"
                value={newPersonName}
                onChange={e => setNewPersonName(e.target.value)}
                aria-required="true"
                maxLength={20}
              />
            </div>
            <div className="flex-col">
              <label htmlFor="new-person-debt">æ¬ æ¬¾é‡‘é¡ (å…ƒ)</label>
              <input
                type="number"
                id="new-person-debt"
                min="0"
                step="100"
                placeholder="è¼¸å…¥æ¬ æ¬¾é‡‘é¡"
                value={newPersonDebt}
                onChange={e => validatePositiveNumber(e.target.value) && setNewPersonDebt(e.target.value)}
                aria-required="true"
              />
            </div>
            <div>
              <button onClick={addRepayPerson} aria-label="æ–°å¢é‚„æ¬¾äºº">æ–°å¢</button>
            </div>
          </div>

          {/* é‚„æ¬¾äººåˆ—è¡¨è¡¨æ ¼ */}
          {repayList.length === 0 ? (
            <p style={{marginTop:'12px'}}>å°šç„¡é‚„æ¬¾äººè³‡æ–™</p>
          ) : (
            <div className="table-wrapper" role="table" aria-label="é‚„æ¬¾äººåˆ—è¡¨" style={{marginTop:'12px'}}>
              <table>
                <thead>
                  <tr>
                    <th>å§“å</th>
                    <th>æ¬ æ¬¾é‡‘é¡ (å…ƒ)</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  {repayList.map((p, i) => (
                    <tr key={p.name}> {/* ä½¿ç”¨ name ä½œç‚º key æ›´ç©©å®š */}
                      <td>{p.name}</td>
                      <td>{p.debt.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                      <td>
                        <button
                          onClick={() => removeRepayPerson(p.name)} // å‚³å…¥å§“åè®“å¾Œç«¯ç§»é™¤
                          aria-label={`ç§»é™¤é‚„æ¬¾äºº ${p.name}`}
                          style={{backgroundColor:'#ef4444', margin: '0 auto', display:'block'}}
                        >åˆªé™¤</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* èª²ç¨‹æ–°å¢èˆ‡åˆ—è¡¨ */}
        <section className="section" aria-labelledby="course-list-label">
          <h2 id="course-list-label">æ–°å¢èª²ç¨‹</h2>
          <div className="flex-row" style={{alignItems: 'flex-end'}}>
            <div className="flex-col">
              <label htmlFor="new-course-fee">èª²ç¨‹ç¸½è²»ç”¨ (å…ƒ)</label>
              <input
                type="number"
                id="new-course-fee"
                min="0"
                step="100"
                placeholder="è¼¸å…¥èª²ç¨‹è²»ç”¨"
                value={newCourseFee}
                onChange={e => validatePositiveNumber(e.target.value) && setNewCourseFee(e.target.value)}
                aria-required="true"
              />
            </div>
            <div className="flex-col" style={{minWidth:'140px'}}>
              <label htmlFor="new-course-months">èª²ç¨‹æœŸæ•¸ (æœˆ)</label>
              <input
                type="number"
                id="new-course-months"
                min="1"
                max="100"
                step="1"
                placeholder="è¼¸å…¥èª²ç¨‹æœŸæ•¸"
                value={newCourseMonths}
                onChange={e => {
                  const val = e.target.value;
                  if (val === '' || (/^\d+$/.test(val) && Number(val) > 0 && Number(val) <= 100)) {
                    setNewCourseMonths(val);
                  }
                }}
                aria-required="true"
              />
            </div>
            <div>
              <button onClick={addCourse} aria-label="æ–°å¢èª²ç¨‹">æ–°å¢</button>
            </div>
          </div>

          {/* èª²ç¨‹åˆ—è¡¨è¡¨æ ¼ */}
          {courseList.length === 0 ? (
            <p style={{marginTop:'12px'}}>å°šç„¡èª²ç¨‹è³‡æ–™</p>
          ) : (
            <div className="table-wrapper" role="table" aria-label="èª²ç¨‹åˆ—è¡¨" style={{marginTop:'12px'}}>
              <table>
                <thead>
                  <tr>
                    <th>èª²ç¨‹ç·¨è™Ÿ</th>
                    <th>èª²ç¨‹ç¸½è²»ç”¨ (å…ƒ)</th>
                    <th>èª²ç¨‹æœŸæ•¸ (æœˆ)</th>
                    <th>æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody>
                  {courseList.map((c, i) => (
                    <tr key={i}>
                      <td>{i+1}</td>
                      <td>{c.fee.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                      <td>{c.months}</td>
                      <td>
                        <button
                          onClick={() => removeCourse(i)} // å‚³å…¥ç´¢å¼•è®“å¾Œç«¯ç§»é™¤
                          aria-label={`ç§»é™¤èª²ç¨‹ç·¨è™Ÿ ${i+1}`}
                          style={{backgroundColor:'#ef4444', margin: '0 auto', display:'block'}}
                        >åˆªé™¤</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </section>

        {/* éŒ¯èª¤è¨Šæ¯ */}
        {errorMsg && <p className="error-msg" role="alert">{errorMsg}</p>}

        {/* è¨ˆç®—æŒ‰éˆ• */}
        <div style={{textAlign: 'center', marginBottom: '32px'}}>
          <button
            onClick={calculateRepaymentPlan} // ç¾åœ¨æœƒå‘å¾Œç«¯ç™¼é€è«‹æ±‚
            aria-label="é–‹å§‹è¨ˆç®—é‚„æ¬¾è¨ˆç•«"
            style={{minWidth:'260px', fontWeight:'700', fontSize:'1.3rem'}}
          >
            è¨ˆç®—é‚„æ¬¾è¨ˆç•«
          </button>
        </div>

        {/* è¨ˆç®—çµæœ */}
        {calcResult && (
          <section className="section" aria-labelledby="result-label">
            <h2 id="result-label">è©¦ç®—çµæœ</h2>
            <p>æ¯æœˆå¯æ”¯é…æ”¶å…¥ï¼š<strong>{calcResult.monthlyRepayBudget.toFixed(2)}</strong> å…ƒ</p>
            <p>ç¸½æ¬ æ¬¾é‡‘é¡ï¼š<strong>{calcResult.totalDebt.toFixed(2)}</strong> å…ƒ</p>
            <p>èª²ç¨‹æ¯æœˆè²»ç”¨åˆè¨ˆï¼š<strong>{calcResult.totalCourseMonthlyFee.toFixed(2)}</strong> å…ƒ</p>
            <p>ä¼°è¨ˆç¸½é‚„æ¬¾æœŸæ•¸ï¼šç´„ <strong>{calcResult.totalMonths}</strong> å€‹æœˆ</p>

            {/* é‚„æ¬¾äººç¹³æ¸…æ—¥æœŸ */}
            {Object.keys(calcResult.repayCompletionDates).length > 0 && (
                <div>
                    <h3>é‚„æ¬¾äººç¹³æ¸…æ—¥æœŸ</h3>
                    <ul>
                        {Object.entries(calcResult.repayCompletionDates).map(([name, date]) => (
                            <li key={name}><strong>{name}</strong>: {date}</li>
                        ))}
                    </ul>
                </div>
            )}

            {/* èª²ç¨‹ç¹³æ¸…æ—¥æœŸ */}
            {Object.keys(calcResult.courseCompletionDates).length > 0 && (
                <div>
                    <h3>èª²ç¨‹ç¹³æ¸…æ—¥æœŸ</h3>
                    <ul>
                        {Object.entries(calcResult.courseCompletionDates).map(([name, date]) => (
                            <li key={name}><strong>{name}</strong>: {date}</li>
                        ))}
                    </ul>
                </div>
            )}

            <div
              className="chart-container"
              role="img"
              aria-label="æ¬ æ¬¾æ¯”ä¾‹åœ“é¤…åœ–"
              style={{maxWidth:'480px', margin:'20px auto'}}
            >
              <canvas ref={chartRef} width="480" height="360"></canvas>
            </div>

            {/* æ¯æœˆé‚„æ¬¾æ˜ç´°è¡¨æ ¼ */}
            {calcResult.plan && calcResult.plan.length > 0 && (
                <div className="table-wrapper" style={{maxHeight:'480px'}}>
                  <table aria-label="æ¯æœˆé‚„æ¬¾è¨ˆç•«æ˜ç´°" style={{tableLayout:'fixed'}}>
                    <thead>
                      <tr>
                        <th style={{width:'80px'}}>æœˆä»½</th>
                        {/* å‹•æ…‹é¡¯ç¤ºæ‰€æœ‰é‚„æ¬¾äººå§“åä½œç‚ºè¡¨é ­ */}
                        {repayList.map(p => (
                          <th key={p.name} style={{wordBreak:'break-word'}}>{p.name}</th>
                        ))}
                        {/* å‹•æ…‹é¡¯ç¤ºæ‰€æœ‰èª²ç¨‹åç¨±ä½œç‚ºè¡¨é ­ */}
                        {courseList.map((c, idx) => (
                          <th key={`course-${idx}`} style={{wordBreak:'break-word'}}>{`èª²ç¨‹${idx+1}`}</th>
                        ))}
                        <th>æœ¬æœˆç¸½é‚„æ¬¾/ç¹³è²»</th>
                        <th>æœ¬æœˆå‰©é¤˜æ”¶å…¥</th>
                      </tr>
                    </thead>
                    <tbody>
                      {calcResult.plan.map((m, idx) => (
                        <tr key={idx}>
                          <td>{m.date}</td>
                          {repayList.map(p => (
                            <td key={p.name + '-' + idx}>{(m.repayments_detail[p.name] || 0).toFixed(2)}</td>
                          ))}
                          {courseList.map((c, cIdx) => (
                            <td key={`course-pay-${cIdx}-${idx}`}>{(m.course_payments_detail[`èª²ç¨‹${cIdx+1}`] || 0).toFixed(2)}</td>
                          ))}
                          <td>{m.total_repaid_this_month.toFixed(2)}</td>
                          <td>{m.remaining_income_this_month.toFixed(2)}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
            )}


            {/* è¤‡è£½èˆ‡åŒ¯å‡ºæŒ‰éˆ• */}
            <div style={{marginTop:'24px', textAlign:'center'}}>
              <button onClick={copyResultToClipboard} aria-label="è¤‡è£½é‚„æ¬¾çµæœ">è¤‡è£½çµæœ</button>
              <button onClick={exportCsvFile} aria-label="åŒ¯å‡ºé‚„æ¬¾è¨ˆç•« CSV" style={{marginLeft:'16px'}}>åŒ¯å‡º CSV</button>
            </div>

            {/* é¡¯ç¤ºå¾Œç«¯è¿”å›çš„åŸå§‹ç¸½çµæ–‡å­— (å¯é¸) */}
            {/* <h3 style={{marginTop: '30px'}}>å®Œæ•´æ–‡å­—æ‘˜è¦ï¼š</h3>
            <pre style={{whiteSpace: 'pre-wrap', backgroundColor: '#f0f4f8', padding: '15px', borderRadius: '8px', border: '1px solid #e2e8f0', fontSize: '0.9em'}}>{calcResult.summaryText}</pre> */}

          </section>
        )}

      </main>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);

</script>
</body>
</html>
