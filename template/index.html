<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width, initial-scale=1" />
Â  <title>ğŸ’° Qç‰ˆé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</title>
Â  <style>
Â  Â  /* --- åŸºæœ¬CSS Reset èˆ‡å­—å‹è¨­å®š --- */
Â  Â  * {
Â  Â  Â  box-sizing: border-box;
Â  Â  }
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
Â  Â  Â  background: #fef6f6;
Â  Â  Â  color: #333;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  -webkit-font-smoothing: antialiased;
Â  Â  Â  -moz-osx-font-smoothing: grayscale;
Â  Â  }
Â  Â  header {
Â  Â  Â  background: #c83e3e;
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 18px 20px;
Â  Â  Â  font-weight: 900;
Â  Â  Â  font-size: 1.7rem;
Â  Â  Â  text-align: center;
Â  Â  Â  box-shadow: 0 4px 6px rgba(200, 62, 62, 0.5);
Â  Â  Â  user-select: none;
Â  Â  }
Â  Â  main {
Â  Â  Â  flex-grow: 1;
Â  Â  Â  max-width: 960px;
Â  Â  Â  margin: 20px auto 60px auto;
Â  Â  Â  background: #fff5f5;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  box-shadow: 0 6px 16px #f2b7b7cc;
Â  Â  Â  padding: 20px 30px;
Â  Â  }
Â  Â  h2 {
Â  Â  Â  border-left: 5px solid #c83e3e;
Â  Â  Â  padding-left: 12px;
Â  Â  Â  color: #a13131;
Â  Â  Â  margin-top: 30px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  font-weight: 800;
Â  Â  }
Â  Â  label {
Â  Â  Â  display: block;
Â  Â  Â  margin: 10px 0 6px 0;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #7a2a2a;
Â  Â  }
Â  Â  input[type="number"],
Â  Â  input[type="text"],
Â  Â  select {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 10px 14px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  border: 2px solid #f6c2c2;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  transition: border-color 0.3s;
Â  Â  }
Â  Â  input[type="number"]:focus,
Â  Â  input[type="text"]:focus,
Â  Â  select:focus {
Â  Â  Â  border-color: #c83e3e;
Â  Â  Â  outline: none;
Â  Â  }
Â  Â  button {
Â  Â  Â  margin-top: 15px;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  border-radius: 28px;
Â  Â  Â  border: none;
Â  Â  Â  background: #c83e3e;
Â  Â  Â  color: white;
Â  Â  Â  font-weight: 700;
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background-color 0.3s;
Â  Â  Â  user-select: none;
Â  Â  }
    button + button { /* Added for spacing between buttons */
        margin-left: 10px;
    }
Â  Â  button:hover {
Â  Â  Â  background: #a83131;
Â  Â  }
Â  Â  .list-group {
Â  Â  Â  margin: 8px 0 16px 0;
Â  Â  }
Â  Â  .list-item {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 8px;
Â  Â  Â  margin-bottom: 12px;
Â  Â  Â  background: #f6c2c2aa;
Â  Â  Â  border-radius: 14px;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  transition: background-color 0.3s;
Â  Â  }
Â  Â  .list-item:hover {
Â  Â  Â  background: #f08a8a;
Â  Â  }
Â  Â  .list-item input[type="text"],
Â  Â  .list-item input[type="number"] {
Â  Â  Â  flex: 1;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  border: 1.5px solid #f9a3a3;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 6px 10px;
Â  Â  }
Â  Â  .btn-remove {
Â  Â  Â  flex-shrink: 0;
Â  Â  Â  background: #a02a2a;
Â  Â  Â  border-radius: 50%;
Â  Â  Â  color: white;
Â  Â  Â  font-weight: 900;
Â  Â  Â  border: none;
Â  Â  Â  width: 30px;
Â  Â  Â  height: 30px;
Â  Â  Â  font-size: 1.3rem;
Â  Â  Â  line-height: 28px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  user-select: none;
Â  Â  Â  box-shadow: 0 0 6px #a02a2aaa;
Â  Â  Â  transition: background-color 0.2s;
Â  Â  }
Â  Â  .btn-remove:hover {
Â  Â  Â  background: #d14a4a;
Â  Â  Â  box-shadow: 0 0 8px #d14a4aaa;
Â  Â  }
Â  Â  #resultArea {
Â  Â  Â  margin-top: 20px;
Â  Â  Â  background: #fceaea;
Â  Â  Â  border-radius: 18px;
Â  Â  Â  border: 2px dashed #c83e3e;
Â  Â  Â  padding: 18px 24px;
Â  Â  Â  font-weight: 700;
Â  Â  Â  white-space: pre-wrap;
Â  Â  Â  color: #7a2a2a;
Â  Â  Â  min-height: 120px;
Â  Â  Â  overflow-y: auto;
Â  Â  }
Â  Â  #chartsArea {
Â  Â  Â  margin-top: 24px;
Â  Â  Â  background: #fff0f0;
Â  Â  Â  padding: 12px 16px;
Â  Â  Â  border-radius: 18px;
Â  Â  Â  box-shadow: inset 0 0 8px #f9a3a3cc;
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â  canvas {
Â  Â  Â  max-width: 100%;
Â  Â  Â  height: auto !important;
Â  Â  }
Â  Â  footer {
Â  Â  Â  background: #c83e3e;
Â  Â  Â  color: #fff;
Â  Â  Â  text-align: center;
Â  Â  Â  padding: 16px 10px;
Â  Â  Â  font-weight: 600;
Â  Â  Â  user-select: none;
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 0; left: 0; right: 0;
Â  Â  Â  font-size: 0.95rem;
Â  Â  }
Â  Â  footer a {
Â  Â  Â  color: #fff0f0;
Â  Â  Â  text-decoration: none;
Â  Â  Â  margin: 0 8px;
Â  Â  Â  font-weight: 700;
Â  Â  Â  transition: color 0.3s;
Â  Â  }
Â  Â  footer a:hover {
Â  Â  Â  color: #ffd1d1;
Â  Â  Â  text-decoration: underline;
Â  Â  }
Â  Â  @media (max-width: 480px) {
Â  Â  Â  main {
Â  Â  Â  Â  margin: 10px 10px 80px 10px;
Â  Â  Â  Â  padding: 16px 14px;
Â  Â  Â  }
Â  Â  Â  .list-item {
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  }
Â  Â  Â  .list-item input[type="text"],
Â  Â  Â  .list-item input[type="number"] {
Â  Â  Â  Â  width: 100%;
Â  Â  Â  }
Â  Â  Â  .btn-remove {
Â  Â  Â  Â  align-self: flex-end;
Â  Â  Â  Â  margin-top: 8px;
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>
<body>

<header>ğŸ’° Qç‰ˆé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</header>

<main>
Â  Â  <section id="basicInfo">
Â  Â  <h2>åŸºæœ¬è³‡æ–™</h2>
Â  Â  <label for="inputSalary">æ¯æœˆè–ªè³‡ï¼ˆå…ƒï¼‰</label>
Â  Â  <input type="number" id="inputSalary" min="0" placeholder="è«‹è¼¸å…¥æ¯æœˆè–ªè³‡" />
Â  Â  <label for="inputExpense">æ¯æœˆç”Ÿæ´»è²»ï¼ˆå…ƒï¼‰</label>
Â  Â  <input type="number" id="inputExpense" min="0" placeholder="è«‹è¼¸å…¥æ¯æœˆç”Ÿæ´»è²»" />
Â  </section>

Â  Â  <section id="debtorsSection">
Â  Â  <h2>å‚µå‹™äººæ¸…å–®</h2>
Â  Â  <div id="debtorsList" class="list-group"></div>
Â  Â  <button id="btnAddDebtor" type="button">ï¼‹ æ–°å¢å‚µå‹™äºº</button>
Â  </section>

Â  Â  <section id="coursesSection">
Â  Â  <h2>èª²ç¨‹æ¸…å–®</h2>
Â  Â  <div id="coursesList" class="list-group"></div>
Â  Â  <button id="btnAddCourse" type="button">ï¼‹ æ–°å¢èª²ç¨‹</button>
Â  </section>

Â  Â  <section id="startMonthSection">
Â  Â  <h2>èµ·å§‹æœˆä»½</h2>
Â  Â  <label for="selectStartMonth">é¸æ“‡èµ·å§‹æœˆä»½</label>
Â  Â  <select id="selectStartMonth">
Â  Â  Â  <option value="1">1 æœˆ</option>
Â  Â  Â  <option value="2">2 æœˆ</option>
Â  Â  Â  <option value="3">3 æœˆ</option>
Â  Â  Â  <option value="4">4 æœˆ</option>
Â  Â  Â  <option value="5">5 æœˆ</option>
Â  Â  Â  <option value="6">6 æœˆ</option>
Â  Â  Â  <option value="7">7 æœˆ</option>
Â  Â  Â  <option value="8">8 æœˆ</option>
Â  Â  Â  <option value="9">9 æœˆ</option>
Â  Â  Â  <option value="10">10 æœˆ</option>
Â  Â  Â  <option value="11">11 æœˆ</option>
Â  Â  Â  <option value="12">12 æœˆ</option>
Â  Â  </select>
Â  </section>

Â  Â  <section id="actions">
Â  Â  <button id="btnCalculate" type="button">é–‹å§‹è¨ˆç®—</button>
Â  Â  <button id="btnExportCSV" type="button" disabled>åŒ¯å‡º CSV</button>
    <button id="btnClearResults" type="button" disabled>æ¸…é™¤çµæœ</button>
    <button id="btnCopyResults" type="button" disabled>è¤‡è£½çµæœ</button>
Â  </section>

Â  Â  <section id="resultSection">
Â  Â  <h2>è¨ˆç®—çµæœ</h2>
Â  Â  <pre id="resultArea">è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€</pre>
Â  </section>

Â  Â  <section id="chartsSection">
Â  Â  <h2>å‚µå‹™æ¯”ä¾‹åœ“é¤…åœ–</h2>
Â  Â  <div id="chartsArea">
Â  Â  Â  <canvas id="pieChart"></canvas>
Â  Â  </div>
Â  </section>
Â  <section id="contactForm" style="margin-top: 50px;">
Â  <h2>è¯çµ¡æˆ‘å€‘</h2>
Â  <form action="https://formsubmit.co/a3017255@gmail.com" method="POST">
Â  Â  <label for="name">æ‚¨çš„å§“åï¼š</label>
Â  Â  <input type="text" id="name" name="name" required><br><br>

Â  Â  <label for="email">æ‚¨çš„ Emailï¼š</label>
Â  Â  <input type="email" id="email" name="email" required><br><br>

Â  Â  <label for="message">è¨Šæ¯å…§å®¹ï¼š</label><br>
Â  Â  <textarea id="message" name="message" rows="5" required></textarea><br><br>

Â  Â  <button type="submit">é€å‡º</button>
Â  </form>
</section>
</main>

<footer style="text-align: center; font-size: 0.9rem; padding: 14px 10px; background: #ffbaba55; color: #7a2f2f; margin-top: auto; box-shadow: inset 0 1px 4px #ffbabacc;">
Â  <a href="/about" target="_blank" rel="noopener noreferrer" style="color: #d14a4a; font-weight: 700; text-decoration: none; margin: 0 8px;">é—œæ–¼æˆ‘å€‘</a> |Â 
Â  <a href="#contactForm" style="color: #d14a4a; font-weight: 700; text-decoration: none; margin: 0 8px;">è¯çµ¡æˆ‘å€‘</a> |Â 
Â  <a href="/privacy" target="_blank" rel="noopener noreferrer" style="color: #d14a4a; font-weight: 700; text-decoration: none; margin: 0 8px;">éš±ç§æ¬Šæ”¿ç­–</a> |Â 
Â  <a href="/terms" target="_blank" rel="noopener noreferrer" style="color: #d14a4a; font-weight: 700; text-decoration: none; margin: 0 8px;">æœå‹™æ¢æ¬¾</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
Â  // å…¨å±€ç‹€æ…‹
Â  const state = {
Â  Â  salary: 0,
Â  Â  livingExpense: 0,
Â  Â  startMonth: 1,
Â  Â  debtors: [],
Â  Â  courses: [],
Â  Â  monthRecords: [],
Â  };

Â  // DOM Elements
Â  const inputSalary = document.getElementById('inputSalary');
Â  const inputExpense = document.getElementById('inputExpense');
Â  const selectStartMonth = document.getElementById('selectStartMonth');
Â  const debtorsList = document.getElementById('debtorsList');
Â  const coursesList = document.getElementById('coursesList');
Â  const btnAddDebtor = document.getElementById('btnAddDebtor');
Â  const btnAddCourse = document.getElementById('btnAddCourse');
Â  const btnCalculate = document.getElementById('btnCalculate');
Â  const btnExportCSV = document.getElementById('btnExportCSV');
Â  const btnClearResults = document.getElementById('btnClearResults'); // New button
Â  const btnCopyResults = document.getElementById('btnCopyResults'); // New button
Â  const resultArea = document.getElementById('resultArea');
Â  const chartsArea = document.getElementById('chartsArea'); // Get charts area

Â  let pieChart = null;

Â  // å»ºç«‹å‚µå‹™äººè¼¸å…¥å€å¡Š
Â  function createDebtorItem(name = '', debt = '') {
Â  Â  const div = document.createElement('div');
Â  Â  div.className = 'list-item';

Â  Â  const inputName = document.createElement('input');
Â  Â  inputName.type = 'text';
Â  Â  inputName.placeholder = 'å§“å';
Â  Â  inputName.value = name;
Â  Â  inputName.autocomplete = "off";

Â  Â  const inputDebt = document.createElement('input');
Â  Â  inputDebt.type = 'number';
Â  Â  inputDebt.placeholder = 'æ¬ æ¬¾é‡‘é¡';
Â  Â  inputDebt.min = 0;
Â  Â  inputDebt.value = debt;

Â  Â  const btnRemove = document.createElement('button');
Â  Â  btnRemove.className = 'btn-remove';
Â  Â  btnRemove.title = "ç§»é™¤å‚µå‹™äºº";
Â  Â  btnRemove.innerHTML = '&times;';
Â  Â  btnRemove.onclick = () => {
Â  Â  Â  div.remove();
Â  Â  Â  updateStateFromUI();
Â  Â  Â  clearAndDisableResults(); // Clear results when debtor is removed
Â  Â  };

Â  Â  // è¼¸å…¥æ”¹è®Šå³æ›´æ–°ç‹€æ…‹
Â  Â  inputName.addEventListener('input', updateStateFromUI);
Â  Â  inputDebt.addEventListener('input', updateStateFromUI);

Â  Â  div.appendChild(inputName);
Â  Â  div.appendChild(inputDebt);
Â  Â  div.appendChild(btnRemove);

Â  Â  return div;
Â  }

Â  // å»ºç«‹èª²ç¨‹è¼¸å…¥å€å¡Š
Â  function createCourseItem(name = '', fee = '', months = '') {
Â  Â  const div = document.createElement('div');
Â  Â  div.className = 'list-item';

Â  Â  const inputName = document.createElement('input');
Â  Â  inputName.type = 'text';
Â  Â  inputName.placeholder = 'èª²ç¨‹åç¨±';
Â  Â  inputName.value = name;
Â  Â  inputName.autocomplete = "off";

Â  Â  const inputFee = document.createElement('input');
Â  Â  inputFee.type = 'number';
Â  Â  inputFee.placeholder = 'èª²ç¨‹è²»ç”¨';
Â  Â  inputFee.min = 0;
Â  Â  inputFee.value = fee;

Â  Â  const inputMonths = document.createElement('input');
Â  Â  inputMonths.type = 'number';
Â  Â  inputMonths.placeholder = 'æœŸæ•¸ï¼ˆæœˆï¼‰';
Â  Â  inputMonths.min = 1;
Â  Â  inputMonths.value = months;

Â  Â  const btnRemove = document.createElement('button');
Â  Â  btnRemove.className = 'btn-remove';
Â  Â  btnRemove.title = "ç§»é™¤èª²ç¨‹";
Â  Â  btnRemove.innerHTML = '&times;';
Â  Â  btnRemove.onclick = () => {
Â  Â  Â  div.remove();
Â  Â  Â  updateStateFromUI();
Â  Â  Â  clearAndDisableResults(); // Clear results when course is removed
Â  Â  };

Â  Â  // è¼¸å…¥æ”¹è®Šå³æ›´æ–°ç‹€æ…‹
Â  Â  inputName.addEventListener('input', updateStateFromUI);
Â  Â  inputFee.addEventListener('input', updateStateFromUI);
Â  Â  inputMonths.addEventListener('input', updateStateFromUI);

Â  Â  div.appendChild(inputName);
Â  Â  div.appendChild(inputFee);
Â  Â  div.appendChild(inputMonths);
Â  Â  div.appendChild(btnRemove);

Â  Â  return div;
Â  }

Â  // æ–°å¢å‚µå‹™äºº
Â  btnAddDebtor.addEventListener('click', () => {
Â  Â  const item = createDebtorItem();
Â  Â  debtorsList.appendChild(item);
Â  Â  clearAndDisableResults(); // Clear results when new debtor is added
Â  });

Â  // æ–°å¢èª²ç¨‹
Â  btnAddCourse.addEventListener('click', () => {
Â  Â  const item = createCourseItem();
Â  Â  coursesList.appendChild(item);
Â  Â  clearAndDisableResults(); // Clear results when new course is added
Â  });

Â  // å¾UIåŒæ­¥ç‹€æ…‹ç‰©ä»¶
Â  function updateStateFromUI() {
Â  Â  state.salary = parseFloat(inputSalary.value) || 0;
Â  Â  state.livingExpense = parseFloat(inputExpense.value) || 0;
Â  Â  state.startMonth = parseInt(selectStartMonth.value, 10) || 1;

Â  Â  state.debtors = [];
Â  Â  [...debtorsList.children].forEach(div => {
Â  Â  Â  const inputs = div.querySelectorAll('input');
Â  Â  Â  const name = inputs[0].value.trim();
Â  Â  Â  const debt = parseFloat(inputs[1].value);
Â  Â  Â  if (name && !isNaN(debt) && debt > 0) {
Â  Â  Â  Â  state.debtors.push({ name, debt });
Â  Â  Â  }
Â  Â  });

Â  Â  state.courses = [];
Â  Â  [...coursesList.children].forEach(div => {
Â  Â  Â  const inputs = div.querySelectorAll('input');
Â  Â  Â  const name = inputs[0].value.trim() || "èª²ç¨‹";
Â  Â  Â  const fee = parseFloat(inputs[1].value);
Â  Â  Â  const months = parseInt(inputs[2].value, 10);
Â  Â  Â  if (!isNaN(fee) && fee > 0 && !isNaN(months) && months > 0) {
Â  Â  Â  Â  state.courses.push({ name, fee, months });
Â  Â  Â  }
Â  Â  });

Â  Â  // Disable result buttons until calculation is performed
Â  Â  btnExportCSV.disabled = true;
Â  Â  btnClearResults.disabled = true;
Â  Â  btnCopyResults.disabled = true;
Â  }

Â  // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
Â  function showError(msg) {
Â  Â  alert(msg);
Â  }

Â  // è¨ˆç®—é‚è¼¯ï¼ˆèˆ‡ä½ åŸæœ¬Pythoné‚è¼¯ç›¸åŒï¼‰
Â  function calculateRepaymentPlan() {
Â  Â  if (state.salary <= 0) {
Â  Â  Â  showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„è–ªè³‡');
Â  Â  Â  return;
Â  Â  }
Â  Â  if (state.livingExpense < 0) {
Â  Â  Â  showError('ç”Ÿæ´»è²»ä¸å¯ç‚ºè² æ•¸');
Â  Â  Â  return;
Â  Â  }
Â  Â  if (state.livingExpense >= state.salary) {
Â  Â  Â  showError('ç”Ÿæ´»è²»ä¸å¯å¤§æ–¼æˆ–ç­‰æ–¼è–ªè³‡');
Â  Â  Â  return;
Â  Â  }
Â  Â  if (state.debtors.length === 0 && state.courses.length === 0) {
Â  Â  Â  showError('è«‹è‡³å°‘æ–°å¢ä¸€ä½å‚µå‹™äººæˆ–ä¸€å€‹èª²ç¨‹');
Â  Â  Â  return;
Â  Â  }

Â  Â  const disposableIncome = state.salary - state.livingExpense;

Â  Â  // åˆå§‹åŒ–å‚µå‹™äººèˆ‡èª²ç¨‹å‰©é¤˜é‡‘é¡
Â  Â  const debtsRemaining = {};
Â  Â  state.debtors.forEach(d => debtsRemaining[d.name] = d.debt);
Â  Â  const coursesRemaining = state.courses.map(c => ({
Â  Â  Â  ...c,
Â  Â  Â  monthlyPayment: c.fee / c.months,
Â  Â  Â  remainingFee: c.fee
Â  Â  }));

Â  Â  const startYear = new Date().getFullYear();

Â  Â  const monthRecords = [];
Â  Â  let monthCount = 0;
Â  Â  const maxMonths = 2000;

Â  Â  const repayCompletionDates = {};
Â  Â  const courseCompletionDates = {};

Â  Â  while (true) {
Â  Â  Â  // åˆ¤æ–·æ˜¯å¦å…¨éƒ¨é‚„æ¸…
Â  Â  Â  const allDebtsCleared = Object.values(debtsRemaining).every(v => v <= 0.001);
Â  Â  Â  const allCoursesCleared = coursesRemaining.every(c => c.remainingFee <= 0.001);
Â  Â  Â  if (allDebtsCleared && allCoursesCleared) break;
Â  Â  Â  if (monthCount > maxMonths) {
Â  Â  Â  Â  showError('è¨ˆç®—è¶…éæœ€å¤§æœˆä»½ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢º');
Â  Â  Â  Â  break;
Â  Â  Â  }

Â  Â  Â  const currentMonthIndex = (state.startMonth - 1 + monthCount) % 12 + 1;
Â  Â  Â  const currentYear = startYear + Math.floor((state.startMonth - 1 + monthCount) / 12);

Â  Â  Â  // æœ¬æœˆå¯ç”¨æ–¼é‚„æ¬¾çš„é‡‘é¡
Â  Â  Â  let budget = disposableIncome;

Â  Â  Â  // å„ªå…ˆé‚„å‚µå‹™äººï¼Œä¾åºå¹³å‡åˆ†é…
Â  Â  Â  const activeDebtors = Object.entries(debtsRemaining).filter(([_, debt]) => debt > 0.001);
Â  Â  Â  if (activeDebtors.length > 0) {
Â  Â  Â  Â  // å¹³å‡åˆ†é…é ç®—çµ¦æ¯å€‹æ´»å‚µå‹™äºº
Â  Â  Â  Â  const budgetPerDebtor = budget / (activeDebtors.length + coursesRemaining.filter(c => c.remainingFee > 0.001).length);
Â  Â  Â  Â  activeDebtors.forEach(([name, debt]) => {
Â  Â  Â  Â  Â  const pay = Math.min(debt, budgetPerDebtor);
Â  Â  Â  Â  Â  debtsRemaining[name] -= pay;
Â  Â  Â  Â  Â  budget -= pay;
Â  Â  Â  Â  Â  if (debtsRemaining[name] <= 0.001 && !(name in repayCompletionDates)) {
Â  Â  Â  Â  Â  Â  repayCompletionDates[name] = { year: currentYear, month: currentMonthIndex };
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // å‰©ä¸‹é ç®—åˆ†çµ¦èª²ç¨‹æœˆä»˜
Â  Â  Â  const activeCourses = coursesRemaining.filter(c => c.remainingFee > 0.001);
Â  Â  Â  if (activeCourses.length > 0 && budget > 0) {
Â  Â  Â  Â  // å¹³å‡åˆ†é…é ç®—çµ¦æ´»èºèª²ç¨‹
Â  Â  Â  Â  const budgetPerCourse = budget / activeCourses.length;
Â  Â  Â  Â  activeCourses.forEach(course => {
Â  Â  Â  Â  Â  const pay = Math.min(course.remainingFee, budgetPerCourse, course.monthlyPayment);
Â  Â  Â  Â  Â  course.remainingFee -= pay;
Â  Â  Â  Â  Â  budget -= pay;
Â  Â  Â  Â  Â  if (course.remainingFee <= 0.001 && !(course.name in courseCompletionDates)) {
Â  Â  Â  Â  Â  Â  courseCompletionDates[course.name] = { year: currentYear, month: currentMonthIndex };
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  // è¨˜éŒ„æœ¬æœˆè³‡æ–™
Â  Â  Â  monthRecords.push({
Â  Â  Â  Â  year: currentYear,
Â  Â  Â  Â  month: currentMonthIndex,
Â  Â  Â  Â  debtsRemaining: JSON.parse(JSON.stringify(debtsRemaining)),
Â  Â  Â  Â  coursesRemaining: coursesRemaining.map(c => ({ name: c.name, remainingFee: c.remainingFee })),
Â  Â  Â  Â  budgetLeft: budget
Â  Â  Â  });

Â  Â  Â  monthCount++;
Â  Â  }

Â  Â  state.monthRecords = monthRecords;

Â  Â  return {
Â  Â  Â  repayCompletionDates,
Â  Â  Â  courseCompletionDates,
Â  Â  Â  monthCount,
Â  Â  Â  disposableIncome
Â  Â  };
Â  }

Â  // é¡¯ç¤ºçµæœåˆ°é é¢
Â  function displayResults(calcResult) {
Â  let text = `ğŸ“… è¨ˆç®—èµ·å§‹æœˆä»½ï¼š${state.startMonth} æœˆ\n`;
Â  text += `ğŸ’° è–ªè³‡ï¼š${state.salary.toLocaleString()} å…ƒ\n`;
Â  text += `ğŸ  ç”Ÿæ´»è²»ï¼š${state.livingExpense.toLocaleString()} å…ƒ\n`;
Â  text += `ğŸ”¢ ç¸½é‚„æ¬¾æœŸæ•¸ï¼šç´„ ${calcResult.monthCount} å€‹æœˆ\n\n`;

Â  // é‚„æ¬¾å®Œæˆæ™‚é–“
Â  text += 'ğŸ’³ å‚µå‹™äººé‚„æ¸…æ™‚é–“ï¼š\n';
Â  if (Object.keys(calcResult.repayCompletionDates).length === 0) {
Â  Â  text += 'Â  ç„¡å‚µå‹™äººæˆ–å‚µå‹™å·²æ¸…ã€‚\n';
Â  } else {
Â  Â  for (const [name, date] of Object.entries(calcResult.repayCompletionDates)) {
Â  Â  Â  text += `Â  - ${name} ğŸ—“ï¸ ${date.year}/${String(date.month).padStart(2, '0')} é‚„æ¸…\n`;
Â  Â  }
Â  }

Â  // æ¯æœˆé‚„æ¬¾æ˜ç´°
Â  text += `\nğŸ“– æ¯æœˆé‚„æ¬¾åˆ†é…çµ¦å‚µå‹™äººï¼š\n`;

Â  state.monthRecords.forEach((rec, index) => {
Â  Â  text += `ğŸ“† ${rec.year}/${String(rec.month).padStart(2, '0')} (ç¬¬ ${index + 1} æœˆ)\n`;

Â  Â  const repayers = Object.entries(rec.debtsRemaining);

Â  Â  repayers.forEach(([name, remaining]) => {
Â  Â  Â  // ä¸Šå€‹æœˆçš„å‰©é¤˜é‡‘é¡
Â  Â  Â  let prevDebt = 0;
Â  Â  Â  if (index === 0) {
Â  Â  Â  Â  // ç¬¬1å€‹æœˆï¼Œç”¨åŸå§‹é‡‘é¡
Â  Â  Â  Â  const debtor = state.debtors.find(d => d.name === name);
Â  Â  Â  Â  prevDebt = debtor ? debtor.debt : 0;
Â  Â  Â  } else {
Â  Â  Â  Â  // å…¶ä»–æœˆä»½ï¼Œç”¨ä¸Šå€‹æœˆå‰©é¤˜
Â  Â  Â  Â  prevDebt = state.monthRecords[index - 1].debtsRemaining[name];
Â  Â  Â  }

Â  Â  Â  // è¨ˆç®—æœ¬æœˆå¯¦éš›é‚„æ¬¾é‡‘é¡
Â  Â  Â  const paid = prevDebt - remaining;
Â  Â  Â  if (paid > 0.001) {
Â  Â  Â  Â  text += `Â  ğŸ’³ ${name} é‚„ ${paid.toFixed(2)} å…ƒ\n`;
Â  Â  Â  }
Â  Â  });

Â  Â  text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
Â  });

Â  resultArea.textContent = text;
}
Â  // ç¹ªè£½åœ“é¤…åœ– (å‚µå‹™æ¯”ä¾‹)
Â  function renderPieChart() {
Â  Â  if (pieChart) {
Â  Â  Â  pieChart.destroy();
Â  Â  Â  pieChart = null;
Â  Â  }

Â  Â  const totalDebt = state.debtors.reduce((sum, d) => sum + d.debt, 0);
Â  Â  if (totalDebt <= 0) {
Â  Â  Â  // ç„¡å‚µå‹™å°±ä¸ç•«åœ–
Â  Â  Â  chartsArea.style.display = 'none'; // Hide the charts area
Â  Â  Â  return;
Â  Â  }
Â  Â  chartsArea.style.display = 'flex'; // Show the charts area

Â  Â  const labels = state.debtors.map(d => d.name);
Â  Â  const data = state.debtors.map(d => d.debt);

Â  Â  const backgroundColors = [
Â  Â  Â  '#ff6f6f', '#ff9f6f', '#ffc56f', '#b3d955',
Â  Â  Â  '#6fcb9f', '#6fcbe6', '#6f8ffc', '#b16ffb',
Â  Â  Â  '#eb6ffb', '#ff6fb8', '#ff6f8f'
Â  Â  ];

Â  Â  const ctx = document.getElementById('pieChart').getContext('2d');

Â  Â  pieChart = new Chart(ctx, {
Â  Â  Â  type: 'pie',
Â  Â  Â  data: {
Â  Â  Â  Â  labels: labels,
Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  label: 'å‚µå‹™æ¯”ä¾‹',
Â  Â  Â  Â  Â  data: data,
Â  Â  Â  Â  Â  backgroundColor: backgroundColors.slice(0, labels.length),
Â  Â  Â  Â  Â  borderWidth: 1,
Â  Â  Â  Â  Â  borderColor: '#fff'
Â  Â  Â  Â  }]
Â  Â  Â  },
Â  Â  Â  options: {
Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  position: 'right',
Â  Â  Â  Â  Â  Â  labels: {
Â  Â  Â  Â  Â  Â  Â  font: { size: 14, weight: '600' },
Â  Â  Â  Â  Â  Â  Â  color: '#a13131',
Â  Â  Â  Â  Â  Â  Â  padding: 12
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  callbacks: {
Â  Â  Â  Â  Â  Â  Â  label: ctx => `${ctx.label}: ${ctx.parsed.toLocaleString()} å…ƒ`
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  });
Â  }

Â  // ç”¢ç”Ÿ CSV å­—ä¸²
Â  function generateCSV() {
Â  Â  if (!state.monthRecords || state.monthRecords.length === 0) return '';

Â  Â  const headers = ['å¹´æœˆ', ...state.debtors.map(d => `å‚µå‹™-${d.name}`), ...state.courses.map(c => `èª²ç¨‹-${c.name}`), 'å‰©é¤˜é ç®—'];
Â  Â  const rows = state.monthRecords.map(r => {
Â  Â  Â  const yearMonth = `${r.year}å¹´${r.month}æœˆ`;
Â  Â  Â  const debtValues = state.debtors.map(d => {
Â  Â  Â  Â  const val = r.debtsRemaining[d.name];
Â  Â  Â  Â  return val ? val.toFixed(2) : '0.00';
Â  Â  Â  });
Â  Â  Â  const courseValues = state.courses.map(c => {
Â  Â  Â  Â  const course = r.coursesRemaining.find(crs => crs.name === c.name);
Â  Â  Â  Â  return course ? course.remainingFee.toFixed(2) : '0.00';
Â  Â  Â  });
Â  Â  Â  return [yearMonth, ...debtValues, ...courseValues, r.budgetLeft.toFixed(2)];
Â  Â  });

Â  Â  // CSVåˆä½µï¼Œé€—è™Ÿåˆ†éš”ï¼Œæ–‡å­—æ¬„ä½åŒ…é›™å¼•è™Ÿ
Â  Â  let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
Â  Â  rows.forEach(row => {
Â  Â  Â  csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
Â  Â  });

Â  Â  return csvContent;
Â  }

Â  // ä¸‹è¼‰ CSV
Â  function downloadCSV(filename, csvContent) {
Â  Â  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
Â  Â  const link = document.createElement('a');
Â  Â  link.href = URL.createObjectURL(blob);
Â  Â  link.download = filename;
Â  Â  link.style.display = 'none';
Â  Â  document.body.appendChild(link);
Â  Â  link.click();
Â  Â  document.body.removeChild(link);
Â  }

Â  // Function to clear results and disable buttons
Â  function clearAndDisableResults() {
Â  Â  resultArea.textContent = 'è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€';
Â  Â  if (pieChart) {
Â  Â  Â  pieChart.destroy();
Â  Â  Â  pieChart = null;
Â  Â  }
Â  Â  chartsArea.style.display = 'none'; // Hide the charts area
Â  Â  btnExportCSV.disabled = true;
Â  Â  btnClearResults.disabled = true;
Â  Â  btnCopyResults.disabled = true;
Â  Â  state.monthRecords = []; // Clear month records in state
Â  }

Â  // æŒ‰éˆ•äº‹ä»¶ï¼šé–‹å§‹è¨ˆç®—
Â  btnCalculate.addEventListener('click', () => {
Â  Â  updateStateFromUI();

Â  Â  const calcResult = calculateRepaymentPlan();
Â  Â  if (!calcResult) {
Â  Â  Â  clearAndDisableResults(); // Clear if calculation fails
Â  Â  Â  return;
Â  Â  }

Â  Â  displayResults(calcResult);
Â  Â  renderPieChart();
Â  Â  btnExportCSV.disabled = false;
Â  Â  btnClearResults.disabled = false; // Enable clear button after calculation
Â  Â  btnCopyResults.disabled = false; // Enable copy button after calculation
Â  });

Â  // æŒ‰éˆ•äº‹ä»¶ï¼šåŒ¯å‡º CSV
Â  btnExportCSV.addEventListener('click', () => {
Â  Â  const csv = generateCSV();
Â  Â  if (!csv) {
Â  Â  Â  alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
Â  Â  Â  return;
Â  Â  }
Â  Â  const filename = `é‚„æ¬¾è©¦ç®—è¡¨_${new Date().toISOString().slice(0,10)}.csv`;
Â  Â  downloadCSV(filename, csv);
Â  });

Â  // Button event: Clear Results
Â  btnClearResults.addEventListener('click', () => {
Â  Â  clearAndDisableResults();
Â  });

Â  // Button event: Copy Results
Â  btnCopyResults.addEventListener('click', async () => {
Â  Â  try {
Â  Â  Â  await navigator.clipboard.writeText(resultArea.textContent);
Â  Â  Â  alert('è¨ˆç®—çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
Â  Â  } catch (err) {
Â  Â  Â  console.error('ç„¡æ³•è¤‡è£½æ–‡å­—ï¼š', err);
Â  Â  Â  alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
Â  Â  }
Â  });

Â  // é é¢è¼‰å…¥æ™‚ï¼Œé å…ˆåŠ å…¥1ç­†å‚µå‹™äººèˆ‡èª²ç¨‹ï¼Œæ–¹ä¾¿æ“ä½œ
Â  window.onload = () => {
Â  Â  btnAddDebtor.click();
Â  Â  btnAddCourse.click();
Â  Â  chartsArea.style.display = 'none'; // Hide charts area on initial load
Â  };
</script>

</body>
</html>
