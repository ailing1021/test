<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ğŸ’° Qç‰ˆé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</title>
    <style>
        /* --- åŸºæœ¬CSS Reset èˆ‡å­—å‹è¨­å®š --- */
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #fef6f6;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        header {
            background: #c83e3e;
            color: #fff;
            padding: 18px 20px;
            font-weight: 900;
            font-size: 1.7rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(200, 62, 62, 0.5);
            user-select: none;
        }
        main {
            flex-grow: 1;
            max-width: 960px;
            margin: 20px auto 60px auto;
            background: #fff5f5;
            border-radius: 12px;
            box-shadow: 0 6px 16px #f2b7b7cc;
            padding: 20px 30px;
        }
        h2 {
            border-left: 5px solid #c83e3e;
            padding-left: 12px;
            color: #a13131;
            margin-top: 30px;
            margin-bottom: 12px;
            font-weight: 800;
        }
        label {
            display: block;
            margin: 10px 0 6px 0;
            font-weight: 600;
            color: #7a2a2a;
        }
        /* æ‰€æœ‰è¼¸å…¥æ¡†å’Œé¸å–®éƒ½è®Šæˆåœ“è§’ */
        input[type="number"],
        input[type="text"],
        input[type="email"], /* For contact form email input */
        textarea, /* For contact form message textarea */
        select {
            width: 100%;
            padding: 10px 14px;
            border-radius: 20px; /* Qç‰ˆåœ“è§’ */
            border: 2px solid #f6c2c2;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        input[type="number"]:focus,
        input[type="text"]:focus,
        input[type="email"]:focus,
        textarea:focus,
        select:focus {
            border-color: #c83e3e;
            outline: none;
        }
        button {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 28px;
            border: none;
            background: #c83e3e;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            user-select: none;
        }
        button + button { /* Added for spacing between buttons */
            margin-left: 10px;
        }
        button:hover {
            background: #a83131;
        }
        .list-group {
            margin: 8px 0 16px 0;
        }
        .list-item {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            background: #f6c2c2aa;
            border-radius: 22px; /* Qç‰ˆæ©¢åœ“å½¢åˆ—è¡¨é …ç›® */
            padding: 12px 16px;
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s;
        }
        .list-item:hover {
            background: #f08a8a;
        }
        .list-item input[type="text"],
        .list-item input[type="number"] {
            flex: 1;
            font-size: 1rem;
            border: 1.5px solid #f9a3a3;
            border-radius: 16px; /* Qç‰ˆåˆ—è¡¨å…§éƒ¨è¼¸å…¥æ¡†åœ“è§’ */
            padding: 6px 10px;
        }
        .btn-remove {
            flex-shrink: 0;
            background: #a02a2a;
            border-radius: 50%;
            color: white;
            font-weight: 900;
            border: none;
            width: 30px;
            height: 30px;
            font-size: 1.3rem;
            line-height: 28px;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 0 6px #a02a2aaa;
            transition: background-color 0.2s;
        }
        .btn-remove:hover {
            background: #d14a4a;
            box-shadow: 0 0 8px #d14a4aaa;
        }
        #resultArea {
            margin-top: 20px;
            background: #fceaea;
            border-radius: 22px; /* Qç‰ˆçµæœå€å¡Šåœ“è§’ */
            border: 2px dashed #c83e3e;
            padding: 18px 24px;
            font-weight: 700;
            white-space: pre-wrap;
            color: #7a2a2a;
            min-height: 120px;
            overflow-y: auto;
        }
        #chartsArea {
            margin-top: 24px;
            background: #fff0f0;
            border-radius: 22px; /* Qç‰ˆåœ–è¡¨å€å¡Šåœ“è§’ */
            padding: 12px 16px;
            box-shadow: inset 0 0 8px #f9a3a3cc;
            display: flex;
            justify-content: center;
        }
        canvas {
            max-width: 100%;
            height: auto !important;
        }
        footer {
            background: #c83e3e; /* ä¿®æ­£å› Q ç‰ˆé¢¨æ ¼çš„æ·±ç´…è‰² */
            color: #fff; /* ä¿®æ­£å›ç™½è‰²æ–‡å­— */
            text-align: center;
            padding: 16px 10px;
            font-weight: 600;
            user-select: none;
            position: fixed;
            bottom: 0; left: 0; right: 0;
            font-size: 0.95rem;
            box-shadow: 0 -2px 5px rgba(200, 62, 62, 0.4); /* åº•éƒ¨é™°å½± */
        }
        footer a {
            color: #fff0f0;
            text-decoration: none;
            margin: 0 8px;
            font-weight: 700;
            transition: color 0.3s;
        }
        footer a:hover {
            color: #ffd1d1;
            text-decoration: underline;
        }
        @media (max-width: 480px) {
            main {
                margin: 10px 10px 80px 10px;
                padding: 16px 14px;
            }
            .list-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .list-item input[type="text"],
            .list-item input[type="number"] {
                width: 100%;
                border-radius: 20px; /* åœ¨å°è¢å¹•ä¸‹ä¹Ÿä¿æŒåœ“è§’ */
            }
            .btn-remove {
                align-self: flex-end;
                margin-top: 8px;
            }
        }
    </style>
</head>
<body>

<header>ğŸ’° Qç‰ˆé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</header>

<main>
    <section id="basicInfo">
        <h2>åŸºæœ¬è³‡æ–™</h2>
        <label for="inputSalary">æ¯æœˆè–ªè³‡ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="inputSalary" min="0" placeholder="è«‹è¼¸å…¥æ¯æœˆè–ªè³‡" />
        <label for="inputExpense">æ¯æœˆç”Ÿæ´»è²»ï¼ˆå…ƒï¼‰</label>
        <input type="number" id="inputExpense" min="0" placeholder="è«‹è¼¸å…¥æ¯æœˆç”Ÿæ´»è²»" />
    </section>

    <section id="debtorsSection">
        <h2>å‚µå‹™äººæ¸…å–®</h2>
        <div id="debtorsList" class="list-group"></div>
        <button id="btnAddDebtor" type="button">ï¼‹ æ–°å¢å‚µå‹™äºº</button>
    </section>

    <section id="coursesSection">
        <h2>èª²ç¨‹æ¸…å–®</h2>
        <div id="coursesList" class="list-group"></div>
        <button id="btnAddCourse" type="button">ï¼‹ æ–°å¢èª²ç¨‹</button>
    </section>

    <section id="startMonthSection">
        <h2>èµ·å§‹æœˆä»½</h2>
        <label for="selectStartMonth">é¸æ“‡èµ·å§‹æœˆä»½</label>
        <select id="selectStartMonth">
            <option value="1">1 æœˆ</option>
            <option value="2">2 æœˆ</option>
            <option value="3">3 æœˆ</option>
            <option value="4">4 æœˆ</option>
            <option value="5">5 æœˆ</option>
            <option value="6">6 æœˆ</option>
            <option value="7">7 æœˆ</option>
            <option value="8">8 æœˆ</option>
            <option value="9">9 æœˆ</option>
            <option value="10">10 æœˆ</option>
            <option value="11">11 æœˆ</option>
            <option value="12">12 æœˆ</option>
        </select>
    </section>

    <section id="actions">
        <button id="btnCalculate" type="button">é–‹å§‹è¨ˆç®—</button>
        <button id="btnExportCSV" type="button" disabled>åŒ¯å‡º CSV</button>
        <button id="btnClearResults" type="button" disabled>æ¸…é™¤çµæœ</button>
        <button id="btnCopyResults" type="button" disabled>è¤‡è£½çµæœ</button>
        <button id="btnExportPDF" type="button" disabled>åŒ¯å‡º PDF</button> </section>

    <section id="resultSection">
        <h2>è¨ˆç®—çµæœ</h2>
        <pre id="resultArea">è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€</pre>
    </section>

    <section id="chartsSection">
        <h2>å‚µå‹™æ¯”ä¾‹åœ“é¤…åœ–</h2>
        <div id="chartsArea">
            <canvas id="pieChart"></canvas>
        </div>
    </section>
    <section id="contactForm" style="margin-top: 50px;">
        <h2>è¯çµ¡æˆ‘å€‘</h2>
        <form action="https://formsubmit.co/a3017255@gmail.com" method="POST">
            <label for="name">æ‚¨çš„å§“åï¼š</label>
            <input type="text" id="name" name="name" required><br><br>

            <label for="email">æ‚¨çš„ Emailï¼š</label>
            <input type="email" id="email" name="email" required><br><br>

            <label for="message">è¨Šæ¯å…§å®¹ï¼š</label><br>
            <textarea id="message" name="message" rows="5" required></textarea><br><br>

            <button type="submit">é€å‡º</button>
        </form>
    </section>
</main>

<footer style="text-align: center; font-size: 0.9rem; padding: 14px 10px; background: #c83e3e; color: #fff; margin-top: auto; box-shadow: inset 0 1px 4px #ffbabacc;">
    <a href="/about" target="_blank" rel="noopener noreferrer" style="color: #fff0f0; font-weight: 700; text-decoration: none; margin: 0 8px;">é—œæ–¼æˆ‘å€‘</a> |
    <a href="#contactForm" style="color: #fff0f0; font-weight: 700; text-decoration: none; margin: 0 8px;">è¯çµ¡æˆ‘å€‘</a> |
    <a href="/privacy" target="_blank" rel="noopener noreferrer" style="color: #fff0f0; font-weight: 700; text-decoration: none; margin: 0 8px;">éš±ç§æ¬Šæ”¿ç­–</a> |
    <a href="/terms" target="_blank" rel="noopener noreferrer" style="color: #fff0f0; font-weight: 700; text-decoration: none; margin: 0 8px;">æœå‹™æ¢æ¬¾</a>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
    // å…¨å±€ç‹€æ…‹
    const state = {
        salary: 0,
        livingExpense: 0,
        startMonth: 1,
        debtors: [],
        courses: [],
        monthRecords: [],
    };

    // DOM Elements
    const inputSalary = document.getElementById('inputSalary');
    const inputExpense = document.getElementById('inputExpense');
    const selectStartMonth = document.getElementById('selectStartMonth');
    const debtorsList = document.getElementById('debtorsList');
    const coursesList = document.getElementById('coursesList');
    const btnAddDebtor = document.getElementById('btnAddDebtor');
    const btnAddCourse = document.getElementById('btnAddCourse');
    const btnCalculate = document.getElementById('btnCalculate');
    const btnExportCSV = document.getElementById('btnExportCSV');
    const btnClearResults = document.getElementById('btnClearResults');
    const btnCopyResults = document.getElementById('btnCopyResults');
    const btnExportPDF = document.getElementById('btnExportPDF'); // NEW: PDF button element
    const resultArea = document.getElementById('resultArea');
    const chartsArea = document.getElementById('chartsArea');

    let pieChart = null;

    // å»ºç«‹å‚µå‹™äººè¼¸å…¥å€å¡Š
    function createDebtorItem(name = '', debt = '') {
        const div = document.createElement('div');
        div.className = 'list-item';

        const inputName = document.createElement('input');
        inputName.type = 'text';
        inputName.placeholder = 'å§“å';
        inputName.value = name;
        inputName.autocomplete = "off";

        const inputDebt = document.createElement('input');
        inputDebt.type = 'number';
        inputDebt.placeholder = 'æ¬ æ¬¾é‡‘é¡';
        inputDebt.min = 0;
        inputDebt.value = debt;

        const btnRemove = document.createElement('button');
        btnRemove.className = 'btn-remove';
        btnRemove.title = "ç§»é™¤å‚µå‹™äºº";
        btnRemove.innerHTML = '&times;';
        btnRemove.onclick = () => {
            div.remove();
            updateStateFromUI();
            clearAndDisableResults();
        };

        // è¼¸å…¥æ”¹è®Šå³æ›´æ–°ç‹€æ…‹
        inputName.addEventListener('input', updateStateFromUI);
        inputDebt.addEventListener('input', updateStateFromUI);

        div.appendChild(inputName);
        div.appendChild(inputDebt);
        div.appendChild(btnRemove);

        return div;
    }

    // å»ºç«‹èª²ç¨‹è¼¸å…¥å€å¡Š
    function createCourseItem(name = '', fee = '', months = '') {
        const div = document.createElement('div');
        div.className = 'list-item';

        const inputName = document.createElement('input');
        inputName.type = 'text';
        inputName.placeholder = 'èª²ç¨‹åç¨±';
        inputName.value = name;
        inputName.autocomplete = "off";

        const inputFee = document.createElement('input');
        inputFee.type = 'number';
        inputFee.placeholder = 'èª²ç¨‹è²»ç”¨';
        inputFee.min = 0;
        inputFee.value = fee;

        const inputMonths = document.createElement('input');
        inputMonths.type = 'number';
        inputMonths.placeholder = 'æœŸæ•¸ï¼ˆæœˆï¼‰';
        inputMonths.min = 1;
        inputMonths.value = months;

        const btnRemove = document.createElement('button');
        btnRemove.className = 'btn-remove';
        btnRemove.title = "ç§»é™¤èª²ç¨‹";
        btnRemove.innerHTML = '&times;';
        btnRemove.onclick = () => {
            div.remove();
            updateStateFromUI();
            clearAndDisableResults();
        };

        // è¼¸å…¥æ”¹è®Šå³æ›´æ–°ç‹€æ…‹
        inputName.addEventListener('input', updateStateFromUI);
        inputFee.addEventListener('input', updateStateFromUI);
        inputMonths.addEventListener('input', updateStateFromUI);

        div.appendChild(inputName);
        div.appendChild(inputFee);
        div.appendChild(inputMonths);
        div.appendChild(btnRemove);

        return div;
    }

    // æ–°å¢å‚µå‹™äºº
    btnAddDebtor.addEventListener('click', () => {
        const item = createDebtorItem();
        debtorsList.appendChild(item);
        clearAndDisableResults();
    });

    // æ–°å¢èª²ç¨‹
    btnAddCourse.addEventListener('click', () => {
        const item = createCourseItem();
        coursesList.appendChild(item);
        clearAndDisableResults();
    });

    // å¾UIåŒæ­¥ç‹€æ…‹ç‰©ä»¶
    function updateStateFromUI() {
        state.salary = parseFloat(inputSalary.value) || 0;
        state.livingExpense = parseFloat(inputExpense.value) || 0;
        state.startMonth = parseInt(selectStartMonth.value, 10) || 1;

        state.debtors = [];
        [...debtorsList.children].forEach(div => {
            const inputs = div.querySelectorAll('input');
            const name = inputs[0].value.trim();
            const debt = parseFloat(inputs[1].value);
            if (name && !isNaN(debt) && debt > 0) {
                state.debtors.push({ name, debt });
            }
        });

        state.courses = [];
        [...coursesList.children].forEach(div => {
            const inputs = div.querySelectorAll('input');
            const name = inputs[0].value.trim() || "èª²ç¨‹";
            const fee = parseFloat(inputs[1].value);
            const months = parseInt(inputs[2].value, 10);
            if (!isNaN(fee) && fee > 0 && !isNaN(months) && months > 0) {
                state.courses.push({ name, fee, months });
            }
        });

        // Disable result buttons until calculation is performed
        btnExportCSV.disabled = true;
        btnClearResults.disabled = true;
        btnCopyResults.disabled = true;
        btnExportPDF.disabled = true; // NEW: Disable PDF button
    }

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(msg) {
        alert(msg);
    }

    // è¨ˆç®—é‚è¼¯ï¼ˆèˆ‡ä½ åŸæœ¬Pythoné‚è¼¯ç›¸åŒï¼‰
    function calculateRepaymentPlan() {
        if (state.salary <= 0) {
            showError('è«‹è¼¸å…¥æœ‰æ•ˆçš„è–ªè³‡');
            clearAndDisableResults();
            return;
        }
        if (state.livingExpense < 0) {
            showError('ç”Ÿæ´»è²»ä¸å¯ç‚ºè² æ•¸');
            clearAndDisableResults();
            return;
        }
        if (state.livingExpense >= state.salary) {
            showError('ç”Ÿæ´»è²»ä¸å¯å¤§æ–¼æˆ–ç­‰æ–¼è–ªè³‡');
            clearAndDisableResults();
            return;
        }
        if (state.debtors.length === 0 && state.courses.length === 0) {
            showError('è«‹è‡³å°‘æ–°å¢ä¸€ä½å‚µå‹™äººæˆ–ä¸€å€‹èª²ç¨‹');
            clearAndDisableResults();
            return;
        }

        const disposableIncome = state.salary - state.livingExpense;

        // åˆå§‹åŒ–å‚µå‹™äººèˆ‡èª²ç¨‹å‰©é¤˜é‡‘é¡
        const debtsRemaining = {};
        state.debtors.forEach(d => debtsRemaining[d.name] = d.debt);
        const coursesRemaining = state.courses.map(c => ({
            ...c,
            monthlyPayment: c.fee / c.months,
            remainingFee: c.fee
        }));

        const startYear = new Date().getFullYear();

        const monthRecords = [];
        let monthCount = 0;
        const maxMonths = 2000;

        const repayCompletionDates = {};
        const courseCompletionDates = {};

        while (true) {
            // åˆ¤æ–·æ˜¯å¦å…¨éƒ¨é‚„æ¸…
            const allDebtsCleared = Object.values(debtsRemaining).every(v => v <= 0.001);
            const allCoursesCleared = coursesRemaining.every(c => c.remainingFee <= 0.001);
            if (allDebtsCleared && allCoursesCleared) break;
            if (monthCount > maxMonths) {
                showError('è¨ˆç®—è¶…éæœ€å¤§æœˆä»½ï¼Œè«‹æª¢æŸ¥è¼¸å…¥æ˜¯å¦æ­£ç¢º');
                clearAndDisableResults();
                break;
            }

            const currentMonthIndex = (state.startMonth - 1 + monthCount) % 12 + 1;
            const currentYear = startYear + Math.floor((state.startMonth - 1 + monthCount) / 12);

            // æœ¬æœˆå¯ç”¨æ–¼é‚„æ¬¾çš„é‡‘é¡
            let budget = disposableIncome;

            // å„ªå…ˆé‚„å‚µå‹™äººï¼Œä¾åºå¹³å‡åˆ†é…
            const activeDebtors = Object.entries(debtsRemaining).filter(([_, debt]) => debt > 0.001);
            if (activeDebtors.length > 0) {
                // å¹³å‡åˆ†é…é ç®—çµ¦æ¯å€‹æ´»å‚µå‹™äºº
                const budgetPerDebtor = budget / (activeDebtors.length + coursesRemaining.filter(c => c.remainingFee > 0.001).length);
                activeDebtors.forEach(([name, debt]) => {
                    const pay = Math.min(debt, budgetPerDebtor);
                    debtsRemaining[name] -= pay;
                    budget -= pay;
                    if (debtsRemaining[name] <= 0.001 && !(name in repayCompletionDates)) {
                        repayCompletionDates[name] = { year: currentYear, month: currentMonthIndex };
                    }
                });
            }

            // å‰©ä¸‹é ç®—åˆ†çµ¦èª²ç¨‹æœˆä»˜
            const activeCourses = coursesRemaining.filter(c => c.remainingFee > 0.001);
            if (activeCourses.length > 0 && budget > 0) {
                // å¹³å‡åˆ†é…é ç®—çµ¦æ´»èºèª²ç¨‹
                const budgetPerCourse = budget / activeCourses.length;
                activeCourses.forEach(course => {
                    const pay = Math.min(course.remainingFee, budgetPerCourse, course.monthlyPayment);
                    course.remainingFee -= pay;
                    budget -= pay;
                    if (course.remainingFee <= 0.001 && !(course.name in courseCompletionDates)) {
                        courseCompletionDates[course.name] = { year: currentYear, month: currentMonthIndex };
                    }
                });
            }

            // è¨˜éŒ„æœ¬æœˆè³‡æ–™
            monthRecords.push({
                year: currentYear,
                month: currentMonthIndex,
                debtsRemaining: JSON.parse(JSON.stringify(debtsRemaining)),
                coursesRemaining: coursesRemaining.map(c => ({ name: c.name, remainingFee: c.remainingFee })),
                budgetLeft: budget
            });

            monthCount++;
        }

        state.monthRecords = monthRecords;

        return {
            repayCompletionDates,
            courseCompletionDates,
            monthCount,
            disposableIncome
        };
    }

    // é¡¯ç¤ºçµæœåˆ°é é¢
    function displayResults(calcResult) {
        let text = `ğŸ“… è¨ˆç®—èµ·å§‹æœˆä»½ï¼š${state.startMonth} æœˆ\n`;
        text += `ğŸ’° è–ªè³‡ï¼š${state.salary.toLocaleString()} å…ƒ\n`;
        text += `ğŸ  ç”Ÿæ´»è²»ï¼š${state.livingExpense.toLocaleString()} å…ƒ\n`;
        text += `ğŸ”¢ ç¸½é‚„æ¬¾æœŸæ•¸ï¼šç´„ ${calcResult.monthCount} å€‹æœˆ\n\n`;

        // é‚„æ¬¾å®Œæˆæ™‚é–“
        text += 'ğŸ’³ å‚µå‹™äººé‚„æ¸…æ™‚é–“ï¼š\n';
        if (Object.keys(calcResult.repayCompletionDates).length === 0) {
            text += 'Â  ç„¡å‚µå‹™äººæˆ–å‚µå‹™å·²æ¸…ã€‚\n';
        } else {
            for (const [name, date] of Object.entries(calcResult.repayCompletionDates)) {
                text += `Â  - ${name} ğŸ—“ï¸ ${date.year}/${String(date.month).padStart(2, '0')} é‚„æ¸…\n`;
            }
        }

        // æ¯æœˆé‚„æ¬¾æ˜ç´°
        text += `\nğŸ“– æ¯æœˆé‚„æ¬¾åˆ†é…çµ¦å‚µå‹™äººï¼š\n`;

        state.monthRecords.forEach((rec, index) => {
            text += `ğŸ“† ${rec.year}/${String(rec.month).padStart(2, '0')} (ç¬¬ ${index + 1} æœˆ)\n`;

            const repayers = Object.entries(rec.debtsRemaining);

            repayers.forEach(([name, remaining]) => {
                // ä¸Šå€‹æœˆçš„å‰©é¤˜é‡‘é¡
                let prevDebt = 0;
                if (index === 0) {
                    // ç¬¬1å€‹æœˆï¼Œç”¨åŸå§‹é‡‘é¡
                    const debtor = state.debtors.find(d => d.name === name);
                    prevDebt = debtor ? debtor.debt : 0;
                } else {
                    // å…¶ä»–æœˆä»½ï¼Œç”¨ä¸Šå€‹æœˆå‰©é¤˜
                    prevDebt = state.monthRecords[index - 1].debtsRemaining[name];
                }

                // è¨ˆç®—æœ¬æœˆå¯¦éš›é‚„æ¬¾é‡‘é¡
                const paid = prevDebt - remaining;
                if (paid > 0.001) {
                    text += `Â  ğŸ’³ ${name} é‚„ ${paid.toFixed(2)} å…ƒ\n`;
                }
            });

            text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
        });

        resultArea.textContent = text;
    }
    // ç¹ªè£½åœ“é¤…åœ– (å‚µå‹™æ¯”ä¾‹)
    function renderPieChart() {
        if (pieChart) {
            pieChart.destroy();
            pieChart = null;
        }

        const totalDebt = state.debtors.reduce((sum, d) => sum + d.debt, 0);
        if (totalDebt <= 0) {
            // ç„¡å‚µå‹™å°±ä¸ç•«åœ–
            chartsArea.style.display = 'none';
            return;
        }
        chartsArea.style.display = 'flex';

        const labels = state.debtors.map(d => d.name);
        const data = state.debtors.map(d => d.debt);

        const backgroundColors = [
            '#ff6f6f', '#ff9f6f', '#ffc56f', '#b3d955',
            '#6fcb9f', '#6fcbe6', '#6f8ffc', '#b16ffb',
            '#eb6ffb', '#ff6fb8', '#ff6f8f'
        ];

        const ctx = document.getElementById('pieChart').getContext('2d');

        pieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'å‚µå‹™æ¯”ä¾‹',
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            font: { size: 14, weight: '600' },
                            color: '#a13131',
                            padding: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => `${ctx.label}: ${ctx.parsed.toLocaleString()} å…ƒ`
                        }
                    }
                }
            }
        });
    }

    // ç”¢ç”Ÿ CSV å­—ä¸²
    function generateCSV() {
        if (!state.monthRecords || state.monthRecords.length === 0) return '';

        const headers = ['å¹´æœˆ', ...state.debtors.map(d => `å‚µå‹™-${d.name}`), ...state.courses.map(c => `èª²ç¨‹-${c.name}`), 'å‰©é¤˜é ç®—'];
        const rows = state.monthRecords.map(r => {
            const yearMonth = `${r.year}å¹´${r.month}æœˆ`;
            const debtValues = state.debtors.map(d => {
                const val = r.debtsRemaining[d.name];
                return val ? val.toFixed(2) : '0.00';
            });
            const courseValues = state.courses.map(c => {
                const course = r.coursesRemaining.find(crs => crs.name === c.name);
                return course ? course.remainingFee.toFixed(2) : '0.00';
            });
            return [yearMonth, ...debtValues, ...courseValues, r.budgetLeft.toFixed(2)];
        });

        // CSVåˆä½µï¼Œé€—è™Ÿåˆ†éš”ï¼Œæ–‡å­—æ¬„ä½åŒ…é›™å¼•è™Ÿ
        let csvContent = headers.map(h => `"${h}"`).join(',') + '\n';
        rows.forEach(row => {
            csvContent += row.map(cell => `"${cell}"`).join(',') + '\n';
        });

        return csvContent;
    }

    // ä¸‹è¼‰ CSV
    function downloadCSV(filename, csvContent) {
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Function to clear results and disable buttons
    function clearAndDisableResults() {
        resultArea.textContent = 'è«‹å¡«å¯«è³‡æ–™ä¸¦æŒ‰ã€Œé–‹å§‹è¨ˆç®—ã€';
        if (pieChart) {
            pieChart.destroy();
            pieChart = null;
        }
        chartsArea.style.display = 'none';
        btnExportCSV.disabled = true;
        btnClearResults.disabled = true;
        btnCopyResults.disabled = true;
        btnExportPDF.disabled = true; // NEW: Disable PDF button
        state.monthRecords = [];
    }

    // æŒ‰éˆ•äº‹ä»¶ï¼šé–‹å§‹è¨ˆç®—
    btnCalculate.addEventListener('click', () => {
        updateStateFromUI();

        const calcResult = calculateRepaymentPlan();
        if (!calcResult) {
            clearAndDisableResults();
            return;
        }

        displayResults(calcResult);
        renderPieChart();
        btnExportCSV.disabled = false;
        btnClearResults.disabled = false;
        btnCopyResults.disabled = false;
        btnExportPDF.disabled = false; // NEW: Enable PDF button
    });

    // æŒ‰éˆ•äº‹ä»¶ï¼šåŒ¯å‡º CSV
    btnExportCSV.addEventListener('click', () => {
        const csv = generateCSV();
        if (!csv) {
            alert('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
            return;
        }
        const filename = `é‚„æ¬¾è©¦ç®—è¡¨_${new Date().toISOString().slice(0,10)}.csv`;
        downloadCSV(filename, csv);
    });

    // Button event: Clear Results
    btnClearResults.addEventListener('click', () => {
        clearAndDisableResults();
    });

    // Button event: Copy Results
    btnCopyResults.addEventListener('click', async () => {
        try {
            await navigator.clipboard.writeText(resultArea.textContent);
            alert('è¨ˆç®—çµæœå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        } catch (err) {
            console.error('ç„¡æ³•è¤‡è£½æ–‡å­—ï¼š', err);
            alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
        }
    });

    // NEW: Button event: Export PDF
    btnExportPDF.addEventListener('click', async () => {
        try {
            // æš«æ™‚éš±è— footerï¼Œä»¥å…è¢«æˆªåœ–åˆ°
            const originalFooterDisplay = document.querySelector('footer').style.display;
            document.querySelector('footer').style.display = 'none';

            // ç¢ºä¿ main å€åŸŸçš„å…§å®¹æ˜¯å¯è¦‹çš„
            const mainElement = document.querySelector('main');
            const originalMainOverflow = mainElement.style.overflow;
            mainElement.style.overflow = 'visible'; // å…è¨±å…§å®¹æº¢å‡ºï¼Œç¢ºä¿ html2canvas èƒ½å®Œæ•´æˆªåœ–

            // æ•ç²æ•´å€‹ main å€åŸŸ
            const mainCanvas = await html2canvas(mainElement, {
                scale: 2, // æé«˜è§£æåº¦
                useCORS: true,
                logging: false // æ¸›å°‘ console log
            });
            const mainImgData = mainCanvas.toDataURL('image/png');

            // æ¢å¾© footer å’Œ main çš„æ¨£å¼
            document.querySelector('footer').style.display = originalFooterDisplay;
            mainElement.style.overflow = originalMainOverflow;

            // å‰µå»º jsPDF å¯¦ä¾‹
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for A4 size

            const imgWidth = 200; // å¯¬åº¦è¨­å®šç‚º A4 å¯¬åº¦ (210mm) æ¸›å»å·¦å³å„ 5mm é‚Šè·
            let imgHeight = mainCanvas.height * imgWidth / mainCanvas.width;
            let heightLeft = imgHeight;
            let position = 5; // å¾é ‚éƒ¨ 5mm é–‹å§‹

            // é¦–æ¬¡æ·»åŠ åœ–ç‰‡
            doc.addImage(mainImgData, 'PNG', 5, position, imgWidth, imgHeight);
            heightLeft -= (doc.internal.pageSize.height - position); // Adjust heightLeft based on remaining space on first page

            // å¦‚æœåœ–ç‰‡é«˜åº¦è¶…éä¸€é ï¼Œå‰‡åˆ†é æ·»åŠ 
            while (heightLeft >= 0) {
                position = -imgHeight + heightLeft + 5; // Adjust position to show next part of the image
                doc.addPage();
                doc.addImage(mainImgData, 'PNG', 5, position, imgWidth, imgHeight);
                heightLeft -= doc.internal.pageSize.height;
            }

            doc.save(`é‚„æ¬¾è©¦ç®—çµæœ_${new Date().toISOString().slice(0,10)}.pdf`);
            alert('PDF å·²åŒ¯å‡ºï¼');

        } catch (err) {
            console.error('åŒ¯å‡º PDF å¤±æ•—ï¼š', err);
            alert('åŒ¯å‡º PDF å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
        }
    });


    // é é¢è¼‰å…¥æ™‚ï¼Œé å…ˆåŠ å…¥1ç­†å‚µå‹™äººèˆ‡èª²ç¨‹ï¼Œæ–¹ä¾¿æ“ä½œ
    window.onload = () => {
        btnAddDebtor.click();
        btnAddCourse.click();
        chartsArea.style.display = 'none';
    };
</script>

</body>
</html>
