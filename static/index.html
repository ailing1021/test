<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</title>
  <!-- React CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body, #root {
      height: 100%;
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f3f4f6; /* Tailwind gray-100 */
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 380px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    textarea {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">

    // ä¸» App çµ„ä»¶
    function App() {
      // è®€å– LocalStorage æˆ–çµ¦åˆå§‹å€¼
      const getInitialState = () => {
        try {
          return {
            salary: parseFloat(localStorage.getItem('salary')) || 0,
            livingExpense: parseFloat(localStorage.getItem('livingExpense')) || 0,
            startMonth: parseInt(localStorage.getItem('startMonth')) || 1,
            repayList: JSON.parse(localStorage.getItem('repayList')) || [],
            courseList: JSON.parse(localStorage.getItem('courseList')) || [],
            calculationResult: '',
            modalType: null,
          };
        } catch (e) {
          return {
            salary: 0,
            livingExpense: 0,
            startMonth: 1,
            repayList: [],
            courseList: [],
            calculationResult: '',
            modalType: null,
          };
        }
      };

      const [state, setState] = React.useState(getInitialState);

      // æ¯æ¬¡é‡è¦è³‡æ–™æ”¹è®Šå­˜åˆ° LocalStorage
      React.useEffect(() => {
        localStorage.setItem('salary', state.salary);
        localStorage.setItem('livingExpense', state.livingExpense);
        localStorage.setItem('startMonth', state.startMonth);
        localStorage.setItem('repayList', JSON.stringify(state.repayList));
        localStorage.setItem('courseList', JSON.stringify(state.courseList));
      }, [state.salary, state.livingExpense, state.startMonth, state.repayList, state.courseList]);

      // é–‹å•Ÿæ¨¡æ…‹æ¡†
      const openModal = (type) => {
        setState(prev => ({ ...prev, modalType: type }));
      };

      // é—œé–‰æ¨¡æ…‹æ¡†
      const closeModal = () => {
        setState(prev => ({ ...prev, modalType: null }));
      };

      // æ–°å¢é‚„æ¬¾äºº
      const addPerson = (name, debt) => {
        if (!name.trim()) {
          alert("å§“åä¸èƒ½ç‚ºç©º");
          return false;
        }
        if (isNaN(debt) || debt <= 0) {
          alert("æ¬ æ¬¾é‡‘é¡å¿…é ˆå¤§æ–¼0");
          return false;
        }
        const newPerson = {
          name: name.trim(),
          debt: parseFloat(debt),
          remainingDebt: parseFloat(debt),
        };
        setState(prev => ({
          ...prev,
          repayList: [...prev.repayList, newPerson],
          modalType: null,
        }));
        return true;
      };

      // æ–°å¢èª²ç¨‹è²»ç”¨
      const addCourse = (fee, months) => {
        if (isNaN(fee) || fee <= 0) {
          alert("èª²ç¨‹ç¸½è²»ç”¨å¿…é ˆå¤§æ–¼0");
          return false;
        }
        if (!Number.isInteger(months) || months <= 0) {
          alert("èª²ç¨‹æœŸæ•¸å¿…é ˆæ˜¯å¤§æ–¼0çš„æ•´æ•¸");
          return false;
        }
        const newCourse = {
          fee: parseFloat(fee),
          months: months,
          remainingFee: parseFloat(fee),
        };
        setState(prev => ({
          ...prev,
          courseList: [...prev.courseList, newCourse],
          modalType: null,
        }));
        return true;
      };

      // è¨­å®šè–ªæ°´
      const setSalary = (salary) => {
        if (isNaN(salary) || salary < 0) {
          alert("è–ªæ°´å¿…é ˆæ˜¯éè² æ•¸");
          return false;
        }
        setState(prev => ({
          ...prev,
          salary: parseFloat(salary),
          modalType: null,
        }));
        return true;
      };

      // è¨­å®šç”Ÿæ´»è²»
      const setLivingExpense = (expense) => {
        if (isNaN(expense) || expense < 0) {
          alert("ç”Ÿæ´»è²»å¿…é ˆæ˜¯éè² æ•¸");
          return false;
        }
        setState(prev => ({
          ...prev,
          livingExpense: parseFloat(expense),
          modalType: null,
        }));
        return true;
      };

      // è¨­å®šèµ·å§‹æœˆä»½
      const setStartMonth = (month) => {
        if (!Number.isInteger(month) || month < 1 || month > 12) {
          alert("èµ·å§‹æœˆä»½å¿…é ˆä»‹æ–¼1åˆ°12");
          return false;
        }
        setState(prev => ({
          ...prev,
          startMonth: month,
          modalType: null,
        }));
        return true;
      };

      // è¨ˆç®—é‚„æ¬¾è©¦ç®—
      const calculateRepayment = () => {
        if (state.salary <= 0) {
          alert("è«‹å…ˆè¨­å®šè–ªæ°´ä¸”å¤§æ–¼0");
          openModal('setSalary');
          return;
        }
        if (state.livingExpense < 0) {
          alert("ç”Ÿæ´»è²»å¿…é ˆéè² ");
          openModal('setLivingExpense');
          return;
        }
        if (state.repayList.length === 0 && state.courseList.length === 0) {
          alert("è«‹è‡³å°‘æ–°å¢ä¸€ç­†é‚„æ¬¾äººæˆ–èª²ç¨‹è³‡æ–™");
          return;
        }

        // æ·±æ‹·è²é‚„æ¬¾äººèˆ‡èª²ç¨‹ï¼Œé¿å…æ”¹è®ŠåŸå§‹state
        const repayListCopy = state.repayList.map(p => ({
          ...p,
          remainingDebt: p.remainingDebt,
        }));
        const courseListCopy = state.courseList.map(c => ({
          ...c,
          remainingFee: c.remainingFee,
        }));

        const logs = [];
        logs.push(`=== è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ ===`);
        logs.push(`èµ·å§‹æœˆä»½ï¼š${state.startMonth} æœˆ`);
        logs.push(`è–ªæ°´ï¼š${state.salary.toFixed(2)} å…ƒ`);
        logs.push(`ç”Ÿæ´»è²»ï¼š${state.livingExpense.toFixed(2)} å…ƒ`);
        logs.push('');

        // è¨ˆç®—
        let monthCount = 0;
        const maxMonths = 1200; // æœ€å¤šè©¦ç®— 100 å¹´ï¼Œé¿å…ç„¡é™è¿´åœˆ
        function totalRemaining() {
          const repaySum = repayListCopy.reduce((a, c) => a + Math.max(0, c.remainingDebt), 0);
          const courseSum = courseListCopy.reduce((a, c) => a + Math.max(0, c.remainingFee), 0);
          return repaySum + courseSum;
        }

        if (totalRemaining() === 0) {
          logs.push("ç›®å‰æ²’æœ‰ä»»ä½•å‚µå‹™æˆ–èª²ç¨‹è²»ç”¨éœ€å„Ÿé‚„ã€‚");
          setState(prev => ({ ...prev, calculationResult: logs.join('\n') }));
          return;
        }

        while (totalRemaining() > 0 && monthCount < maxMonths) {
          monthCount++;
          // è¨ˆç®—å¹´æœˆ
          const absoluteMonthIndex = state.startMonth + monthCount - 2; // -2 æ˜¯å› ç‚ºæœˆå¾1é–‹å§‹ç®—ï¼Œä¸”ç¬¬ä¸€å€‹æœˆæ˜¯è©¦ç®—ç¬¬ä¸€å€‹æœˆ
          const year = Math.floor(absoluteMonthIndex / 12) + 1;
          const month = (absoluteMonthIndex % 12) + 1;

          logs.push(`--- ç¬¬ ${monthCount} å€‹æœˆ (${year} å¹´ ${month} æœˆ) ---`);
          logs.push(`æœ¬æœˆè–ªæ°´ï¼š${state.salary.toFixed(2)} å…ƒ`);
          logs.push(`æœ¬æœˆç”Ÿæ´»è²»ï¼š${state.livingExpense.toFixed(2)} å…ƒ`);

          // å¯æ”¯é…é‡‘é¡
          let disposable = state.salary - state.livingExpense;
          logs.push(`æœ¬æœˆå¯æ”¯é…é‡‘é¡(æ‰£é™¤ç”Ÿæ´»è²»å¾Œ)ï¼š${disposable.toFixed(2)} å…ƒ`);

          // èª²ç¨‹åˆ†æœŸä»˜æ¬¾å…ˆæ‰£
          let coursePayTotal = 0;
          courseListCopy.forEach(course => {
            if (course.remainingFee > 0 && course.months > 0) {
              // æ¯æœˆæ‡‰ä»˜
              const monthlyPayment = course.fee / course.months;
              const payThisMonth = Math.min(monthlyPayment, course.remainingFee);
              coursePayTotal += payThisMonth;
              course.remainingFee -= payThisMonth;
              course.remainingFee = Math.max(course.remainingFee, 0);
            }
          });
          if (coursePayTotal > 0) {
            logs.push(`æœ¬æœˆèª²ç¨‹ä»˜æ¬¾ç¸½é¡ï¼š${coursePayTotal.toFixed(2)} å…ƒ`);
            disposable -= coursePayTotal;
          }

          if (disposable <= 0) {
            logs.push("æœ¬æœˆå¯ç”¨æ–¼é‚„æ¬¾çš„é‡‘é¡ä¸è¶³ï¼Œç„¡æ³•é‚„å€‹äººå‚µå‹™ã€‚");
          } else {
            logs.push(`æœ¬æœˆå¯ç”¨æ–¼é‚„å€‹äººå‚µå‹™çš„é‡‘é¡ï¼š${disposable.toFixed(2)} å…ƒ`);

            // å€‹äººå‚µå‹™å‰©é¤˜ç¸½é¡
            const totalDebtRemaining = repayListCopy.reduce((a, c) => a + Math.max(0, c.remainingDebt), 0);
            if (totalDebtRemaining === 0) {
              logs.push("æ‰€æœ‰å€‹äººå‚µå‹™å·²é‚„æ¸…ã€‚");
            } else {
              // æ ¹æ“šæ¯”ä¾‹åˆ†é…é‚„æ¬¾
              let allocated = 0;
              repayListCopy.forEach(p => {
                if (p.remainingDebt > 0) {
                  const ratio = p.remainingDebt / totalDebtRemaining;
                  let payment = disposable * ratio;
                  payment = Math.min(payment, p.remainingDebt);
                  payment = parseFloat(payment.toFixed(2));
                  p.remainingDebt -= payment;
                  p.remainingDebt = Math.max(p.remainingDebt, 0);
                  allocated += payment;
                  logs.push(`- é‚„çµ¦ ${p.name}ï¼š${payment.toFixed(2)} å…ƒ`);
                }
              });

              // è™•ç†å› å››æ¨äº”å…¥é€ æˆçš„æ®˜å·®
              let residual = disposable - allocated;
              residual = parseFloat(residual.toFixed(2));
              if (residual > 0) {
                // è£œçµ¦å‰©é¤˜æœ€å¤§å‚µå‹™è€…
                repayListCopy.sort((a, b) => b.remainingDebt - a.remainingDebt);
                for (let i = 0; i < repayListCopy.length && residual > 0; i++) {
                  let p = repayListCopy[i];
                  if (p.remainingDebt > 0) {
                    let addPayment = Math.min(residual, p.remainingDebt);
                    addPayment = parseFloat(addPayment.toFixed(2));
                    p.remainingDebt -= addPayment;
                    p.remainingDebt = Math.max(p.remainingDebt, 0);
                    residual -= addPayment;
                    residual = parseFloat(residual.toFixed(2));
                    // è£œè¨˜éŒ„
                    logs.push(`- (è£œè¶³) é‚„çµ¦ ${p.name}ï¼š${addPayment.toFixed(2)} å…ƒ`);
                  }
                }
              }
            }
          }

          // æœ¬æœˆçµæŸå¾Œå‚µå‹™ç‹€æ³
          const totalDebtLeft = repayListCopy.reduce((a, c) => a + Math.max(0, c.remainingDebt), 0);
          const totalCourseLeft = courseListCopy.reduce((a, c) => a + Math.max(0, c.remainingFee), 0);
          logs.push(`æœ¬æœˆçµæŸå¾Œï¼Œå‰©é¤˜å€‹äººå‚µå‹™ï¼š${totalDebtLeft.toFixed(2)} å…ƒ`);
          logs.push(`æœ¬æœˆçµæŸå¾Œï¼Œå‰©é¤˜èª²ç¨‹è²»ç”¨ï¼š${totalCourseLeft.toFixed(2)} å…ƒ`);
          logs.push('');
          
          if (monthCount >= maxMonths && totalRemaining() > 0) {
            logs.push('âš ï¸ è­¦å‘Šï¼šè©¦ç®—è¶…é 100 å¹´ï¼Œå¯èƒ½æ”¶å…¥ä¸è¶³é‚„æ¸…å…¨éƒ¨å‚µå‹™ã€‚');
            break;
          }
        }

        if (totalRemaining() <= 0) {
          logs.push(`æ­å–œï¼æ‰€æœ‰å‚µå‹™åŠèª²ç¨‹è²»ç”¨å·²æ–¼ ${monthCount} å€‹æœˆå…§é‚„æ¸…ã€‚`);
        } else {
          logs.push(`è©¦ç®—çµæŸï¼Œ${monthCount} å€‹æœˆå¾Œä»æœ‰å‰©é¤˜å‚µå‹™æˆ–è²»ç”¨ã€‚`);
        }

        // é¡¯ç¤ºçµæœ
        setState(prev => ({ ...prev, calculationResult: logs.join('\n') }));
      };

      // åŒ¯å‡º CSV åŠŸèƒ½
      const exportCSV = () => {
        if (!state.calculationResult) {
          alert("æ²’æœ‰å¯åŒ¯å‡ºçš„è¨ˆç®—çµæœ");
          return;
        }
        // å°‡æ¯è¡ŒåŒ…æˆé›™å¼•è™Ÿï¼Œé¿å…é€—è™Ÿå•é¡Œ
        const csvLines = state.calculationResult
          .split('\n')
          .map(line => `"${line.replace(/"/g, '""')}"`)
          .join('\n');
        const blob = new Blob([csvLines], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'repayment_plan.csv';
        a.click();
        URL.revokeObjectURL(url);
      };

      // é‡ç½®å…¨éƒ¨è³‡æ–™
      const resetAll = () => {
        if (!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
        localStorage.clear();
        setState({
          salary: 0,
          livingExpense: 0,
          startMonth: 1,
          repayList: [],
          courseList: [],
          calculationResult: '',
          modalType: null,
        });
      };

      // Modal å…§å®¹æ ¹æ“š type åˆ‡æ›
      const ModalContent = () => {
        const [input1, setInput1] = React.useState('');
        const [input2, setInput2] = React.useState('');
        React.useEffect(() => {
          if (state.modalType === 'setSalary') setInput1(state.salary.toString());
          else if (state.modalType === 'setLivingExpense') setInput1(state.livingExpense.toString());
          else if (state.modalType === 'setStartMonth') setInput1(state.startMonth.toString());
          else setInput1('');
          setInput2('');
        }, [state.modalType]);

        const onConfirm = () => {
          if (state.modalType === 'addPerson') {
            if (addPerson(input1, parseFloat(input2))) closeModal();
          } else if (state.modalType === 'addCourse') {
            if (addCourse(parseFloat(input1), parseInt(input2))) closeModal();
          } else if (state.modalType === 'setSalary') {
            if (setSalary(parseFloat(input1))) closeModal();
          } else if (state.modalType === 'setLivingExpense') {
            if (setLivingExpense(parseFloat(input1))) closeModal();
          } else if (state.modalType === 'setStartMonth') {
            if (setStartMonth(parseInt(input1))) closeModal();
          }
        };

        // Modal æ¨™é¡Œèˆ‡èªªæ˜
        let title = '';
        let label1 = '';
        let label2 = '';
        let input1Type = 'text';
        let input2Type = 'text';
        let input2Placeholder = '';
        let showInput2 = false;

        switch (state.modalType) {
          case 'addPerson':
            title = 'æ–°å¢é‚„æ¬¾äºº';
            label1 = 'å§“å';
            label2 = 'æ¬ æ¬¾é‡‘é¡ (å…ƒ)';
            input1Type = 'text';
            input2Type = 'number';
            input2Placeholder = 'æ•¸å­—';
            showInput2 = true;
            break;
          case 'addCourse':
            title = 'æ–°å¢èª²ç¨‹è²»ç”¨';
            label1 = 'èª²ç¨‹ç¸½è²»ç”¨ (å…ƒ)';
            label2 = 'èª²ç¨‹æœŸæ•¸ (æœˆ)';
            input1Type = 'number';
            input2Type = 'number';
            input2Placeholder = 'æ•´æ•¸';
            showInput2 = true;
            break;
          case 'setSalary':
            title = 'è¨­å®šè–ªæ°´';
            label1 = 'æœˆè–ª (å…ƒ)';
            input1Type = 'number';
            showInput2 = false;
            break;
          case 'setLivingExpense':
            title = 'è¨­å®šç”Ÿæ´»è²»';
            label1 = 'æœˆç”Ÿæ´»è²» (å…ƒ)';
            input1Type = 'number';
            showInput2 = false;
            break;
          case 'setStartMonth':
            title = 'è¨­å®šèµ·å§‹æœˆä»½';
            label1 = 'èµ·å§‹æœˆä»½ (1~12)';
            input1Type = 'number';
            showInput2 = false;
            break;
          default:
            return null;
        }

        return (
          <div className="modal" onClick={closeModal}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
              <h2 className="text-xl font-bold mb-4">{title}</h2>
              <label className="block mb-1 font-semibold">{label1}</label>
              <input
                type={input1Type}
                className="w-full border rounded px-3 py-2 mb-3"
                value={input1}
                onChange={e => setInput1(e.target.value)}
                autoFocus
              />
              {showInput2 && (
                <>
                  <label className="block mb-1 font-semibold">{label2}</label>
                  <input
                    type={input2Type}
                    className="w-full border rounded px-3 py-2 mb-3"
                    value={input2}
                    onChange={e => setInput2(e.target.value)}
                    placeholder={input2Placeholder}
                  />
                </>
              )}
              <div className="flex justify-end space-x-3">
                <button
                  onClick={onConfirm}
                  className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
                >
                  ç¢ºå®š
                </button>
                <button
                  onClick={closeModal}
                  className="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded"
                >
                  å–æ¶ˆ
                </button>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="max-w-3xl mx-auto p-6 bg-white rounded shadow mt-10 flex flex-col">
          <h1 className="text-3xl font-bold text-center mb-6">ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</h1>

          <div className="mb-6 text-center text-gray-700 space-y-1">
            <p>è–ªæ°´ï¼š<span className="font-semibold">{state.salary.toFixed(2)} å…ƒ</span></p>
            <p>ç”Ÿæ´»è²»ï¼š<span className="font-semibold">{state.livingExpense.toFixed(2)} å…ƒ</span></p>
            <p>èµ·å§‹æœˆä»½ï¼š<span className="font-semibold">{state.startMonth} æœˆ</span></p>
          </div>

          {/* æ“ä½œæŒ‰éˆ•ç¾¤ */}
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
            <button
              className="bg-blue-500 hover:bg-blue-600 text-white py-2 rounded"
              onClick={() => openModal('addPerson')}
              type="button"
            >
              æ–°å¢é‚„æ¬¾äºº
            </button>
            <button
              className="bg-green-500 hover:bg-green-600 text-white py-2 rounded"
              onClick={() => openModal('addCourse')}
              type="button"
            >
              æ–°å¢èª²ç¨‹è²»ç”¨
            </button>
            <button
              className="bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded"
              onClick={() => openModal('setSalary')}
              type="button"
            >
              è¨­å®šè–ªæ°´
            </button>
            <button
              className="bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded"
              onClick={() => openModal('setLivingExpense')}
              type="button"
            >
              è¨­å®šç”Ÿæ´»è²»
            </button>
            <button
              className="bg-purple-500 hover:bg-purple-600 text-white py-2 rounded"
              onClick={() => openModal('setStartMonth')}
              type="button"
            >
              è¨­å®šèµ·å§‹æœˆä»½
            </button>
            <button
              className="bg-red-500 hover:bg-red-600 text-white py-2 rounded"
              onClick={calculateRepayment}
              type="button"
            >
              é–‹å§‹è©¦ç®—
            </button>
            <button
              className="col-span-2 sm:col-span-1 bg-teal-500 hover:bg-teal-600 text-white py-2 rounded"
              onClick={exportCSV}
              type="button"
            >
              åŒ¯å‡ºCSV
            </button>
            <button
              className="col-span-2 sm:col-span-1 bg-gray-700 hover:bg-gray-900 text-white py-2 rounded"
              onClick={resetAll}
              type="button"
            >
              æ¸…ç©ºæ‰€æœ‰è³‡æ–™
            </button>
          </div>

          {/* é¡¯ç¤ºçµæœå€ */}
          <textarea
            readOnly
            className="h-96 p-4 border border-gray-300 rounded resize-none bg-gray-50 text-sm font-mono overflow-auto"
            value={state.calculationResult || 'è«‹è¨­å®šè³‡æ–™ä¸¦é»æ“Šã€Œé–‹å§‹è©¦ç®—ã€ä»¥é¡¯ç¤ºçµæœ'}
          />

          {/* Modal */}
          {state.modalType && <ModalContent />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
