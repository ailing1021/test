<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.18.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
    }
    .modal {
      display: flex;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 350px;
      border-radius: 8px;
    }
    textarea {
      font-family: Consolas, monospace;
    }
  </style>
</head>
<body class="bg-gray-100 p-2 min-h-screen flex flex-col">

  <div id="root" class="flex-grow flex flex-col"></div>

  <script type="text/babel">
    function App() {
      const [state, setState] = React.useState({
        salary: 0,
        living_expense: 5000,
        start_month: 1,
        repay_list: [], // { name: 'Alice', debt: 10000 }
        course_list: [], // { fee: 12000, months: 12 }
        result: '',
        modal: null
      });

      const showModal = (type) => setState({ ...state, modal: type });
      const closeModal = () => setState({ ...state, modal: null });

      // æ¨¡æ“¬å¾Œç«¯ API è«‹æ±‚
      const apiPost = async (url, payload = {}) => {
        console.log(`æ¨¡æ“¬ POST åˆ° ${url}ï¼Œè³‡æ–™:`, payload);
        let res = { status: 'success', message: 'æ“ä½œæˆåŠŸ' };

        // é€™è£¡æœƒç›´æ¥åœ¨å‰ç«¯è™•ç†ç‹€æ…‹ï¼Œä»¥ä¾¿æ¼”ç¤º
        switch (url) {
          case '/api/add_person':
            // ç¢ºä¿æ¯æ¬¡æ–°å¢æ™‚éƒ½åˆå§‹åŒ–ä¸€å€‹ remaining_debt
            const newRepayList = [...state.repay_list, { name: payload.name, debt: parseFloat(payload.debt), remaining_debt: parseFloat(payload.debt) }];
            res.repay_list = newRepayList;
            break;
          case '/api/add_course':
            // ç¢ºä¿æ¯æ¬¡æ–°å¢æ™‚éƒ½åˆå§‹åŒ–ä¸€å€‹ remaining_fee
            const newCourseList = [...state.course_list, { fee: parseFloat(payload.fee), months: parseInt(payload.months, 10), remaining_fee: parseFloat(payload.fee) }];
            res.course_list = newCourseList;
            break;
          case '/api/set_salary':
            res.salary = parseFloat(payload.salary);
            break;
          case '/api/set_living_expense':
            res.living_expense = parseFloat(payload.expense);
            break;
          case '/api/set_start_month':
            res.start_month = parseInt(payload.start_month, 10);
            break;
          case '/api/calculate':
            let log = [`--- é‚„æ¬¾è©¦ç®—çµæœ (èµ·å§‹æœˆ: ${state.start_month}) ---`];
            let monthCount = 0;
            // å‰µå»ºå¯è®Šçš„å‚µå‹™å’Œèª²ç¨‹è²»ç”¨å‰¯æœ¬
            let repayablePersons = state.repay_list.map(p => ({ ...p }));
            let repayableCourses = state.course_list.map(c => ({ ...c }));

            let totalRemainingDebt = repayablePersons.reduce((sum, p) => sum + p.remaining_debt, 0);
            let totalRemainingCourseFee = repayableCourses.reduce((sum, c) => sum + c.remaining_fee, 0);

            // ç•¶æ‰€æœ‰å‚µå‹™å’Œèª²ç¨‹è²»ç”¨éƒ½é‚„æ¸…æ™‚åœæ­¢
            while (totalRemainingDebt > 0 || totalRemainingCourseFee > 0) {
                monthCount++;
                const displayMonth = (state.start_month + monthCount - 2) % 12 + 1; // è¨ˆç®—é¡¯ç¤ºæœˆä»½ (1-12)
                const displayYear = Math.floor((state.start_month + monthCount - 2) / 12) + 1; // ç°¡åŒ–å¹´ä»½è¨ˆç®—ï¼Œå¾ç¬¬1å¹´é–‹å§‹

                let disposableIncome = state.salary - state.living_expense;
                log.push(`\n${displayYear} å¹´ ${displayMonth} æœˆ (æœˆæ”¶å…¥: ${state.salary.toFixed(2)}, ç”Ÿæ´»è²»: ${state.living_expense.toFixed(2)})`);
                log.push(`- æœ¬æœˆå¯æ”¯é…é‡‘é¡: ${disposableIncome.toFixed(2)} å…ƒ`);

                // å„ªå…ˆè™•ç†èª²ç¨‹è²»ç”¨ (æ¯æœˆå›ºå®šåˆ†æœŸ)
                let currentMonthCoursePayment = 0;
                repayableCourses.forEach(course => {
                    if (course.remaining_fee > 0 && course.months > 0) {
                        const monthlyPayment = course.fee / course.months; // åŸå§‹ç¸½è²»ç”¨ / æœˆæ•¸
                        const paymentToApply = Math.min(monthlyPayment, course.remaining_fee); // ä¸è¶…éå‰©é¤˜è²»ç”¨
                        currentMonthCoursePayment += paymentToApply;
                        course.remaining_fee -= paymentToApply;
                    }
                });

                if (currentMonthCoursePayment > 0) {
                    log.push(`- èª²ç¨‹åˆ†æœŸç¹³ç´: ${currentMonthCoursePayment.toFixed(2)} å…ƒ`);
                    disposableIncome -= currentMonthCoursePayment;
                }

                if (disposableIncome <= 0) {
                    log.push(`- å¯ç”¨æ–¼é‚„æ¬¾çš„é‡‘é¡ä¸è¶³ï¼Œæœ¬æœˆç„¡é¡å¤–é‚„æ¬¾æˆ–èµ¤å­—ï¼š${disposableIncome.toFixed(2)} å…ƒã€‚`);
                    // å³ä½¿èµ¤å­—ï¼Œæˆ‘å€‘ä¹Ÿç¹¼çºŒå¾ªç’°ï¼Œç›´åˆ°æ‰€æœ‰å‚µå‹™æ­¸é›¶ (è¡¨ç¤ºéœ€è¦å¤–éƒ¨è³‡é‡‘æˆ–èª¿æ•´è¨­å®š)
                } else {
                    log.push(`- æœ¬æœˆå¯ç”¨æ–¼å„Ÿé‚„å€‹äººå‚µå‹™é‡‘é¡: ${disposableIncome.toFixed(2)} å…ƒ`);

                    // æŒ‰ç…§åˆ—è¡¨é †åºä¾æ¬¡é‚„æ¬¾ï¼Œç›´åˆ°å¯æ”¯é…é‡‘é¡ç”¨å®Œæˆ–æ‰€æœ‰å‚µå‹™é‚„æ¸…
                    for (let i = 0; i < repayablePersons.length && disposableIncome > 0; i++) {
                        let person = repayablePersons[i];
                        if (person.remaining_debt > 0) {
                            let amountToRepay = Math.min(disposableIncome, person.remaining_debt);
                            person.remaining_debt -= amountToRepay;
                            disposableIncome -= amountToRepay;
                            log.push(`  - é‚„çµ¦ ${person.name}: ${amountToRepay.toFixed(2)} å…ƒ`);
                        }
                    }
                }

                // æ›´æ–°ç¸½å‰©é¤˜å‚µå‹™å’Œèª²ç¨‹è²»ç”¨
                totalRemainingDebt = repayablePersons.reduce((sum, p) => sum + Math.max(0, p.remaining_debt), 0);
                totalRemainingCourseFee = repayableCourses.reduce((sum, c) => sum + Math.max(0, c.remaining_fee), 0);

                log.push(`- ç•¶å‰ç¸½å‰©é¤˜å‚µå‹™: ${totalRemainingDebt.toFixed(2)} å…ƒ`);
                log.push(`- ç•¶å‰ç¸½å‰©é¤˜èª²ç¨‹è²»ç”¨: ${totalRemainingCourseFee.toFixed(2)} å…ƒ`);

                if (monthCount > 1200) { // è¨­å®šä¸€å€‹æœ€å¤§å¾ªç’°æ¬¡æ•¸ï¼Œé¿å…ç„¡é™å¾ªç’°
                    log.push("\n--- è­¦å‘Šï¼šè©¦ç®—æ™‚é–“éé•· (è¶…é 100 å¹´)ã€‚å¯èƒ½è¨­å®šæœ‰èª¤ï¼Œæˆ–æ”¶å…¥ä¸è¶³ä»¥é‚„æ¸…æ‰€æœ‰å‚µå‹™å’Œèª²ç¨‹è²»ç”¨ã€‚---");
                    break;
                }
            }
            log.push(`\n--- è©¦ç®—çµæŸ ---`);
            log.push(`æ­å–œï¼ç¸½è¨ˆèŠ±è²» ${monthCount} å€‹æœˆ (å¾ ${state.start_month} æœˆç®—èµ·) é‚„æ¸…æ‰€æœ‰å‚µå‹™å’Œèª²ç¨‹è²»ç”¨ã€‚`);
            res.result = log.join('\n');
            break;
          case '/api/reset':
            res.message = 'æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºã€‚';
            break;
          case '/api/export_csv':
             return {};
          default:
            res.status = 'error';
            res.message = 'æœªçŸ¥ API è·¯å¾‘';
        }
        return res;
      };

      const addPerson = async () => {
        const nameInput = document.getElementById('person-name');
        const debtInput = document.getElementById('person-debt');
        const name = nameInput.value.trim();
        const debt = parseFloat(debtInput.value);

        if (name === '') {
            alert('å§“åä¸èƒ½ç‚ºç©º');
            nameInput.focus();
            return;
        }
        if (isNaN(debt) || debt <= 0) {
            alert('æ¬ æ¬¾é‡‘é¡å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”å¤§æ–¼ 0');
            debtInput.focus();
            return;
        }
        // å°‡ remaining_debt ä¸€ä½µåŠ å…¥
        const res = await apiPost('/api/add_person', { name, debt, remaining_debt: debt });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, repay_list: res.repay_list, modal: null });
      };

      const addCourse = async () => {
        const feeInput = document.getElementById('course-fee');
        const monthsInput = document.getElementById('course-months');
        const fee = parseFloat(feeInput.value);
        const months = parseInt(monthsInput.value, 10);

        if (isNaN(fee) || fee <= 0) {
            alert('èª²ç¨‹ç¸½è²»ç”¨å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”å¤§æ–¼ 0');
            feeInput.focus();
            return;
        }
        if (isNaN(months) || months <= 0) {
            alert('èª²ç¨‹æœŸæ•¸å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”å¤§æ–¼ 0');
            monthsInput.focus();
            return;
        }
        // å°‡ remaining_fee ä¸€ä½µåŠ å…¥
        const res = await apiPost('/api/add_course', { fee, months, remaining_fee: fee });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, course_list: res.course_list, modal: null });
      };

      const setSalary = async () => {
        const salaryInput = document.getElementById('salary-input');
        const salary = parseFloat(salaryInput.value);

        if (isNaN(salary) || salary < 0) {
            alert('è–ªæ°´å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”éè² æ•¸');
            salaryInput.focus();
            return;
        }
        const res = await apiPost('/api/set_salary', { salary });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, salary: res.salary, modal: null });
      };

      const setLivingExpense = async () => {
        const expenseInput = document.getElementById('expense-input');
        const expense = parseFloat(expenseInput.value);

        if (isNaN(expense) || expense < 0) {
            alert('ç”Ÿæ´»è²»å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”éè² æ•¸');
            expenseInput.focus();
            return;
        }
        const res = await apiPost('/api/set_living_expense', { expense });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, living_expense: res.living_expense, modal: null });
      };

      const setStartMonth = async () => {
        const startMonthInput = document.getElementById('start-month-input');
        const start_month = parseInt(startMonthInput.value, 10);

        if (isNaN(start_month) || start_month < 1 || start_month > 12) {
            alert('èµ·å§‹æœˆä»½å¿…é ˆæ˜¯ 1 åˆ° 12 ä¹‹é–“çš„æ•´æ•¸');
            startMonthInput.focus();
            return;
        }
        const res = await apiPost('/api/set_start_month', { start_month });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, start_month: res.start_month, modal: null });
      };

      const calculate = async () => {
        // å…ˆé€²è¡ŒåŸºæœ¬çš„æ•¸æ“šæª¢æŸ¥
        if (state.salary <= 0) {
            alert('è«‹å…ˆè¨­å®šæ‚¨çš„è–ªæ°´ (å¿…é ˆå¤§æ–¼ 0)ã€‚');
            showModal('setSalary');
            return;
        }
        if (state.living_expense < 0) {
            alert('è«‹è¨­å®šæ‚¨çš„ç”Ÿæ´»è²» (å¿…é ˆéè² æ•¸)ã€‚');
            showModal('setLivingExpense');
            return;
        }
        if (state.repay_list.length === 0 && state.course_list.length === 0) {
            alert('è«‹æ–°å¢é‚„æ¬¾äººæˆ–èª²ç¨‹å¾Œå†é€²è¡Œè©¦ç®—ã€‚');
            return;
        }


        const res = await apiPost('/api/calculate');
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, result: res.result });
      };

      const exportCsv = () => {
        if (!state.result) {
            alert('ç„¡è©¦ç®—çµæœå¯åŒ¯å‡º');
            return;
        }
        // åœ¨çœŸå¯¦æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒè§¸ç™¼å¾Œç«¯ç”Ÿæˆä¸¦ä¸‹è¼‰ CSV æª”æ¡ˆ
        // ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘æ¨¡æ“¬é€™å€‹è¡Œç‚º
        alert('æ­¤åŠŸèƒ½æœƒå°å‡ºç•¶å‰è©¦ç®—çµæœç‚º CSV (éœ€å¾Œç«¯æ”¯æ´)');
        // window.location.href = '/api/export_csv'; // å¦‚æœæœ‰å¾Œç«¯ï¼Œé€™è¡ŒæœƒçœŸæ­£è§¸ç™¼ä¸‹è¼‰
      };

      const copyResult = () => {
        if (!state.result) {
            alert('ç„¡è©¦ç®—çµæœ');
            return;
        }
        navigator.clipboard.writeText(state.result);
        alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
      };

      const clearAll = async () => {
        if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨­å®šå’Œçµæœå—ï¼Ÿ')) {
            return;
        }
        const res = await apiPost('/api/reset');
        alert(res.message);
        setState({
          salary: 0, living_expense: 5000, start_month: 1,
          repay_list: [], course_list: [], result: '', modal: null
        });
      };

      const exitApp = () => {
        if (confirm('ç¢ºå®šé›¢é–‹ï¼Ÿ')) {
            window.close();
            alert('æ„Ÿè¬ä½¿ç”¨ï¼');
        }
      };

      return (
        <div className="max-w-xl w-full mx-auto bg-white p-4 rounded-lg shadow flex-grow flex flex-col">
          <h1 className="text-xl font-bold text-center mb-4">ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</h1>

          <div className="flex flex-wrap gap-2 mb-4">
            <button className="px-3 py-2 bg-yellow-300 rounded text-sm font-bold" onClick={exportCsv} disabled={!state.result}>ğŸ’¾ åŒ¯å‡º CSV</button>
            <button className="px-3 py-2 bg-blue-300 rounded text-sm font-bold" onClick={copyResult} disabled={!state.result}>ğŸ“‹ è¤‡è£½çµæœ</button>
            <button className="px-3 py-2 bg-pink-300 rounded text-sm font-bold" onClick={() => showModal('addPerson')}>â• é‚„æ¬¾äºº</button>
            <button className="px-3 py-2 bg-indigo-200 rounded text-sm font-bold" onClick={() => showModal('addCourse')}>â• èª²ç¨‹</button>
            <button className="px-3 py-2 bg-sky-300 rounded text-sm font-bold" onClick={() => showModal('setSalary')}>ğŸ’¼ è–ªæ°´</button>
            <button className="px-3 py-2 bg-yellow-200 rounded text-sm font-bold" onClick={() => showModal('setLivingExpense')}>ğŸ™ ç”Ÿæ´»è²»</button>
            <button className="px-3 py-2 bg-orange-200 rounded text-sm font-bold" onClick={() => showModal('setStartMonth')}>ğŸ“† èµ·å§‹æœˆ</button>
            <button className="px-3 py-2 bg-purple-200 rounded text-sm font-bold" onClick={clearAll}>ğŸ§¹ æ¸…ç©º</button>
            <button className="px-3 py-2 bg-red-400 text-white rounded text-sm font-bold" onClick={exitApp}>âŒ é›¢é–‹</button>
          </div>

          <div className="text-sm mb-2">è–ªæ°´: {state.salary.toFixed(2)} å…ƒ | ç”Ÿæ´»è²»: {state.living_expense.toFixed(2)} å…ƒ | èµ·å§‹æœˆ: {state.start_month}</div>

          <textarea readOnly className="w-full h-24 p-2 border rounded mb-2 text-sm" value={state.repay_list.map(p => `${p.name} æ¬  ${p.debt.toFixed(2)} å…ƒ (å‰©é¤˜ ${p.remaining_debt ? p.remaining_debt.toFixed(2) : p.debt.toFixed(2)} å…ƒ)`).join('\n') || 'å°šç„¡é‚„æ¬¾äºº' }></textarea>
          <textarea readOnly className="w-full h-24 p-2 border rounded mb-2 text-sm" value={state.course_list.length ? state.course_list.map((c, i) => `èª²ç¨‹${i+1}: ç¸½ ${c.fee.toFixed(2)} å…ƒï¼Œåˆ† ${c.months} æœŸ (å‰©é¤˜ ${c.remaining_fee ? c.remaining_fee.toFixed(2) : c.fee.toFixed(2)} å…ƒ)`).join('\n') : 'å°šç„¡èª²ç¨‹'}></textarea>

          <button className="w-full py-3 bg-green-300 rounded font-bold text-sm mb-4" onClick={calculate}>ğŸ“Š é–‹å§‹è©¦ç®—</button>
          <textarea readOnly className="w-full flex-grow p-2 border rounded text-sm" value={state.result || 'é»æ“Š "é–‹å§‹è©¦ç®—" å¾Œé¡¯ç¤ºçµæœ' }></textarea>

          {/* Modal è¦–çª— */}
          {state.modal && (
            <div className="modal">
              <div className="modal-content">
                {state.modal === 'addPerson' && (
                  <div>
                    <h3 className="font-bold mb-2">æ–°å¢é‚„æ¬¾äºº</h3>
                    <input id="person-name" className="border p-1 w-full mb-2" placeholder="å§“å" type="text" />
                    <input id="person-debt" className="border p-1 w-full mb-2" placeholder="æ¬ æ¬¾é‡‘é¡" type="number" step="0.01" />
                    <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={addPerson}>æ–°å¢</button>
                    <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
                  </div>
                )}

                {state.modal === 'addCourse' && (
                  <div>
                    <h3 className="font-bold mb-2">æ–°å¢èª²ç¨‹</h3>
                    <input id="course-fee" className="border p-1 w-full mb-2" placeholder="èª²ç¨‹ç¸½è²»ç”¨" type="number" step="0.01" />
                    <input id="course-months" className="border p-1 w-full mb-2" placeholder="åˆ†æœŸæœˆæ•¸" type="number" min="1" step="1" />
                    <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={addCourse}>æ–°å¢</button>
                    <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
                  </div>
                )}

                {state.modal === 'setSalary' && (
                  <div>
                    <h3 className="font-bold mb-2">è¨­å®šè–ªæ°´</h3>
                    <input id="salary-input" className="border p-1 w-full mb-2" placeholder="æœˆè–ª" type="number" step="0.01" />
                    <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={setSalary}>è¨­å®š</button>
                    <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
                  </div>
                )}

                {state.modal === 'setLivingExpense' && (
                  <div>
                    <h3 className="font-bold mb-2">è¨­å®šç”Ÿæ´»è²»</h3>
                    <input id="expense-input" className="border p-1 w-full mb-2" placeholder="æ¯æœˆç”Ÿæ´»è²»" type="number" step="0.01" />
                    <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={setLivingExpense}>è¨­å®š</button>
                    <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
                  </div>
                )}

                {state.modal === 'setStartMonth' && (
                  <div>
                    <h3 className="font-bold mb-2">è¨­å®šèµ·å§‹æœˆä»½</h3>
                    <input id="start-month-input" className="border p-1 w-full mb-2" placeholder="èµ·å§‹æœˆä»½ (1-12)" type="number" min="1" max="12" step="1" />
                    <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={setStartMonth}>è¨­å®š</button>
                    <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

</body>
</html>
