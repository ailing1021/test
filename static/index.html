<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ - å®Œæ•´ç‰ˆ</title>
  <!-- React CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body, #root {
      height: 100%;
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      background-color: #f3f4f6; /* Tailwind gray-100 */
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 380px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    textarea {
      font-family: 'Courier New', Courier, monospace;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div id="root" class="h-full flex flex-col"></div>

  <script type="text/babel">

    function App() {
      const getInitialState = () => {
        try {
          return {
            salary: parseFloat(localStorage.getItem('salary')) || 0,
            livingExpense: parseFloat(localStorage.getItem('livingExpense')) || 0,
            startMonth: parseInt(localStorage.getItem('startMonth')) || 1,
            repayList: JSON.parse(localStorage.getItem('repayList')) || [],
            courseList: JSON.parse(localStorage.getItem('courseList')) || [],
            calculationResult: '',
            modalType: null,
          };
        } catch (e) {
          return {
            salary: 0,
            livingExpense: 0,
            startMonth: 1,
            repayList: [],
            courseList: [],
            calculationResult: '',
            modalType: null,
          };
        }
      };

      const [state, setState] = React.useState(getInitialState);

      React.useEffect(() => {
        localStorage.setItem('salary', state.salary);
        localStorage.setItem('livingExpense', state.livingExpense);
        localStorage.setItem('startMonth', state.startMonth);
        localStorage.setItem('repayList', JSON.stringify(state.repayList));
        localStorage.setItem('courseList', JSON.stringify(state.courseList));
      }, [state.salary, state.livingExpense, state.startMonth, state.repayList, state.courseList]);

      const openModal = (type) => {
        setState(prev => ({ ...prev, modalType: type }));
      };

      const closeModal = () => {
        setState(prev => ({ ...prev, modalType: null }));
      };

      const addPerson = (name, debt) => {
        if (!name.trim()) {
          alert("å§“åä¸èƒ½ç‚ºç©º");
          return false;
        }
        if (isNaN(debt) || debt <= 0) {
          alert("æ¬ æ¬¾é‡‘é¡å¿…é ˆå¤§æ–¼0");
          return false;
        }
        const newPerson = {
          name: name.trim(),
          debt: parseFloat(debt),
          remainingDebt: parseFloat(debt),
        };
        setState(prev => ({
          ...prev,
          repayList: [...prev.repayList, newPerson],
          modalType: null,
        }));
        return true;
      };

      const addCourse = (fee, months) => {
        if (isNaN(fee) || fee <= 0) {
          alert("èª²ç¨‹ç¸½è²»ç”¨å¿…é ˆå¤§æ–¼0");
          return false;
        }
        if (!Number.isInteger(months) || months <= 0) {
          alert("èª²ç¨‹æœŸæ•¸å¿…é ˆæ˜¯å¤§æ–¼0çš„æ•´æ•¸");
          return false;
        }
        const newCourse = {
          fee: parseFloat(fee),
          months: months,
          remainingFee: parseFloat(fee),
        };
        setState(prev => ({
          ...prev,
          courseList: [...prev.courseList, newCourse],
          modalType: null,
        }));
        return true;
      };

      const setSalary = (salary) => {
        if (isNaN(salary) || salary < 0) {
          alert("è–ªæ°´å¿…é ˆæ˜¯éè² æ•¸");
          return false;
        }
        setState(prev => ({
          ...prev,
          salary: parseFloat(salary),
          modalType: null,
        }));
        return true;
      };

      const setLivingExpense = (expense) => {
        if (isNaN(expense) || expense < 0) {
          alert("ç”Ÿæ´»è²»å¿…é ˆæ˜¯éè² æ•¸");
          return false;
        }
        setState(prev => ({
          ...prev,
          livingExpense: parseFloat(expense),
          modalType: null,
        }));
        return true;
      };

      const setStartMonth = (month) => {
        if (!Number.isInteger(month) || month < 1 || month > 12) {
          alert("èµ·å§‹æœˆä»½å¿…é ˆä»‹æ–¼1åˆ°12");
          return false;
        }
        setState(prev => ({
          ...prev,
          startMonth: month,
          modalType: null,
        }));
        return true;
      };

      // åˆªé™¤é‚„æ¬¾äºº
      const removePerson = (index) => {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤é‚„æ¬¾äººã€Œ${state.repayList[index].name}ã€å—ï¼Ÿ`)) return;
        const newList = [...state.repayList];
        newList.splice(index, 1);
        setState(prev => ({ ...prev, repayList: newList }));
      };

      // åˆªé™¤èª²ç¨‹
      const removeCourse = (index) => {
        if (!confirm(`ç¢ºå®šè¦åˆªé™¤èª²ç¨‹ #${index + 1} å—ï¼Ÿ`)) return;
        const newList = [...state.courseList];
        newList.splice(index, 1);
        setState(prev => ({ ...prev, courseList: newList }));
      };

      // è¨ˆç®—é‚„æ¬¾è©¦ç®—è¡¨ï¼Œé€™è£¡ç‚ºç¤ºæ„ï¼Œåƒ…ç°¡å–®ç¤ºç¯„
      const calculate = () => {
        if (state.salary <= 0) {
          alert('è«‹å…ˆè¨­å®šæ‚¨çš„è–ªæ°´ (å¿…é ˆå¤§æ–¼ 0)ã€‚');
          openModal('setSalary');
          return;
        }
        if (state.livingExpense < 0) {
          alert('è«‹è¨­å®šæ‚¨çš„ç”Ÿæ´»è²» (å¿…é ˆéè² æ•¸)ã€‚');
          openModal('setLivingExpense');
          return;
        }
        if (state.repayList.length === 0 && state.courseList.length === 0) {
          alert('è«‹æ–°å¢é‚„æ¬¾äººæˆ–èª²ç¨‹å¾Œå†é€²è¡Œè©¦ç®—ã€‚');
          return;
        }
        // é€™é‚Šæ”¾ä½ çš„è©¦ç®—é‚è¼¯ï¼Œé€™è£¡ç°¡å–®ç¤ºç¯„é¡¯ç¤ºæ–‡å­—
        let resultText = `è–ªæ°´ï¼š${state.salary.toFixed(2)}ï¼Œç”Ÿæ´»è²»ï¼š${state.livingExpense.toFixed(2)}ï¼Œèµ·å§‹æœˆï¼š${state.startMonth}\n\n`;
        resultText += "é‚„æ¬¾äººåˆ—è¡¨ï¼š\n";
        state.repayList.forEach(p => {
          resultText += ` - ${p.name} æ¬ æ¬¾ ${p.debt.toFixed(2)} å…ƒï¼Œå‰©é¤˜ ${p.remainingDebt.toFixed(2)} å…ƒ\n`;
        });
        resultText += "\nèª²ç¨‹åˆ—è¡¨ï¼š\n";
        state.courseList.forEach((c, i) => {
          resultText += ` - èª²ç¨‹${i+1} ç¸½è²»ç”¨ ${c.fee.toFixed(2)} å…ƒï¼ŒæœŸæ•¸ ${c.months}ï¼Œå‰©é¤˜ ${c.remainingFee.toFixed(2)} å…ƒ\n`;
        });
        setState(prev => ({ ...prev, calculationResult: resultText }));
      };

      // åŒ¯å‡ºCSVï¼ˆç¤ºæ„ï¼‰
      const exportCsv = () => {
        if (!state.calculationResult) {
          alert('ç„¡è©¦ç®—çµæœå¯åŒ¯å‡º');
          return;
        }
        alert('æ­¤åŠŸèƒ½æš«æœªå¯¦ä½œï¼Œå¾…å¾Œç«¯æ”¯æ´');
      };

      // è¤‡è£½çµæœæ–‡å­—
      const copyResult = () => {
        if (!state.calculationResult) {
          alert('ç„¡è©¦ç®—çµæœ');
          return;
        }
        navigator.clipboard.writeText(state.calculationResult);
        alert('å·²è¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿');
      };

      // æ¸…ç©ºæ‰€æœ‰è³‡æ–™
      const clearAll = () => {
        if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨­å®šå’Œçµæœå—ï¼Ÿ')) return;
        localStorage.clear();
        setState({
          salary: 0,
          livingExpense: 0,
          startMonth: 1,
          repayList: [],
          courseList: [],
          calculationResult: '',
          modalType: null,
        });
      };

      // é›¢é–‹
      const exitApp = () => {
        if (confirm('ç¢ºå®šé›¢é–‹ï¼Ÿ')) {
          window.close();
          alert('æ„Ÿè¬ä½¿ç”¨ï¼');
        }
      };

      // Modal å…§éƒ¨è¡¨å–®å…ƒä»¶
      const ModalContent = () => {
        if (!state.modalType) return null;

        // ç”¨ ref å–å¾—è¼¸å…¥æ¡†å€¼ (ç°¡å–®ç¤ºç¯„ç”¨ controlled ä¹Ÿè¡Œ)
        let input1 = React.useRef(null);
        let input2 = React.useRef(null);

        // è™•ç†æäº¤
        const handleSubmit = () => {
          switch (state.modalType) {
            case 'addPerson':
              if (addPerson(input1.current.value, input2.current.value)) closeModal();
              break;
            case 'addCourse':
              if (addCourse(input1.current.value, parseInt(input2.current.value))) closeModal();
              break;
            case 'setSalary':
              if (setSalary(input1.current.value)) closeModal();
              break;
            case 'setLivingExpense':
              if (setLivingExpense(input1.current.value)) closeModal();
              break;
            case 'setStartMonth':
              if (setStartMonth(parseInt(input1.current.value))) closeModal();
              break;
            default:
              closeModal();
          }
        };

        // Modal æ¨™é¡Œèˆ‡æ¬„ä½æ–‡å­—
        let title = '';
        let label1 = '';
        let label2 = '';
        let placeholder1 = '';
        let placeholder2 = '';
        let showInput2 = true;

        switch (state.modalType) {
          case 'addPerson':
            title = 'ğŸ€ æ–°å¢é‚„æ¬¾äºº ğŸ€';
            label1 = 'å§“å';
            label2 = 'æ¬ æ¬¾é‡‘é¡ (å…ƒ)';
            placeholder1 = 'ä¾‹å¦‚ï¼šå°æ˜';
            placeholder2 = 'ä¾‹å¦‚ï¼š10000';
            break;
          case 'addCourse':
            title = 'ğŸ€ æ–°å¢èª²ç¨‹è²»ç”¨ ğŸ€';
            label1 = 'èª²ç¨‹ç¸½è²»ç”¨ (å…ƒ)';
            label2 = 'æœŸæ•¸ï¼ˆæœˆï¼‰';
            placeholder1 = 'ä¾‹å¦‚ï¼š30000';
            placeholder2 = 'ä¾‹å¦‚ï¼š6';
            break;
          case 'setSalary':
            title = 'ğŸ’° è¨­å®šè–ªæ°´ ğŸ’°';
            label1 = 'è–ªæ°´ (å…ƒ)';
            placeholder1 = 'ä¾‹å¦‚ï¼š34000';
            showInput2 = false;
            break;
          case 'setLivingExpense':
            title = 'ğŸ€ è¨­å®šç”Ÿæ´»è²» ğŸ€';
            label1 = 'ç”Ÿæ´»è²» (å…ƒ)';
            placeholder1 = 'ä¾‹å¦‚ï¼š5000';
            showInput2 = false;
            break;
          case 'setStartMonth':
            title = 'ğŸ“… è¨­å®šèµ·å§‹æœˆä»½ ğŸ“…';
            label1 = 'èµ·å§‹æœˆä»½ (1~12)';
            placeholder1 = 'ä¾‹å¦‚ï¼š1';
            showInput2 = false;
            break;
          default:
            return null;
        }

        return (
          <div className="modal" onClick={closeModal}>
            <div className="modal-content" onClick={e => e.stopPropagation()}>
              <h2 className="text-xl font-bold mb-4">{title}</h2>
              <div className="mb-3">
                <label className="block mb-1">{label1}:</label>
                <input
                  type={state.modalType.includes('Month') ? 'number' : 'text'}
                  ref={input1}
                  placeholder={placeholder1}
                  className="w-full border rounded px-2 py-1"
                  autoFocus
                />
              </div>
              {showInput2 && (
                <div className="mb-3">
                  <label className="block mb-1">{label2}:</label>
                  <input
                    type="number"
                    ref={input2}
                    placeholder={placeholder2}
                    className="w-full border rounded px-2 py-1"
                  />
                </div>
              )}
              <div className="flex justify-end space-x-2">
                <button
                  className="bg-gray-300 hover:bg-gray-400 px-3 py-1 rounded"
                  onClick={closeModal}
                >
                  å–æ¶ˆ
                </button>
                <button
                  className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                  onClick={handleSubmit}
                >
                  ç¢ºå®š
                </button>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="flex flex-col h-full p-4 max-w-3xl mx-auto">
          <h1 className="text-3xl font-bold mb-4 text-center">ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</h1>

          {/* æŒ‰éˆ•å€ */}
          <div className="flex flex-wrap gap-3 mb-6 justify-center">
            <button
              className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
              onClick={() => openModal('setSalary')}
              title="è¨­å®šè–ªæ°´"
            >
              è–ªæ°´ï¼š{state.salary.toFixed(0)}
            </button>

            <button
              className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
              onClick={() => openModal('setLivingExpense')}
              title="è¨­å®šç”Ÿæ´»è²»"
            >
              ç”Ÿæ´»è²»ï¼š{state.livingExpense.toFixed(0)}
            </button>

            <button
              className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700"
              onClick={() => openModal('setStartMonth')}
              title="è¨­å®šèµ·å§‹æœˆä»½"
            >
              èµ·å§‹æœˆï¼š{state.startMonth}
            </button>

            <button
              className="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700"
              onClick={() => openModal('addPerson')}
              title="æ–°å¢é‚„æ¬¾äºº"
            >
              æ–°å¢é‚„æ¬¾äºº
            </button>

            <button
              className="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700"
              onClick={() => openModal('addCourse')}
              title="æ–°å¢èª²ç¨‹è²»ç”¨"
            >
              æ–°å¢èª²ç¨‹è²»ç”¨
            </button>

            <button
              className="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700"
              onClick={calculate}
              title="è¨ˆç®—è©¦ç®—è¡¨"
            >
              è¨ˆç®—è©¦ç®—
            </button>

            <button
              className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700"
              onClick={exportCsv}
              title="åŒ¯å‡º CSV"
            >
              åŒ¯å‡º CSV
            </button>

            <button
              className="bg-gray-400 text-black px-4 py-2 rounded hover:bg-gray-500"
              onClick={copyResult}
              title="è¤‡è£½è©¦ç®—çµæœ"
            >
              è¤‡è£½çµæœ
            </button>

            <button
              className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
              onClick={clearAll}
              title="æ¸…ç©ºæ‰€æœ‰è³‡æ–™"
            >
              æ¸…ç©ºè³‡æ–™
            </button>

            <button
              className="bg-black text-white px-4 py-2 rounded hover:bg-gray-900"
              onClick={exitApp}
              title="é›¢é–‹"
            >
              é›¢é–‹
            </button>
          </div>

          {/* é‚„æ¬¾äººæ¸…å–® */}
          <section className="mb-6">
            <h2 className="text-xl font-semibold mb-2">é‚„æ¬¾äººæ¸…å–®</h2>
            {state.repayList.length === 0 ? (
              <p className="text-gray-500">å°šç„¡é‚„æ¬¾äººè³‡æ–™ï¼Œè«‹æ–°å¢ã€‚</p>
            ) : (
              <div className="border border-gray-300 rounded p-2 max-h-48 overflow-y-auto bg-white">
                <table className="w-full text-left">
                  <thead className="border-b border-gray-300">
                    <tr>
                      <th className="px-2 py-1">å§“å</th>
                      <th className="px-2 py-1">æ¬ æ¬¾é‡‘é¡(å…ƒ)</th>
                      <th className="px-2 py-1">å‰©é¤˜æ¬ æ¬¾(å…ƒ)</th>
                      <th className="px-2 py-1">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {state.repayList.map((p, i) => (
                      <tr key={i} className="border-b border-gray-200">
                        <td className="px-2 py-1">{p.name}</td>
                        <td className="px-2 py-1">{p.debt.toFixed(2)}</td>
                        <td className="px-2 py-1">{p.remainingDebt.toFixed(2)}</td>
                        <td className="px-2 py-1">
                          <button
                            className="text-red-600 hover:underline"
                            onClick={() => removePerson(i)}
                          >
                            åˆªé™¤
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </section>

          {/* èª²ç¨‹è²»ç”¨æ¸…å–® */}
          <section className="mb-6">
            <h2 className="text-xl font-semibold mb-2">èª²ç¨‹è²»ç”¨æ¸…å–®</h2>
            {state.courseList.length === 0 ? (
              <p className="text-gray-500">å°šç„¡èª²ç¨‹è²»ç”¨è³‡æ–™ï¼Œè«‹æ–°å¢ã€‚</p>
            ) : (
              <div className="border border-gray-300 rounded p-2 max-h-48 overflow-y-auto bg-white">
                <table className="w-full text-left">
                  <thead className="border-b border-gray-300">
                    <tr>
                      <th className="px-2 py-1">èª²ç¨‹ç·¨è™Ÿ</th>
                      <th className="px-2 py-1">ç¸½è²»ç”¨(å…ƒ)</th>
                      <th className="px-2 py-1">æœŸæ•¸(æœˆ)</th>
                      <th className="px-2 py-1">å‰©é¤˜è²»ç”¨(å…ƒ)</th>
                      <th className="px-2 py-1">æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>
                    {state.courseList.map((c, i) => (
                      <tr key={i} className="border-b border-gray-200">
                        <td className="px-2 py-1">{i + 1}</td>
                        <td className="px-2 py-1">{c.fee.toFixed(2)}</td>
                        <td className="px-2 py-1">{c.months}</td>
                        <td className="px-2 py-1">{c.remainingFee.toFixed(2)}</td>
                        <td className="px-2 py-1">
                          <button
                            className="text-red-600 hover:underline"
                            onClick={() => removeCourse(i)}
                          >
                            åˆªé™¤
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </section>

          {/* è¨ˆç®—çµæœå€ */}
          <section className="mb-4">
            <h2 className="text-xl font-semibold mb-2">è©¦ç®—çµæœ</h2>
            <textarea
              readOnly
              value={state.calculationResult}
              rows={12}
              className="w-full p-2 border border-gray-300 rounded bg-white resize-none"
              placeholder="æŒ‰ä¸‹ã€Œè¨ˆç®—è©¦ç®—ã€å¾Œæœƒé¡¯ç¤ºçµæœ"
            />
          </section>

          {state.modalType && <ModalContent />}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
