<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.18.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
    }
    .modal {
      display: flex;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 350px;
      border-radius: 8px;
    }
    textarea {
      font-family: Consolas, monospace;
    }
  </style>
</head>
<body class="bg-gray-100 p-2 min-h-screen flex flex-col">

  <div id="root" class="flex-grow flex flex-col"></div>

  <script type="text/babel">
    function App() {
      const [state, setState] = React.useState({
        salary: 0,
        living_expense: 5000,
        start_month: 1,
        repay_list: [],
        course_list: [],
        result: '',
        modal: null
      });

      const showModal = (type) => setState({ ...state, modal: type });
      const closeModal = () => setState({ ...state, modal: null });

      const apiPost = async (url, payload = {}) => {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        return await res.json();
      };

      const addPerson = async () => {
        const name = document.getElementById('person-name').value;
        const debt = document.getElementById('person-debt').value;
        const res = await apiPost('/api/add_person', { name, debt });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, repay_list: res.repay_list, modal: null });
      };

      const addCourse = async () => {
        const fee = document.getElementById('course-fee').value;
        const months = document.getElementById('course-months').value;
        const res = await apiPost('/api/add_course', { fee, months });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, course_list: res.course_list, modal: null });
      };

      const setSalary = async () => {
        const salary = document.getElementById('salary-input').value;
        const res = await apiPost('/api/set_salary', { salary });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, salary: res.salary, modal: null });
      };

      const setLivingExpense = async () => {
        const expense = document.getElementById('expense-input').value;
        const res = await apiPost('/api/set_living_expense', { expense });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, living_expense: res.living_expense, modal: null });
      };

      const setStartMonth = async () => {
        const start_month = document.getElementById('start-month-input').value;
        const res = await apiPost('/api/set_start_month', { start_month });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, start_month: res.start_month, modal: null });
      };

      const calculate = async () => {
        const res = await apiPost('/api/calculate');
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, result: res.result });
      };

      const exportCsv = () => window.location.href = '/api/export_csv';
      const copyResult = () => {
        if (!state.result) return alert('ç„¡è©¦ç®—çµæœ');
        navigator.clipboard.writeText(state.result);
        alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
      };

      const clearAll = async () => {
        const res = await apiPost('/api/reset');
        alert(res.message);
        setState({
          salary: 0, living_expense: 5000, start_month: 1,
          repay_list: [], course_list: [], result: '', modal: null
        });
      };

      const exitApp = () => {
        if (confirm('ç¢ºå®šé›¢é–‹ï¼Ÿ')) window.close();
      };

      return (
        <div className="max-w-xl w-full mx-auto bg-white p-4 rounded-lg shadow flex-grow flex flex-col">
          <h1 className="text-xl font-bold text-center mb-4">ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</h1>

          <div className="flex flex-wrap gap-2 mb-4">
            <button className="px-3 py-2 bg-yellow-300 rounded text-sm font-bold" onClick={exportCsv} disabled={!state.result}>ğŸ’¾ åŒ¯å‡º CSV</button>
            <button className="px-3 py-2 bg-blue-300 rounded text-sm font-bold" onClick={copyResult} disabled={!state.result}>ğŸ“‹ è¤‡è£½çµæœ</button>
            <button className="px-3 py-2 bg-pink-300 rounded text-sm font-bold" onClick={() => showModal('addPerson')}>â• é‚„æ¬¾äºº</button>
            <button className="px-3 py-2 bg-indigo-200 rounded text-sm font-bold" onClick={() => showModal('addCourse')}>â• èª²ç¨‹</button>
            <button className="px-3 py-2 bg-sky-300 rounded text-sm font-bold" onClick={() => showModal('setSalary')}>ğŸ’¼ è–ªæ°´</button>
            <button className="px-3 py-2 bg-yellow-200 rounded text-sm font-bold" onClick={() => showModal('setLivingExpense')}>ğŸ™ ç”Ÿæ´»è²»</button>
            <button className="px-3 py-2 bg-orange-200 rounded text-sm font-bold" onClick={() => showModal('setStartMonth')}>ğŸ“† èµ·å§‹æœˆ</button>
            <button className="px-3 py-2 bg-purple-200 rounded text-sm font-bold" onClick={clearAll}>ğŸ§¹ æ¸…ç©º</button>
            <button className="px-3 py-2 bg-red-400 text-white rounded text-sm font-bold" onClick={exitApp}>âŒ é›¢é–‹</button>
          </div>

          <div className="text-sm mb-2">è–ªæ°´: {state.salary.toFixed(2)} å…ƒ | ç”Ÿæ´»è²»: {state.living_expense.toFixed(2)} å…ƒ | èµ·å§‹æœˆ: {state.start_month}</div>

          <textarea readOnly className="w-full h-24 p-2 border rounded mb-2 text-sm" value={state.repay_list.map(p => `${p.name} æ¬  ${p.debt.toFixed(2)} å…ƒ`).join('\n')}></textarea>
          <textarea readOnly className="w-full h-24 p-2 border rounded mb-2 text-sm" value={state.course_list.length ? state.course_list.map((c, i) => `èª²ç¨‹${i+1}: ç¸½ ${c.fee.toFixed(2)} æœŸ ${c.months}`).join('\n') : 'å°šç„¡èª²ç¨‹'}></textarea>

          <button className="w-full py-3 bg-green-300 rounded font-bold text-sm mb-4" onClick={calculate}>ğŸ“Š é–‹å§‹è©¦ç®—</button>
          <textarea readOnly className="w-full flex-grow p-2 border rounded text-sm" value={state.result}></textarea>

          {/* Modal è¦–çª— */}
          {state.modal && (
            <div className="modal">
              <div className="modal-content">
                {state.modal === 'addPerson' && (
                  <div>
                    <h3 className="font-bold mb-2">æ–°å¢é‚„æ¬¾äºº</h3>
                    <input id="person-name" className="border p-1 w-full mb-2" placeholder="å§“å" />
                    <input id="person-debt" className="border p-1 w-full mb-2" placeholder="æ¬ æ¬¾é‡‘é¡" />
                    <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={addPerson}>æ–°å¢</button>
                    <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
                  </div>
                )}
                {/* å…¶ä»– modal é¡å‹è‡ªå·±è£œä¸Š */}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

</body>
</html>
