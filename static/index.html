<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.18.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    textarea { font-family: Consolas, monospace; }
    .modal { display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { background: white; margin: 20% auto; padding: 20px; width: 300px; border-radius: 8px; }
  </style>
</head>
<body class="bg-gray-100 p-4">
  <div id="root"></div>

  <script type="text/babel">
    function App() {
      const [state, setState] = React.useState({
        salary: 0,
        living_expense: 5000,
        start_month: 1,
        repay_list: [],
        course_list: [],
        result: '',
        modal: null
      });

      const showModal = (type) => setState({...state, modal: type});
      const closeModal = () => setState({...state, modal: null});

      const addPerson = async () => {
        const name = document.getElementById('person-name').value;
        const debt = document.getElementById('person-debt').value;
        const res = await fetch('/api/add_person', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({name, debt})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, repay_list: data.repay_list, modal: null});
      };

      const addCourse = async () => {
        const fee = document.getElementById('course-fee').value;
        const months = document.getElementById('course-months').value;
        const res = await fetch('/api/add_course', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({fee, months})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, course_list: data.course_list, modal: null});
      };

      const setSalary = async () => {
        const salary = document.getElementById('salary-input').value;
        const res = await fetch('/api/set_salary', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({salary})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, salary: data.salary, modal: null});
      };

      const setLivingExpense = async () => {
        const expense = document.getElementById('expense-input').value;
        const res = await fetch('/api/set_living_expense', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({expense})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, living_expense: data.living_expense, modal: null});
      };

      const setStartMonth = async () => {
        const start_month = document.getElementById('start-month-input').value;
        const res = await fetch('/api/set_start_month', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({start_month})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, start_month: data.start_month, modal: null});
      };

      const calculate = async () => {
        const res = await fetch('/api/calculate', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, result: data.result});
      };

      const exportCsv = () => window.location.href = '/api/export_csv';
      const copyResult = () => {
        if(!state.result) return alert('ç„¡è©¦ç®—çµæœ');
        navigator.clipboard.writeText(state.result).then(()=>alert('å·²è¤‡è£½'));
      };

      const clearAll = async () => {
        const res = await fetch('/api/reset', {method: 'POST'});
        const data = await res.json();
        setState({
          salary: 0, living_expense: 5000, start_month: 1,
          repay_list: [], course_list: [], result: '', modal: null
        });
        alert(data.message);
      };

      return (
        <div className="max-w-3xl mx-auto bg-white p-4 rounded-lg shadow">
          <h1 className="text-2xl font-bold mb-4 text-center">ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</h1>

          <div className="flex flex-wrap gap-2 mb-4">
            <button className="bg-yellow-400 px-3 py-1 rounded" onClick={exportCsv} disabled={!state.result}>ğŸ’¾ åŒ¯å‡º CSV</button>
            <button className="bg-blue-300 px-3 py-1 rounded" onClick={copyResult} disabled={!state.result}>ğŸ“‹ è¤‡è£½çµæœ</button>
            <button className="bg-pink-300 px-3 py-1 rounded" onClick={()=>showModal('addPerson')}>â• æ–°å¢é‚„æ¬¾äºº</button>
            <button className="bg-blue-200 px-3 py-1 rounded" onClick={()=>showModal('addCourse')}>â• æ–°å¢èª²ç¨‹</button>
            <button className="bg-green-300 px-3 py-1 rounded" onClick={()=>showModal('setSalary')}>ğŸ’¼ è¨­å®šè–ªæ°´</button>
            <button className="bg-yellow-300 px-3 py-1 rounded" onClick={()=>showModal('setLivingExpense')}>ğŸ™ è¨­ç”Ÿæ´»è²»</button>
            <button className="bg-orange-200 px-3 py-1 rounded" onClick={()=>showModal('setStartMonth')}>ğŸ“… èµ·å§‹æœˆ</button>
            <button className="bg-red-400 px-3 py-1 text-white rounded" onClick={clearAll}>ğŸ§¹ æ¸…ç©º</button>
          </div>

          <p>è–ªæ°´: {state.salary}ï¼Œç”Ÿæ´»è²»: {state.living_expense}ï¼Œèµ·å§‹æœˆ: {state.start_month}</p>
          <textarea className="w-full h-24 border mt-2 p-1 text-sm" readOnly value={state.repay_list.map(p=>`${p.name} æ¬  ${p.debt}`).join('\\n')}></textarea>
          <textarea className="w-full h-20 border mt-2 p-1 text-sm" readOnly value={state.course_list.map((c,i)=>`èª²ç¨‹${i+1}: ${c.fee}å…ƒ, ${c.months}æœˆ`).join('\\n')}></textarea>

          <button className="w-full bg-green-400 py-2 mt-4 rounded font-bold" onClick={calculate}>ğŸ“Š é–‹å§‹è©¦ç®—</button>
          <textarea className="w-full h-64 border mt-2 p-1 text-sm" readOnly value={state.result}></textarea>

          {/* Modal å€ */}
          {state.modal==='addPerson' && (
            <div className="modal">
              <div className="modal-content">
                <h2>æ–°å¢é‚„æ¬¾äºº</h2>
                <input id="person-name" className="border p-1 w-full mb-2" placeholder="å§“å"/>
                <input id="person-debt" type="number" className="border p-1 w-full mb-2" placeholder="æ¬ æ¬¾é‡‘é¡"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={addPerson}>ç¢ºèª</button>
                <button className="px-2 py-1" onClick={closeModal}>å–æ¶ˆ</button>
              </div>
            </div>
          )}

          {state.modal==='addCourse' && (
            <div className="modal">
              <div className="modal-content">
                <h2>æ–°å¢èª²ç¨‹</h2>
                <input id="course-fee" type="number" className="border p-1 w-full mb-2" placeholder="è²»ç”¨"/>
                <input id="course-months" type="number" className="border p-1 w-full mb-2" placeholder="æœŸæ•¸"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={addCourse}>ç¢ºèª</button>
                <button className="px-2 py-1" onClick={closeModal}>å–æ¶ˆ</button>
              </div>
            </div>
          )}

          {state.modal==='setSalary' && (
            <div className="modal">
              <div className="modal-content">
                <h2>è¨­å®šè–ªæ°´</h2>
                <input id="salary-input" type="number" className="border p-1 w-full mb-2" placeholder="è–ªæ°´"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={setSalary}>ç¢ºèª</button>
                <button className="px-2 py-1" onClick={closeModal}>å–æ¶ˆ</button>
              </div>
            </div>
          )}

          {state.modal==='setLivingExpense' && (
            <div className="modal">
              <div className="modal-content">
                <h2>è¨­å®šç”Ÿæ´»è²»</h2>
                <input id="expense-input" type="number" className="border p-1 w-full mb-2" placeholder="ç”Ÿæ´»è²»"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={setLivingExpense}>ç¢ºèª</button>
                <button className="px-2 py-1" onClick={closeModal}>å–æ¶ˆ</button>
              </div>
            </div>
          )}

          {state.modal==='setStartMonth' && (
            <div className="modal">
              <div className="modal-content">
                <h2>è¨­å®šèµ·å§‹æœˆ</h2>
                <input id="start-month-input" type="number" className="border p-1 w-full mb-2" placeholder="èµ·å§‹æœˆ"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={setStartMonth}>ç¢ºèª</button>
                <button className="px-2 py-1" onClick={closeModal}>å–æ¶ˆ</button>
              </div>
            </div>
          )}

        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
