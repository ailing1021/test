<!DOCTYPE html>
<html lang="zh-TW">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</title>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.18.9/babel.min.js"></script>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <style>
Â  Â  html, body {
Â  Â  Â  height: 100%;
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0;
Â  Â  }
Â  Â  body {
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  }
Â  Â  .modal {
Â  Â  Â  display: flex;
Â  Â  Â  position: fixed;
Â  Â  Â  inset: 0;
Â  Â  Â  background: rgba(0,0,0,0.5);
Â  Â  Â  z-index: 1000;
Â  Â  Â  justify-content: center;
Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .modal-content {
Â  Â  Â  background: white;
Â  Â  Â  padding: 20px;
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 350px;
Â  Â  Â  border-radius: 8px;
Â  Â  }
Â  Â  textarea {
Â  Â  Â  font-family: Consolas, monospace;
Â  Â  }
Â  </style>
</head>
<body class="bg-gray-100 p-2 min-h-screen flex flex-col">

Â  <div id="root" class="flex-grow flex flex-col"></div>

Â  <script type="text/babel">
Â  Â  function App() {
Â  Â  Â  // å¾ localStorage è¼‰å…¥è³‡æ–™ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­å€¼
Â  Â  Â  const getInitialState = () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const storedSalary = localStorage.getItem('salary');
Â  Â  Â  Â  Â  const storedLivingExpense = localStorage.getItem('living_expense');
Â  Â  Â  Â  Â  const storedStartMonth = localStorage.getItem('start_month');
Â  Â  Â  Â  Â  const storedRepayList = localStorage.getItem('repay_list');
Â  Â  Â  Â  Â  const storedCourseList = localStorage.getItem('course_list');

Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  salary: storedSalary ? parseFloat(storedSalary) : 0,
Â  Â  Â  Â  Â  Â  living_expense: storedLivingExpense ? parseFloat(storedLivingExpense) : 0,
Â  Â  Â  Â  Â  Â  start_month: storedStartMonth ? parseInt(storedStartMonth, 10) : 1,
Â  Â  Â  Â  Â  Â  repay_list: storedRepayList ? JSON.parse(storedRepayList) : [],
Â  Â  Â  Â  Â  Â  course_list: storedCourseList ? JSON.parse(storedCourseList) : [],
Â  Â  Â  Â  Â  Â  result: '',
Â  Â  Â  Â  Â  Â  modal: null
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error("è¼‰å…¥ LocalStorage å¤±æ•—:", error);
Â  Â  Â  Â  Â  // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œè¿”å›é è¨­å€¼
Â  Â  Â  Â  Â  return {
Â  Â  Â  Â  Â  Â  salary: 0,
Â  Â  Â  Â  Â  Â  living_expense: 0, // Changed default to 0
Â  Â  Â  Â  Â  Â  start_month: 1,
Â  Â  Â  Â  Â  Â  repay_list: [],
Â  Â  Â  Â  Â  Â  course_list: [],
Â  Â  Â  Â  Â  Â  result: '',
Â  Â  Â  Â  Â  Â  modal: null
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const [state, setState] = React.useState(getInitialState);

Â  Â  Â  // ä½¿ç”¨ useEffect ä¾†ç›£è½ç‹€æ…‹è®ŠåŒ–ä¸¦å„²å­˜åˆ° LocalStorage
Â  Â  Â  React.useEffect(() => {
Â  Â  Â  Â  localStorage.setItem('salary', state.salary);
Â  Â  Â  Â  localStorage.setItem('living_expense', state.living_expense);
Â  Â  Â  Â  localStorage.setItem('start_month', state.start_month);
Â  Â  Â  Â  localStorage.setItem('repay_list', JSON.stringify(state.repay_list));
Â  Â  Â  Â  localStorage.setItem('course_list', JSON.stringify(state.course_list));
Â  Â  Â  }, [state.salary, state.living_expense, state.start_month, state.repay_list, state.course_list]);


Â  Â  Â  const showModal = (type) => setState({ ...state, modal: type });
Â  Â  Â  const closeModal = () => setState({ ...state, modal: null });

Â  Â  Â  // æ¨¡æ“¬å¾Œç«¯ API è«‹æ±‚ - åœ¨é€™è£¡è™•ç†ç‹€æ…‹æ›´æ–°å’Œè©¦ç®—é‚è¼¯
Â  Â  Â  const apiPost = async (url, payload = {}) => {
Â  Â  Â  Â  console.log(`æ¨¡æ“¬ POST åˆ° ${url}ï¼Œè³‡æ–™:`, payload);
Â  Â  Â  Â  let res = { status: 'success', message: 'æ“ä½œæˆåŠŸ' };

Â  Â  Â  Â  switch (url) {
Â  Â  Â  Â  Â  case '/api/add_person':
Â  Â  Â  Â  Â  Â  const updatedRepayList = [...state.repay_list, { name: payload.name, debt: parseFloat(payload.debt), remaining_debt: parseFloat(payload.debt) }];
Â  Â  Â  Â  Â  Â  res.repay_list = updatedRepayList;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '/api/add_course':
Â  Â  Â  Â  Â  Â  const updatedCourseList = [...state.course_list, { fee: parseFloat(payload.fee), months: parseInt(payload.months, 10), remaining_fee: parseFloat(payload.fee) }];
Â  Â  Â  Â  Â  Â  res.course_list = updatedCourseList;
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '/api/set_salary':
Â  Â  Â  Â  Â  Â  res.salary = parseFloat(payload.salary);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '/api/set_living_expense':
Â  Â  Â  Â  Â  Â  res.living_expense = parseFloat(payload.expense);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '/api/set_start_month':
Â  Â  Â  Â  Â  Â  res.start_month = parseInt(payload.start_month, 10);
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '/api/calculate':
Â  Â  Â  Â  Â  Â  let log = [`--- è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨ (èµ·å§‹æœˆ: ${state.start_month}) ---`];
Â  Â  Â  Â  Â  Â  let monthCount = 0;

Â  Â  Â  Â  Â  Â  let currentRepayPersons = JSON.parse(JSON.stringify(state.repay_list));
Â  Â  Â  Â  Â  Â  let currentCourses = JSON.parse(JSON.stringify(state.course_list));

Â  Â  Â  Â  Â  Â  let getTotalRemaining = () => {
Â  Â  Â  Â  Â  Â  Â  Â  const debt = currentRepayPersons.reduce((sum, p) => sum + Math.max(0, p.remaining_debt), 0);
Â  Â  Â  Â  Â  Â  Â  Â  const course = currentCourses.reduce((sum, c) => sum + Math.max(0, c.remaining_fee), 0);
Â  Â  Â  Â  Â  Â  Â  Â  return debt + course;
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  if (getTotalRemaining() === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  log.push("\nç›®å‰æ²’æœ‰ä»»ä½•å‚µå‹™æˆ–èª²ç¨‹è²»ç”¨éœ€è¦å„Ÿé‚„ã€‚");
Â  Â  Â  Â  Â  Â  Â  Â  res.result = log.join('\n');
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const MAX_MONTHS = 1200; // æœ€å¤šè©¦ç®— 100 å¹´ï¼Œé¿å…ç„¡é™å¾ªç’°

Â  Â  Â  Â  Â  Â  while (getTotalRemaining() > 0 && monthCount < MAX_MONTHS) {
Â  Â  Â  Â  Â  Â  Â  Â  monthCount++;
Â  Â  Â  Â  Â  Â  Â  Â  const actualMonthIndex = state.start_month + monthCount - 2;
Â  Â  Â  Â  Â  Â  Â  Â  const displayYear = Math.floor(actualMonthIndex / 12) + 1;
Â  Â  Â  Â  Â  Â  Â  Â  const displayMonth = (actualMonthIndex % 12) + 1;

Â  Â  Â  Â  Â  Â  Â  Â  let disposableIncome = state.salary - state.living_expense;
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`\n=== ${displayYear} å¹´ ${displayMonth} æœˆ ===`);
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`- æœˆæ”¶å…¥: ${state.salary.toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`- ç”Ÿæ´»è²»: ${state.living_expense.toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`- æœ¬æœˆå¯æ”¯é…é‡‘é¡ (æ‰£é™¤ç”Ÿæ´»è²»å¾Œ): ${disposableIncome.toFixed(2)} å…ƒ`);

Â  Â  Â  Â  Â  Â  Â  Â  let totalCoursePaymentThisMonth = 0;
Â  Â  Â  Â  Â  Â  Â  Â  currentCourses.forEach(course => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (course.remaining_fee > 0 && course.months > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const monthlyPaymentPerCourse = course.fee / course.months;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const paymentToApply = Math.min(monthlyPaymentPerCourse, course.remaining_fee);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalCoursePaymentThisMonth += paymentToApply;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  course.remaining_fee -= paymentToApply;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (totalCoursePaymentThisMonth > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log.push(`- èª²ç¨‹åˆ†æœŸç¹³ç´ç¸½é¡: ${totalCoursePaymentThisMonth.toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  disposableIncome -= totalCoursePaymentThisMonth;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (disposableIncome <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log.push(`- æœ¬æœˆå¯ç”¨æ–¼å„Ÿé‚„å€‹äººå‚µå‹™é‡‘é¡ä¸è¶³ (åƒ…å‰© ${disposableIncome.toFixed(2)} å…ƒ)ï¼Œæœ¬æœˆç„¡é¡å¤–é‚„æ¬¾ã€‚`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log.push(`- æœ¬æœˆå¯éˆæ´»æ”¯é…ç”¨æ–¼å„Ÿé‚„å€‹äººå‚µå‹™é‡‘é¡: ${disposableIncome.toFixed(2)} å…ƒ`);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let currentTotalPersonsDebt = currentRepayPersons.reduce((sum, p) => sum + Math.max(0, p.remaining_debt), 0);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentTotalPersonsDebt > 0 && disposableIncome > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // è¨ˆç®—æ‰€æœ‰æœ‰å‚µå‹™çš„äººï¼Œä¸¦æŒ‰æ¯”ä¾‹åˆ†é…
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let totalAllocated = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRepayPersons.forEach(person => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (person.remaining_debt > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const debtRatio = person.remaining_debt / currentTotalPersonsDebt;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let amountToRepay = disposableIncome * debtRatio;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ç¢ºä¿ä¸è¶…éå‰©é¤˜å‚µå‹™ï¼Œä¸¦å››æ¨äº”å…¥åˆ°å°æ•¸é»å…©ä½
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amountToRepay = Math.min(amountToRepay, person.remaining_debt);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amountToRepay = parseFloat(amountToRepay.toFixed(2)); 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (amountToRepay > 0) { // ç¢ºä¿åˆ†é…çš„é‡‘é¡å¤§æ–¼0
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  person.remaining_debt -= amountToRepay;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalAllocated += amountToRepay;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log.push(` Â - é‚„çµ¦ ${person.name}: ${amountToRepay.toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // è™•ç†å› ç‚ºtoFixed()å››æ¨äº”å…¥é€ æˆçš„å¾®å°å‰©é¤˜ï¼Œç›¡é‡åˆ†å®Œ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let finalRemainingDisposable = disposableIncome - totalAllocated;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (finalRemainingDisposable > 0.01) { // å¦‚æœé‚„æœ‰å¾®å°å‰©é¤˜ä¸”è¶…éä¸€å®šé–¾å€¼
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // å†æ¬¡å˜—è©¦åˆ†é…çµ¦ä»æœ‰å‚µå‹™çš„äººï¼Œå„ªå…ˆçµ¦é‚£äº›å‰©é¤˜å‚µå‹™å¤§çš„
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRepayPersons.sort((a, b) => b.remaining_debt - a.remaining_debt); // æŒ‰å‰©é¤˜å‚µå‹™é™åº
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let i = 0; i < currentRepayPersons.length && finalRemainingDisposable > 0.01; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let person = currentRepayPersons[i];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (person.remaining_debt > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let amountToAdd = Math.min(finalRemainingDisposable, person.remaining_debt);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  amountToAdd = parseFloat(amountToAdd.toFixed(2));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (amountToAdd > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  person.remaining_debt -= amountToAdd;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalRemainingDisposable -= amountToAdd;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // æ‰¾åˆ°ä¹‹å‰è¨˜éŒ„çš„é‚„æ¬¾è¡Œä¸¦æ›´æ–°å®ƒï¼Œæˆ–è€…æ–°å¢ä¸€è¡Œ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let updatedLog = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let k = log.length - 1; k >= 0; k--) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (log[k].includes(`é‚„çµ¦ ${person.name}`)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalAmountMatch = log[k].match(/é‚„çµ¦\s.+:\s([\d.]+)\så…ƒ/);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (originalAmountMatch) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const originalAmount = parseFloat(originalAmountMatch[1]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newAmount = originalAmount + amountToAdd;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log[k] = log[k].replace(`${originalAmount.toFixed(2)} å…ƒ`, `${newAmount.toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updatedLog = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!updatedLog) { // å¦‚æœä¹‹å‰æ²’æœ‰é‚„æ¬¾è¨˜éŒ„ï¼Œå‰‡æ–°å¢ä¸€è¡Œ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â log.push(` Â - (è£œè¶³) é‚„çµ¦ ${person.name}: ${amountToAdd.toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentTotalPersonsDebt > 0 && disposableIncome <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â log.push(` Â - æ²’æœ‰è¶³å¤ çš„é‡‘é¡å„Ÿé‚„å€‹äººå‚µå‹™ã€‚`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentTotalPersonsDebt === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â log.push(` Â - æ‰€æœ‰å€‹äººå‚µå‹™å·²æ¸…å„Ÿã€‚`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  Â  Â  log.push(`- æœ¬æœˆçµæŸå¾Œï¼Œç¸½å‰©é¤˜å‚µå‹™: ${currentRepayPersons.reduce((sum, p) => sum + Math.max(0, p.remaining_debt), 0).toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`- æœ¬æœˆçµæŸå¾Œï¼Œç¸½å‰©é¤˜èª²ç¨‹è²»ç”¨: ${currentCourses.reduce((sum, c) => sum + Math.max(0, c.remaining_fee), 0).toFixed(2)} å…ƒ`);

Â  Â  Â  Â  Â  Â  Â  Â  if (monthCount >= MAX_MONTHS && getTotalRemaining() > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log.push("\n--- è­¦å‘Šï¼šè©¦ç®—æ™‚é–“éé•· (è¶…é 100 å¹´)ã€‚å¯èƒ½æ”¶å…¥ä¸è¶³ä»¥é‚„æ¸…æ‰€æœ‰å‚µå‹™å’Œèª²ç¨‹è²»ç”¨ï¼Œè«‹èª¿æ•´æ‚¨çš„è²¡å‹™è¨­å®šã€‚---");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (getTotalRemaining() <= 0) {
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`\n--- æ­å–œï¼ ---`);
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`æ‰€æœ‰å‚µå‹™å’Œèª²ç¨‹è²»ç”¨å·²åœ¨ç¸½è¨ˆ ${monthCount} å€‹æœˆå…§æ¸…å„Ÿå®Œç•¢ï¼`);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`\n--- è©¦ç®—çµæŸ ---`);
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`ç¶“é ${monthCount} å€‹æœˆçš„è©¦ç®—ï¼Œä»æœ‰å‚µå‹™æˆ–èª²ç¨‹è²»ç”¨æœªæ¸…å„Ÿã€‚`);
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`å‰©é¤˜ç¸½å‚µå‹™: ${currentRepayPersons.reduce((sum, p) => sum + Math.max(0, p.remaining_debt), 0).toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  Â  Â  log.push(`å‰©é¤˜ç¸½èª²ç¨‹è²»ç”¨: ${currentCourses.reduce((sum, c) => sum + Math.max(0, c.remaining_fee), 0).toFixed(2)} å…ƒ`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  res.result = log.join('\n');
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '/api/reset':
Â  Â  Â  Â  Â  Â  // æ¸…ç©º LocalStorage
Â  Â  Â  Â  Â  Â  localStorage.clear();
Â  Â  Â  Â  Â  Â  res.message = 'æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºã€‚';
Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  case '/api/export_csv':
Â  Â  Â  Â  Â  Â  Â return {};
Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  res.status = 'error';
Â  Â  Â  Â  Â  Â  res.message = 'æœªçŸ¥ API è·¯å¾‘';
Â  Â  Â  Â  }
Â  Â  Â  Â  return res;
Â  Â  Â  };

Â  Â  Â  const addPerson = async () => {
Â  Â  Â  Â  const nameInput = document.getElementById('person-name');
Â  Â  Â  Â  const debtInput = document.getElementById('person-debt');
Â  Â  Â  Â  const name = nameInput.value.trim();
Â  Â  Â  Â  const debt = parseFloat(debtInput.value);

Â  Â  Â  Â  if (name === '') {
Â  Â  Â  Â  Â  Â  alert('å§“åä¸èƒ½ç‚ºç©º');
Â  Â  Â  Â  Â  Â  nameInput.focus();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (isNaN(debt) || debt <= 0) {
Â  Â  Â  Â  Â  Â  alert('æ¬ æ¬¾é‡‘é¡å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”å¤§æ–¼ 0');
Â  Â  Â  Â  Â  Â  debtInput.focus();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const res = await apiPost('/api/add_person', { name, debt });
Â  Â  Â  Â  if (res.status === 'error') alert(res.message);
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  setState({ ...state, repay_list: res.repay_list, modal: null });
Â  Â  Â  Â  Â  nameInput.value = '';
Â  Â  Â  Â  Â  debtInput.value = '';
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const addCourse = async () => {
Â  Â  Â  Â  const feeInput = document.getElementById('course-fee');
Â  Â  Â  Â  const monthsInput = document.getElementById('course-months');
Â  Â  Â  Â  const fee = parseFloat(feeInput.value);
Â  Â  Â  Â  const months = parseInt(monthsInput.value, 10);

Â  Â  Â  Â  if (isNaN(fee) || fee <= 0) {
Â  Â  Â  Â  Â  Â  alert('èª²ç¨‹ç¸½è²»ç”¨å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”å¤§æ–¼ 0');
Â  Â  Â  Â  Â  Â  feeInput.focus();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (isNaN(months) || months <= 0) {
Â  Â  Â  Â  Â  Â  alert('èª²ç¨‹æœŸæ•¸å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”å¤§æ–¼ 0');
Â  Â  Â  Â  Â  Â  monthsInput.focus();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const res = await apiPost('/api/add_course', { fee, months });
Â  Â  Â  Â  if (res.status === 'error') alert(res.message);
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  setState({ ...state, course_list: res.course_list, modal: null });
Â  Â  Â  Â  Â  feeInput.value = '';
Â  Â  Â  Â  Â  monthsInput.value = '';
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  const setSalary = async () => {
Â  Â  Â  Â  const salaryInput = document.getElementById('salary-input');
Â  Â  Â  Â  const salary = parseFloat(salaryInput.value);

Â  Â  Â  Â  if (isNaN(salary) || salary < 0) {
Â  Â  Â  Â  Â  Â  alert('è–ªæ°´å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”éè² æ•¸');
Â  Â  Â  Â  Â  Â  salaryInput.focus();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const res = await apiPost('/api/set_salary', { salary });
Â  Â  Â  Â  if (res.status === 'error') alert(res.message);
Â  Â  Â  Â  else setState({ ...state, salary: res.salary, modal: null });
Â  Â  Â  };

Â  Â  Â  const setLivingExpense = async () => {
Â  Â  Â  Â  const expenseInput = document.getElementById('expense-input');
Â  Â  Â  Â  const expense = parseFloat(expenseInput.value);

Â  Â  Â  Â  if (isNaN(expense) || expense < 0) {
Â  Â  Â  Â  Â  Â  alert('ç”Ÿæ´»è²»å¿…é ˆç‚ºæœ‰æ•ˆæ•¸å­—ä¸”éè² æ•¸');
Â  Â  Â  Â  Â  Â  expenseInput.focus();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const res = await apiPost('/api/set_living_expense', { expense });
Â  Â  Â  Â  if (res.status === 'error') alert(res.message);
Â  Â  Â  Â  else setState({ ...state, living_expense: res.living_expense, modal: null });
Â  Â  Â  };

Â  Â  Â  const setStartMonth = async () => {
Â  Â  Â  Â  const startMonthInput = document.getElementById('start-month-input');
Â  Â  Â  Â  const start_month = parseInt(startMonthInput.value, 10);

Â  Â  Â  Â  if (isNaN(start_month) || start_month < 1 || start_month > 12) {
Â  Â  Â  Â  Â  Â  alert('èµ·å§‹æœˆä»½å¿…é ˆæ˜¯ 1 åˆ° 12 ä¹‹é–“çš„æ•´æ•¸');
Â  Â  Â  Â  Â  Â  startMonthInput.focus();
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const res = await apiPost('/api/set_start_month', { start_month });
Â  Â  Â  Â  if (res.status === 'error') alert(res.message);
Â  Â  Â  Â  else setState({ ...state, start_month: res.start_month, modal: null });
Â  Â  Â  };

Â  Â  Â  const calculate = async () => {
Â  Â  Â  Â  if (state.salary <= 0) {
Â  Â  Â  Â  Â  Â  alert('è«‹å…ˆè¨­å®šæ‚¨çš„è–ªæ°´ (å¿…é ˆå¤§æ–¼ 0)ã€‚');
Â  Â  Â  Â  Â  Â  showModal('setSalary');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (state.living_expense < 0) {
Â  Â  Â  Â  Â  Â  alert('è«‹è¨­å®šæ‚¨çš„ç”Ÿæ´»è²» (å¿…é ˆéè² æ•¸)ã€‚');
Â  Â  Â  Â  Â  Â  showModal('setLivingExpense');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (state.repay_list.length === 0 && state.course_list.length === 0) {
Â  Â  Â  Â  Â  Â  alert('è«‹æ–°å¢é‚„æ¬¾äººæˆ–èª²ç¨‹å¾Œå†é€²è¡Œè©¦ç®—ã€‚');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const res = await apiPost('/api/calculate');
Â  Â  Â  Â  if (res.status === 'error') alert(res.message);
Â  Â  Â  Â  else setState({ ...state, result: res.result });
Â  Â  Â  };

Â  Â  Â  const exportCsv = () => {
Â  Â  Â  Â  if (!state.result) {
Â  Â  Â  Â  Â  Â  alert('ç„¡è©¦ç®—çµæœå¯åŒ¯å‡º');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  alert('æ­¤åŠŸèƒ½æœƒå°å‡ºç•¶å‰è©¦ç®—çµæœç‚º CSV (éœ€å¾Œç«¯æ”¯æ´)');
Â  Â  Â  Â  // window.location.href = '/api/export_csv';
Â  Â  Â  };

Â  Â  Â  const copyResult = () => {
Â  Â  Â  Â  if (!state.result) {
Â  Â  Â  Â  Â  Â  alert('ç„¡è©¦ç®—çµæœ');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  navigator.clipboard.writeText(state.result);
Â  Â  Â  Â  alert('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
Â  Â  Â  };

Â  Â  Â  const clearAll = async () => {
Â  Â  Â  Â  if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è¨­å®šå’Œçµæœå—ï¼Ÿ')) {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  const res = await apiPost('/api/reset');
Â  Â  Â  Â  alert(res.message);
Â  Â  Â  Â  setState({
Â  Â  Â  Â  Â  salary: 0, living_expense: 0, start_month: 1, // Changed default to 0
Â  Â  Â  Â  Â  repay_list: [], course_list: [], result: '', modal: null
Â  Â  Â  Â  });
Â  Â  Â  };

Â  Â  Â  const exitApp = () => {
Â  Â  Â  Â  if (confirm('ç¢ºå®šé›¢é–‹ï¼Ÿ')) {
Â  Â  Â  Â  Â  Â  window.close();
Â  Â  Â  Â  Â  Â  alert('æ„Ÿè¬ä½¿ç”¨ï¼');
Â  Â  Â  Â  }
Â  Â  Â  };

Â  Â  Â  return (
Â  Â  Â  Â  <div className="max-w-xl w-full mx-auto bg-white p-4 rounded-lg shadow flex-grow flex flex-col">
Â  Â  Â  Â  Â  <h1 className="text-xl font-bold text-center mb-4">ğŸ’° è¶…ç´šé‚„æ¬¾è©¦ç®—è¡¨</h1>

Â  Â  Â  Â  Â  <div className="flex flex-wrap gap-2 mb-4">
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-yellow-300 rounded text-sm font-bold" onClick={exportCsv} disabled={!state.result}>ğŸ’¾ åŒ¯å‡º CSV</button>
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-blue-300 rounded text-sm font-bold" onClick={copyResult} disabled={!state.result}>ğŸ“‹ è¤‡è£½çµæœ</button>
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-pink-300 rounded text-sm font-bold" onClick={() => showModal('addPerson')}>â• é‚„æ¬¾äºº</button>
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-indigo-200 rounded text-sm font-bold" onClick={() => showModal('addCourse')}>â• èª²ç¨‹</button>
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-sky-300 rounded text-sm font-bold" onClick={() => showModal('setSalary')}>ğŸ’¼ è–ªæ°´</button>
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-yellow-200 rounded text-sm font-bold" onClick={() => showModal('setLivingExpense')}>ğŸ™ ç”Ÿæ´»è²»</button>
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-orange-200 rounded text-sm font-bold" onClick={() => showModal('setStartMonth')}>ğŸ“† èµ·å§‹æœˆ</button>
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-purple-200 rounded text-sm font-bold" onClick={clearAll}>ğŸ§¹ æ¸…ç©º</button>
Â  Â  Â  Â  Â  Â  <button className="px-3 py-2 bg-red-400 text-white rounded text-sm font-bold" onClick={exitApp}>âŒ é›¢é–‹</button>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div className="text-sm mb-2">è–ªæ°´: {state.salary.toFixed(2)} å…ƒ | ç”Ÿæ´»è²»: {state.living_expense.toFixed(2)} å…ƒ | èµ·å§‹æœˆ: {state.start_month}</div>

Â  Â  Â  Â  Â  {/* é¡¯ç¤ºåŸå§‹å‚µå‹™å’Œå‰©é¤˜å‚µå‹™ */}
Â  Â  Â  Â  Â  <textarea readOnly className="w-full h-24 p-2 border rounded mb-2 text-sm" value={state.repay_list.map(p => `${p.name} æ¬  ${p.debt.toFixed(2)} å…ƒ`).join('\n') || 'å°šç„¡é‚„æ¬¾äºº' }></textarea>
Â  Â  Â  Â  Â  <textarea readOnly className="w-full h-24 p-2 border rounded mb-2 text-sm" value={state.course_list.length ? state.course_list.map((c, i) => `èª²ç¨‹${i+1}: ç¸½ ${c.fee.toFixed(2)} å…ƒï¼Œåˆ† ${c.months} æœŸ`).join('\n') : 'å°šç„¡èª²ç¨‹'}></textarea>

Â  Â  Â  Â  Â  <button className="w-full py-3 bg-green-300 rounded font-bold text-sm mb-4" onClick={calculate}>ğŸ“Š é–‹å§‹è©¦ç®—</button>
Â  Â  Â  Â  Â  <textarea readOnly className="w-full flex-grow p-2 border rounded text-sm" value={state.result || 'é»æ“Š "é–‹å§‹è©¦ç®—" å¾Œé¡¯ç¤ºçµæœ' }></textarea>

Â  Â  Â  Â  Â  {/* Modal è¦–çª— */}
Â  Â  Â  Â  Â  {state.modal && (
Â  Â  Â  Â  Â  Â  <div className="modal">
Â  Â  Â  Â  Â  Â  Â  <div className="modal-content">
Â  Â  Â  Â  Â  Â  Â  Â  {state.modal === 'addPerson' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 className="font-bold mb-2">æ–°å¢é‚„æ¬¾äºº</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="person-name" className="border p-1 w-full mb-2" placeholder="å§“å" type="text" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="person-debt" className="border p-1 w-full mb-2" placeholder="æ¬ æ¬¾é‡‘é¡" type="number" step="0.01" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={addPerson}>æ–°å¢</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  )}

Â  Â  Â  Â  Â  Â  Â  Â  {state.modal === 'addCourse' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 className="font-bold mb-2">æ–°å¢èª²ç¨‹</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="course-fee" className="border p-1 w-full mb-2" placeholder="èª²ç¨‹ç¸½è²»ç”¨" type="number" step="0.01" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="course-months" className="border p-1 w-full mb-2" placeholder="åˆ†æœŸæœˆæ•¸" type="number" min="1" step="1" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={addCourse}>æ–°å¢</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  )}

Â  Â  Â  Â  Â  Â  Â  Â  {state.modal === 'setSalary' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 className="font-bold mb-2">è¨­å®šè–ªæ°´</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="salary-input" className="border p-1 w-full mb-2" placeholder="æœˆè–ª" type="number" step="0.01" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={setSalary}>è¨­å®š</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  )}

Â  Â  Â  Â  Â  Â  Â  Â  {state.modal === 'setLivingExpense' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 className="font-bold mb-2">è¨­å®šç”Ÿæ´»è²»</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="expense-input" className="border p-1 w-full mb-2" placeholder="æ¯æœˆç”Ÿæ´»è²»" type="number" step="0.01" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={setLivingExpense}>è¨­å®š</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  )}

Â  Â  Â  Â  Â  Â  Â  Â  {state.modal === 'setStartMonth' && (
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 className="font-bold mb-2">è¨­å®šèµ·å§‹æœˆä»½</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="start-month-input" className="border p-1 w-full mb-2" placeholder="èµ·å§‹æœˆä»½ (1-12)" type="number" min="1" max="12" step="1" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={setStartMonth}>è¨­å®š</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  )}
Â  Â  Â  Â  </div>
Â  Â  Â  );
Â  Â  }

Â  Â  ReactDOM.render(<App />, document.getElementById('root'));
Â  </script>

</body>
</html>
