<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>💰 超級還款試算表</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.18.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
    }
    .modal {
      display: flex;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      width: 90%;
      max-width: 350px;
      border-radius: 8px;
    }
    textarea {
      font-family: Consolas, monospace;
    }
  </style>
</head>
<body class="bg-gray-100 p-2 min-h-screen flex flex-col">

  <div id="root" class="flex-grow flex flex-col"></div>

  <script type="text/babel">
    function App() {
      const [state, setState] = React.useState({
        salary: 0,
        living_expense: 5000,
        start_month: 1,
        repay_list: [],
        course_list: [],
        result: '',
        modal: null
      });

      const showModal = (type) => setState({ ...state, modal: type });
      const closeModal = () => setState({ ...state, modal: null });

      const apiPost = async (url, payload = {}) => {
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        return await res.json();
      };

      const addPerson = async () => {
        const name = document.getElementById('person-name').value;
        const debt = document.getElementById('person-debt').value;
        const res = await apiPost('/api/add_person', { name, debt });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, repay_list: res.repay_list, modal: null });
      };

      const addCourse = async () => {
        const fee = document.getElementById('course-fee').value;
        const months = document.getElementById('course-months').value;
        const res = await apiPost('/api/add_course', { fee, months });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, course_list: res.course_list, modal: null });
      };

      const setSalary = async () => {
        const salary = document.getElementById('salary-input').value;
        const res = await apiPost('/api/set_salary', { salary });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, salary: res.salary, modal: null });
      };

      const setLivingExpense = async () => {
        const expense = document.getElementById('expense-input').value;
        const res = await apiPost('/api/set_living_expense', { expense });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, living_expense: res.living_expense, modal: null });
      };

      const setStartMonth = async () => {
        const start_month = document.getElementById('start-month-input').value;
        const res = await apiPost('/api/set_start_month', { start_month });
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, start_month: res.start_month, modal: null });
      };

      const calculate = async () => {
        const res = await apiPost('/api/calculate');
        if (res.status === 'error') alert(res.message);
        else setState({ ...state, result: res.result });
      };

      const exportCsv = () => window.location.href = '/api/export_csv';
      const copyResult = () => {
        if (!state.result) return alert('無試算結果');
        navigator.clipboard.writeText(state.result);
        alert('已複製到剪貼簿');
      };

      const clearAll = async () => {
        const res = await apiPost('/api/reset');
        alert(res.message);
        setState({
          salary: 0, living_expense: 5000, start_month: 1,
          repay_list: [], course_list: [], result: '', modal: null
        });
      };

      const exitApp = () => {
        if (confirm('確定離開？')) window.close();
      };

      return (
        <div className="max-w-xl w-full mx-auto bg-white p-4 rounded-lg shadow flex-grow flex flex-col">
          <h1 className="text-xl font-bold text-center mb-4">💰 超級還款試算表</h1>

          <div className="flex flex-wrap gap-2 mb-4">
            <button className="px-3 py-2 bg-yellow-300 rounded text-sm font-bold" onClick={exportCsv} disabled={!state.result}>💾 匯出 CSV</button>
            <button className="px-3 py-2 bg-blue-300 rounded text-sm font-bold" onClick={copyResult} disabled={!state.result}>📋 複製結果</button>
            <button className="px-3 py-2 bg-pink-300 rounded text-sm font-bold" onClick={() => showModal('addPerson')}>➕ 還款人</button>
            <button className="px-3 py-2 bg-indigo-200 rounded text-sm font-bold" onClick={() => showModal('addCourse')}>➕ 課程</button>
            <button className="px-3 py-2 bg-sky-300 rounded text-sm font-bold" onClick={() => showModal('setSalary')}>💼 薪水</button>
            <button className="px-3 py-2 bg-yellow-200 rounded text-sm font-bold" onClick={() => showModal('setLivingExpense')}>🍙 生活費</button>
            <button className="px-3 py-2 bg-orange-200 rounded text-sm font-bold" onClick={() => showModal('setStartMonth')}>📆 起始月</button>
            <button className="px-3 py-2 bg-purple-200 rounded text-sm font-bold" onClick={clearAll}>🧹 清空</button>
            <button className="px-3 py-2 bg-red-400 text-white rounded text-sm font-bold" onClick={exitApp}>❌ 離開</button>
          </div>

          <div className="text-sm mb-2">薪水: {state.salary.toFixed(2)} 元 | 生活費: {state.living_expense.toFixed(2)} 元 | 起始月: {state.start_month}</div>

          <textarea readOnly className="w-full h-24 p-2 border rounded mb-2 text-sm" value={state.repay_list.map(p => `${p.name} 欠 ${p.debt.toFixed(2)} 元`).join('\n')}></textarea>
          <textarea readOnly className="w-full h-24 p-2 border rounded mb-2 text-sm" value={state.course_list.length ? state.course_list.map((c, i) => `課程${i+1}: 總 ${c.fee.toFixed(2)} 期 ${c.months}`).join('\n') : '尚無課程'}></textarea>

          <button className="w-full py-3 bg-green-300 rounded font-bold text-sm mb-4" onClick={calculate}>📊 開始試算</button>
          <textarea readOnly className="w-full flex-grow p-2 border rounded text-sm" value={state.result}></textarea>

          {/* Modal 視窗 */}
          {state.modal && (
            <div className="modal">
              <div className="modal-content">
                {state.modal === 'addPerson' && (
                  <div>
                    <h3 className="font-bold mb-2">新增還款人</h3>
                    <input id="person-name" className="border p-1 w-full mb-2" placeholder="姓名" />
                    <input id="person-debt" className="border p-1 w-full mb-2" placeholder="欠款金額" />
                    <button className="bg-green-400 px-3 py-1 rounded mr-2" onClick={addPerson}>新增</button>
                    <button className="bg-gray-300 px-3 py-1 rounded" onClick={closeModal}>取消</button>
                  </div>
                )}
                {/* 其他 modal 類型自己補上 */}
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>

</body>
</html>
