<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>💰 超級還款試算表</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.18.9/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Arial, sans-serif; }
    textarea { font-family: Consolas, monospace; }
    .modal { display: block; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { background: white; margin: 20% auto; padding: 20px; width: 300px; border-radius: 8px; }
  </style>
</head>
<body class="bg-gray-100 p-4">
  <div id="root"></div>

  <script type="text/babel">
    function App() {
      const [state, setState] = React.useState({
        salary: 0,
        living_expense: 5000,
        start_month: 1,
        repay_list: [],
        course_list: [],
        result: '',
        modal: null
      });

      const showModal = (type) => setState({...state, modal: type});
      const closeModal = () => setState({...state, modal: null});

      const addPerson = async () => {
        const name = document.getElementById('person-name').value;
        const debt = document.getElementById('person-debt').value;
        const res = await fetch('/api/add_person', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({name, debt})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, repay_list: data.repay_list, modal: null});
      };

      const addCourse = async () => {
        const fee = document.getElementById('course-fee').value;
        const months = document.getElementById('course-months').value;
        const res = await fetch('/api/add_course', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({fee, months})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, course_list: data.course_list, modal: null});
      };

      const setSalary = async () => {
        const salary = document.getElementById('salary-input').value;
        const res = await fetch('/api/set_salary', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({salary})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, salary: data.salary, modal: null});
      };

      const setLivingExpense = async () => {
        const expense = document.getElementById('expense-input').value;
        const res = await fetch('/api/set_living_expense', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({expense})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, living_expense: data.living_expense, modal: null});
      };

      const setStartMonth = async () => {
        const start_month = document.getElementById('start-month-input').value;
        const res = await fetch('/api/set_start_month', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({start_month})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, start_month: data.start_month, modal: null});
      };

      const calculate = async () => {
        const res = await fetch('/api/calculate', {
          method: 'POST', headers: {'Content-Type':'application/json'},
          body: JSON.stringify({})
        });
        const data = await res.json();
        if(data.status==='error') alert(data.message);
        else setState({...state, result: data.result});
      };

      const exportCsv = () => window.location.href = '/api/export_csv';
      const copyResult = () => {
        if(!state.result) return alert('無試算結果');
        navigator.clipboard.writeText(state.result).then(()=>alert('已複製'));
      };

      const clearAll = async () => {
        const res = await fetch('/api/reset', {method: 'POST'});
        const data = await res.json();
        setState({
          salary: 0, living_expense: 5000, start_month: 1,
          repay_list: [], course_list: [], result: '', modal: null
        });
        alert(data.message);
      };

      return (
        <div className="max-w-3xl mx-auto bg-white p-4 rounded-lg shadow">
          <h1 className="text-2xl font-bold mb-4 text-center">💰 超級還款試算表</h1>

          <div className="flex flex-wrap gap-2 mb-4">
            <button className="bg-yellow-400 px-3 py-1 rounded" onClick={exportCsv} disabled={!state.result}>💾 匯出 CSV</button>
            <button className="bg-blue-300 px-3 py-1 rounded" onClick={copyResult} disabled={!state.result}>📋 複製結果</button>
            <button className="bg-pink-300 px-3 py-1 rounded" onClick={()=>showModal('addPerson')}>➕ 新增還款人</button>
            <button className="bg-blue-200 px-3 py-1 rounded" onClick={()=>showModal('addCourse')}>➕ 新增課程</button>
            <button className="bg-green-300 px-3 py-1 rounded" onClick={()=>showModal('setSalary')}>💼 設定薪水</button>
            <button className="bg-yellow-300 px-3 py-1 rounded" onClick={()=>showModal('setLivingExpense')}>🍙 設生活費</button>
            <button className="bg-orange-200 px-3 py-1 rounded" onClick={()=>showModal('setStartMonth')}>📅 起始月</button>
            <button className="bg-red-400 px-3 py-1 text-white rounded" onClick={clearAll}>🧹 清空</button>
          </div>

          <p>薪水: {state.salary}，生活費: {state.living_expense}，起始月: {state.start_month}</p>
          <textarea className="w-full h-24 border mt-2 p-1 text-sm" readOnly value={state.repay_list.map(p=>`${p.name} 欠 ${p.debt}`).join('\\n')}></textarea>
          <textarea className="w-full h-20 border mt-2 p-1 text-sm" readOnly value={state.course_list.map((c,i)=>`課程${i+1}: ${c.fee}元, ${c.months}月`).join('\\n')}></textarea>

          <button className="w-full bg-green-400 py-2 mt-4 rounded font-bold" onClick={calculate}>📊 開始試算</button>
          <textarea className="w-full h-64 border mt-2 p-1 text-sm" readOnly value={state.result}></textarea>

          {/* Modal 區 */}
          {state.modal==='addPerson' && (
            <div className="modal">
              <div className="modal-content">
                <h2>新增還款人</h2>
                <input id="person-name" className="border p-1 w-full mb-2" placeholder="姓名"/>
                <input id="person-debt" type="number" className="border p-1 w-full mb-2" placeholder="欠款金額"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={addPerson}>確認</button>
                <button className="px-2 py-1" onClick={closeModal}>取消</button>
              </div>
            </div>
          )}

          {state.modal==='addCourse' && (
            <div className="modal">
              <div className="modal-content">
                <h2>新增課程</h2>
                <input id="course-fee" type="number" className="border p-1 w-full mb-2" placeholder="費用"/>
                <input id="course-months" type="number" className="border p-1 w-full mb-2" placeholder="期數"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={addCourse}>確認</button>
                <button className="px-2 py-1" onClick={closeModal}>取消</button>
              </div>
            </div>
          )}

          {state.modal==='setSalary' && (
            <div className="modal">
              <div className="modal-content">
                <h2>設定薪水</h2>
                <input id="salary-input" type="number" className="border p-1 w-full mb-2" placeholder="薪水"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={setSalary}>確認</button>
                <button className="px-2 py-1" onClick={closeModal}>取消</button>
              </div>
            </div>
          )}

          {state.modal==='setLivingExpense' && (
            <div className="modal">
              <div className="modal-content">
                <h2>設定生活費</h2>
                <input id="expense-input" type="number" className="border p-1 w-full mb-2" placeholder="生活費"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={setLivingExpense}>確認</button>
                <button className="px-2 py-1" onClick={closeModal}>取消</button>
              </div>
            </div>
          )}

          {state.modal==='setStartMonth' && (
            <div className="modal">
              <div className="modal-content">
                <h2>設定起始月</h2>
                <input id="start-month-input" type="number" className="border p-1 w-full mb-2" placeholder="起始月"/>
                <button className="bg-green-500 text-white px-2 py-1 mr-2" onClick={setStartMonth}>確認</button>
                <button className="px-2 py-1" onClick={closeModal}>取消</button>
              </div>
            </div>
          )}

        </div>
      );
    }

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
